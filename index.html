<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<title>POLISH CREW — Accounting</title>
<script id="pc-config" type="application/json">{"supabaseUrl":"","supabaseAnonKey":"","stripePriceId":"","stripeFunction":"create-stripe-checkout","notificationsFunction":"send-booking-confirmation"}</script>
<script type="module" src="js/supabase-bridge.js"></script>
<style>
  :root { --bg:#0b0b0c; --card:#101114; --text:#f5f7f7; --muted:#a7b0b0; --green:#00A651; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Montserrat,system-ui,Segoe UI,Roboto,Arial,sans-serif;}
  .appbar{position:sticky;top:0;z-index:10;display:flex;gap:.75rem;align-items:center;padding:.75rem 1rem;background:linear-gradient(180deg,#000c,#0009);border-bottom:1px solid #16181a;backdrop-filter:blur(8px);}
  .logo{width:32px;height:32px;border-radius:8px;background:#000;border:2px solid var(--green);}
  .title{font-family:Oswald,'Bebas Neue',Impact,sans-serif;font-weight:800;letter-spacing:.5px;font-size:1.05rem;}
  .spacer{flex:1}
  .iconbtn{background:#0a0b0c;border:1px solid #1b1d20;padding:.5rem;border-radius:12px;cursor:pointer;}
  .tabs{display:flex;gap:.5rem;padding:.5rem;border-bottom:1px solid #15171a;background:#050607;position:sticky;top:3.5rem;z-index:9;}
  .tab{padding:.5rem .75rem;border:1px solid #1a1e21;border-radius:999px;cursor:pointer;font-weight:700;color:#cfd6d6}
  .tab.active{background:radial-gradient(120% 120% at 50% 0%,#0f1a12,#0a0d0b);border-color:#1f2a1f;color:var(--text);box-shadow:0 0 0 1px #112c19 inset,0 0 12px #0a1}
  .wrap{padding:1rem;max-width:1100px;margin:0 auto}
  .grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));}
  .grid.single-column{grid-template-columns:minmax(0,1fr);}  
  .card{background:linear-gradient(180deg,#0f1013,#0b0c0f);border:1px solid #1a1e21;border-radius:16px;padding:1rem;box-shadow:inset 0 1px 0 #1b221d;}
  .card h3{margin:.25rem 0 .75rem;font-family:Oswald,'Bebas Neue',Impact,sans-serif;letter-spacing:.4px}
  .muted{color:var(--muted);font-size:.9rem}
  input,select,textarea{width:100%;background:#0a0b0c;color:var(--text);border:1px solid #1a1e21;border-radius:12px;padding:.6rem .7rem;outline:none}
  textarea{min-height:72px}
  label{font-size:.85rem;color:#c7d0d0;display:block;margin:.4rem 0 .2rem}
  .row{display:flex;gap:.5rem;align-items:center}
  .row>*{flex:1}
  .btn{background:linear-gradient(180deg,#0c1f14,#0b1510);color:#eaf5ef;border:1px solid #153a26;border-radius:12px;padding:.6rem .8rem;cursor:pointer;font-weight:800}
  .btn.secondary{background:#0b0c0f;border-color:#20242a;color:#d5dddd}
  .pill{border-radius:999px;padding:.25rem .6rem;border:1px solid #1f2a1f;background:#0b130d;color:#cfe9d6;font-weight:800}
  .list{display:flex;flex-direction:column;gap:.5rem}
  .list-item{padding:.5rem .6rem;border:1px solid #171a1d;background:#0a0c0f;border-radius:10px}
  .tiny{font-size:.8rem;color:#aab5b5}
  .hidden{display:none}
  .stack-buttons{display:flex;flex-direction:column;gap:.5rem;align-items:stretch}
  .stack-buttons .fullwidth{width:100%}
  .stack-buttons .btn,.stack-buttons .pill{width:100%}
  @media(min-width:720px){
    .stack-buttons{flex-direction:row;}
    .stack-buttons .btn,.stack-buttons .pill{width:auto;flex:1}
  }
  .receipt-scan{display:flex;flex-direction:column;gap:.75rem;}
  .receipt-preview{border:1px dashed #1f2428;border-radius:12px;padding:.75rem;background:#080a0d;display:flex;flex-direction:column;gap:.6rem;}
  .receipt-preview.hidden{display:none;}
  .receipt-preview img{width:100%;max-height:220px;object-fit:contain;border-radius:10px;background:#000;}
  .receipt-ocr-status{font-size:.8rem;color:var(--muted);}
  .form-grid{display:flex;flex-direction:column;gap:.75rem;}
  .mobile-field-row{display:flex;flex-direction:column;gap:.5rem;}
  @media(min-width:720px){
    .mobile-field-row{flex-direction:row;}
    .mobile-field-row>div{flex:1;}
  }
  .transaction-card{display:flex;flex-direction:column;gap:.5rem;}
  .transaction-card h4{margin:0;font-size:1rem;}
  .transaction-meta{display:flex;flex-wrap:wrap;gap:.35rem;font-size:.75rem;color:var(--muted);}
  .transaction-meta span{background:#101215;border-radius:999px;padding:.2rem .6rem;}
  .transaction-amount{font-weight:800;}
  .transaction-notes{font-size:.85rem;color:#c7d0d0;}
  .vehicle-addon-row[data-included="true"]{opacity:.6;}
  .vehicle-addon-row[data-included="true"] input{pointer-events:none;opacity:.7;}
  .vehicle-package-info{border-radius:12px;border:1px solid #15191c;background:#090b0d;padding:.65rem;margin-top:.5rem;display:flex;flex-direction:column;gap:.35rem;}
  .vehicle-package-info.hidden{display:none;}
  .vehicle-package-info h4{margin:0;font-size:.85rem;color:#f5f7f7;letter-spacing:.2px;}
  .vehicle-package-info p{margin:0;color:#bac6c6;font-size:.85rem;line-height:1.4;}
  .vehicle-package-info ul{margin:.1rem 0 0 1.1rem;padding:0;color:#95a6a6;font-size:.8rem;line-height:1.5;}
  .menu-pkg-card{background:linear-gradient(180deg,#121418,#0c0d10);border:1px solid #1a1e21;border-radius:16px;padding:.75rem;display:flex;flex-direction:column;gap:.6rem;}
  .menu-pkg-card .pkg-header{display:flex;align-items:center;gap:.6rem;}
  .menu-pkg-card .pkg-name{width:100%;}
  .menu-pkg-card .pkg-toggle{flex:0 0 auto;background:#0b0c0f;border:1px solid #1a1e21;color:#d5dddd;border-radius:10px;padding:.3rem .55rem;cursor:pointer;font-size:.85rem;font-weight:700;line-height:1;}
  .menu-pkg-card .pkg-summary{font-size:.8rem;color:#96a4a4;cursor:pointer;}
  .menu-pkg-card .pkg-body{display:flex;flex-direction:column;gap:.5rem;}
  .menu-pkg-card[data-collapsed="true"] .pkg-body{display:none;}
  .menu-pkg-card .pkg-addon-options{display:flex;flex-wrap:wrap;gap:.4rem;}
  .pkg-addon-option{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .6rem;border:1px solid #1b1f22;border-radius:999px;background:#0a0c0f;font-size:.8rem;cursor:pointer;}
  .pkg-addon-option[data-selected="true"]{opacity:.6;}
  .pkg-addon-option input{margin:0;}
  .footnote{font-size:.8rem;color:#8ea59a}
  .crew-callout{border-radius:14px;padding:.75rem;border:1px solid #1f2a1f;background:linear-gradient(180deg,#0d130f,#080c0a);color:#dbe9df;font-size:.85rem;line-height:1.4}
  .crew-callout.alert{border-color:#3a2626;background:linear-gradient(180deg,#1b0f0f,#120909);color:#f4d6d6}
  .crew-checklist-section{display:flex;flex-direction:column;gap:.5rem}
  .crew-checklist-header{display:flex;justify-content:space-between;align-items:flex-end;gap:.75rem;flex-wrap:wrap}
  .crew-checklist-items{display:flex;flex-direction:column;gap:.5rem}
  .crew-checklist-item{display:flex;align-items:center;gap:.75rem;padding:.6rem;border:1px solid #15191c;background:#090b0d;border-radius:12px}
  .crew-checklist-item[data-complete="true"]{border-color:#1f2a1f;background:#0d1310}
  .crew-checklist-item[data-running="true"] .crew-timer{color:var(--green)}
  .crew-checklist-item input[type=checkbox]{width:18px;height:18px}
  .crew-step{flex:1}
  .crew-step .tiny{color:#99a7a7}
  .crew-timer{font-variant-numeric:tabular-nums;font-weight:700;min-width:72px;text-align:right}
  .crew-timer-controls{display:flex;align-items:center;gap:.45rem}
  .drawer {position:fixed;right:0;top:0;height:100%;width:min(92vw,420px);transform:translateX(100%);transition:transform .25s ease;background:#050607;border-left:1px solid #14171a;z-index:20;display:flex;flex-direction:column}
  .drawer.open{transform:translateX(0)}
  .job-panel{position:fixed;right:0;top:0;height:100%;width:min(96vw,520px);transform:translateX(100%);transition:transform .28s ease;background:#060708;border-left:1px solid #15191c;z-index:25;display:flex;flex-direction:column;box-shadow:-12px 0 40px rgba(0,0,0,.35)}
  .job-panel.open{transform:translateX(0)}
  .job-panel header{padding:1rem;border-bottom:1px solid #14171a;display:flex;flex-direction:column;gap:.35rem;background:linear-gradient(180deg,#080a0c,#050607)}
  .job-panel header .row{align-items:center}
  .job-panel-body{flex:1;overflow:auto;padding:1rem;display:flex;flex-direction:column;gap:1rem}
  .job-meta-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.6rem}
  .job-section{border:1px solid #15191c;background:#090b0d;border-radius:14px;padding:.85rem;display:flex;flex-direction:column;gap:.55rem}
  .job-section h4{margin:0;font-family:Oswald,'Bebas Neue',Impact,sans-serif;letter-spacing:.4px;font-size:1rem}
  .job-services{display:flex;flex-direction:column;gap:.45rem}
  .job-service{display:flex;align-items:center;gap:.5rem;background:#0a0c0f;border:1px solid #15191c;padding:.5rem .6rem;border-radius:12px}
  .job-service .service-main{flex:1}
  .job-service .service-meta{font-size:.8rem;color:#96a4a4}
  .job-timers{display:flex;flex-direction:column;gap:.5rem}
  .job-timer{display:flex;align-items:center;gap:.6rem;background:#0a0c0f;border:1px solid #15191c;padding:.5rem .6rem;border-radius:12px}
  .job-timer .timer-info{flex:1}
  .job-timer .timer-label{font-weight:800}
  .job-timer .timer-value{font-variant-numeric:tabular-nums;font-weight:800;font-size:1.05rem;color:#e4f6eb}
  .job-timer[data-running="true"] .timer-value{color:var(--green)}
  .job-timer-controls{display:flex;gap:.35rem;flex-wrap:wrap}
  .job-timer-controls .pill{cursor:pointer}
  .job-filter-active{background:linear-gradient(180deg,#102b1c,#0b1a12);color:#f2fbf7;border-color:#1f3a29;box-shadow:0 0 0 1px #173a26 inset}
  .sync-status{position:sticky;top:6.5rem;z-index:8;margin:0 0 1rem;padding:.6rem .75rem;border-radius:12px;border:1px solid #1a1e21;background:#070808;font-size:.8rem;color:#a7b0b0;display:flex;align-items:center;gap:.5rem}
  .sync-status[data-state="connected"]{border-color:#163221;background:linear-gradient(180deg,#09140d,#060d08);color:#bfe8ce}
  .sync-status[data-state="error"]{border-color:#3a1818;background:linear-gradient(180deg,#150808,#0d0505);color:#f4c5c5}
  .crm-board{display:grid;gap:.75rem;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));align-items:flex-start}
  .crm-column{display:flex;flex-direction:column;gap:.5rem;background:linear-gradient(180deg,#0d0f12,#08090c);border:1px solid #14171a;border-radius:14px;padding:.6rem}
  .crm-column-header{display:flex;justify-content:space-between;align-items:center;font-weight:800;font-size:.9rem;text-transform:uppercase;letter-spacing:.6px}
  .crm-column-badge{background:#101c14;border:1px solid #1d3224;border-radius:999px;padding:.15rem .55rem;font-size:.7rem;font-weight:700;color:#a8d7b6}
  .crm-column-body{display:flex;flex-direction:column;gap:.5rem}
  .crm-empty{font-size:.8rem;color:#6f7a7a;text-align:center;padding:.75rem 0;border:1px dashed #1a1e21;border-radius:12px;background:#060708}
  .crm-action{display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.5rem}
  .crm-action .pill,.crm-action .btn{flex:1;min-width:120px}
  .job-card.crm{border:1px solid #1a1e21;background:#0a0c0f}
  .subtabs{display:flex;flex-wrap:wrap;gap:.35rem;margin-bottom:.5rem;}
  .subtab{padding:.35rem .6rem;border-radius:999px;border:1px solid #1a1e21;background:#0a0c0f;cursor:pointer;font-size:.85rem;font-weight:700;color:#cfd6d6;}
  .subtab.active{background:linear-gradient(180deg,#102b1c,#0b1811);border-color:#1f3a29;color:#f2fbf7;}
  .marketing-metric{display:flex;justify-content:space-between;align-items:center;padding:.5rem .6rem;border:1px solid #15191c;border-radius:10px;background:#090b0d;}
  .policy-item{display:flex;align-items:center;gap:.55rem;padding:.45rem .6rem;border:1px solid #15191c;border-radius:10px;background:#0a0c0f;}
  .policy-item input{width:18px;height:18px;}
  .toc-link{display:block;padding:.45rem .5rem;border-radius:10px;border:1px solid #15191c;background:#080a0d;color:#cfd6d6;text-decoration:none;cursor:pointer;}
  .toc-link.active{border-color:#1f3a29;background:#0d1a12;color:#f2fbf7;}
  .checklist-row{display:flex;align-items:center;gap:.6rem;padding:.5rem .6rem;border:1px solid #15191c;border-radius:10px;background:#090b0d;}
  .checklist-row[data-complete="true"]{border-color:#1f2a1f;background:#0d1310;}
  .checklist-row label{flex:1;margin:0;color:#e0ece4;font-weight:600;}
  .checklist-row .tiny{margin:0;color:#a3b5b0;}
  .checklist-row button{flex:0 0 auto;}
</style>
</head>
<body>
  <div class="appbar">
    <img id="headerLogo" class="logo" alt="logo">
    <div id="headerTitle" class="title">POLISH CREW — Accounting</div>
    <div class="spacer"></div>
    <button id="openDrawer" class="iconbtn" title="More">⚙️</button>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="Dashboard">Dashboard</div>
    <div class="tab" data-tab="Quotes">Quotes</div>
    <div class="tab" data-tab="Jobs">Jobs</div>
    <div class="tab" data-tab="Clients">Clients</div>
    <div class="tab" data-tab="Marketing">Marketing</div>
    <div class="tab" data-tab="Playbook">Playbook</div>
    <div class="tab" data-tab="Checklists">Checklists</div>
    <div class="tab" data-tab="Settings">Settings</div>
  </div>

  <div class="wrap">
    <section id="Dashboard" class="tabpage">
      <div class="grid">
        <div class="card">
          <h3>Month to Date</h3>
          <div class="grid">
            <div class="card"><div class="muted">Income</div><div id="mIncome" style="font-size:1.6rem;font-weight:800">$0.00</div></div>
            <div class="card"><div class="muted">Expenses</div><div id="mExpense" style="font-size:1.6rem;font-weight:800">$0.00</div></div>
            <div class="card"><div class="muted">Net</div><div id="mNet" style="font-size:1.6rem;font-weight:800">$0.00</div></div>
          </div>
        </div>
        <div class="card">
          <h3>Quick Actions</h3>
          <div class="row">
            <button class="btn" onclick="UI.startQuoteFlow()">Start a Quote</button>
            <button class="btn" onclick="UI.openExpenseForm()">Add Expense</button>
            <button class="btn" onclick="UI.switchTab('Clients')">Add Client</button>
            <button class="btn secondary" onclick="Data.exportCSV()">Export CSV</button>
          </div>
        </div>
        <div class="card">
          <h3>Recent Activity</h3>
          <div id="recentList" class="list"></div>
        </div>
        <div class="card">
          <h3>Follow-ups Due</h3>
          <div id="followUpsList" class="list"></div>
        </div>
        <div class="card">
          <h3>Marketing Progress</h3>
          <div id="marketingProgress" class="list"></div>
        </div>
      </div>
    </section>

    <section id="Quotes" class="tabpage hidden">
      <div class="grid single-column">
        <div class="card">
          <h3>Pending Quotes</h3>
          <div class="muted tiny">Quotes stay here until you convert them into jobs or collect payment.</div>
          <div class="stack-buttons" style="margin:.75rem 0 .5rem;">
            <button class="btn fullwidth" onclick="UI.startQuoteFlow()">New Quote</button>
            <button class="btn secondary fullwidth" onclick="UI.printQuotesSummary()">Print All Quotes</button>
          </div>
          <div id="quotesList" class="list"></div>
        </div>
      </div>
    </section>

    <section id="Jobs" class="tabpage hidden">
      <div class="grid">
        <div class="card" style="grid-column:1 / -1;">
          <h3>Job Board</h3>
          <div class="row" style="flex-wrap:wrap;gap:.5rem;align-items:center;">
            <div class="row" style="gap:.4rem;flex-wrap:wrap;">
              <button class="pill" data-filter="all" onclick="UI.setJobFilter('all')">All</button>
              <button class="pill" data-filter="today" onclick="UI.setJobFilter('today')">Today</button>
              <button class="pill" data-filter="upcoming" onclick="UI.setJobFilter('upcoming')">Upcoming</button>
              <button class="pill" data-filter="completed" onclick="UI.setJobFilter('completed')">Completed</button>
              <button class="pill" data-filter="unpaid" onclick="UI.setJobFilter('unpaid')">Unpaid</button>
            </div>
            <div class="spacer"></div>
            <button class="btn" onclick="UI.startQuoteFlow()">Create Quote</button>
          </div>
          <div id="jobsList" class="list" style="margin-top:.75rem;"></div>
        </div>
        <div class="card">
          <h3>Schedule Planner</h3>
          <label for="jobPlannerDate">Select day</label>
          <input id="jobPlannerDate" type="date" onchange="UI.refreshJobPlanner()">
          <div id="jobPlannerList" class="list" style="margin-top:.6rem;"></div>
        </div>
        <div class="card">
          <h3>Performance Snapshot</h3>
          <div id="jobPerformance" class="list" style="gap:.35rem;"></div>
          <div class="footnote" style="margin-top:.6rem;">Completed job durations help track crew efficiency and plan future ETAs.</div>
        </div>
      </div>
    </section>

    <section id="QuoteBuilder" class="tabpage hidden">
      <div class="grid">
        <div class="card">
          <h3>Quote → Book → Pay</h3>
          <div class="row">
            <div><label>Client</label><select id="jobClient"></select></div>
            <div style="flex:0"><label>&nbsp;</label><button class="btn" onclick="UI.showQuickClient()">Quick Add Client</button></div>
          </div>

          <div class="row" style="margin-top:.6rem;flex-wrap:wrap;gap:.75rem;">
            <div style="flex:1;min-width:160px;">
              <label>Date</label>
              <input id="jobDate" type="date">
            </div>
            <div style="flex:1;min-width:140px;">
              <label>Start Time</label>
              <input id="jobStart" type="time">
            </div>
            <div style="flex:1;min-width:140px;">
              <label>End Time</label>
              <input id="jobEnd" type="time">
            </div>
            <div style="flex:1;min-width:140px;">
              <label>Estimated Duration</label>
              <input id="jobDuration" placeholder="1h 45m">
            </div>
          </div>

          <div id="quickClient" class="card hidden" style="margin:.5rem 0;">
            <div class="row"><div><label>Name *</label><input id="qcName"></div><div><label>Phone</label><input id="qcPhone"></div></div>
            <label>Email</label><input id="qcEmail" type="email" placeholder="client@domain.com">
            <div class="row"><div>
              <label>Default Discount</label>
              <div class="row">
                <select id="qcDiscType"><option value="none">None</option><option value="%">%</option><option value="$">$</option></select>
                <input id="qcDiscValue" type="number" min="0" step="1" placeholder="0">
              </div>
            </div><div><label>Notes</label><input id="qcNotes"></div></div>
            <div class="row"><button class="btn" onclick="App.addQuickClient()">Save Client</button><button class="btn secondary" onclick="UI.hideQuickClient()">Cancel</button></div>
          </div>

            <div class="card" style="margin-top:.6rem;">
              <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:.4rem;gap:.5rem;flex-wrap:wrap;">
                <h3 style="margin:.25rem 0;">Vehicles</h3>
                <div class="row" style="gap:.5rem;flex-wrap:wrap;justify-content:flex-end;">
                  <button class="btn secondary" onclick="UI.openCustomBuilder()">Edit Packages</button>
                <button class="btn secondary" onclick="UI.addVehicle()">Add Vehicle</button>
              </div>
            </div>
            <div id="vehiclesList" class="list"></div>
            <div id="addonSummary" class="crew-callout" style="margin-top:.5rem;">
              <div style="font-weight:800;">Add-on guidance</div>
              <div class="tiny">Select packages and add-ons to see maintenance vs. full detail recommendations.</div>
            </div>
            <div class="footnote">≤3 add-ons = Maintenance. 4+ or heavy soil → Full Detail upgrade.</div>
          </div>

          <div class="row" style="margin-top:.6rem;align-items:flex-start;gap:1rem;">
            <div style="flex:1;">
              <label>Discount</label>
              <div class="row">
                <select id="jobDiscType"><option value="none">None</option><option value="%">%</option><option value="$">$</option></select>
                <input id="jobDiscValue" type="number" min="0" step="1" value="0">
              </div>
              <div class="row" style="gap:.5rem;margin-top:.4rem;">
                <button class="pill" onclick="UI.quickDisc('$',10)">$10</button>
                <button class="pill" onclick="UI.quickDisc('$',20)">$20</button>
                <button class="pill" onclick="UI.quickDisc('%',10)">10%</button>
                <button class="pill" onclick="UI.quickDisc('%',15)">F&amp;F 15%</button>
              </div>
              <div class="row" style="gap:.5rem;margin-top:.4rem;align-items:center;">
                <div class="tiny" style="flex:0 0 auto;color:#aab5b5;">Apply</div>
                <select id="jobDiscScope" style="flex:1;">
                  <option value="job">Once per job</option>
                  <option value="vehicle">Per vehicle</option>
                </select>
              </div>
              <div class="tiny" style="margin-top:.25rem;">Per-vehicle discounts are applied to each vehicle individually.</div>
            </div>
            <div style="flex:1;"><label>Notes</label><textarea id="jobNotes" placeholder="Any special conditions, soil level, etc."></textarea></div>
          </div>

          <div class="grid">
            <div class="card"><div class="muted">Subtotal</div><div id="jobSubtotal" style="font-size:1.4rem;font-weight:800">$0.00</div></div>
            <div class="card"><div class="muted">Discount</div><div id="jobDiscount" style="font-size:1.4rem;font-weight:800">$0.00</div></div>
            <div class="card"><div class="muted">Total</div><div id="jobTotal" style="font-size:1.4rem;font-weight:800">$0.00</div></div>
          </div>

          <div class="stack-buttons">
            <button id="quoteSaveBtn" class="btn fullwidth" onclick="App.saveJob({asQuote:true})">Save Quote</button>
            <button id="jobSaveBtn" class="btn fullwidth" onclick="App.saveJob({asQuote:false})">Schedule Job</button>
            <button class="btn secondary fullwidth" onclick="UI.printQuote()">Print / Save Quote</button>
            <button id="jobEditCancel" class="btn secondary fullwidth hidden" type="button" onclick="UI.cancelJobEdit()">Cancel Edit</button>
          </div>
        </div>
      </div>
    </section>

    <section id="Clients" class="tabpage hidden">
      <div class="grid">
        <div class="card">
          <h3>Add Client</h3>
          <div class="row"><div><label>Name *</label><input id="cName"></div><div><label>Phone</label><input id="cPhone"></div></div>
          <label>Email</label><input id="cEmail" type="email" placeholder="client@domain.com">
          <label>City</label><input id="cCity" placeholder="Client city">
          <label>Notes</label><input id="cNotes">
          <label>Loyalty Tier</label>
          <select id="cLoyalty">
            <option value="new">New</option>
            <option value="repeat">Repeat</option>
            <option value="vip">VIP</option>
          </select>
          <div class="row">
            <div>
              <label>Default Discount</label>
              <div class="row">
                <select id="cDiscType"><option value="none">None</option><option value="%">%</option><option value="$">$</option></select>
                <input id="cDiscValue" type="number" min="0" step="1" value="0">
              </div>
            </div>
            <div class="row" style="align-items:flex-end;"><button class="btn" onclick="App.addClient()">Save Client</button></div>
          </div>
        </div>
        <div class="card">
          <h3>Client Directory</h3>
          <div id="clientsList" class="list"></div>
        </div>
        <div class="card" style="grid-column:1 / -1;">
          <h3>Pipeline</h3>
          <div class="tiny" style="margin-bottom:.6rem;">Tap a record to update stage and view details.</div>
          <div id="crmBoard" class="crm-board"></div>
        </div>
        <div class="card">
          <h3>Upcoming Appointments</h3>
          <div id="crmAppointments" class="list" style="gap:.5rem;"></div>
        </div>
        <div class="card">
          <h3>Payments</h3>
          <div class="tiny">Deposits and balances captured via Stripe are mirrored here.</div>
          <div id="crmPayments" class="list" style="gap:.5rem;margin-top:.5rem;"></div>
        </div>
      </div>
    </section>

    <section id="Marketing" class="tabpage hidden">
      <div class="card">
        <h3>Marketing & Campaigns</h3>
        <div class="row" id="marketingTabs" style="gap:.4rem;flex-wrap:wrap;margin-bottom:.5rem;"></div>
        <div id="marketingContent" class="list" style="gap:.75rem;"></div>
      </div>
    </section>

    <section id="Playbook" class="tabpage hidden">
      <div class="grid single-column">
        <div class="card">
          <h3>Operations & Marketing Playbook</h3>
          <div class="tiny">Search, edit, and export the 2025 playbook. Use copy buttons to drop sections into scripts.</div>
          <div class="row" style="gap:.5rem;margin:.5rem 0;flex-wrap:wrap;">
            <input id="playbookSearch" placeholder="Search playbook" oninput="UI.filterPlaybook()">
            <button class="btn" onclick="UI.exportPlaybook()">Export PDF</button>
            <button class="btn secondary" onclick="UI.resetPlaybook()">Reset to Default</button>
          </div>
          <div class="row" style="align-items:flex-start;gap:1rem;flex-wrap:wrap;">
            <div style="flex:1;min-width:240px;">
              <label>Table of Contents</label>
              <div id="playbookToc" class="list" style="max-height:320px;overflow:auto;"></div>
            </div>
            <div style="flex:2;min-width:320px;display:flex;flex-direction:column;gap:.5rem;">
              <label for="playbookEditor">Editable Markdown</label>
              <textarea id="playbookEditor" style="min-height:280px;" oninput="UI.updatePlaybookPreview()"></textarea>
              <label>Preview</label>
              <div id="playbookPreview" style="border:1px solid #15191c;border-radius:12px;padding:.75rem;max-height:360px;overflow:auto;background:#080a0d;"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="Checklists" class="tabpage hidden">
      <div class="grid single-column">
        <div class="card">
          <h3>Daily Discipline</h3>
          <div id="dailyChecklist" class="list" style="gap:.45rem;"></div>
        </div>
        <div class="card">
          <h3>Weekly Rhythm</h3>
          <div id="weeklyChecklist" class="list" style="gap:.45rem;"></div>
        </div>
        <div class="card">
          <h3>Custom Checklist Builder</h3>
          <div class="tiny">Add crew SOPs, marketing pushes, or seasonal reminders.</div>
          <div class="row" style="gap:.5rem;margin:.5rem 0;flex-wrap:wrap;">
            <input id="customChecklistName" placeholder="Task name">
            <select id="customChecklistCadence">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
            </select>
            <button class="btn" onclick="App.addCustomChecklistTask()">Add Task</button>
          </div>
          <div id="customChecklist" class="list" style="gap:.45rem;"></div>
        </div>
      </div>
    </section>

    <section id="Settings" class="tabpage hidden">
      <div class="grid single-column">
        <div class="card">
          <h3>Brand Settings</h3>
          <div class="row" style="gap:.5rem;flex-wrap:wrap;">
            <div style="flex:1;min-width:200px;">
              <label>Business Name</label>
              <input id="settingsBusiness" placeholder="Polish Crew">
            </div>
            <div style="flex:1;min-width:200px;">
              <label>Dashboard Title</label>
              <input id="settingsHeader" placeholder="POLISH CREW — Accounting">
            </div>
          </div>
          <div class="row" style="gap:.5rem;margin-top:.5rem;flex-wrap:wrap;">
            <div style="flex:1;min-width:200px;">
              <label>City</label>
              <input id="settingsCity" placeholder="Service city">
            </div>
          </div>
          <div class="row" style="gap:.5rem;margin-top:.5rem;flex-wrap:wrap;">
            <button class="btn" onclick="UI.pickLogo()">Upload Logo</button>
            <button class="btn secondary" onclick="UI.clearLogo()">Remove Logo</button>
          </div>
          <div class="tiny" style="margin-top:.5rem;">Swap icon-192.png / icon-512.png for updated install icons.</div>
        </div>
        <div class="card">
          <h3>Brand Rules & Crew Policies</h3>
          <div id="brandPolicies" class="list" style="gap:.4rem;"></div>
        </div>
        <div class="card">
          <h3>Sync & Backups</h3>
          <div class="tiny">Enable optional Supabase sync for cross-device updates.</div>
          <label class="row" style="gap:.5rem;align-items:center;">
            <input type="checkbox" id="syncToggle" onchange="App.toggleCloudSync(this.checked)">
            <span>Supabase Sync</span>
          </label>
          <div id="syncStatus" class="sync-status" data-state="idle">Supabase sync idle. Configure keys in pc-config.</div>
          <button class="btn secondary" onclick="App.requestBackup()">Request Manual Backup</button>
        </div>
      </div>
    </section>
  </div>

  <div id="drawer" class="drawer">
    <header style="padding:1rem;border-bottom:1px solid #14171a;display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:800;">More</div>
      <button class="iconbtn" onclick="UI.toggleDrawer(false)">✖</button>
    </header>
    <div class="content" style="padding:1rem;display:flex;flex-direction:column;gap:.6rem;overflow:auto;">
      <div class="tiny">Operations</div>
      <div class="list">
        <div class="list-item" onclick="UI.openMenuEditor()">Menu Editor ›</div>
      </div>
      <div class="tiny">Records</div>
      <div class="list">
        <div class="list-item" onclick="UI.openMileage()">Mileage ›</div>
        <div class="list-item" onclick="UI.openTransactions()">Transactions ›</div>
        <div class="list-item" onclick="UI.openExpenses()">Expenses ›</div>
      </div>
      <div class="tiny">Data</div>
      <div class="list">
        <div class="list-item" onclick="Data.exportJSON()">Export JSON ›</div>
        <div class="list-item" onclick="UI.openImport()">Import JSON ›</div>
      </div>
      <div class="tiny">App</div>
      <div class="list">
        <div class="list-item" onclick="UI.openScripts()">Scripts & Templates ›</div>
        <div class="list-item" onclick="UI.openSettings()">Settings ›</div>
        <div class="list-item" onclick="UI.openPolicies()">Brand Policies ›</div>
      </div>
      <div class="footnote">Build cache: <b>pcwa-v3.1.0</b></div>
    </div>
  </div>

  <div id="jobPanel" class="job-panel">
    <header>
      <div class="row" style="justify-content:space-between;gap:.5rem;">
        <div id="jobPanelTitle" style="font-weight:800;font-size:1.1rem;">Job Details</div>
        <button class="iconbtn" onclick="UI.closeJobPanel()">✖</button>
      </div>
      <div id="jobPanelSubtitle" class="tiny" style="color:#9fb2ae;"></div>
    </header>
    <div id="jobPanelBody" class="job-panel-body"></div>
  </div>

  <div id="modalHost"></div>

<script>
const SupabaseSync = window.SupabaseBridge || null;
const CACHE_VERSION = 'pcwa-v3.1.0';
const DEFAULT_SIZES = ["Coupe","Sedan","Crossover","SUV/Truck","XL/Lifted"];
const DEFAULT_POLICIES = [
  {id:'policy-photos', label:'Before/After photo requirement', description:'Capture and upload every job for marketing and QA.', active:true},
  {id:'policy-honesty', label:'Never overpromise', description:'Set expectations clearly. Explain limits with confidence.', active:true},
  {id:'policy-weather', label:'Weather reschedule rule', description:'Safety first — lightning, high winds, or freezing temps allow reschedule.', active:true},
  {id:'policy-shampoo', label:'Manual shampoo only', description:'No automated carpet extractors without inspection — protect interiors.', active:true},
  {id:'policy-presentation', label:'Professional presentation', description:'Uniform, branded mats, and tidy van before arriving.', active:true},
  {id:'policy-consistency', label:'Consistency over perfection', description:'Stick to the playbook. Document deviations in job notes.', active:true}
];
const DEFAULT_DAILY_CHECKLIST = [
  {id:'daily-story', label:'Publish Story / Reel', note:'Post a behind-the-scenes clip or before/after.', cadence:'daily'},
  {id:'daily-leads', label:'Add new leads to CRM', note:'Every inbound message logged the same day.', cadence:'daily'},
  {id:'daily-groups', label:'Post in neighborhood groups', note:'Keep the Polish Crew name in rotation.', cadence:'daily'},
  {id:'daily-dm', label:'DM 5 prospects or past clients', note:'Personal touch every day builds pipeline.', cadence:'daily'},
  {id:'daily-photo', label:'Upload one photo to gallery', note:'Fuel future marketing assets.', cadence:'daily'}
];
const DEFAULT_WEEKLY_CHECKLIST = [
  {id:'weekly-flyers', label:'Drop 10 flyers locally', note:'Rotate hot zip codes every week.', cadence:'weekly'},
  {id:'weekly-reviews', label:'Request 3 reviews', note:'Use the script and send links same-day.', cadence:'weekly'},
  {id:'weekly-content', label:'Publish 5 before/after posts', note:'Batch content Sundays if needed.', cadence:'weekly'},
  {id:'weekly-crm', label:'Update CRM statuses', note:'Move quotes, log payments, close loops.', cadence:'weekly'}
];
const DEFAULT_SCRIPTS = {
  inquiry:"Hey [Name]! Appreciate you reaching out. We’re the Polish Crew — mobile, insured, and obsessed with the details. What are we working on?",
  qualification:"Awesome. What’s the year/make/model and when did you last have it detailed? Any pet hair, stains, or special requests?",
  quote:"Based on what you shared, I recommend our [Package] for [Vehicle]. It lands at $[PackagePrice] and includes [Highlights].",
  booking:"Let’s lock your spot. We have openings [TimeWindow]. I’ll send a quick confirmation with prep tips — sound good?",
  arrival:"Polish Crew on site! We’re pulling up now. We’ll walk the vehicle with you to confirm priorities before we start.",
  afterJob:"Your ride is looking dialed in. Quick walk-through? We’ll highlight care tips and next service timing.",
  follow24:"24-hour check-in — how’s everything looking? If you spot anything at all, we’ll make it right.",
  follow7:"Hope you’re loving the detail! Would you mind sharing a review? Here’s the link: [ReviewLink]. Appreciate you!",
  follow30:"It’s been about a month — ready for a freshen up? Maintenance spots go quick; want me to hold one?",
  review:"Mind dropping a 5-star review? It helps a ton and keeps the crew rolling. [ReviewLink]",
  referral:"Know anyone who needs a reset? We send $20 credits for every referral that books. Just reply with a name!",
  maintenance:"Stay on the maintenance plan and we’ll keep that showroom look locked in. Let’s schedule your next visit."
};
const DEFAULT_PLAYBOOK = `POLISH CREW — OPERATIONS & MARKETING PLAYBOOK (2025)

We Bring the Shine

Polish Crew exists to make every driveway, workplace, and fleet stall look and feel like a professional showroom. This Playbook is the single source of truth for how we operate, communicate, and scale in 2025. Every crew member must understand the systems inside—quotes, jobs, marketing, and financial accountability. Every process in this book is field-tested and aligned with the Polish Crew identity: dependable, premium, and relentlessly consistent.

---

SECTION 1 — BRAND STANDARD

Mission: Deliver a professional detail with zero hassle for the client.
Promise: We show up prepared, on time, and finish with a spotless exit.
Tone: Confident, calm, and helpful. We do not oversell or pressure; we educate and recommend.
Visual Identity: Black base, Polish Crew green accents (#00A651), sharp sans-serif typography, bold iconography.

Non-Negotiables:
• Never overpromise. If conditions change, communicate immediately.
• Before/after photos on every job (minimum 3 angles).
• Crew uniforms clean, tucked, and branded.
• Weather reschedule rule: lightning or freezing temps trigger proactive outreach.
• Safety first—cone off work zone, secure cords and hoses.

Brand Voice Guide:
• “We bring the shine to you.”
• Focus on benefits: time savings, protection, pride of ownership.
• Avoid jargon; explain detailing steps clearly.

---

SECTION 2 — SERVICE MENU & PACKAGES

Vehicle Size Tiers: Coupe, Sedan, Crossover, SUV/Truck, XL/Lifted.
Core Packages:
1. Exterior Wash Only – Hand wash, foam bath, wheel faces, tire dressing, streak-free glass.
2. Interior Clean Only – Vacuum, wipe, dust, crevices, glass, mat scrub.
3. In & Out Combo – Full wash and interior reset with dressed tires.
4. Quick In & Out – Express 60-minute refresh for repeat clients.
5. Maintenance Detail – Deep interior + exterior decon for loyal clients.
6. Full Detail – Full reset with decon, sealant, interior shampoo.
7. Dog Hair / Stain Focus – Targeted remediation for problem areas.

Add-On Catalog (pair with packages as needed):
• Wheels & Tires Deep Clean
• Exterior Brush Detail
• Interior Brush Detail
• Interior Protectant
• Dog Hair Removal
• Spot Stain Clean
• Odor Neutralizer
• Engine Bay Clean
• Trim Restore
• Spray Wax
• Paste Wax
• Spray Sealant
• Spray Ceramic
• Clay & Iron Decon

Upgrade Logic:
• If three or fewer add-ons, label job “Maintenance.”
• If four or more add-ons or heavy soil flagged, suggest Full Detail upgrade.
• Offer Ceramic/Sealant upsells whenever protection expires (6–12 month cadence).

---

SECTION 3 — SALES FLOW (LEAD ➝ BOOKING)

Stage Map: Inquiry → Qualification → Quote → Booking → Job → Payment → Follow-Up.

Workflow:
1. Respond to new inquiries within 10 minutes using Inquiry Script.
2. Collect Name, City, Vehicle, Pain Points, Timeline, Budget indicator.
3. Use Qualification Script to recommend a base package and set expectations.
4. Build quote in app: select package, size, add-ons, loyalty discount.
5. Send quote message with CTA (“Ready to lock in Tuesday at 9am?”).
6. Upon acceptance, convert to job, assign crew, set reminders.
7. Collect deposit if required. Confirm address and access details.

Response Standards:
• SMS template for speed, DM template for social replies.
• Include link to booking page if client prefers self-service.
• Track every lead in CRM with status tags.

---

SECTION 4 — OPERATIONS & JOB EXECUTION

Preparation Checklist:
• Load foam cannon, soaps, interior kit, brushes, extractor.
• Confirm water/power access plan.
• Review client notes, preferences, and loyalty perks.

On-Site Flow:
1. Arrival Script at the door or via text if client remote.
2. Walk vehicle, document pre-existing damage in app.
3. Start Setup Timer when staging gear.
4. Follow package checklist step by step (Setup → Base → Add-ons).
5. Capture before photos before touching the vehicle.
6. During Base Services, run timers for accountability.
7. Log add-on steps and mark checklist tasks complete.
8. Take after photos, confirm satisfaction with client.
9. Collect payment: card reader, stored card, or invoice within 1 hour.

Quality Standards:
• Glass: streak-free, edges wiped.
• Interior: vents brushed, mats dressed, crevices vacuumed.
• Exterior: no soap residue, tires dressed evenly, jambs wiped.
• Fragrance: neutral to light citrus.

---

SECTION 5 — CUSTOMER EXPERIENCE & LOYALTY

Client Profile Data Points:
• Name, Phone, Email, City.
• Vehicle details and notes.
• Preferred contact channel (SMS vs Email).
• Loyalty Tier: New, Repeat, VIP.
• Default discount (VIP gets automatic 10%).

Follow-Up Cadence:
• 24 hours: Send gratitude + review ask.
• 7 days: Share maintenance tips, request referral.
• 30 days: Offer maintenance rebook (loyalty pricing).
• Birthday month: Send Birthday Offer script.

Retention Moves:
• Track lifetime spend and job history.
• Flag clients with >3 jobs as VIP.
• Send seasonal reminders (Spring refresh, Winter salt protection).
• Reward referrals with $25 credit or add-on upgrade.

---

SECTION 6 — MARKETING ENGINE

Guerrilla Plan (90-Day Sprint):
Month 1: Presence
• Daily: Post a story/reel, DM 5 prospects, add leads to CRM.
• Weekly: Drop 10 flyers, collect 3 reviews, upload 5 before/after sets.
Month 2: Authority
• Partner with local businesses (gyms, coffee shops).
• Share client testimonials and behind-the-scenes content.
• Run referral contest with leaderboard.
Month 3: Expansion
• Launch neighborhood campaign (Nextdoor, Facebook groups).
• Test paid boost for top-performing reel.
• Host pop-up wash day with partner.

Paid Ads Framework:
• Campaign brief: objective, budget/day, geography, creative angle.
• Track CPM, CPC, cost per booked job, ROI target 3×.
• Weekly review: pause underperformers, scale winners.
• Retarget website visitors with maintenance offer.

Marketing Log:
• Every activity logged same day: reels posted, flyers placed, review asks sent.
• Daily summary auto-calculates streak. Keep momentum above 80% completion.

---

SECTION 7 — CONTENT & SCRIPTS

Core Script Library (all housed in app):
1. Inquiry Script — greet, qualify, set hook.
2. Qualification Script — discover needs, present package.
3. Quote Script — share pricing, outline value, CTA.
4. Booking Script — confirm date, deposit, expectations.
5. Arrival Script — friendly check-in, review work order.
6. After Job Script — recap services, remind of next steps.
7. Follow-Up Series — 24h, 7d, 30d messages.
8. Review Ask — personalized thank-you + review link.
9. Referral Script — request introduction and reward.
10. Maintenance Reminder — seasonal prompts.
11. Birthday Offer — celebratory discount or add-on.

Template Guidelines:
• Use [Name], [Vehicle], [Package], [City] placeholders.
• Include specific results (“Your Model Y now has ceramic protection good for 12 months.”).
• Close with clear CTA (“Reply YES to confirm,” “Tap link to schedule maintenance.”).

---

SECTION 8 — FINANCE & METRICS

Trackers in App:
• Income, Expenses, Net Profit (Month-to-Date, Quarter-to-Date).
• Job profitability per package (base vs add-ons vs labor time).
• Marketing ROI meter with green zone at 3×.

Accounting Best Practices:
• Log every transaction same day (income, expenses, mileage).
• Capture receipt photos immediately.
• Reconcile deposits vs completed jobs weekly.
• Exclude deleted records from exports to maintain clean books.

Key KPIs:
• Average Ticket: target $185+.
• Close Rate: aim for 70% of quoted leads.
• Repeat Rate: 45% of monthly jobs from existing clients.
• Review Velocity: minimum 10 new reviews per month.

---

SECTION 9 — SYSTEMS & TECHNOLOGY

Offline-First Stack:
• App caches locally; data accessible without signal.
• Supabase sync optional—enable for live backups and multi-device coordination.
• Cache version PCWA-v3.1.0 or newer for 2025 release.

Data Hygiene:
• Maintain accurate job dates/times for reminders.
• Verify client records before merging duplicates.
• Use Export > JSON for monthly archive.

Security:
• Limit Supabase keys to least privilege.
• Update passwords quarterly.
• Lost device? Trigger remote logout by toggling sync off/on.

---

SECTION 10 — TEAM & CULTURE

Crew Expectations:
• Show up 15 minutes early to HQ or first appointment.
• Daily huddle covers jobs, upsell targets, marketing tasks.
• Weekly recap meeting reviews numbers, wins, lessons.

Training Cadence:
• Onboarding: 2 ride-alongs, product knowledge test, script practice.
• Monthly skill focus: extraction, ceramic application, paint correction basics.
• Marketing lab once a month—shoot content, edit reels, plan campaigns.

Recognition:
• “Shine Champion” badge for top reviews.
• “Closer of the Month” for highest conversion.
• Quarterly bonus tied to revenue + review goals.

Support Resources:
• Playbook tab for SOPs and scripts.
• Checklist tab for daily/weekly accountability.
• Settings tab for brand policies and quick reference.

---

APPENDIX A — DAILY CHECKLIST

1. Gear loaded and inspected.
2. Battery packs charged.
3. Towels counted (minimum 30 microfiber per crew).
4. Chemicals restocked.
5. CRM updated with previous day’s notes.
6. Marketing tasks assigned.

APPENDIX B — WEEKLY CHECKLIST

1. Deep clean van and restock.
2. Sharpen blades, wash mitts, applicators.
3. Audit open quotes and send follow-ups.
4. Review expenses, upload missing receipts.
5. Publish long-form post (blog, LinkedIn, newsletter).

APPENDIX C — EMERGENCY PROTOCOLS

• Weather Delay: notify clients 2 hours in advance with reschedule options.
• Equipment Failure: switch to backup kit, log maintenance request.
• Injury: administer first aid, contact supervisor, document incident.
• Vehicle Damage: pause work, inform client immediately, capture photos, notify insurance liaison.

APPENDIX D — GLOSSARY

• “Maintenance Detail” — recurring service for loyal clients, 90-minute target.
• “Full Reset” — full detail with decon and protection upgrade.
• “Protection Boost” — ceramic or sealant enhancement between full corrections.
• “Marketing Momentum” — streak metric tracking how many daily marketing tasks completed.
• “Supabase Sync” — optional cloud sync for multi-device operations.

APPENDIX E — YEARLY GOALS

Revenue: $480k gross.
Average Ticket: $210.
New Reviews: 120.
Referral Share: 35% of new clients.
Crew Growth: Add 2 mobile teams by Q4.

Quarterly Themes:
Q1 — Systemize: refine CRM, dial in scripts, clean data.
Q2 — Scale: increase ad spend, partner with luxury communities.
Q3 — Retain: loyalty promos, VIP appreciation events.
Q4 — Optimize: analyze margins, plan 2026 service upgrades.

---

We Close Strong

Every interaction should leave the client confident they chose the pros. Review this Playbook weekly. Update the app when you learn something new in the field. Share wins, learnings, and opportunities with the crew.

POLISH CREW — Clean. Polish. Protect.`;
const DEFAULT_MARKETING = {
  guerrilla:[
    {id:'month-1', label:'Month 1', tasks:[
      {id:'m1-story', label:'Daily Story/Reel', target:30, completed:0},
      {id:'m1-groups', label:'Post in 4 local groups weekly', target:16, completed:0},
      {id:'m1-flyers', label:'Hand out 40 flyers', target:40, completed:0}
    ]},
    {id:'month-2', label:'Month 2', tasks:[
      {id:'m2-reviews', label:'Gather 12 new reviews', target:12, completed:0},
      {id:'m2-referrals', label:'Book 6 referral jobs', target:6, completed:0},
      {id:'m2-alliances', label:'Meet 4 local partners', target:4, completed:0}
    ]},
    {id:'month-3', label:'Month 3', tasks:[
      {id:'m3-campaigns', label:'Run 3 paid ad tests', target:3, completed:0},
      {id:'m3-content', label:'Film 10 hero clips', target:10, completed:0},
      {id:'m3-email', label:'Send 4 nurture emails', target:4, completed:0}
    ]}
  ],
  campaigns:[],
  log:[],
  reviews:[],
  leaderboard:[],
  streak:{count:0,lastActivity:null}
};
const DEFAULT_MARKETING_LOG_TYPES = ['Reel','Flyers','Review','Post','DMs'];
const DEFAULT_CHECKLISTS = {
  daily: DEFAULT_DAILY_CHECKLIST.map(task=>({ ...task, completedOn:'' })),
  weekly: DEFAULT_WEEKLY_CHECKLIST.map(task=>({ ...task, completedOn:'' })),
  custom: [],
  lastDailyReset: '',
  lastWeeklyReset: ''
};
const DEFAULT_REMINDERS = [];
const DEFAULT_APPOINTMENTS = [];
const DEFAULT_MENU = {
  sizes: DEFAULT_SIZES,
  packages: {
    "Exterior Wash Only": [40,45,50,55,65],
    "Interior Clean Only": [45,50,55,60,70],
    "In & Out Combo": [70,75,85,95,110],
    "Quick In & Out": [65,70,80,90,100],
    "Maintenance Detail": [100,110,120,130,145],
    "Full Detail": [125,140,155,175,200],
    "Dog Hair / Stain Focus": [100,110,120,130,150]
  },
  addons: {
    "Wheels & Tires — Deep clean wheels, barrels, tires + gloss dressing": [10,12,15,18,20],
    "Exterior Brush Detail — Emblems, trim, grilles, window seals": [15,18,20,22,25],
    "Interior Brush Detail — Vents, seams, cupholders, buttons": [15,18,20,22,25],
    "Interior Protectant — UV / fade protection on plastics & vinyl": [10,12,15,18,20],
    "Dog Hair Removal — Light–heavy removal using rubber brush + vac": [30,60,80,100,130],
    "Spot Stain Clean — 1–3 seat or carpet stains treated": [25,30,35,40,50],
    "Odor Neutralizer — Deodorizing mist or fog": [25,28,30,32,35],
    "Engine Bay Clean — Degrease → rinse → dress plastics": [40,45,50,55,60],
    "Trim Restore — Restores faded black plastics / rubber": [25,28,30,32,35],
    "Spray Wax — Adds short-term gloss & slickness": [10,12,15,20,25],
    "Paste Wax — Warmer shine & 1–3 mo. protection": [20,25,28,32,35],
    "Spray Sealant — Hydrophobic layer (3–6 mo. protection)": [30,35,38,42,45],
    "Spray Ceramic — Strong hydrophobic & 6–12 mo. durability": [40,45,50,52,55],
    "Clay & Iron Decon — Removes bonded contaminants before protection": [45,50,55,60,65]
  },
  guidance: "Add ≤3 add-ons → stays at Maintenance Detail. 4+ or heavy soil → upgrade to Full Detail.",
  packageMeta: {
    "Exterior Wash Only": {lock:false, includedAddons:[], description:"Hand wash, foam bath, wheel faces, tire dressing, and streak-free glass."},
    "Interior Clean Only": {lock:false, includedAddons:[], description:"Vacuum interior, wipe plastics, clean glass, and refresh touch points."},
    "In & Out Combo": {lock:false, includedAddons:[], description:"Our balanced interior & exterior refresh with wash, vacuum, wipe-down, and glass."},
    "Quick In & Out": {lock:false, includedAddons:[], description:"Express spruce up for maintenance customers needing a fast touch-up."},
    "Maintenance Detail": {lock:false, includedAddons:[
      "Wheels & Tires — Deep clean wheels, barrels, tires + gloss dressing",
      "Exterior Brush Detail — Emblems, trim, grilles, window seals",
      "Interior Brush Detail — Vents, seams, cupholders, buttons",
      "Interior Protectant — UV / fade protection on plastics & vinyl",
      "Spray Sealant — Hydrophobic layer (3–6 mo. protection)",
      "Spot Stain Clean — 1–3 seat or carpet stains treated"
    ], description:"Full maintenance service with high-touch interior and exterior detailing essentials."},
    "Full Detail": {lock:false, includedAddons:[
      "Wheels & Tires — Deep clean wheels, barrels, tires + gloss dressing",
      "Exterior Brush Detail — Emblems, trim, grilles, window seals",
      "Interior Brush Detail — Vents, seams, cupholders, buttons",
      "Interior Protectant — UV / fade protection on plastics & vinyl",
      "Spray Sealant — Hydrophobic layer (3–6 mo. protection)",
      "Spot Stain Clean — 1–3 seat or carpet stains treated",
      "Dog Hair Removal — Light–heavy removal using rubber brush + vac",
      "Odor Neutralizer — Deodorizing mist or fog",
      "Clay & Iron Decon — Removes bonded contaminants before protection"
    ], description:"Comprehensive reset for vehicles needing the works plus odor & contamination removal."},
    "Dog Hair / Stain Focus": {lock:false, includedAddons:[
      "Dog Hair Removal — Light–heavy removal using rubber brush + vac",
      "Spot Stain Clean — 1–3 seat or carpet stains treated",
      "Odor Neutralizer — Deodorizing mist or fog"
    ], description:"Targeted interior overhaul to tackle embedded hair, stains, and lingering odors."}
  }
};

const DEFAULT_SETTINGS = {
  paymentMethods: ["Cash","Card","Zelle","Venmo","CashApp","Bank"],
  categories: ["Package","Add-on","Supplies","Fuel","Tools/Equipment","Marketing","Labor/Subcontract","Fees","Other"],
  syncEnabled: false,
  lastBackupPrompt: ''
};

const DEFAULT_BIZ = { name:"Polish Crew", headerTitle:"POLISH CREW — Accounting", logoDataUrl:"", city:"" };

const CREW_CHECKLIST_SECTIONS = [
  {
    id: 'setup',
    title: 'Setup',
    goalMinutes: 10,
    items: [
      { id: 'setup-position', label: 'Position truck + hose for easy flow.', description: 'Stage the rig for an efficient workflow and protect the customer’s property.' },
      { id: 'setup-prep', label: 'Prep bucket system, towels, brushes, and chemicals.', description: 'Separate interior, exterior, glass, and wheel towels. Confirm correct dilution.' },
      { id: 'setup-power', label: 'Confirm power source or generator placement.', description: 'Keep exhaust safe and avoid detailing under direct sun when possible.' },
      { id: 'setup-greet', label: 'Greet customer, confirm package, spotlight special issues.', description: 'Manage expectations before touching the vehicle.' }
    ]
  },
  {
    id: 'exterior',
    title: 'Exterior Process',
    goalMinutes: 35,
    items: [
      { id: 'ext-rinse', label: 'Rinse vehicle.', description: 'Knock down loose dirt before contact wash.' },
      { id: 'ext-foam', label: 'Foam & wash top-down.', description: 'No dry wiping on paint — use lubricated mitts and detailer.' },
      { id: 'ext-wheels', label: 'Clean wheels & tires.', description: 'Use dedicated brushes and towels for wheels.' },
      { id: 'ext-final-rinse', label: 'Final rinse.', description: 'Check seams and badges for soap runoff.' },
      { id: 'ext-dry', label: 'Dry with microfiber + blower.', description: 'Keep towels clean and avoid dragging on paint.' },
      { id: 'ext-upsell', label: 'Offer Spray Wax / Sealant / Ceramic upsell.', description: 'Upsell once exterior is clean and dry for added protection.' },
      { id: 'ext-glass', label: 'Tire shine + exterior glass.', description: 'Dress tires (not pedals) and finish glass streak-free.' }
    ]
  },
  {
    id: 'interior',
    title: 'Interior Process',
    goalMinutes: 45,
    items: [
      { id: 'int-trash', label: 'Remove trash & mats.', description: 'Keep customer belongings organized.' },
      { id: 'int-vacuum', label: 'Vacuum rear to front.', description: 'Address pet hair or heavy soil with proper tools.' },
      { id: 'int-wipe', label: 'Wipe plastics, buttons, cupholders.', description: 'Never dress pedals or steering wheel.' },
      { id: 'int-brush', label: 'Brush seams, vents, and edges.', description: 'Use gentle detail brushes for vents and trim.' },
      { id: 'int-glass', label: 'Clean interior glass.', description: 'Use fresh towels reserved for glass only.' },
      { id: 'int-protect', label: 'Add interior protectant & scent.', description: 'Apply light, even coverage for UV protection.' },
      { id: 'int-final-check', label: 'Final interior check.', description: 'Inspect steering wheel, door jambs, and screens.' }
    ]
  },
  {
    id: 'presentation',
    title: 'Final Presentation',
    goalMinutes: 10,
    items: [
      { id: 'final-walk', label: 'Walk around with customer.', description: 'Showcase results with confident energy.' },
      { id: 'final-notes', label: 'Point out existing wear or permanent marks.', description: 'Set expectations and educate on what was corrected.' },
      { id: 'final-payment', label: 'Collect payment (Cash / Zelle / Venmo).', description: 'Use official pricing — no unapproved discounts.' },
      { id: 'final-testimonial', label: 'Request testimonial or photo.', description: 'Capture content for socials; highlight green brand accents.' }
    ]
  }
];

const AppState = {
  business: DEFAULT_BIZ,
  clients: [],
  menu: DEFAULT_MENU,
  jobs: [],
  transactions: [],
  mileage: [],
  settings: DEFAULT_SETTINGS,
  reminders: DEFAULT_REMINDERS,
  appointments: DEFAULT_APPOINTMENTS,
  marketing: DEFAULT_MARKETING,
  scripts: DEFAULT_SCRIPTS,
  playbook: DEFAULT_PLAYBOOK,
  checklists: DEFAULT_CHECKLISTS,
  policies: DEFAULT_POLICIES
};

function cloneData(obj){
  if(typeof structuredClone === 'function'){
    return structuredClone(obj);
  }
  return JSON.parse(JSON.stringify(obj));
}

const Storage = {
  key: "pc_accounting_v3",
  legacyKeys: ["pc_accounting_v2"],
  load() {
    try {
      let raw = localStorage.getItem(this.key);
      if (!raw) {
        for (const legacyKey of this.legacyKeys) {
          const legacyRaw = localStorage.getItem(legacyKey);
          if (legacyRaw) {
            raw = legacyRaw;
            try { localStorage.setItem(this.key, legacyRaw); } catch(err) { console.warn('Unable to migrate storage', err); }
            break;
          }
        }
      }
      if (!raw) return cloneData(AppState);
      const parsed = JSON.parse(raw);
      if (!parsed.settings) parsed.settings = cloneData(DEFAULT_SETTINGS);
      if (!parsed.menu) parsed.menu = cloneData(DEFAULT_MENU);
      if (!parsed.business) parsed.business = cloneData(DEFAULT_BIZ);
      if (!parsed.transactions) parsed.transactions = [];
      if (!parsed.clients) parsed.clients = [];
      if (!parsed.jobs) parsed.jobs = [];
      if (!parsed.mileage) parsed.mileage = [];
      if (!parsed.menu.packageMeta) parsed.menu.packageMeta = {};
      if (!parsed.reminders) parsed.reminders = cloneData(DEFAULT_REMINDERS);
      if (!parsed.appointments) parsed.appointments = cloneData(DEFAULT_APPOINTMENTS);
      if (!parsed.marketing) parsed.marketing = cloneData(DEFAULT_MARKETING);
      if (!parsed.scripts) parsed.scripts = cloneData(DEFAULT_SCRIPTS);
      if (typeof parsed.playbook !== 'string') parsed.playbook = DEFAULT_PLAYBOOK;
      if (!parsed.checklists) parsed.checklists = cloneData(DEFAULT_CHECKLISTS);
      if (!parsed.policies) parsed.policies = cloneData(DEFAULT_POLICIES);
      return parsed;
    } catch(e) {
      UI.bootError("Failed to load saved data: " + e.message);
      return cloneData(AppState);
    }
  },
  save(state) {
    localStorage.setItem(this.key, JSON.stringify(state));
    if (Array.isArray(this.legacyKeys)) {
      this.legacyKeys.forEach(key=>{ if(key!==this.key) localStorage.removeItem(key); });
    }
  }
};

let S = Storage.load();
ensurePackageMetaStructure();

/*** Normalization ***/
function ensurePackageMetaStructure(){
  let changed=false;
  if(!S.menu){
    S.menu={sizes:[],packages:{},addons:{},packageMeta:{}};
    changed=true;
  }
  if(!S.menu.packageMeta){
    S.menu.packageMeta={};
    changed=true;
  }
  for(const name of Object.keys(S.menu.packages||{})){
    if(!S.menu.packageMeta[name]){
      S.menu.packageMeta[name]={};
      changed=true;
    }
    const meta=S.menu.packageMeta[name];
    if(!Array.isArray(meta.includedAddons)){
      meta.includedAddons=[];
      changed=true;
    }
    if(typeof meta.description!=='string'){
      meta.description='';
      changed=true;
    }
    const lockValue=!!meta.lock;
    if(meta.lock!==lockValue){
      meta.lock=lockValue;
      changed=true;
    }
  }
  if(changed) Storage.save(S);
}

/*** Utils ***/
function uid(){ return Math.random().toString(36).slice(2,10); }
function fmt(n){ return "$"+Number(n||0).toFixed(2); }
function el(tag, attrs={}, ...children){ const e=document.createElement(tag); for(const [k,v] of Object.entries(attrs)){ if(k==='class')e.className=v; else if(k==='html') e.innerHTML=v; else if(k.startsWith('on')) e.addEventListener(k.slice(2),v); else e.setAttribute(k,v); } children.forEach(c=>e.append(c)); return e; }
function today(){ return new Date().toISOString().slice(0,10); }
function parseDurationInput(value){
  if(!value) return null;
  const raw=String(value).trim();
  if(!raw) return null;
  const colonMatch=raw.match(/^(\d+):(\d{1,2})$/);
  if(colonMatch){
    const hrs=Number(colonMatch[1]);
    const mins=Number(colonMatch[2]);
    if(!Number.isNaN(hrs) && !Number.isNaN(mins)) return hrs*60+mins;
  }
  let total=0;
  let matched=false;
  const hourMatch=raw.match(/(\d+(?:\.\d+)?)\s*h/i);
  if(hourMatch){
    total+=Math.round(parseFloat(hourMatch[1])*60);
    matched=true;
  }
  const minMatch=raw.match(/(\d+)\s*m/i);
  if(minMatch){
    total+=parseInt(minMatch[1],10);
    matched=true;
  }
  if(!matched && /^\d+(?:\.\d+)?$/.test(raw)){
    const numeric=parseFloat(raw);
    if(raw.includes('.') && numeric<=24){
      total+=Math.round(numeric*60);
    } else {
      total+=Math.round(numeric);
    }
    matched=true;
  }
  return matched && total>0 ? total : null;
}
function formatDurationMinutes(mins){
  if(mins==null) return '';
  const value=Math.max(0,Math.round(mins));
  const hrs=Math.floor(value/60);
  const rem=value%60;
  if(hrs && rem) return `${hrs}h ${rem}m`;
  if(hrs) return `${hrs}h`;
  return `${rem}m`;
}
function pkgMeta(name){
  const meta=(S.menu.packageMeta && S.menu.packageMeta[name])||{};
  const included=Array.isArray(meta.includedAddons)?meta.includedAddons:[];
  const description=typeof meta.description==='string'?meta.description:'';
  return {lock:!!meta.lock, includedAddons:included, description};
}

const Calc = {
  sizeIndex(size){ return S.menu.sizes.indexOf(size); },
  base(pkg,size){ const i=this.sizeIndex(size); return (S.menu.packages[pkg]||[])[i]||0; },
  addonPrice(name,size){ const i=this.sizeIndex(size); return (S.menu.addons[name]||[])[i]||0; },
  vehicleSubtotal(vehicle){ const add=(vehicle.addons||[]).reduce((t,a)=>t+Number(a.price||0),0); return Number(vehicle.base||0)+add; },
  vehicles(job){
    if(job.vehicles && job.vehicles.length){
      return job.vehicles.map(v=>({
        size: v.size || job.size || S.menu.sizes[0],
        base: Number(v.base||0),
        addons: (v.addons||[]).map(a=>({name:a.name, price:Number(a.price||0), included:!!a.included})),
        pkg: v.pkg || job.pkg || '',
        label: v.label || ''
      }));
    }
    const count=Math.max(1, Number(job.vehicleCount||1));
    const base=Number(job.base||0);
    const size=job.size || S.menu.sizes[0];
    const addons=(job.addons||[]).map(a=>({name:a.name, price:Number(a.price||0), included:!!a.included}));
    return Array.from({length:count},()=>({
      size,
      base,
      addons: addons.map(a=>({name:a.name, price:Number(a.price||0), included:!!a.included})),
      pkg: job.pkg || ''
    }));
  },
  addonSummary(job){
    const vehicles=this.vehicles(job);
    const perVehicle=vehicles.map((v,idx)=>{
      const addons=Array.isArray(v.addons)?v.addons:[];
      const included=addons.filter(a=>a && a.included).length;
      const custom=addons.filter(a=>a && !a.included).length;
      return {index:idx,label:v.label||'',size:v.size||'',included,custom};
    });
    let legacyIncluded=0;
    let legacyCustom=0;
    if(!vehicles.length && Array.isArray(job.addons)){
      for(const addon of job.addons){
        if(addon?.included) legacyIncluded++;
        else legacyCustom++;
      }
    }
    const totals=perVehicle.reduce((acc,info)=>{
      acc.custom+=info.custom;
      acc.included+=info.included;
      return acc;
    },{custom:legacyCustom,included:legacyIncluded});
    if(Array.isArray(job.extraCharges)){
      for(const extra of job.extraCharges){
        if(!extra) continue;
        if(extra.included) totals.included++;
        else totals.custom++;
      }
    }
    const requiresUpgrade=totals.custom>=4;
    const message=requiresUpgrade
      ? '4+ custom add-ons selected. Upgrade to Full Detail pricing or adjust scope.'
      : (totals.custom>0
          ? '≤3 custom add-ons keeps this at Maintenance pricing. Track time carefully.'
          : 'No custom add-ons selected. Maintain Maintenance Detail pricing.');
    const upsell='Always offer Spray Wax / Sealant / Ceramic after the exterior is clean and dry.';
    return {perVehicle, totalCustom:totals.custom, totalIncluded:totals.included, requiresUpgrade, message, upsell};
  },
  vehicleCount(job){ return this.vehicles(job).length; },
  subtotal(job){
    const base=this.vehicles(job).reduce((t,v)=>t+this.vehicleSubtotal(v),0);
    const extras=Array.isArray(job.extraCharges)?job.extraCharges.reduce((sum,charge)=>{
      if(!charge) return sum;
      if(charge.included) return sum;
      return sum+Number(charge.price||0);
    },0):0;
    return base+extras;
  },
  discount(job){
    const discType = job.discType;
    if(!discType || discType==='none') return 0;
    const value = Number(job.discValue||0);
    if(!value) return 0;
    const scope = job.discScope==='vehicle' ? 'vehicle' : 'job';
    const vehicles = this.vehicles(job);
    if(!vehicles.length) return 0;
    const subtotal = this.subtotal(job);
    if(discType==='%'){
      const pct = value/100;
      if(pct<=0) return 0;
      if(scope==='vehicle') return vehicles.reduce((sum,v)=>sum+this.vehicleSubtotal(v)*pct,0);
      return subtotal * pct;
    }
    if(discType==='$'){
      if(scope==='vehicle') return vehicles.reduce((sum,v)=>sum+Math.min(this.vehicleSubtotal(v), value),0);
      return Math.min(subtotal, value);
    }
    return 0;
  },
  total(job){ return this.subtotal(job)-this.discount(job); }
};

/*** App ***/
const App = {
  init(){
    this.normalizeSettings();
    this.normalizeClients();
    this.normalizeJobs();
    this.normalizePolicies();
    this.normalizeScripts();
    this.normalizeChecklists();
    this.normalizeMarketing();
    this.normalizeReminders();
    this.normalizeAppointments();
    this.normalizePlaybook();
    UI.initHeader();
    UI.initTabs();
    UI.populateClients();
    UI.populateSizesAndPackages();
    UI.renderMarketingTabs();
    UI.renderMarketingSection(S.marketing.activeTab||'guerrilla');
    UI.renderChecklists();
    UI.refreshBrandPolicies();
    UI.loadPlaybook();
    UI.populateSettingsTab();
    const clientSel=document.getElementById('jobClient');
    if(clientSel){
      clientSel.addEventListener('change',()=>UI.onClientChange());
    }
    document.getElementById('jobDiscType').addEventListener('change',()=>UI.updateTotals());
    document.getElementById('jobDiscValue').addEventListener('input',()=>UI.updateTotals());
    document.getElementById('jobDiscScope').addEventListener('change',()=>UI.updateTotals());
    UI.resetJobForm();
    UI.refreshJobsList();
    UI.refreshDashboard();
    this.checkAutoBackupPrompt();
    if('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');
    if(S.settings.syncEnabled){
      this.initializeSupabase();
    } else {
      UI.updateSyncStatus('idle','Supabase sync disabled.');
    }
  },
  normalizeClients(){
    S.clients = Array.isArray(S.clients) ? S.clients : [];
    for(const c of S.clients){
      if(typeof c.email!=='string') c.email='';
      if(typeof c.city!=='string') c.city='';
      if(typeof c.loyalty!=='string') c.loyalty='new';
      if(!c.discount) c.discount={type:'none', value:0};
      if(!Array.isArray(c.vehicles)) c.vehicles=[];
      for(const v of c.vehicles){
        if(!v.id) v.id=uid();
        if(!v.lastService) v.lastService=null;
        if(!Array.isArray(v.history)) v.history=[];
      }
    }
  },
  normalizeJobs(){
    S.jobs = Array.isArray(S.jobs) ? S.jobs : [];
    for(const job of S.jobs){
      this.ensureJobStructure(job);
    }
    Storage.save(S);
  },
  normalizeSettings(){
    if(!S.settings || typeof S.settings!=='object') S.settings=cloneData(DEFAULT_SETTINGS);
    if(!Array.isArray(S.settings.paymentMethods)) S.settings=Object.assign(cloneData(DEFAULT_SETTINGS),S.settings||{});
    if(!Array.isArray(S.settings.paymentMethods)) S.settings.paymentMethods=cloneData(DEFAULT_SETTINGS.paymentMethods);
    if(!Array.isArray(S.settings.categories)) S.settings.categories=cloneData(DEFAULT_SETTINGS.categories);
    if(typeof S.settings.syncEnabled!=='boolean') S.settings.syncEnabled=!!DEFAULT_SETTINGS.syncEnabled;
    if(typeof S.settings.lastBackupPrompt!=='string') S.settings.lastBackupPrompt='';
  },
  normalizePolicies(){
    if(!Array.isArray(S.policies)) S.policies=cloneData(DEFAULT_POLICIES);
    const defaults=new Map(DEFAULT_POLICIES.map(p=>[p.id,p]));
    S.policies=S.policies.map(policy=>({
      id:policy.id||uid(),
      label:policy.label||defaults.get(policy.id)?.label||'Policy',
      description:policy.description||defaults.get(policy.id)?.description||'',
      active:policy.active!==false
    }));
    for(const def of DEFAULT_POLICIES){
      if(!S.policies.some(p=>p.id===def.id)) S.policies.push(cloneData(def));
    }
  },
  normalizeScripts(){
    if(!S.scripts || typeof S.scripts!=='object') S.scripts=cloneData(DEFAULT_SCRIPTS);
    for(const [key,val] of Object.entries(DEFAULT_SCRIPTS)){
      if(typeof S.scripts[key]!=='string') S.scripts[key]=val;
    }
  },
  normalizePlaybook(){
    if(typeof S.playbook!=='string' || !S.playbook.trim()){
      S.playbook=DEFAULT_PLAYBOOK;
    }
  },
  normalizeChecklists(){
    if(!S.checklists || typeof S.checklists!=='object') S.checklists=cloneData(DEFAULT_CHECKLISTS);
    if(!Array.isArray(S.checklists.daily)) S.checklists.daily=[];
    if(!Array.isArray(S.checklists.weekly)) S.checklists.weekly=[];
    if(!Array.isArray(S.checklists.custom)) S.checklists.custom=[];
    if(typeof S.checklists.lastDailyReset!=='string') S.checklists.lastDailyReset='';
    if(typeof S.checklists.lastWeeklyReset!=='string') S.checklists.lastWeeklyReset='';
    const dailyDefaults=new Map(DEFAULT_CHECKLISTS.daily.map(item=>[item.id,item]));
    const weeklyDefaults=new Map(DEFAULT_CHECKLISTS.weekly.map(item=>[item.id,item]));
    S.checklists.daily=Array.from(dailyDefaults.values()).map(item=>{
      const existing=S.checklists.daily.find(entry=>entry.id===item.id) || {};
      return {id:item.id,label:item.label,note:item.note||'',cadence:'daily',completedOn:existing.completedOn||''};
    });
    S.checklists.weekly=Array.from(weeklyDefaults.values()).map(item=>{
      const existing=S.checklists.weekly.find(entry=>entry.id===item.id) || {};
      return {id:item.id,label:item.label,note:item.note||'',cadence:'weekly',completedOn:existing.completedOn||''};
    });
    S.checklists.custom=S.checklists.custom.map(item=>({
      id:item.id||uid(),
      label:item.label||'Custom Task',
      note:item.note||'',
      cadence:item.cadence==='weekly'?'weekly':'daily',
      completedOn:item.completedOn||''
    }));
    this.resetChecklistCadence('daily');
    this.resetChecklistCadence('weekly');
  },
  resetChecklistCadence(type){
    const todayStr=today();
    let changed=false;
    if(type==='daily'){
      if(S.checklists.lastDailyReset!==todayStr){
        S.checklists.daily.forEach(item=>item.completedOn='');
        S.checklists.custom.filter(item=>item.cadence==='daily').forEach(item=>item.completedOn='');
        S.checklists.lastDailyReset=todayStr;
        changed=true;
      }
    } else if(type==='weekly'){
      const now=new Date();
      const startOfWeek=new Date(now);
      const day=now.getDay();
      const diff=(day+6)%7;
      startOfWeek.setDate(now.getDate()-diff);
      const isoWeek=startOfWeek.toISOString().slice(0,10);
      if(S.checklists.lastWeeklyReset!==isoWeek){
        S.checklists.weekly.forEach(item=>item.completedOn='');
        S.checklists.custom.filter(item=>item.cadence==='weekly').forEach(item=>item.completedOn='');
        S.checklists.lastWeeklyReset=isoWeek;
        changed=true;
      }
    }
    if(changed) Storage.save(S);
  },
  normalizeMarketing(){
    if(!S.marketing || typeof S.marketing!=='object') S.marketing=cloneData(DEFAULT_MARKETING);
    if(!Array.isArray(S.marketing.campaigns)) S.marketing.campaigns=[];
    if(!Array.isArray(S.marketing.log)) S.marketing.log=[];
    if(!Array.isArray(S.marketing.reviews)) S.marketing.reviews=[];
    if(!Array.isArray(S.marketing.leaderboard)) S.marketing.leaderboard=[];
    if(!S.marketing.streak) S.marketing.streak={count:0,lastActivity:null};
    if(!Array.isArray(S.marketing.guerrilla)) S.marketing.guerrilla=[];
    const defaultMap=new Map(DEFAULT_MARKETING.guerrilla.map(section=>[section.id,section]));
    S.marketing.guerrilla=Array.from(defaultMap.values()).map(section=>{
      const existing=S.marketing.guerrilla.find(s=>s.id===section.id) || {};
      const tasks=(existing.tasks||[]).map(task=>({id:task.id,label:task.label||'',target:Number(task.target||0)||0,completed:Number(task.completed||0)||0}));
      return {
        id:section.id,
        label:section.label,
        tasks:section.tasks.map(task=>{
          const match=tasks.find(t=>t.id===task.id) || {};
          return {id:task.id,label:task.label,target:Number(task.target||0)||0,completed:Number(match.completed||0)||0};
        })
      };
    });
    if(!['guerrilla','campaigns','log','reviews'].includes(S.marketing.activeTab)){
      S.marketing.activeTab='guerrilla';
    }
  },
  normalizeReminders(){
    if(!Array.isArray(S.reminders)) S.reminders=[];
    S.reminders=S.reminders.map(rem=>({
      id:rem.id||uid(),
      jobId:rem.jobId||null,
      clientId:rem.clientId||null,
      type:rem.type||'followup',
      dueDate:rem.dueDate||today(),
      label:rem.label||'Follow-up',
      note:rem.note||'',
      done:!!rem.done
    }));
  },
  normalizeAppointments(){
    if(!Array.isArray(S.appointments)) S.appointments=[];
    S.appointments=S.appointments.map(appt=>({
      id:appt.id||uid(),
      jobId:appt.jobId||null,
      clientId:appt.clientId||null,
      date:appt.date||today(),
      time:appt.time||'',
      location:appt.location||'',
      notes:appt.notes||'',
      status:appt.status||'Booked',
      reminders:Array.isArray(appt.reminders)?appt.reminders:[]
    }));
  },
  checkAutoBackupPrompt(){
    const last=S.settings.lastBackupPrompt;
    const now=today();
    if(!last){
      S.settings.lastBackupPrompt=now;
      Storage.save(S);
      return;
    }
    const lastDate=new Date(last+'T00:00:00');
    const currentDate=new Date(now+'T00:00:00');
    const diffDays=Math.floor((currentDate-lastDate)/(1000*60*60*24));
    if(diffDays>=30){
      UI.flash('Time for a backup — export JSON to keep data safe.');
      S.settings.lastBackupPrompt=now;
      Storage.save(S);
    }
  },
  toggleCloudSync(enabled){
    S.settings.syncEnabled=!!enabled;
    Storage.save(S);
    UI.updateSyncToggle();
    if(enabled){
      this.initializeSupabase();
    } else {
      UI.updateSyncStatus('idle','Supabase sync disabled.');
    }
  },
  requestBackup(){
    Data.exportJSON();
    S.settings.lastBackupPrompt=today();
    Storage.save(S);
    UI.flash('Backup exported.');
  },
  addCustomChecklistTask(){
    const nameInput=document.getElementById('customChecklistName');
    const cadenceSel=document.getElementById('customChecklistCadence');
    if(!nameInput) return;
    const label=nameInput.value.trim();
    if(!label) return alert('Task name required');
    const cadence=cadenceSel?.value==='weekly'?'weekly':'daily';
    S.checklists.custom.push({id:uid(),label,note:'',cadence,completedOn:''});
    Storage.save(S);
    UI.renderChecklists();
    nameInput.value='';
  },
  setChecklistComplete(taskId,complete){
    const lists=[S.checklists.daily,S.checklists.weekly,S.checklists.custom];
    const target=lists.flat().find(item=>item.id===taskId);
    if(!target) return;
    target.completedOn=complete?today():'';
    Storage.save(S);
    UI.renderChecklists();
  },
  removeCustomChecklistTask(taskId){
    S.checklists.custom=S.checklists.custom.filter(task=>task.id!==taskId);
    Storage.save(S);
    UI.renderChecklists();
  },
  logMarketingAction(entry){
    const payload={
      id:uid(),
      type:entry.type||DEFAULT_MARKETING_LOG_TYPES[0],
      count:Number(entry.count||0)||0,
      notes:entry.notes||'',
      date:today()
    };
    S.marketing.log.unshift(payload);
    if(S.marketing.log.length>120) S.marketing.log.length=120;
    this.recordMarketingTouch();
    Storage.save(S);
    if(S.marketing.activeTab==='log') UI.renderMarketingSection('log');
    UI.refreshDashboard();
  },
  updateGuerrillaTask(sectionId,taskId,value){
    const section=S.marketing.guerrilla.find(s=>s.id===sectionId);
    if(!section) return;
    const task=section.tasks.find(t=>t.id===taskId);
    if(!task) return;
    task.completed=Math.max(0,Math.min(Number(task.target||0),Number(value||0)));
    this.recordMarketingTouch();
    Storage.save(S);
    if(S.marketing.activeTab==='guerrilla') UI.renderMarketingSection('guerrilla');
    UI.refreshDashboard();
  },
  addMarketingCampaign(campaign){
    const payload={
      id:uid(),
      name:campaign.name||'Campaign',
      channel:campaign.channel||'',
      budgetPerDay:Number(campaign.budgetPerDay||0)||0,
      start:campaign.start||today(),
      end:campaign.end||'',
      goals:campaign.goals||'',
      notes:campaign.notes||'',
      spend:Number(campaign.spend||0)||0,
      newJobs:Number(campaign.newJobs||0)||0
    };
    S.marketing.campaigns.push(payload);
    Storage.save(S);
    if(S.marketing.activeTab==='campaigns') UI.renderMarketingSection('campaigns');
  },
  addReviewEntry(entry){
    const payload={id:uid(), client:entry.client||'Client', note:entry.note||'', date:today()};
    S.marketing.leaderboard.unshift(payload);
    if(S.marketing.leaderboard.length>10) S.marketing.leaderboard.length=10;
    this.recordMarketingTouch();
    Storage.save(S);
    if(S.marketing.activeTab==='reviews') UI.renderMarketingSection('reviews');
  },
  recordMarketingTouch(){
    const todayStr=today();
    if(S.marketing.streak.lastActivity===todayStr) return;
    const last=S.marketing.streak.lastActivity;
    S.marketing.streak.lastActivity=todayStr;
    if(!last) {
      S.marketing.streak.count=1;
    } else {
      const lastDate=new Date(last+'T00:00:00');
      const currentDate=new Date(todayStr+'T00:00:00');
      const diff=Math.floor((currentDate-lastDate)/(1000*60*60*24));
      if(diff===1) S.marketing.streak.count+=1;
      else if(diff>1) S.marketing.streak.count=1;
    }
  },
  ensureReminder(job,type,dueDate,label,note=''){
    if(!dueDate) return;
    const existing=S.reminders.find(rem=>rem.jobId===job.id && rem.type===type);
    if(existing){
      const wasDone=existing.done;
      const previous=existing.dueDate;
      existing.dueDate=dueDate;
      existing.label=label;
      existing.note=note;
      existing.clientId=job.clientId;
      if(wasDone && previous!==dueDate){
        existing.done=false;
      }
      return;
    }
    S.reminders.push({id:uid(),jobId:job.id,clientId:job.clientId,type,dueDate:dueDate,label,note,done:false});
  },
  completeReminder(id,done=true){
    const reminder=S.reminders.find(r=>r.id===id);
    if(!reminder) return;
    reminder.done=!!done;
    Storage.save(S);
    UI.refreshDashboard();
    UI.renderMarketingSection(S.marketing.activeTab||'guerrilla');
  },
  syncJobReminders(job){
    if(!job) return;
    if(!Array.isArray(S.reminders)) S.reminders=[];
    if(job.schedule?.date){
      const baseDate=new Date(`${job.schedule.date}T${job.schedule.start||'08:00'}`);
      const pre=new Date(baseDate);
      pre.setDate(pre.getDate()-1);
      this.ensureReminder(job,'confirm',pre.toISOString().slice(0,10),'24h confirmation','Send confirmation text.');
    }
    if(['Complete','Paid'].includes(job.status)){
      const completeDate=new Date((job.completedAt||job.schedule?.date||today())+'T00:00:00');
      const review=new Date(completeDate);
      review.setDate(review.getDate()+7);
      const maintenance=new Date(completeDate);
      maintenance.setDate(maintenance.getDate()+30);
      this.ensureReminder(job,'review',review.toISOString().slice(0,10),'7 day review ask','Use the Review script.');
      this.ensureReminder(job,'maintenance',maintenance.toISOString().slice(0,10),'30 day maintenance check','Suggest maintenance detail.');
    }
    S.reminders=S.reminders.filter(rem=>rem.jobId!==job.id || rem.dueDate);
    Storage.save(S);
    UI.refreshDashboard();
  },
  syncAppointmentsForJob(job){
    if(!job) return;
    if(!Array.isArray(S.appointments)) S.appointments=[];
    const existing=S.appointments.find(appt=>appt.jobId===job.id);
    if(job.schedule?.date){
      const payload=existing || {id:uid(),jobId:job.id};
      payload.clientId=job.clientId||null;
      payload.date=job.schedule.date;
      payload.time=job.schedule.start||'';
      payload.location=job.location||'';
      payload.notes=job.notes||'';
      payload.status=job.status;
      if(!existing) S.appointments.push(payload);
    } else if(existing){
      S.appointments=S.appointments.filter(appt=>appt.jobId!==job.id);
    }
    Storage.save(S);
  },
  ensureJobStructure(job){
    if(!job) return;
    if(!job.remote || typeof job.remote!=='object') job.remote={};
    if(job.remoteTotal==null) job.remoteTotal=0;
    if(!Array.isArray(job.vehicles)) job.vehicles=[];
    if(!Array.isArray(job.payments)) job.payments=[];
    if(!job.schedule || typeof job.schedule!=='object'){
      job.schedule={ date:job.date||today(), start:'', end:'', durationMinutes:null };
    } else {
      if(!job.schedule.date) job.schedule.date=job.date||today();
      if(job.schedule.durationMinutes!=null) job.schedule.durationMinutes=Number(job.schedule.durationMinutes)||0;
    }
    if(!job.date) job.date=job.schedule.date||today();
    if(!job.createdAt){
      const base=job.schedule.date?`${job.schedule.date}T08:00:00`:`${today()}T08:00:00`;
      job.createdAt=new Date(base).toISOString();
    }
    if(!Array.isArray(job.extraCharges)) job.extraCharges=[];
    if(!Array.isArray(job.services) || !job.services.length){
      job.services=this.createServicesFromVehicles(job);
    } else {
      this.normalizeServices(job);
    }
    this.ensureTimers(job);
    this.ensureChecklist(job);
  },
  normalizeServices(job){
    if(!Array.isArray(job.services)){
      job.services=[];
      return;
    }
    job.services=job.services.map(service=>{
      const copy={...service};
      copy.id=copy.id||uid();
      copy.type=copy.type||'custom';
      copy.name=copy.name||'Service';
      if(copy.price!=null) copy.price=Number(copy.price||0);
      copy.included=!!copy.included;
      if(copy.vehicleIndex!=null) copy.vehicleIndex=Number(copy.vehicleIndex);
      if(copy.vehicleLabel==null) copy.vehicleLabel='';
      return copy;
    });
  },
  createServicesFromVehicles(job){
    const services=[];
    const vehicles=Array.isArray(job.vehicles)?job.vehicles:[];
    vehicles.forEach((vehicle,idx)=>{
      const label=vehicle.label||`Vehicle ${idx+1}`;
      if(vehicle.pkg){
        services.push({id:uid(),type:'package',name:vehicle.pkg,vehicleIndex:idx,vehicleLabel:label,price:Number(vehicle.base||0)||0,included:false});
      }
      (vehicle.addons||[]).forEach(addon=>{
        if(!addon?.name) return;
        services.push({id:uid(),type:'addon',name:addon.name,vehicleIndex:idx,vehicleLabel:label,price:Number(addon.price||0)||0,included:!!addon.included});
      });
    });
    if(Array.isArray(job.extraCharges)){
      job.extraCharges.forEach(extra=>{
        if(!extra?.name) return;
        services.push({id:extra.id||uid(),type:extra.type||'custom',name:extra.name,vehicleIndex:extra.vehicleIndex!=null?Number(extra.vehicleIndex):null,vehicleLabel:extra.vehicleLabel||'',price:Number(extra.price||0)||0,included:!!extra.included});
      });
    }
    return services;
  },
  createTimers(){
    return {
      overall:this.createTimer('overall','Overall Timer'),
      setup:this.createTimer('setup','Setup / Prep'),
      base:this.createTimer('base','Base Services'),
      addons:this.createTimer('addons','Add-ons / Finishing')
    };
  },
  createTimer(id,label){
    return {id,label,elapsed:0,runningSince:null};
  },
  ensureTimers(job){
    if(!job.timers || typeof job.timers!=='object'){
      job.timers=this.createTimers();
      return;
    }
    const defaults=this.createTimers();
    for(const key of Object.keys(defaults)){
      if(!job.timers[key]){
        job.timers[key]=defaults[key];
        continue;
      }
      const timer=job.timers[key];
      if(typeof timer.label!=='string') timer.label=defaults[key].label;
      if(typeof timer.elapsed!=='number') timer.elapsed=Number(timer.elapsed||0);
      if(typeof timer.runningSince!=='number') timer.runningSince=null;
      timer.id=timer.id||key;
    }
  },
  serviceSlug(name){
    return (name||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'')||uid();
  },
  collectAddonNames(job){
    const names=[];
    if(Array.isArray(job?.services)){
      for(const service of job.services){
        if(!service?.name) continue;
        if((service.type==='addon'||service.type==='custom') && !names.includes(service.name)){
          names.push(service.name);
        }
      }
    }
    if(Array.isArray(job?.vehicles)){
      job.vehicles.forEach(vehicle=>{
        (vehicle.addons||[]).forEach(addon=>{
          if(addon?.name && !names.includes(addon.name)) names.push(addon.name);
        });
      });
    }
    if(Array.isArray(job?.extraCharges)){
      job.extraCharges.forEach(extra=>{
        if(extra?.name && !names.includes(extra.name)) names.push(extra.name);
      });
    }
    return names;
  },
  timerElapsedMs(timer){
    if(!timer) return 0;
    const elapsed=Number(timer.elapsed||0);
    if(timer.runningSince) return elapsed+Math.max(0, Date.now()-timer.runningSince);
    return elapsed;
  },
  timerElapsedMinutes(timer){
    return Math.round(this.timerElapsedMs(timer)/60000);
  },
  toggleTimer(jobId,key){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    this.ensureTimers(job);
    const timer=job.timers[key];
    if(!timer) return;
    if(timer.runningSince){
      timer.elapsed+=Date.now()-timer.runningSince;
      timer.runningSince=null;
    } else {
      timer.runningSince=Date.now();
      if(key!=='overall' && job.timers.overall && !job.timers.overall.runningSince){
        job.timers.overall.runningSince=Date.now();
      }
    }
    Storage.save(S);
    UI.refreshJobsList();
    UI.renderJobPanel(jobId);
  },
  resetTimer(jobId,key){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    this.ensureTimers(job);
    const timer=job.timers[key];
    if(!timer) return;
    timer.elapsed=0;
    timer.runningSince=null;
    Storage.save(S);
    UI.refreshJobsList();
    UI.renderJobPanel(jobId);
  },
  setTimerMinutes(jobId,key,minutes){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    this.ensureTimers(job);
    const timer=job.timers[key];
    if(!timer) return;
    timer.elapsed=Math.max(0, Math.round(Number(minutes||0)*60000));
    timer.runningSince=null;
    Storage.save(S);
    UI.refreshJobsList();
    UI.renderJobPanel(jobId);
  },
  addService(jobId, service){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    this.ensureJobStructure(job);
    const entry={
      id:uid(),
      type:service.type||'custom',
      name:service.name||'Service',
      price:Number(service.price||0),
      included:!!service.included,
      vehicleIndex:service.vehicleIndex!=null?Number(service.vehicleIndex):null,
      vehicleLabel:service.vehicleLabel||''
    };
    job.services.push(entry);
    if(entry.type==='addon' || entry.type==='custom'){
      job.extraCharges=Array.isArray(job.extraCharges)?job.extraCharges:[];
      job.extraCharges.push({id:entry.id,name:entry.name,price:entry.price,included:entry.included,type:entry.type,vehicleIndex:entry.vehicleIndex,vehicleLabel:entry.vehicleLabel});
    }
    this.ensureChecklist(job);
    Storage.save(S);
    UI.refreshJobsList();
    UI.renderJobPanel(jobId);
  },
  removeService(jobId, serviceId){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job || !Array.isArray(job.services)) return;
    const idx=job.services.findIndex(s=>s.id===serviceId);
    if(idx<0) return;
    job.services.splice(idx,1);
    if(Array.isArray(job.extraCharges)){
      job.extraCharges=job.extraCharges.filter(extra=>extra?.id!==serviceId);
    }
    this.ensureChecklist(job);
    Storage.save(S);
    UI.refreshJobsList();
    UI.renderJobPanel(jobId);
  },
  createChecklist(job=null){
    return { sections: this.createChecklistSections(job) };
  },
  createChecklistSections(job=null){
    const sections = CREW_CHECKLIST_SECTIONS.map(section=>({
      id: section.id,
      title: section.title,
      goalMinutes: section.goalMinutes,
      items: section.items.map(item=>({
        id: item.id,
        label: item.label,
        description: item.description || '',
        completed: false,
        elapsed: 0,
        runningSince: null
      }))
    }));
    const dynamic=this.buildAddonChecklistSection(job);
    if(dynamic) sections.push(dynamic);
    return sections;
  },
  buildAddonChecklistSection(job){
    if(!job) return null;
    const addonNames=this.collectAddonNames(job);
    if(!addonNames.length) return null;
    const items=addonNames.map(name=>({
      id:'addon-'+this.serviceSlug(name),
      label:name,
      description:'Confirm completion for this add-on or finishing touch.',
      completed:false,
      elapsed:0,
      runningSince:null
    }));
    return {
      id:'addons-dynamic',
      title:'Add-ons & Finishing',
      goalMinutes:Math.max(15, job.schedule?.durationMinutes ? Math.round(job.schedule.durationMinutes*0.25)||15 : 20),
      items
    };
  },
  ensureChecklist(job){
    if(!job) return;
    let changed=false;
    if(!job.checklist || !Array.isArray(job.checklist.sections)){
      job.checklist=this.createChecklist(job);
      changed=true;
    }
    const sections=job.checklist.sections;
    const templateMap=new Map(CREW_CHECKLIST_SECTIONS.map(section=>[section.id, section]));
    for(const [sectionId, template] of templateMap){
      let section=sections.find(s=>s.id===sectionId);
      if(!section){
        section={
          id: template.id,
          title: template.title,
          goalMinutes: template.goalMinutes,
          items: template.items.map(item=>({
            id: item.id,
            label: item.label,
            description: item.description || '',
            completed: false,
            elapsed: 0,
            runningSince: null
          }))
        };
        sections.push(section);
        changed=true;
        continue;
      }
      if(section.title==null) section.title=template.title;
      if(section.goalMinutes==null) section.goalMinutes=template.goalMinutes;
      if(!Array.isArray(section.items)) section.items=[];
      for(const itemTemplate of template.items){
        let item=section.items.find(i=>i.id===itemTemplate.id);
        if(!item){
          section.items.push({
            id: itemTemplate.id,
            label: itemTemplate.label,
            description: itemTemplate.description || '',
            completed: false,
            elapsed: 0,
            runningSince: null
          });
          changed=true;
        } else {
          if(item.label==null) item.label=itemTemplate.label;
          if(item.description==null && itemTemplate.description) item.description=itemTemplate.description;
          if(item.elapsed==null) item.elapsed=0;
          if(item.runningSince==null || typeof item.runningSince!=='number') item.runningSince=null;
          if(typeof item.completed!=='boolean') item.completed=!!item.completed;
        }
      }
    }
    const dynamicTemplate=this.buildAddonChecklistSection(job);
    const dynamicIndex=sections.findIndex(s=>s.id==='addons-dynamic');
    if(dynamicTemplate){
      let section=dynamicIndex>=0?sections[dynamicIndex]:null;
      if(!section){
        sections.push(dynamicTemplate);
        changed=true;
      } else {
        if(section.title!==dynamicTemplate.title){ section.title=dynamicTemplate.title; changed=true; }
        if(section.goalMinutes!==dynamicTemplate.goalMinutes){ section.goalMinutes=dynamicTemplate.goalMinutes; changed=true; }
        if(!Array.isArray(section.items)) section.items=[];
        const seen=new Set();
        for(const itemTemplate of dynamicTemplate.items){
          let item=section.items.find(i=>i.id===itemTemplate.id);
          if(!item){
            section.items.push({...itemTemplate});
            changed=true;
            item=section.items[section.items.length-1];
          }
          if(item.label!==itemTemplate.label){ item.label=itemTemplate.label; changed=true; }
          if(item.description==null) item.description=itemTemplate.description;
          if(item.elapsed==null) item.elapsed=0;
          if(item.runningSince==null || typeof item.runningSince!=='number') item.runningSince=null;
          if(typeof item.completed!=='boolean') item.completed=!!item.completed;
          seen.add(itemTemplate.id);
        }
        const filtered=section.items.filter(i=>seen.has(i.id));
        if(filtered.length!==section.items.length){
          section.items=filtered;
          changed=true;
        }
      }
    } else if(dynamicIndex>=0){
      sections.splice(dynamicIndex,1);
      changed=true;
    }
    if(changed) Storage.save(S);
  },
  findChecklistItem(job, sectionId, itemId){
    if(!job?.checklist?.sections) return {section:null,item:null};
    const section=job.checklist.sections.find(s=>s.id===sectionId) || null;
    const item=section?.items?.find(i=>i.id===itemId) || null;
    return {section,item};
  },
  checklistElapsedMs(item){
    if(!item) return 0;
    const elapsed=Number(item.elapsed||0);
    if(item.runningSince) return elapsed+Math.max(0,Date.now()-item.runningSince);
    return elapsed;
  },
  setChecklistComplete(jobId, sectionId, itemId, completed){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    this.ensureChecklist(job);
    const {item}=this.findChecklistItem(job,sectionId,itemId);
    if(!item) return;
    item.completed=!!completed;
    if(item.completed && item.runningSince){
      item.elapsed+=Date.now()-item.runningSince;
      item.runningSince=null;
    }
    Storage.save(S);
  },
  toggleChecklistTimer(jobId, sectionId, itemId){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    this.ensureChecklist(job);
    const {item}=this.findChecklistItem(job,sectionId,itemId);
    if(!item) return;
    if(item.runningSince){
      item.elapsed+=Date.now()-item.runningSince;
      item.runningSince=null;
    } else {
      item.runningSince=Date.now();
    }
    Storage.save(S);
  },
  addClient(){ const name=document.getElementById('cName').value.trim(); if(!name) return alert('Client name required'); const city=document.getElementById('cCity').value.trim(); const loyalty=document.getElementById('cLoyalty')?.value||'new'; const c={id:uid(), name, phone:document.getElementById('cPhone').value.trim(), email:document.getElementById('cEmail').value.trim(), city, loyalty, notes:document.getElementById('cNotes').value.trim(), discount:{type:document.getElementById('cDiscType').value, value:Number(document.getElementById('cDiscValue').value||0)}, vehicles:[]}; S.clients.push(c); Storage.save(S); SupabaseSync?.scheduleUpsert?.('customers',{id:c.id,name:c.name,phone:c.phone,email:c.email,notes:c.notes,city:c.city,loyalty:c.loyalty}); UI.populateClients(); UI.flash('Client added.'); document.getElementById('cName').value='';document.getElementById('cPhone').value='';document.getElementById('cEmail').value='';document.getElementById('cCity').value='';document.getElementById('cNotes').value='';document.getElementById('cDiscType').value='none';document.getElementById('cDiscValue').value='0'; document.getElementById('cLoyalty').value='new'; },
  addQuickClient(){ const name=document.getElementById('qcName').value.trim(); if(!name) return alert('Client name required'); const c={id:uid(), name, phone:document.getElementById('qcPhone').value.trim(), email:document.getElementById('qcEmail').value.trim(), city:'', loyalty:'new', notes:document.getElementById('qcNotes').value.trim(), discount:{type:document.getElementById('qcDiscType').value, value:Number(document.getElementById('qcDiscValue').value||0)}, vehicles:[]}; S.clients.push(c); Storage.save(S); SupabaseSync?.scheduleUpsert?.('customers',{id:c.id,name:c.name,phone:c.phone,email:c.email,notes:c.notes,city:c.city,loyalty:c.loyalty}); UI.populateClients(c.id); UI.hideQuickClient(); UI.flash('Client added.'); UI.onClientChange(); },
  syncClientVehicles(job,{updateLastService=false}={}){
    const client=S.clients.find(x=>x.id===job.clientId);
    if(!client) return;
    if(!Array.isArray(client.vehicles)) client.vehicles=[];
    for(const vehicle of job.vehicles||[]){
      const label=(vehicle.label||'').trim();
      const candidateId=vehicle.clientVehicleId||vehicle.vehicleId||'';
      let record=null;
      if(candidateId){
        record=client.vehicles.find(v=>v.id===candidateId);
      }
      if(!record && label){
        record=client.vehicles.find(v=>(v.label||'').toLowerCase()===label.toLowerCase());
      }
      if(record){
        if(label) record.label=label;
        if(vehicle.size) record.size=vehicle.size;
      } else if(label){
        record={id:candidateId||uid(), label, size:vehicle.size||'', lastService:null, history:[]};
        client.vehicles.push(record);
      } else {
        continue;
      }
      if(!Array.isArray(record.history)) record.history=[];
      if(updateLastService){
        const serviceInfo={jobId:job.id, date:job.date, pkg:vehicle.pkg||job.pkg||'', addons:(vehicle.addons||[]).map(a=>a.name).filter(Boolean)};
        record.lastService=serviceInfo;
        record.history.unshift(serviceInfo);
        if(record.history.length>20) record.history.length=20;
      }
    }
    Storage.save(S);
    UI.populateClients(job.clientId);
  },
  serializeVehicles(job){
    const vehicles=Array.isArray(job.vehicles)?job.vehicles:[];
    return vehicles.map((vehicle,idx)=>({
      id:vehicle.id||vehicle.clientVehicleId||`vehicle-${idx}`,
      label:vehicle.label||'',
      pkg:vehicle.pkg||job.pkg||'',
      size:vehicle.size||job.size||'',
      base:Number(vehicle.base!=null?vehicle.base:Calc.base(vehicle.pkg||job.pkg||'', vehicle.size||job.size||''))||0,
      addons:Array.isArray(vehicle.addons)?vehicle.addons.map(addon=>({
        name:addon.name||'',
        price:Number(addon.price||0)||0,
        included:!!addon.included
      })) : []
    }));
  },
  serializeAddons(job){
    const list=[];
    this.serializeVehicles(job).forEach(vehicle=>{
      vehicle.addons.forEach(addon=>{
        list.push({
          name:addon.name||'',
          price:addon.price||0,
          included:addon.included||false,
          vehicle_id:vehicle.id,
          vehicle_label:vehicle.label||''
        });
      });
    });
    return list;
  },
  isoFromDateTime(date,time){
    if(!date) return null;
    let safe=time||'08:00';
    if(safe.length===4 && !safe.includes(':')) safe=`${safe.slice(0,2)}:${safe.slice(2)}`;
    if(!safe.includes(':')) safe=`${safe.slice(0,2)}:${safe.slice(2,4)}`;
    if(safe.length===5) safe=`${safe}:00`;
    return `${date}T${safe}`;
  },
  pushJobToSupabase(job){
    if(!SupabaseSync) return;
    this.ensureJobStructure(job);
    const ref=job.remote || (job.remote={});
    const vehicles=this.serializeVehicles(job);
    const addons=this.serializeAddons(job);
    const total=Calc.total(job);
    const customerId=job.clientId||null;
    if(!customerId) return;
    const quoteId=ref.quoteId || job.id;
    const quotePayload={
      id:quoteId,
      customer_id:customerId,
      pkg:job.pkg||'',
      size:job.size||'',
      addons:JSON.stringify(addons),
      vehicles:JSON.stringify(vehicles),
      total,
      status:job.status==='Quoted'?'Quoted':'Won',
      notes:job.notes||'',
      created_at:job.createdAt||new Date().toISOString()
    };
    ref.quoteId=quoteId;
    SupabaseSync.scheduleUpsert('quotes', quotePayload);
    if(job.status && job.status!=='Quoted'){
      const jobId=ref.jobId || job.id;
      const startIso=this.isoFromDateTime(job.schedule?.date, job.schedule?.start);
      const endIso=this.isoFromDateTime(job.schedule?.date, job.schedule?.end);
      const jobPayload={
        id:jobId,
        quote_id:ref.quoteId||null,
        customer_id:customerId,
        status:job.status,
        total,
        notes:job.notes||'',
        start_time:startIso,
        end_time:endIso
      };
      ref.jobId=jobId;
      SupabaseSync.scheduleUpsert('jobs', jobPayload);
    }
  },
  pushTransactionToSupabase(tx){
    if(!SupabaseSync) return;
    if(!tx.remote || typeof tx.remote!=='object') tx.remote={};
    const payload={
      id:tx.remote.transactionId || tx.id,
      job_id:tx.jobId||null,
      customer_id:tx.clientId||null,
      amount:Number(tx.amount||0),
      method:tx.payment||'',
      type:tx.remoteType||'deposit',
      date:tx.date||today()
    };
    tx.remote.transactionId=payload.id;
    SupabaseSync.scheduleUpsert('transactions', payload);
  },
  initializeSupabase(){
    if(!SupabaseSync){
      UI.updateSyncStatus('idle','Supabase sync unavailable. Provide configuration.');
      return;
    }
    SupabaseSync.setLocalState(S);
    UI.updateSyncStatus('syncing','Syncing with Supabase…');
    SupabaseSync.on('sync:complete',()=>{
      try {
        Storage.save(S);
      } catch(err){
        console.warn('Failed to persist synced state', err);
      }
      UI.refreshJobsList();
      UI.updateSyncStatus('connected','Connected to Supabase.');
    });
    SupabaseSync.on('booking:created',()=>{
      UI.flash('New booking received.');
      UI.refreshJobsList();
    });
    SupabaseSync.bootstrap(S).then(result=>{
      if(result?.synced){
        Storage.save(S);
        UI.refreshJobsList();
        UI.updateSyncStatus('connected','Connected to Supabase.');
      } else if(result?.reason==='not-configured'){
        UI.updateSyncStatus('idle','Supabase sync idle. Configure keys in pc-config.');
      } else {
        UI.updateSyncStatus('error',`Sync failed: ${result?.reason||'Unknown error'}`);
      }
    }).catch(err=>{
      console.error('Supabase bootstrap error', err);
      UI.updateSyncStatus('error','Supabase sync failed. Check console.');
    });
  },
  saveJob(options={}){
    const asQuote=!!(options && options.asQuote);
    const clientId=document.getElementById('jobClient').value;
    if(!clientId) return alert('Client is required');
    const vehicles=UI.collectVehicles();
    if(!vehicles.length) return alert('Add at least one vehicle');
    if(vehicles.some(v=>!v.pkg)) return alert('Select a package for each vehicle');
    const discType=document.getElementById('jobDiscType').value;
    const discValue=Number(document.getElementById('jobDiscValue').value||0);
    const discScopeValue=document.getElementById('jobDiscScope').value;
    const discScope=discScopeValue==='vehicle'?'vehicle':'job';
    const notes=document.getElementById('jobNotes').value.trim();
    const scheduleDate=document.getElementById('jobDate').value || today();
    const scheduleStart=document.getElementById('jobStart').value || '';
    const scheduleEnd=document.getElementById('jobEnd').value || '';
    const scheduleDuration=parseDurationInput(document.getElementById('jobDuration').value);
    const primaryPkg=vehicles[0]?.pkg||'';
    const schedule={date:scheduleDate,start:scheduleStart,end:scheduleEnd,durationMinutes:scheduleDuration};
    if(UI.editingJobId){
      const job=S.jobs.find(x=>x.id===UI.editingJobId);
      if(job){
        const previousStatus=job.status;
        job.clientId=clientId;
        job.pkg=primaryPkg;
        job.vehicles=vehicles.map(v=>({
          ...v,
          addons:Array.isArray(v.addons)?v.addons.map(a=>({...a})) : []
        }));
        job.discType=discType;
        job.discValue=discValue;
        job.discScope=discScope;
        job.notes=notes;
        job.schedule=schedule;
        job.date=scheduleDate;
        job.size=vehicles[0]?.size||'';
        job.vehicleCount=vehicles.length;
        if(Array.isArray(job.extraCharges)){
          job.extraCharges=job.extraCharges.map(extra=>{
            if(!extra) return extra;
            const copy={...extra};
            const idx=copy.vehicleIndex!=null?Number(copy.vehicleIndex):-1;
            if(copy.vehicleIndex!=null) copy.vehicleIndex=idx;
            if(idx>=vehicles.length){
              copy.vehicleIndex=null;
              copy.vehicleLabel='';
            }
            return copy;
          });
        } else {
          job.extraCharges=[];
        }
        job.services=this.createServicesFromVehicles(job);
        this.normalizeServices(job);
        this.ensureChecklist(job);
        Storage.save(S);
        this.syncClientVehicles(job);
        this.syncAppointmentsForJob(job);
        this.syncJobReminders(job);
        UI.refreshJobsList();
        UI.renderJobPanel(job.id,true);
        UI.resetJobForm();
        let converted=false;
        if(asQuote){
          if(!['Paid','Complete'].includes(job.status)){
            job.status='Quoted';
            Storage.save(S);
            UI.refreshJobsList();
          }
          this.pushJobToSupabase(job);
          UI.flash('Quote updated.');
          UI.switchTab('Quotes');
        } else {
          if(previousStatus==='Quoted'){
            job.status='Booked';
            Storage.save(S);
            UI.refreshJobsList();
            converted=true;
          }
          this.pushJobToSupabase(job);
          if(converted){
            UI.flash('Quote converted to job.');
            UI.switchTab('Jobs');
          } else {
            UI.flash('Job updated.');
          }
        }
        return;
      }
      UI.editingJobId=null;
      UI.updateJobFormEditingUI(null);
      UI.flash('Could not find the original job. A new job will be scheduled instead.');
    }
    const job={
      id:uid(),
      date:scheduleDate,
      createdAt:new Date().toISOString(),
      clientId,
      pkg:primaryPkg,
      vehicles,
      discType,
      discValue,
      discScope,
      notes,
      status:asQuote?'Quoted':'Booked',
      payments:[],
      schedule,
      extraCharges:[]
    };
    job.size=vehicles[0]?.size||'';
    job.vehicleCount=vehicles.length;
    job.services=this.createServicesFromVehicles(job);
    job.timers=this.createTimers();
    job.checklist=this.createChecklist(job);
    this.ensureChecklist(job);
    S.jobs.unshift(job);
    Storage.save(S);
    this.syncClientVehicles(job);
    this.syncAppointmentsForJob(job);
    this.syncJobReminders(job);
    UI.refreshJobsList();
    UI.resetJobForm();
    this.pushJobToSupabase(job);
    if(asQuote){
      UI.flash('Quote saved.');
      UI.switchTab('Quotes');
    } else {
      UI.flash('Job scheduled.');
      UI.switchTab('Jobs');
    }
  },
  updateJobStatus(id,next){
    const job=S.jobs.find(x=>x.id===id);
    if(!job) return;
    this.ensureJobStructure(job);
    job.status=next;
    let savedViaSync=false;
    if(next==='In Progress' && !job.startedAt){
      job.startedAt=new Date().toISOString();
      if(job.timers?.overall && !job.timers.overall.runningSince){
        job.timers.overall.runningSince=Date.now();
      }
    }
    if(next==='Complete' || next==='Paid'){
      job.completedAt=new Date().toISOString();
      if(job.timers){
        for(const timer of Object.values(job.timers)){
          if(timer?.runningSince){
            timer.elapsed+=Date.now()-timer.runningSince;
            timer.runningSince=null;
          }
        }
      }
      job.totalMinutes=this.timerElapsedMinutes(job.timers?.overall||{elapsed:0});
      this.syncClientVehicles(job,{updateLastService:true});
      savedViaSync=true;
    }
    if(!savedViaSync){
      Storage.save(S);
      UI.populateClients(job.clientId);
    }
    this.syncAppointmentsForJob(job);
    this.syncJobReminders(job);
    this.pushJobToSupabase(job);
    UI.refreshJobsList();
    UI.renderJobPanel(id);
    UI.flash('Status: '+next);
    if(next==='Complete'){
      UI.promptScript('follow24',job);
    } else if(next==='Paid'){
      UI.promptScript('review',job);
    }
  },
  takePayment(id){
    const j=S.jobs.find(x=>x.id===id);
    if(!j) return;
    const paid=(j.payments||[]).reduce((t,p)=>t+Number(p.amount||0),0);
    const due=Math.max(0,Calc.total(j)-paid);
    const amount=Number(prompt('Amount received', due.toFixed(2))||0);
    if(amount<=0) return;
    const method=prompt('Method (Cash/Card/Zelle/Venmo/CashApp/Bank)','Cash')||'Cash';
    j.payments.push({date:today(),method,amount});
    const vehicleLabel=UI.jobVehicleSummary(j);
    const pkgLabel=UI.jobPackageLabel(j);
    const itemLabel=vehicleLabel?`${pkgLabel} — ${vehicleLabel}`:pkgLabel;
    const paymentType=(amount>=due-0.01)?'balance':'deposit';
    const tx={id:uid(), jobId:j.id, type:'Income', date:today(), category:'Package', item:itemLabel, clientId:j.clientId, vendor:'', payment:method, amount, notes:paymentType==='deposit'?'Deposit collected via dashboard.':'Balance payment collected.', remoteType:paymentType};
    S.transactions.push(tx);
    Storage.save(S);
    this.pushTransactionToSupabase(tx);
    this.pushJobToSupabase(j);
    const paid2=j.payments.reduce((t,p)=>t+Number(p.amount||0),0);
    if(paid2+1e-6>=Calc.total(j)){
      this.updateJobStatus(j.id,'Paid');
      UI.flash('Paid in full. Income posted.');
    } else {
      UI.populateClients(j.clientId);
      UI.refreshJobsList();
      UI.renderJobPanel(id);
      UI.flash('Partial payment recorded.');
    }
    UI.refreshDashboard();
  },
  deleteJob(id){
    if(!confirm('Delete this job?')) return;
    const before=S.transactions.length;
    S.jobs=S.jobs.filter(x=>x.id!==id);
    S.transactions=S.transactions.filter(t=>t.jobId!==id);
    S.reminders=S.reminders.filter(rem=>rem.jobId!==id);
    S.appointments=S.appointments.filter(appt=>appt.jobId!==id);
    Storage.save(S);
    if(UI.jobPanelJobId===id) UI.closeJobPanel();
    UI.refreshJobsList();
    UI.refreshDashboard();
    const removed=before!==S.transactions.length;
    UI.flash(removed?'Job and related income removed.':'Job deleted.');
  },
  deleteTransaction(id){
    const idx=S.transactions.findIndex(t=>t.id===id);
    if(idx<0) return false;
    if(!confirm('Delete this record?')) return false;
    S.transactions.splice(idx,1);
    Storage.save(S);
    UI.refreshDashboard();
    UI.flash('Transaction deleted.');
    return true;
  },
  addExpenseRecord(rec){
    const record={id:rec.id||uid(), type:'Expense', date:rec.date, category:rec.category, item:rec.item||'', clientId:rec.clientId||null, vendor:rec.vendor||'', payment:rec.payment||'', amount:Number(rec.amount||0), notes:rec.notes||'', receiptImage:rec.receiptImage||null};
    S.transactions.push(record);
    try {
      Storage.save(S);
    } catch(err){
      console.error('Failed to save expense record', err);
      S.transactions.pop();
      alert('Could not save the expense. Storage might be full from receipt images. Please export or delete older receipts and try again.');
      return false;
    }
    UI.refreshDashboard();
    return true;
  }
};

/*** UI ***/
const UI = {
  checklistTicker:null,
  checklistHost:null,
  checklistJobId:null,
  ocrPromise:null,
  jobFilter:'all',
  jobPanelJobId:null,
  editingJobId:null,
  crmStages:['New','Quoted','Booked','In Progress','Paid','Complete'],
  crmColumns:[
    {key:'New',label:'New'},
    {key:'Quoted',label:'Quoted'},
    {key:'Booked',label:'Booked'},
    {key:'In Progress',label:'In Progress'},
    {key:'Paid',label:'Paid'},
    {key:'Complete',label:'Complete'}
  ],
  initHeader(){ const logo=document.getElementById('headerLogo'); logo.src=S.business.logoDataUrl||'icon-192.png'; document.getElementById('headerTitle').textContent=S.business.headerTitle||'POLISH CREW — Accounting'; document.getElementById('openDrawer').onclick=()=>UI.toggleDrawer(true); },
  switchTab(name){
    document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.getAttribute('data-tab')===name));
    document.querySelectorAll('.tabpage').forEach(p=>p.classList.add('hidden'));
    const page=document.getElementById(name);
    if(page) page.classList.remove('hidden');
    if(name==='Clients'){
      this.renderCRMBoard();
      this.renderCRMAppointments();
      this.renderCRMPayments();
    } else if(name==='Marketing'){
      this.renderMarketingTabs();
      this.renderMarketingSection(S.marketing.activeTab||'guerrilla');
    } else if(name==='Playbook'){
      this.loadPlaybook();
    } else if(name==='Checklists'){
      this.renderChecklists();
    } else if(name==='Settings'){
      this.populateSettingsTab();
      this.refreshBrandPolicies();
    } else if(name==='Dashboard'){
      this.refreshDashboard();
    }
  },
  crmNextStatus(status){
    const idx=this.crmStages.indexOf(status||'');
    if(idx>=0 && idx<this.crmStages.length-1) return this.crmStages[idx+1];
    return null;
  },
  updateSyncStatus(state='idle', message=''){
    const node=document.getElementById('syncStatus');
    if(!node) return;
    node.setAttribute('data-state', state);
    if(message) node.textContent=message;
  },
  renderCRMBoard(){
    const host=document.getElementById('crmBoard');
    if(!host) return;
    host.innerHTML='';
    const jobs=[...S.jobs];
    jobs.forEach(job=>App.ensureJobStructure(job));
    this.crmColumns.forEach(col=>{
      const column=el('div',{class:'crm-column'});
      const header=el('div',{class:'crm-column-header'});
      const title=el('span',{},col.label);
      const badge=el('span',{class:'crm-column-badge'},'0');
      header.append(title,badge);
      const body=el('div',{class:'crm-column-body'});
      const columnJobs=jobs.filter(job=>{
        if(col.key==='New') return job.status==='New' || job.status==='Lead';
        return job.status===col.key;
      });
      columnJobs.sort((a,b)=>{
        const dateA=(a.schedule?.date||'')+(a.schedule?.start||'');
        const dateB=(b.schedule?.date||'')+(b.schedule?.start||'');
        return dateA.localeCompare(dateB);
      });
      badge.textContent=columnJobs.length;
      if(!columnJobs.length){
        body.append(el('div',{class:'crm-empty'},'No records here yet.'));
      } else {
        columnJobs.forEach(job=>body.append(this.buildJobCard(job,{context:'crm'})));
      }
      column.append(header,body);
      host.append(column);
    });
  },
  renderCRMAppointments(){
    const list=document.getElementById('crmAppointments');
    if(!list) return;
    list.innerHTML='';
    const todayStr=today();
    const upcoming=[...S.jobs]
      .filter(job=>{
        App.ensureJobStructure(job);
        const date=job.schedule?.date || job.date || '';
        if(!date) return false;
        if(['Complete','Paid'].includes(job.status)) return false;
        return date>=todayStr;
      })
      .sort((a,b)=>{
        const dateA=(a.schedule?.date||'')+(a.schedule?.start||'');
        const dateB=(b.schedule?.date||'')+(b.schedule?.start||'');
        return dateA.localeCompare(dateB);
      })
      .slice(0,8);
    if(!upcoming.length){
      list.append(el('div',{class:'tiny'},'No upcoming appointments.'));
      return;
    }
    upcoming.forEach(job=>{
      const client=S.clients.find(c=>c.id===job.clientId);
      const row=el('div',{class:'list-item'},
        el('div',{style:'font-weight:700;'}, client?.name||'Unknown'),
        el('div',{class:'tiny'}, `${job.schedule?.date||job.date||''} · ${job.schedule?.start||'Any time'} · ${job.status}`),
        el('div',{class:'tiny'}, UI.jobPackageLabel(job))
      );
      list.append(row);
    });
  },
  renderCRMPayments(){
    const list=document.getElementById('crmPayments');
    if(!list) return;
    list.innerHTML='';
    const payments=[...S.transactions]
      .filter(tx=>tx.type==='Income')
      .sort((a,b)=>String(b.date||'').localeCompare(a.date||''))
      .slice(0,6);
    if(!payments.length){
      list.append(el('div',{class:'tiny'},'No payments captured yet.'));
      return;
    }
    payments.forEach(tx=>{
      list.append(this.buildTransactionCard(tx,{showType:false}));
    });
  },
  renderMarketingTabs(){
    const host=document.getElementById('marketingTabs');
    if(!host) return;
    const sections=[
      {id:'guerrilla',label:'Guerrilla Tracker'},
      {id:'campaigns',label:'Paid Campaigns'},
      {id:'log',label:'Marketing Log'},
      {id:'reviews',label:'Review & Referral Boost'}
    ];
    host.innerHTML='';
    sections.forEach(section=>{
      const btn=el('div',{class:`subtab${S.marketing.activeTab===section.id?' active':''}`},section.label);
      btn.addEventListener('click',()=>{
        S.marketing.activeTab=section.id;
        Storage.save(S);
        this.renderMarketingTabs();
        this.renderMarketingSection(section.id);
      });
      host.append(btn);
    });
  },
  renderMarketingSection(tab){
    const host=document.getElementById('marketingContent');
    if(!host) return;
    if(!tab) tab=S.marketing.activeTab||'guerrilla';
    S.marketing.activeTab=tab;
    Storage.save(S);
    host.innerHTML='';
    if(tab==='guerrilla'){
      this.renderMarketingGuerrilla(host);
    } else if(tab==='campaigns'){
      this.renderMarketingCampaigns(host);
    } else if(tab==='log'){
      this.renderMarketingLog(host);
    } else {
      this.renderMarketingReviews(host);
    }
  },
  renderMarketingGuerrilla(host){
    S.marketing.guerrilla.forEach(section=>{
      const card=el('div',{class:'card'});
      card.append(el('h4',{},section.label));
      section.tasks.forEach(task=>{
        const row=el('div',{class:'marketing-metric'});
        row.append(el('div',{},`${task.label}`));
        const input=el('input',{type:'number',min:'0',max:String(task.target||0),value:String(task.completed||0),style:'width:72px;background:#0b0c0f;border-radius:8px;padding:.35rem .4rem;color:#f5f7f7;border:1px solid #1a1e21'});
        input.addEventListener('input',()=>{
          const value=Math.max(0,Math.min(Number(task.target||0),Number(input.value||0)));
          App.updateGuerrillaTask(section.id,task.id,value);
        });
        const progress=task.target?`${task.completed||0}/${task.target}`:`${task.completed||0}`;
        row.append(el('div',{class:'tiny'},progress));
        row.append(input);
        card.append(row);
      });
      host.append(card);
    });
  },
  renderMarketingCampaigns(host){
    const list=el('div',{class:'list',style:'gap:.6rem;'});
    const campaigns=S.marketing.campaigns.slice().sort((a,b)=>String(b.start||'').localeCompare(a.start||''));
    if(!campaigns.length){
      list.append(el('div',{class:'tiny'},'No paid campaigns yet. Track ROI once ads are live.'));
    } else {
      campaigns.forEach(c=>{
        const spend=c.spend||0;
        const jobs=c.newJobs||0;
        const costPer=jobs?spend/Math.max(1,jobs):0;
        const roiMet=jobs?((jobs*3)>=spend):false;
        const card=el('div',{class:'list-item'},
          el('div',{style:'font-weight:700;'},`${c.name||'Campaign'} ${c.channel?`· ${c.channel}`:''}`),
          el('div',{class:'tiny'},`${c.start||'Start'} → ${c.end||'Ongoing'} · Budget/day ${fmt(c.budgetPerDay||0)}`),
          el('div',{class:'tiny'},`Spend: ${fmt(spend)} · New jobs: ${jobs} · Cost/job: ${jobs?fmt(costPer):'--'} · ROI 3× ${roiMet?'✅':'⚠️'}`),
          c.notes?el('div',{class:'tiny'},c.notes):null
        );
        list.append(card);
      });
    }
    const form=el('div',{class:'card'});
    form.append(el('h4',{},'Add Campaign'));
    const name=el('input',{placeholder:'Campaign name'});
    const channel=el('input',{placeholder:'Channel (Meta, Google, etc.)'});
    const budget=el('input',{type:'number',min:'0',step:'1',placeholder:'Budget / day'});
    const start=el('input',{type:'date'});
    const end=el('input',{type:'date'});
    const goals=el('textarea',{placeholder:'Goals'});
    const spendInput=el('input',{type:'number',min:'0',step:'1',placeholder:'Spend to date'});
    const jobsInput=el('input',{type:'number',min:'0',step:'1',placeholder:'New jobs'});
    const notes=el('textarea',{placeholder:'Notes or results'});
    form.append(el('label',{},'Name'), name,
      el('label',{},'Channel'), channel,
      el('label',{},'Budget per day'), budget,
      el('label',{},'Start'), start,
      el('label',{},'End'), end,
      el('label',{},'Goals'), goals,
      el('label',{},'Spend to date'), spendInput,
      el('label',{},'New jobs'), jobsInput,
      el('label',{},'Notes'), notes,
      el('button',{class:'btn',type:'button',onclick:()=>{
        App.addMarketingCampaign({
          name:name.value.trim(),
          channel:channel.value.trim(),
          budgetPerDay:Number(budget.value||0),
          start:start.value,
          end:end.value,
          goals:goals.value.trim(),
          spend:Number(spendInput.value||0),
          newJobs:Number(jobsInput.value||0),
          notes:notes.value.trim()
        });
        name.value=''; channel.value=''; budget.value=''; start.value=''; end.value=''; goals.value=''; spendInput.value=''; jobsInput.value=''; notes.value='';
      }},'Save Campaign'));
    host.append(list,form);
  },
  renderMarketingLog(host){
    const form=el('div',{class:'card'});
    form.append(el('h4',{},'Quick Log'));
    const typeSel=el('select',{});
    DEFAULT_MARKETING_LOG_TYPES.forEach(type=>typeSel.append(el('option',{value:type},type)));
    if(!typeSel.value && DEFAULT_MARKETING_LOG_TYPES.length) typeSel.value=DEFAULT_MARKETING_LOG_TYPES[0];
    const countInput=el('input',{type:'number',min:'0',step:'1',placeholder:'Count'});
    const notesInput=el('input',{placeholder:'Notes'});
    const submit=el('button',{class:'btn',type:'button',onclick:()=>{
      App.logMarketingAction({type:typeSel.value,count:Number(countInput.value||0),notes:notesInput.value.trim()});
      countInput.value='';
      notesInput.value='';
    }},'Log Activity');
    form.append(el('label',{},'Type'),typeSel,el('label',{},'Count'),countInput,el('label',{},'Notes'),notesInput,submit);
    const list=el('div',{class:'list',style:'gap:.4rem;'});
    if(!S.marketing.log.length){
      list.append(el('div',{class:'tiny'},'No marketing actions logged yet. Start with a DM burst or flyer drop.'));
    } else {
      S.marketing.log.slice(0,40).forEach(entry=>{
        list.append(el('div',{class:'list-item'},`${entry.date||today()} · ${entry.type} × ${entry.count||0}${entry.notes?` — ${entry.notes}`:''}`));
      });
    }
    host.append(form,list);
  },
  renderMarketingReviews(host){
    const wrap=el('div',{class:'list',style:'gap:.6rem;'});
    const actions=el('div',{class:'card'},
      el('h4',{},'Review & Referral Boost'),
      el('div',{class:'stack-buttons'},
        el('button',{class:'btn',onclick:()=>UI.promptScript('review')},'Send Review Ask'),
        el('button',{class:'btn secondary',onclick:()=>UI.promptScript('referral')},'Send Referral Text')
      )
    );
    wrap.append(actions);
    const logForm=el('div',{class:'card'});
    logForm.append(el('h4',{},'Log Review'));
    const clientInput=el('input',{placeholder:'Client name'});
    const noteInput=el('input',{placeholder:'Notes or platform'});
    logForm.append(el('label',{},'Client'),clientInput,el('label',{},'Notes'),noteInput,el('button',{class:'btn',type:'button',onclick:()=>{
      App.addReviewEntry({client:clientInput.value.trim(),note:noteInput.value.trim()});
      clientInput.value='';
      noteInput.value='';
    }},'Save Review'));
    wrap.append(logForm);
    const leaderboard=el('div',{class:'card'});
    leaderboard.append(el('h4',{},'Latest Reviews'));
    if(!S.marketing.leaderboard.length){
      leaderboard.append(el('div',{class:'tiny'},'No reviews logged yet. Add notes after each request.'));
    } else {
      S.marketing.leaderboard.slice(0,5).forEach(item=>{
        leaderboard.append(el('div',{class:'list-item'},`${item.date||today()} · ${item.client||'Client'} — ${item.note||'Review received'}`));
      });
    }
    wrap.append(leaderboard);
    host.append(wrap);
  },
  renderFollowUps(){
    const host=document.getElementById('followUpsList');
    if(!host) return;
    host.innerHTML='';
    const reminders=S.reminders.filter(rem=>!rem.done).sort((a,b)=>String(a.dueDate||'').localeCompare(b.dueDate||''));
    if(!reminders.length){
      host.append(el('div',{class:'tiny'},'All clear. Follow-ups will appear here automatically.'));
      return;
    }
    reminders.slice(0,8).forEach(rem=>{
      const client=UI.clientName(rem.clientId);
      const row=el('div',{class:'list-item'},
        el('div',{style:'font-weight:700;'}, `${rem.dueDate||today()} · ${client||'Client'}`),
        el('div',{class:'tiny'}, rem.label||rem.type),
        rem.note?el('div',{class:'tiny'}, rem.note):null,
        el('button',{class:'btn secondary',onclick:()=>App.completeReminder(rem.id,true)},'Done')
      );
      host.append(row);
    });
  },
  renderMarketingProgress(){
    const host=document.getElementById('marketingProgress');
    if(!host) return;
    host.innerHTML='';
    const streak=S.marketing.streak||{count:0,lastActivity:null};
    const last=streak.lastActivity?`Last action ${streak.lastActivity}`:'No activity logged yet';
    host.append(el('div',{class:'marketing-metric'},
      el('div',{},'Streak'),
      el('div',{class:'tiny'}, `${streak.count||0} days`)
    ));
    host.append(el('div',{class:'tiny'}, last));
    const lastActivity=streak.lastActivity?new Date(streak.lastActivity+'T00:00:00'):null;
    const todayDate=new Date(today()+'T00:00:00');
    if(!lastActivity || Math.floor((todayDate-lastActivity)/(1000*60*60*24))>=7){
      host.append(el('div',{class:'crew-callout alert'},'No marketing logged in 7+ days. Run a Guerrilla blitz today.'));
    }
  },
  renderChecklists(){
    App.resetChecklistCadence('daily');
    App.resetChecklistCadence('weekly');
    const renderGroup=(containerId,tasks,{allowRemove=false}={})=>{
      const host=document.getElementById(containerId);
      if(!host) return;
      host.innerHTML='';
      if(!tasks.length){
        host.append(el('div',{class:'tiny'},'No tasks yet.'));
        return;
      }
      tasks.forEach(task=>{
        const row=el('div',{class:'checklist-row','data-complete':task.completedOn?'true':'false'});
        const checkbox=el('input',{type:'checkbox',checked:!!task.completedOn});
        checkbox.addEventListener('change',()=>App.setChecklistComplete(task.id,checkbox.checked));
        row.append(checkbox);
        const label=el('label',{},task.label);
        row.append(label);
        if(task.note){
          row.append(el('div',{class:'tiny'},task.note));
        }
        if(allowRemove){
          row.append(el('button',{class:'btn secondary',onclick:()=>App.removeCustomChecklistTask(task.id)},'Remove'));
        }
        host.append(row);
      });
    };
    renderGroup('dailyChecklist',S.checklists.daily||[]);
    renderGroup('weeklyChecklist',S.checklists.weekly||[]);
    renderGroup('customChecklist',S.checklists.custom||[],{allowRemove:true});
  },
  refreshBrandPolicies(){
    const host=document.getElementById('brandPolicies');
    if(!host) return;
    host.innerHTML='';
    S.policies.forEach(policy=>{
      const row=el('div',{class:'policy-item'});
      const checkbox=el('input',{type:'checkbox',checked:policy.active});
      checkbox.addEventListener('change',()=>{
        policy.active=checkbox.checked;
        Storage.save(S);
      });
      row.append(checkbox, el('div',{},
        el('div',{style:'font-weight:700;'},policy.label),
        el('div',{class:'tiny'},policy.description)
      ));
      host.append(row);
    });
  },
  loadPlaybook(){
    const editor=document.getElementById('playbookEditor');
    if(!editor) return;
    editor.value=S.playbook||DEFAULT_PLAYBOOK;
    this.updatePlaybookPreview();
    this.renderPlaybookToc();
  },
  renderPlaybookToc(){
    const tocHost=document.getElementById('playbookToc');
    if(!tocHost) return;
    tocHost.innerHTML='';
    const sections=(S.playbook||'').split(/\n##\s+/).slice(1);
    sections.forEach(section=>{
      const title=section.split('\n')[0];
      const btn=el('div',{class:'toc-link'},title);
      btn.addEventListener('click',()=>{
        const editor=document.getElementById('playbookEditor');
        if(!editor) return;
        const index=editor.value.indexOf(`## ${title}`);
        if(index>=0){
          editor.focus();
          editor.setSelectionRange(index,index+title.length);
        }
      });
      tocHost.append(btn);
    });
  },
  updatePlaybookPreview(){
    const editor=document.getElementById('playbookEditor');
    const preview=document.getElementById('playbookPreview');
    if(!editor || !preview) return;
    S.playbook=editor.value;
    Storage.save(S);
    preview.innerHTML=this.simpleMarkdown(editor.value);
    this.renderPlaybookToc();
  },
  simpleMarkdown(text){
    const escaped=text.replace(/[&<>]/g,char=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[char]));
    return escaped
      .replace(/^###\s?(.*)$/gm,'<h4>$1</h4>')
      .replace(/^##\s?(.*)$/gm,'<h3>$1</h3>')
      .replace(/^#\s?(.*)$/gm,'<h2>$1</h2>')
      .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
      .replace(/\n\n/g,'</p><p>')
      .replace(/\n/g,'<br>')
      .replace(/^<p>/,'<p>') || '<p></p>';
  },
  filterPlaybook(){
    const query=(document.getElementById('playbookSearch')?.value||'').trim().toLowerCase();
    const preview=document.getElementById('playbookPreview');
    if(!preview) return;
    if(!query){
      this.updatePlaybookPreview();
      return;
    }
    const text=S.playbook||'';
    const regex=new RegExp(`(${query.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&')})`,'gi');
    const highlighted=this.simpleMarkdown(text).replace(regex,'<mark>$1</mark>');
    preview.innerHTML=highlighted;
  },
  exportPlaybook(){
    const popup=window.open('','_blank');
    if(!popup || popup.closed){ alert('Allow pop-ups to export the playbook.'); return; }
    const html=`<!doctype html><html><head><meta charset="utf-8"><title>Polish Crew Playbook</title><style>body{font-family:Montserrat,Arial,sans-serif;padding:24px;} h2,h3,h4{color:#0b1a12;} mark{background:#ffe08a;}</style></head><body><h1>Polish Crew — 2025 Playbook</h1>${this.simpleMarkdown(S.playbook||'')}</body></html>`;
    popup.document.write(html);
    popup.document.close();
  },
  resetPlaybook(){
    if(!confirm('Reset playbook to default text?')) return;
    S.playbook=DEFAULT_PLAYBOOK;
    Storage.save(S);
    this.loadPlaybook();
    UI.flash('Playbook reset.');
  },
  populateSettingsTab(){
    const biz=document.getElementById('settingsBusiness');
    const header=document.getElementById('settingsHeader');
    const city=document.getElementById('settingsCity');
    if(biz){
      biz.value=S.business.name||'';
      biz.onchange=()=>{
        S.business.name=biz.value.trim();
        Storage.save(S);
        UI.initHeader();
        UI.flash('Brand name updated.');
      };
    }
    if(header){
      header.value=S.business.headerTitle||'';
      header.onchange=()=>{
        S.business.headerTitle=header.value.trim();
        Storage.save(S);
        UI.initHeader();
        UI.flash('Header updated.');
      };
    }
    if(city){
      city.value=S.business.city||'';
      city.onchange=()=>{
        S.business.city=city.value.trim();
        Storage.save(S);
        UI.flash('City updated.');
      };
    }
    this.updateSyncToggle();
  },
  updateSyncToggle(){
    const toggle=document.getElementById('syncToggle');
    if(toggle) toggle.checked=!!S.settings.syncEnabled;
  },
  openScripts(){
    const list=el('div',{class:'list',style:'gap:.6rem;'});
    Object.entries(S.scripts).forEach(([key,value])=>{
      const label=key.replace(/([A-Z])/g,' $1').replace(/^./,c=>c.toUpperCase());
      const item=el('div',{class:'card'},
        el('h4',{},label),
        el('div',{class:'tiny'},value),
        el('div',{class:'stack-buttons'},
          el('button',{class:'btn',onclick:()=>UI.copyText(value)},'Copy'),
          el('button',{class:'btn secondary',onclick:()=>UI.promptScript(key)},'Open')
        )
      );
      list.append(item);
    });
    this.modal('Scripts & Templates',close=>close(),list,'Close',false,true);
  },
  openPolicies(){
    this.switchTab('Settings');
    const container=document.getElementById('brandPolicies');
    if(container) container.scrollIntoView({behavior:'smooth'});
  },
  promptScript(key,job=null){
    const script=S.scripts[key] || DEFAULT_SCRIPTS[key] || '';
    if(!script){
      UI.flash('Script not found.');
      return;
    }
    const text=script
      .replace(/\[Name\]/g, job?UI.clientName(job.clientId):'Client')
      .replace(/\[Vehicle\]/g, job?UI.jobVehicleSummary(job):'vehicle')
      .replace(/\[Package\]/g, job?UI.jobPackageLabel(job):'package')
      .replace(/\[City\]/g, S.business.city||'');
    const content=el('div',{class:'form-grid'},
      el('div',{class:'tiny'},'Copy and send via SMS, DM, or email.'),
      el('textarea',{style:'min-height:160px;',value:text,readonly:true})
    );
    this.modal('Script',()=>{ UI.copyText(text); UI.flash('Copied to clipboard.'); },content,'Copy Script');
  },
  copyText(value){
    if(navigator.clipboard){
      navigator.clipboard.writeText(value).then(()=>UI.flash('Copied.')).catch(()=>{
        const temp=document.createElement('textarea');
        temp.value=value;
        document.body.append(temp);
        temp.select();
        document.execCommand('copy');
        temp.remove();
        UI.flash('Copied.');
      });
    }
  },
  initTabs(){ document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>UI.switchTab(t.getAttribute('data-tab')))); },
  packageOptionLabel(name,size){
    const price=Calc.base(name,size);
    const meta=pkgMeta(name);
    const included=(meta.includedAddons||[]).filter(Boolean);
    const description=(meta.description||'').trim();
    const descText=description?` • ${description}`:'';
    const includeText=included.length?` • Includes: ${included.join(', ')}`:'';
    return `${name} — ${fmt(price)}${descText}${includeText}`;
  },
  updatePackageSelectOptions(sel,{preferred}={}){
    if(!sel) return;
    const row=sel.closest('.vehicle-row');
    const size=row?.querySelector('.vehicle-size')?.value || S.menu.sizes[0] || '';
    const packageNames=Object.keys(S.menu.packages);
    const desired=(preferred && S.menu.packages[preferred])?preferred:((sel.value && S.menu.packages[sel.value])?sel.value:'');
    sel.innerHTML='';
    packageNames.forEach(name=>sel.append(el('option',{value:name},UI.packageOptionLabel(name,size))));
    if(desired && S.menu.packages[desired]) sel.value=desired;
    else if(sel.options.length) sel.value=sel.options[0].value;
  },
  addonOptionLabel(name,size,meta){
    const price=Calc.addonPrice(name,size);
    const included=!!meta?.includedAddons?.includes(name);
    return `${name} — ${fmt(price)}${included?' (Included)':''}`;
  },
  populateClients(selectId){ const sel=document.getElementById('jobClient'); if(sel){ sel.innerHTML='<option value="">-- select client --</option>'; for(const c of S.clients){ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; sel.appendChild(o); } if(selectId) sel.value=selectId; }
    const list=document.getElementById('clientsList');
    if(list){
      list.innerHTML='';
      const formatter=(date)=>{
        if(!date) return '--';
        try { return new Date(date+'T00:00:00').toLocaleDateString(); } catch(err){ return date; }
      };
      for(const c of S.clients){
        const vehicles=Array.isArray(c.vehicles)?c.vehicles:[];
        const jobs=S.jobs.filter(job=>job.clientId===c.id);
        const completed=jobs.filter(job=>['Complete','Paid'].includes(job.status));
        const lifetime=S.transactions.filter(tx=>tx.clientId===c.id && tx.type==='Income').reduce((sum,tx)=>sum+Number(tx.amount||0),0);
        const lastJob=completed.reduce((latest,job)=>{
          const date=job.completedAt||job.schedule?.date||job.date||'';
          if(!date) return latest;
          return !latest || date>latest?date:latest;
        },'');
        const nextService=lastJob?(()=>{ const dt=new Date(lastJob+'T00:00:00'); dt.setDate(dt.getDate()+30); return dt.toISOString().slice(0,10); })():'';
        const pendingReminder=S.reminders.find(rem=>rem.clientId===c.id && !rem.done);
        const loyaltyLabel=(c.loyalty||'new').toUpperCase();
        const summary=el('div',{class:'list-item'},
          el('div',{class:'row',style:'justify-content:space-between;align-items:flex-start;gap:.5rem;'},
            el('div',{},
              el('div',{style:'font-weight:700;'}, c.name||'Client'),
              el('div',{class:'tiny'}, [c.city||'', [c.phone,c.email].filter(Boolean).join(' • ')].filter(Boolean).join(' · '))
            ),
            el('div',{class:'row',style:'gap:.35rem;align-items:center;'},
              el('span',{class:'pill'}, loyaltyLabel),
              el('button',{class:'pill',onclick:()=>UI.openClientVehicles(c.id)},'Vehicles')
            )
          ),
          el('div',{class:'tiny'},`Lifetime spend: ${fmt(lifetime)} · Jobs completed: ${completed.length}`),
          el('div',{class:'tiny'},`Last service: ${lastJob?formatter(lastJob):'--'} · Next recommended: ${nextService?formatter(nextService):'--'}`),
          ...(pendingReminder?[el('div',{class:'crew-callout alert'},`Reminder due ${pendingReminder.dueDate}: ${pendingReminder.label}`)]:[]),
          ...(c.notes?[el('div',{class:'tiny'},c.notes)]:[]),
          ...(vehicles.length?vehicles.map(v=>{
            const service=v.lastService;
            const addonsLabel=service?.addons&&service.addons.length?` (${service.addons.join(', ')})`:'';
            const pkgLabel=service?.pkg?` — ${service.pkg}`:'';
            const serviceText=service?`Last service: ${service.date||'Unknown date'}${pkgLabel}${addonsLabel}`:'No service recorded yet.';
            return el('div',{class:'tiny'},`${v.label||'Vehicle'}${v.size?` · ${v.size}`:''} · ${serviceText}`);
          }):[el('div',{class:'tiny'},'No vehicles saved yet.')])
        );
        list.append(summary);
      }
    }
    UI.refreshClientVehicleOptions();
  },
  refreshClientVehicleOptions(){
    const clientId=document.getElementById('jobClient')?.value || '';
    const client=S.clients.find(c=>c.id===clientId);
    const vehicles=client?.vehicles||[];
    document.querySelectorAll('.vehicle-row').forEach(row=>{
      const sel=row.querySelector('.vehicle-existing');
      if(!sel) return;
      const current=sel.value;
      sel.innerHTML='';
      sel.append(el('option',{value:''}, clientId?'New vehicle':'Select client first'));
      vehicles.forEach(v=>sel.append(el('option',{value:v.id},v.label||'Unnamed Vehicle')));
      if(current && vehicles.some(v=>v.id===current)) sel.value=current;
      else sel.value='';
      if(sel.value){ row.setAttribute('data-client-vehicle-id', sel.value); }
      else row.removeAttribute('data-client-vehicle-id');
    });
  },
  onClientChange(){
    UI.refreshClientVehicleOptions();
  },
  updateJobFormEditingUI(job){
    const saveBtn=document.getElementById('jobSaveBtn');
    const quoteBtn=document.getElementById('quoteSaveBtn');
    const cancelBtn=document.getElementById('jobEditCancel');
    if(job){
      if(saveBtn) saveBtn.textContent=job.status==='Quoted'?'Book Job':'Update Job';
      if(quoteBtn){
        if(['Paid','Complete'].includes(job.status)){
          quoteBtn.classList.add('hidden');
        } else {
          quoteBtn.classList.remove('hidden');
          quoteBtn.textContent=job.status==='Quoted'?'Update Quote':'Save as Quote';
        }
      }
      if(cancelBtn) cancelBtn.classList.remove('hidden');
    } else {
      if(saveBtn) saveBtn.textContent='Schedule Job';
      if(quoteBtn){
        quoteBtn.classList.remove('hidden');
        quoteBtn.textContent='Save Quote';
      }
      if(cancelBtn) cancelBtn.classList.add('hidden');
    }
  },
  editJob(jobId){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    App.ensureJobStructure(job);
    this.switchTab('QuoteBuilder');
    this.editingJobId=jobId;
    this.populateClients(job.clientId);
    const clientSel=document.getElementById('jobClient');
    if(clientSel) clientSel.value=job.clientId||'';
    const list=document.getElementById('vehiclesList');
    if(list){
      list.innerHTML='';
    }
    this.onClientChange();
    if(list){
      if(Array.isArray(job.vehicles) && job.vehicles.length){
        job.vehicles.forEach(vehicle=>{
          const clone={...vehicle};
          if(Array.isArray(vehicle.addons)) clone.addons=vehicle.addons.map(a=>({...a}));
          this.addVehicle(clone);
        });
      } else {
        this.addVehicle();
      }
    }
    const schedule=job.schedule||{};
    const dateInput=document.getElementById('jobDate');
    if(dateInput) dateInput.value=schedule.date || job.date || today();
    const startInput=document.getElementById('jobStart');
    if(startInput) startInput.value=schedule.start || '';
    const endInput=document.getElementById('jobEnd');
    if(endInput) endInput.value=schedule.end || '';
    const durationInput=document.getElementById('jobDuration');
    if(durationInput){
      const mins=Number(schedule.durationMinutes||0);
      durationInput.value=mins>0?formatDurationMinutes(mins):'';
    }
    const discTypeSel=document.getElementById('jobDiscType');
    if(discTypeSel) discTypeSel.value=job.discType||'none';
    const discValueInput=document.getElementById('jobDiscValue');
    if(discValueInput) discValueInput.value=Number(job.discValue||0);
    const discScopeSel=document.getElementById('jobDiscScope');
    if(discScopeSel) discScopeSel.value=job.discScope==='vehicle'?'vehicle':'job';
    const notesInput=document.getElementById('jobNotes');
    if(notesInput) notesInput.value=job.notes||'';
    this.updateTotals();
    this.updateJobFormEditingUI(job);
    this.flash('Edit mode enabled for this job.');
  },
  cancelJobEdit(){
    if(!this.editingJobId){
      this.updateJobFormEditingUI(null);
      return;
    }
    this.resetJobForm();
    this.flash('Edit cancelled.');
  },
  openClientVehicles(id){
    const client=S.clients.find(c=>c.id===id);
    if(!client) return;
    if(!Array.isArray(client.vehicles)) client.vehicles=[];
    const list=el('div',{class:'list',style:'gap:.5rem;'});
    const renderList=()=>{
      list.innerHTML='';
      if(!client.vehicles.length){
        list.append(el('div',{class:'tiny'},'No vehicles saved yet.'));
        return;
      }
      client.vehicles.forEach(v=>{
        if(!v.id) v.id=uid();
        const item=el('div',{class:'list-item'});
        const header=el('div',{class:'row',style:'gap:.5rem;flex-wrap:wrap;align-items:flex-end;'});
        const labelWrap=el('div',{style:'flex:1;min-width:200px;'});
        labelWrap.append(el('label',{},'Vehicle'), el('input',{value:v.label||'',placeholder:'Year / Make / Model',oninput:(e)=>{ v.label=e.target.value.trim(); }}));
        const sizeWrap=el('div',{style:'flex:1;min-width:160px;'});
        const sizeSel=el('select',{});
        sizeSel.append(el('option',{value:''},'Size not set'));
        S.menu.sizes.forEach(s=>sizeSel.append(el('option',{value:s},s)));
        sizeSel.value=v.size||'';
        sizeSel.addEventListener('change',()=>{ v.size=sizeSel.value; });
        sizeWrap.append(el('label',{},'Size'), sizeSel);
        const removeBtn=el('button',{class:'btn secondary',type:'button'},'Remove');
        removeBtn.addEventListener('click',()=>{
          if(confirm('Remove this vehicle?')){
            client.vehicles=client.vehicles.filter(x=>x.id!==v.id);
            renderList();
          }
        });
        header.append(labelWrap,sizeWrap,removeBtn);
        item.append(header);
        const service=v.lastService;
        const addonsLabel=service?.addons&&service.addons.length?` (${service.addons.join(', ')})`:'';
        const pkgLabel=service?.pkg?` — ${service.pkg}`:'';
        item.append(el('div',{class:'tiny',style:'margin-top:.25rem;'}, service?`Last service: ${service.date||'Unknown date'}${pkgLabel}${addonsLabel}`:'No recorded service yet.'));
        list.append(item);
      });
    };
    renderList();
    const addLabel=el('input',{placeholder:'Year / Make / Model'});
    const addSize=el('select',{});
    addSize.append(el('option',{value:''},'Size not set'));
    S.menu.sizes.forEach(s=>addSize.append(el('option',{value:s},s)));
    const addButton=el('button',{class:'btn',type:'button'},'Add Vehicle');
    addButton.addEventListener('click',()=>{
      const label=addLabel.value.trim();
      if(!label) return alert('Vehicle description required');
      client.vehicles.push({id:uid(), label, size:addSize.value||'', lastService:null, history:[]});
      addLabel.value='';
      addSize.value='';
      renderList();
    });
    const content=el('div',{}, list, el('div',{class:'row',style:'gap:.5rem;margin-top:.75rem;align-items:flex-end;flex-wrap:wrap;'},
      el('div',{style:'flex:1;min-width:220px;'}, el('label',{},'Vehicle'), addLabel),
      el('div',{style:'flex:1;min-width:160px;'}, el('label',{},'Size'), addSize),
      addButton
    ));
    UI.modal('Client Vehicles',(close)=>{
      client.vehicles=client.vehicles.filter(v=>(v.label||'').trim());
      Storage.save(S);
      UI.populateClients(client.id);
      UI.refreshClientVehicleOptions();
      UI.flash('Vehicles updated.');
      close();
    },content,'Done',true,true);
  },
  populateSizesAndPackages(){
    document.querySelectorAll('.vehicle-package').forEach(sel=>{
      UI.updatePackageSelectOptions(sel);
      const row=sel.closest('.vehicle-row');
      if(row) UI.refreshVehicleRow(row,{setBase:true, skipPackageSync:true});
    });
    document.querySelectorAll('.vehicle-size').forEach(sel=>{
      const current=sel.value;
      sel.innerHTML='';
      S.menu.sizes.forEach(size=>sel.append(el('option',{value:size},size)));
      if(S.menu.sizes.includes(current)) sel.value=current;
      else if(S.menu.sizes.length) sel.value=S.menu.sizes[0];
    });
  },
  handlePackageChange(){
    document.querySelectorAll('.vehicle-row').forEach(row=>{
      UI.refreshVehicleRow(row,{setBase:true});
    });
    UI.updateTotals();
  },
  prefillBase(){ this.handlePackageChange(); },
  renderAddons(){ this.handlePackageChange(); },
  addVehicle(prefill={}){
    const list=document.getElementById('vehiclesList');
    if(!list) return;
    const sizeOptions=S.menu.sizes;
    const sizePref=(prefill.size && sizeOptions.includes(prefill.size))?prefill.size:(sizeOptions[0]||'');
    const pkgOptions=Object.keys(S.menu.packages);
    const pkgPref=(prefill.pkg && S.menu.packages[prefill.pkg])?prefill.pkg:(pkgOptions[0]||'');
    const baseDefault=Calc.base(pkgPref,sizePref);
    const baseValue=prefill.base!=null?Number(prefill.base):baseDefault;
    const row=el('div',{class:'list-item vehicle-row'});
    const header=el('div',{class:'row',style:'gap:.5rem;flex-wrap:wrap;align-items:flex-end;'});

    const clientId=document.getElementById('jobClient')?.value || '';
    const client=S.clients.find(c=>c.id===clientId);
    const knownVehicles=client?.vehicles||[];
    const labelPref=(prefill.label||'');
    const clientVehicleIdPref=prefill.clientVehicleId||prefill.vehicleId||'';
    const vehicleWrap=el('div',{style:'flex:1;min-width:240px;'});
    vehicleWrap.append(el('label',{},'Vehicle'));
    const vehicleRow=el('div',{class:'row',style:'gap:.4rem;'});
    const vehicleSel=el('select',{class:'vehicle-existing'});
    vehicleSel.append(el('option',{value:''}, clientId?'New vehicle':'Select client first'));
    knownVehicles.forEach(v=>vehicleSel.append(el('option',{value:v.id},v.label||'Unnamed Vehicle')));
    if(clientVehicleIdPref && knownVehicles.some(v=>v.id===clientVehicleIdPref)) vehicleSel.value=clientVehicleIdPref;
    const vehicleInput=el('input',{class:'vehicle-label',placeholder:'Year / Make / Model',value:labelPref});
    if(vehicleSel.value) row.setAttribute('data-client-vehicle-id', vehicleSel.value);
    if(labelPref) row.setAttribute('data-vehicle-label', labelPref);
    vehicleInput.addEventListener('input',()=>{ row.setAttribute('data-vehicle-label', vehicleInput.value.trim()); });
    vehicleRow.append(vehicleSel,vehicleInput);
    vehicleWrap.append(vehicleRow);
    header.append(vehicleWrap);

    const pkgWrap=el('div',{style:'flex:1;min-width:200px;'});
    pkgWrap.append(el('label',{},'Package'));
    const pkgRow=el('div',{class:'row',style:'gap:.4rem;'});
    const pkgSel=el('select',{class:'vehicle-package'});
    UI.updatePackageSelectOptions(pkgSel,{preferred:pkgPref});
    pkgRow.append(pkgSel);
    pkgWrap.append(pkgRow);
    header.append(pkgWrap);

    const sizeWrap=el('div',{style:'flex:1;min-width:160px;'});
    sizeWrap.append(el('label',{},'Vehicle Size'));
    const sizeSel=el('select',{class:'vehicle-size'});
    sizeOptions.forEach(s=>sizeSel.append(el('option',{value:s},s)));
    if(sizePref) sizeSel.value=sizePref;
    sizeWrap.append(sizeSel);
    header.append(sizeWrap);

    const baseWrap=el('div',{style:'flex:1;min-width:140px;'});
    baseWrap.append(el('label',{},'Base'));
    const baseInput=el('input',{type:'number',min:'0',step:'0.01',class:'vehicle-base',value:Number(baseValue||0).toFixed(2)});
    baseWrap.append(baseInput);
    header.append(baseWrap);

    const removeWrap=el('div',{style:'flex:0;'});
    removeWrap.append(el('label',{},'\u00a0'));
    const removeBtn=el('button',{class:'btn secondary vehicle-remove',onclick:()=>UI.removeVehicle(row)},'Remove');
    removeWrap.append(removeBtn);
    header.append(removeWrap);

    row.append(header);
    const pkgInfo=el('div',{class:'vehicle-package-info hidden'});
    row.append(pkgInfo);
    const addonsHost=el('div',{class:'list vehicle-addons',style:'margin-top:.6rem;gap:.4rem;'});
    row.append(addonsHost);
    list.append(row);

    const syncSelectedVehicle=()=>{
      const selectedId=vehicleSel.value;
      if(selectedId && client){
        const record=client.vehicles.find(v=>v.id===selectedId);
        if(record){
          if(record.label){
            vehicleInput.value=record.label;
            row.setAttribute('data-vehicle-label', record.label);
          }
          if(record.size && sizeOptions.includes(record.size)){
            sizeSel.value=record.size;
          }
        }
        row.setAttribute('data-client-vehicle-id', selectedId);
      } else {
        row.removeAttribute('data-client-vehicle-id');
      }
    };

    vehicleSel.addEventListener('change',()=>{
      syncSelectedVehicle();
      UI.refreshVehicleRow(row,{setBase:true});
      UI.updateTotals();
    });

    syncSelectedVehicle();

    UI.refreshVehicleRow(row,{skipAddons:true});
    UI.renderVehicleAddons(row, prefill.addons||null);

    baseInput.addEventListener('input',()=>UI.updateTotals());
    sizeSel.addEventListener('change',()=>{ UI.refreshVehicleRow(row,{setBase:true}); UI.updateTotals(); });
    pkgSel.addEventListener('change',()=>{ UI.refreshVehicleRow(row,{setBase:true}); UI.updateTotals(); });

    UI.syncVehicleRemovers();
    UI.refreshClientVehicleOptions();
    UI.updateTotals();
  },
  removeVehicle(row){
    const list=document.getElementById('vehiclesList');
    if(!list) return;
    if(list.querySelectorAll('.vehicle-row').length<=1){
      UI.flash('At least one vehicle required.');
      return;
    }
    row.remove();
    UI.syncVehicleRemovers();
    UI.updateTotals();
  },
  refreshVehicleRow(row,{setBase=false, skipAddons=false, skipPackageSync=false}={}){
    const pkgSel=row.querySelector('.vehicle-package');
    if(pkgSel && !skipPackageSync){
      UI.updatePackageSelectOptions(pkgSel,{preferred:pkgSel.value});
    }
    const pkg=pkgSel?.value || '';
    const meta=pkgMeta(pkg);
    const sizeSel=row.querySelector('.vehicle-size');
    const baseInput=row.querySelector('.vehicle-base');
    const size=sizeSel?.value || S.menu.sizes[0] || '';
    if(setBase && baseInput){
      const base=Calc.base(pkg,size);
      baseInput.value=Number(base||0).toFixed(2);
    }
    if(baseInput) baseInput.disabled=!!meta.lock;
    row.setAttribute('data-pkg',pkg);
    UI.renderVehiclePackageInfo(row, meta);
    if(!skipAddons) UI.renderVehicleAddons(row);
  },
  renderVehiclePackageInfo(row, metaOverride=null){
    const info=row.querySelector('.vehicle-package-info');
    if(!info) return;
    const pkgSel=row.querySelector('.vehicle-package');
    const pkg=pkgSel?.value || '';
    const size=row.querySelector('.vehicle-size')?.value || S.menu.sizes[0] || '';
    if(!pkg){
      info.innerHTML='';
      info.classList.add('hidden');
      return;
    }
    const meta=metaOverride || pkgMeta(pkg);
    const included=(meta.includedAddons||[]).filter(Boolean);
    const description=(meta.description||'').trim();
    info.innerHTML='';
    info.classList.remove('hidden');
    info.append(el('h4',{}, pkg));
    info.append(el('div',{class:'tiny',style:'color:#9fb2ae;font-weight:700;'},`Base for ${size||'selected size'}: ${fmt(Calc.base(pkg,size))}`));
    if(description) info.append(el('p',{}, description));
    if(included.length){
      info.append(el('div',{class:'muted',style:'font-size:.8rem;font-weight:700;color:#9db0a9;'},'Included add-ons'));
      const list=el('ul',{});
      included.forEach(name=>list.append(el('li',{},name)));
      info.append(list);
    } else if(!description){
      info.append(el('p',{class:'tiny',style:'color:#8f9a9a;'},'No add-ons are included by default for this package.'));
    }
  },
  renderVehicleAddons(row,preset=null){
    const host=row.querySelector('.vehicle-addons');
    if(!host) return;
    const pkgSel=row.querySelector('.vehicle-package');
    const pkg=pkgSel?.value || '';
    const size=row.querySelector('.vehicle-size')?.value || S.menu.sizes[0] || '';
    const meta=pkgMeta(pkg);
    const previous=new Map();
    if(preset){
      (preset||[]).forEach(a=>previous.set(a.name,{price:Number(a.price||0), included:a.included || meta.includedAddons?.includes(a.name)}));
    } else {
      host.querySelectorAll('.vehicle-addon-row').forEach(node=>{
        const name=node.getAttribute('data-name');
        const price=node.querySelector('input[type=number]');
        const included=node.getAttribute('data-included')==='true';
        previous.set(name,{price:Number(price?.value||0), included});
      });
    }
    host.innerHTML='';

    const controlRow=el('div',{class:'row',style:'gap:.5rem;align-items:flex-end;'});
    const select=el('select',{class:'vehicle-addon-picker'});
    select.append(el('option',{value:''},'Add add-on…'));
    Object.keys(S.menu.addons).forEach(name=>select.append(el('option',{value:name},UI.addonOptionLabel(name,size,meta))));
    const addBtn=el('button',{class:'btn secondary',type:'button'},'Add');
    controlRow.append(select,addBtn);
    host.append(controlRow);

    const selectedWrap=el('div',{class:'list vehicle-addon-selected',style:'margin-top:.5rem;gap:.4rem;'});
    host.append(selectedWrap);

    const chosen=new Set();
    const refreshOptions=()=>{
      Array.from(select.options).forEach(opt=>{
        if(!opt.value) return;
        opt.disabled=chosen.has(opt.value);
      });
    };

    const addRow=(name,info={})=>{
      if(!name || !S.menu.addons[name] || chosen.has(name)) return;
      const included=info.included || !!meta.includedAddons?.includes(name);
      const basePrice=Calc.addonPrice(name,size);
      const priceVal=included?0:(info.price!=null?Number(info.price):basePrice);
      const rowEl=el('div',{class:'list-item vehicle-addon-row','data-name':name,'data-included':included?'true':'false'});
      const rowContent=el('div',{class:'row',style:'align-items:center;gap:.5rem;'});
      rowContent.append(el('div',{style:'flex:1;font-weight:800;'}, name + (included?' — Included':'')));
      const priceInput=el('input',{type:'number',min:'0',step:'0.01',value:Number(priceVal||0).toFixed(2),style:'flex:0;width:120px;'});
      if(included) priceInput.disabled=true;
      const setStoredPrice=(val)=>previous.set(name,{price:val, included});
      setStoredPrice(Number(priceVal||0));
      priceInput.addEventListener('input',()=>{
        setStoredPrice(Number(priceInput.value||0));
        UI.updateTotals();
      });
      rowContent.append(priceInput);
      if(included){
        rowContent.append(el('span',{class:'pill',style:'flex:0 0 auto;'},'Included'));
      } else {
        const removeBtn=el('button',{class:'btn secondary',type:'button'},'Remove');
        removeBtn.addEventListener('click',()=>{
          chosen.delete(name);
          rowEl.remove();
          previous.delete(name);
          refreshOptions();
          UI.updateTotals();
        });
        rowContent.append(removeBtn);
      }
      rowEl.append(rowContent);
      selectedWrap.append(rowEl);
      chosen.add(name);
      refreshOptions();
      UI.updateTotals();
    };

    const includedSet=new Set(meta.includedAddons||[]);
    const initialMap=new Map();
    previous.forEach((info,name)=>{
      const included=includedSet.has(name) || info.included;
      initialMap.set(name,{name, price:included?0:Number(info.price||0), included});
    });
    includedSet.forEach(name=>{
      if(!initialMap.has(name)) initialMap.set(name,{name, price:0, included:true});
      else {
        const item=initialMap.get(name);
        initialMap.set(name,{name, price:0, included:true});
      }
    });
    initialMap.forEach(item=>addRow(item.name,item));

    addBtn.addEventListener('click',()=>{
      const value=select.value;
      if(!value) return;
      addRow(value,previous.get(value)||{});
      select.value='';
      refreshOptions();
    });
    select.addEventListener('change',()=>{
      if(!select.value) return;
      addRow(select.value,previous.get(select.value)||{});
      select.value='';
      refreshOptions();
    });

    refreshOptions();
  },
  syncVehicleRemovers(){
    const rows=document.querySelectorAll('.vehicle-row');
    rows.forEach(row=>{
      const btn=row.querySelector('.vehicle-remove');
      if(btn) btn.classList.toggle('hidden', rows.length<=1);
    });
  },
  collectVehicles(){
    return Array.from(document.querySelectorAll('.vehicle-row')).map(row=>{
      const size=row.querySelector('.vehicle-size')?.value || '';
      const base=Number(row.querySelector('.vehicle-base')?.value||0);
      const pkg=row.querySelector('.vehicle-package')?.value || '';
      const label=row.querySelector('.vehicle-label')?.value.trim() || '';
      const clientVehicleId=row.querySelector('.vehicle-existing')?.value || '';
      const addons=Array.from(row.querySelectorAll('.vehicle-addon-row')).map(aRow=>{
        const priceInput=aRow.querySelector('input[type=number]');
        const name=aRow.getAttribute('data-name');
        const price=Number(priceInput?.value||0);
        const included=aRow.getAttribute('data-included')==='true';
        return {name, price, included};
      }).filter(a=>a && a.name);
      const vehicle={size, base, addons, pkg};
      if(label) vehicle.label=label;
      if(clientVehicleId) vehicle.clientVehicleId=clientVehicleId;
      return vehicle;
    });
  },
  updateTotals(){
    const vehicles=this.collectVehicles();
    const job={
      pkg:vehicles[0]?.pkg || '',
      vehicles,
      discType:document.getElementById('jobDiscType').value,
      discValue:Number(document.getElementById('jobDiscValue').value||0),
      discScope:document.getElementById('jobDiscScope').value
    };
    const subtotal=Calc.subtotal(job);
    const discount=Calc.discount(job);
    const total=Calc.total(job);
    document.getElementById('jobSubtotal').textContent=fmt(subtotal);
    document.getElementById('jobDiscount').textContent=fmt(discount);
    document.getElementById('jobTotal').textContent=fmt(total);
    this.renderAddonSummary(vehicles);
  },
  renderAddonSummary(vehicles){
    const host=document.getElementById('addonSummary');
    if(!host) return;
    host.innerHTML='';
    if(!vehicles.length){
      host.append(el('div',{style:'font-weight:800;'},'Add-on guidance'));
      host.append(el('div',{class:'tiny'},'Add vehicles to compare Maintenance vs. Full Detail.'));
      host.classList.remove('alert');
      return;
    }
    const summary=Calc.addonSummary({vehicles});
    host.append(el('div',{style:'font-weight:800;'}, summary.requiresUpgrade ? '⚠️ Add-on upgrade recommended' : 'Add-on guidance'));
    host.append(el('div',{class:'tiny'}, summary.message));
    if(summary.totalIncluded){
      host.append(el('div',{class:'tiny'}, `Included add-ons: ${summary.totalIncluded}`));
    }
    if(summary.perVehicle.length>1){
      host.append(el('div',{class:'tiny'}, summary.perVehicle.map((info,idx)=>`Vehicle ${idx+1}: ${info.custom} custom / ${info.included} included`).join(' · ')));
    } else if(summary.perVehicle.length===1){
      const info=summary.perVehicle[0];
      host.append(el('div',{class:'tiny'}, `${info.custom} custom · ${info.included} included add-ons`));
    }
    host.append(el('div',{class:'tiny'}, summary.upsell));
    host.classList.toggle('alert', summary.requiresUpgrade);
  },
  refreshDashboard(){
    const month=today().slice(0,7);
    let income=0;
    let expense=0;
    for(const t of S.transactions){
      const date=(t.date||'').slice(0,7);
      if(date!==month) continue;
      const amount=Number(t.amount||0);
      if(t.type==='Income') income+=amount;
      else if(t.type==='Expense') expense+=amount;
    }
    const net=income-expense;
    const incomeEl=document.getElementById('mIncome');
    const expenseEl=document.getElementById('mExpense');
    const netEl=document.getElementById('mNet');
    if(incomeEl) incomeEl.textContent=fmt(income);
    if(expenseEl) expenseEl.textContent=fmt(expense);
    if(netEl) netEl.textContent=fmt(net);
    this.renderCRMPayments();
    this.renderFollowUps();
    this.renderMarketingProgress();
  },
  quickDisc(type,val){ document.getElementById('jobDiscType').value=type; document.getElementById('jobDiscValue').value=val; UI.updateTotals(); },
  resetJobForm(){
    const list=document.getElementById('vehiclesList');
    if(list) list.innerHTML='';
    this.addVehicle();
    this.handlePackageChange();
    const discType=document.getElementById('jobDiscType');
    if(discType) discType.value='none';
    const discValue=document.getElementById('jobDiscValue');
    if(discValue) discValue.value='0';
    const discScope=document.getElementById('jobDiscScope');
    if(discScope) discScope.value='job';
    const notes=document.getElementById('jobNotes');
    if(notes) notes.value='';
    const dateInput=document.getElementById('jobDate');
    if(dateInput) dateInput.value=today();
    const startInput=document.getElementById('jobStart');
    if(startInput) startInput.value='';
    const endInput=document.getElementById('jobEnd');
    if(endInput) endInput.value='';
    const durationInput=document.getElementById('jobDuration');
    if(durationInput) durationInput.value='';
    this.editingJobId=null;
    this.updateJobFormEditingUI(null);
    const quoteBtn=document.getElementById('quoteSaveBtn');
    if(quoteBtn){
      quoteBtn.textContent='Save Quote';
      quoteBtn.classList.remove('hidden');
    }
    const jobBtn=document.getElementById('jobSaveBtn');
    if(jobBtn) jobBtn.textContent='Schedule Job';
    this.updateTotals();
  },
  jobVehicleSummary(job){ const vehicles=Calc.vehicles(job); if(!vehicles.length) return ''; const counts={}; vehicles.forEach(v=>{ const key=v.size||'Vehicle'; counts[key]=(counts[key]||0)+1; }); return Object.entries(counts).map(([size,count])=>count>1?`${size} × ${count}`:size).join(', '); },
  jobPackageLabel(job){
    const vehicles=Calc.vehicles(job);
    const names=[...new Set(vehicles.map(v=>v.pkg).filter(Boolean))];
    if(names.length===1) return names[0];
    if(names.length>1) return 'Multiple Packages';
    return job.pkg || '';
  },
  buildJobCard(job,{context='jobs'}={}){
    App.ensureJobStructure(job);
    const client=S.clients.find(x=>x.id===job.clientId);
    const scheduleDate=job.schedule?.date || job.date || '';
    const dateLabel=scheduleDate ? new Date(scheduleDate+'T00:00:00').toLocaleDateString() : 'No date';
    const timeLabel=job.schedule?.start ? `${job.schedule.start}${job.schedule.end?` – ${job.schedule.end}`:''}` : 'Any time';
    const summary=this.jobPackageLabel(job);
    const vehicleSummary=this.jobVehicleSummary(job);
    const paid=(job.payments||[]).reduce((t,p)=>t+Number(p.amount||0),0);
    const total=Calc.total(job);
    const due=Math.max(0,total-paid);
    const timerMinutes=App.timerElapsedMinutes(job.timers?.overall||{elapsed:0});
    const card=el('div',{class:`list-item job-card${context==='crm'?' crm':''}`});
    const header=el('div',{class:'row',style:'justify-content:space-between;gap:.5rem;flex-wrap:wrap;align-items:center;'},
      el('div',{style:'font-weight:800;'}, client?.name||'Unknown'),
      el('div',{class:'pill'}, job.status)
    );
    const subtextParts=[summary];
    if(vehicleSummary) subtextParts.push(vehicleSummary);
    const subtitleText=subtextParts.filter(Boolean).join(' • ');
    if(subtitleText){
      header.append(el('div',{class:'tiny',style:'color:#96a4a4;margin-top:.15rem;'}, subtitleText));
    }
    const metaGrid=el('div',{class:'job-meta-grid',style:'margin-top:.6rem;'},
      el('div',{}, el('div',{class:'tiny'},'Scheduled'), el('div',{style:'font-weight:700;'}, `${dateLabel}${timeLabel?` · ${timeLabel}`:''}`)),
      el('div',{}, el('div',{class:'tiny'},'Total'), el('div',{style:'font-weight:700;'}, fmt(total))),
      el('div',{}, el('div',{class:'tiny'},'Paid'), el('div',{style:'font-weight:700;'}, fmt(paid))),
      el('div',{}, el('div',{class:'tiny'},'Due'), el('div',{style:'font-weight:700;color:'+(due>0?'#f5d7d7':'#9fb2ae')}, fmt(due))),
      el('div',{}, el('div',{class:'tiny'},'Tracked Time'), el('div',{style:'font-weight:700;'}, timerMinutes?formatDurationMinutes(timerMinutes):'--'))
    );
    const actionsContainer=context==='crm'
      ? el('div',{class:'crm-action',style:'margin-top:.75rem;'})
      : el('div',{class:'stack-buttons',style:'margin-top:.75rem;'});
    const actions=[];
    const openJob=()=>UI.openJob(job.id);
    const editJob=()=>UI.editJob(job.id);
    if(context==='jobs'){
      actions.push(el('button',{class:'pill',onclick:openJob},'View Job'));
      actions.push(el('button',{class:'pill',onclick:editJob},'Edit Job'));
      if(job.status==='Quoted'){
        actions.push(el('button',{class:'btn secondary',onclick:()=>{ App.updateJobStatus(job.id,'Booked'); UI.switchTab('Jobs'); }},'Convert to Job'));
      }
      if(job.status==='Booked') actions.push(el('button',{class:'pill',onclick:()=>App.updateJobStatus(job.id,'In Progress')},'Start Job'));
      if(job.status==='In Progress') actions.push(el('button',{class:'pill',onclick:()=>App.updateJobStatus(job.id,'Complete')},'Mark Complete'));
      if(job.status==='Complete') actions.push(el('button',{class:'pill',onclick:()=>App.updateJobStatus(job.id,'Paid')},'Mark Paid'));
      if(due>0.01) actions.push(el('button',{class:'pill',onclick:()=>App.takePayment(job.id)},'Take Payment'));
      actions.push(el('button',{class:'pill',onclick:()=>UI.openChecklist(job.id)},'Checklist'));
      actions.push(el('button',{class:'pill',onclick:()=>UI.openPrintDetails(job.id)},'Print Summary'));
      actions.push(el('button',{class:'pill',onclick:()=>App.deleteJob(job.id)},'Delete'));
    } else if(context==='quotes'){
      actions.push(el('button',{class:'pill',onclick:editJob},'Edit Quote'));
      actions.push(el('button',{class:'btn',onclick:()=>{ App.updateJobStatus(job.id,'Booked'); UI.switchTab('Jobs'); UI.flash('Quote converted to job.'); }},'Convert to Job'));
      actions.push(el('button',{class:'pill',onclick:()=>UI.openPrintDetails(job.id)},'Print Quote'));
      actions.push(el('button',{class:'pill',onclick:()=>App.deleteJob(job.id)},'Delete Quote'));
    } else {
      actions.push(el('button',{class:'pill',onclick:openJob},'Open'));
      const nextStage=this.crmNextStatus(job.status);
      if(nextStage){
        actions.push(el('button',{class:'pill',onclick:()=>App.updateJobStatus(job.id,nextStage)},`Move to ${nextStage}`));
      }
      if(due>0.01 && !['Paid','Complete'].includes(job.status)){
        actions.push(el('button',{class:'pill',onclick:()=>App.takePayment(job.id)},'Collect Payment'));
      }
      actions.push(el('button',{class:'pill',onclick:editJob},'Edit'));
      actions.push(el('button',{class:'pill',onclick:()=>UI.openChecklist(job.id)},'Checklist'));
    }
    actions.forEach(btn=>actionsContainer.append(btn));
    card.append(header, metaGrid);
    if(job.notes){
      card.append(el('div',{class:'tiny',style:'color:#9fb2ae;'}, job.notes));
    }
    if(actions.length) card.append(actionsContainer);
    return card;
  },
  buildTransactionCard(tx,{showType=true}={}){
    const card=el('div',{class:'list-item transaction-card'});
    const titleParts=[];
    if(showType && tx.type) titleParts.push(tx.type);
    if(tx.category) titleParts.push(tx.category);
    const title=titleParts.join(' • ') || 'Transaction';
    const left=el('div',{});
    left.append(el('h4',{}, title));
    if(tx.item) left.append(el('div',{class:'tiny'}, tx.item));
    if(tx.vendor) left.append(el('div',{class:'tiny'}, tx.vendor));
    const amountValue=Number(tx.amount||0);
    const amountLabel=fmt(amountValue);
    const amountColor=tx.type==='Expense'?'#f5d7d7':'#9fe4b9';
    const right=el('div',{style:'display:flex;flex-direction:column;align-items:flex-end;gap:.25rem;'});
    if(tx.date) right.append(el('div',{class:'tiny'}, tx.date));
    right.append(el('div',{class:'transaction-amount',style:`color:${amountColor};`}, amountLabel));
    const header=el('div',{class:'row',style:'justify-content:space-between;align-items:flex-start;gap:.5rem;'}, left,right);
    card.append(header);
    const meta=el('div',{class:'transaction-meta'});
    if(tx.payment) meta.append(el('span',{}, tx.payment));
    if(tx.clientId){
      const clientName=this.clientName(tx.clientId);
      if(clientName) meta.append(el('span',{}, clientName));
    }
    if(tx.type==='Income' && tx.jobId) meta.append(el('span',{}, 'Linked to job'));
    if(meta.childElementCount) card.append(meta);
    if(tx.notes) card.append(el('div',{class:'transaction-notes'}, tx.notes));
    const actions=el('div',{class:'stack-buttons'});
    if(tx.receiptImage){
      actions.append(el('button',{class:'btn secondary fullwidth',onclick:()=>this.showReceipt({image:tx.receiptImage,vendor:tx.vendor,date:tx.date,amount:amountLabel})},'View Receipt'));
    }
    actions.append(el('button',{class:'btn secondary fullwidth',onclick:()=>{ if(App.deleteTransaction(tx.id)) card.remove(); }},'Delete'));
    card.append(actions);
    return card;
  },
  setJobFilter(filter){
    this.jobFilter=filter;
    this.refreshJobsList();
  },
  refreshJobsList(){
    const list=document.getElementById('jobsList');
    if(!list) return;
    document.querySelectorAll('[data-filter]').forEach(btn=>{
      const filter=btn.getAttribute('data-filter');
      btn.classList.toggle('job-filter-active', filter===this.jobFilter);
    });
    const todayStr=today();
    const jobs=[...S.jobs];
    jobs.forEach(job=>App.ensureJobStructure(job));
    jobs.sort((a,b)=>{
      const dateA=(a.schedule?.date||a.date||'')+(a.schedule?.start||'');
      const dateB=(b.schedule?.date||b.date||'')+(b.schedule?.start||'');
      return dateA.localeCompare(dateB);
    });
    const filtered=jobs.filter(job=>{
      if(job.status==='Quoted') return false;
      const scheduleDate=job.schedule?.date || job.date || '';
      const paid=(job.payments||[]).reduce((t,p)=>t+Number(p.amount||0),0);
      const due=Math.max(0,Calc.total(job)-paid);
      switch(this.jobFilter){
        case 'today': return scheduleDate===todayStr;
        case 'upcoming': return scheduleDate>todayStr && !['Complete','Paid'].includes(job.status);
        case 'completed': return ['Complete','Paid'].includes(job.status);
        case 'unpaid': return due>0.01;
        default: return true;
      }
    });
    list.innerHTML='';
    if(!filtered.length){
      list.append(el('div',{class:'tiny'},'No jobs match the current filter.'));
    }
    for(const job of filtered){
      list.append(this.buildJobCard(job,{context:'jobs'}));
    }
    const recent=document.getElementById('recentList');
    if(recent){
      recent.innerHTML='';
      jobs.filter(job=>job.status!=='Quoted').slice(0,5).forEach(job=>{
        const client=S.clients.find(x=>x.id===job.clientId);
        const vehicleSummary=this.jobVehicleSummary(job);
        const pkgLabel=this.jobPackageLabel(job);
        const summaryText=vehicleSummary?`${pkgLabel} — ${vehicleSummary}`:pkgLabel;
        recent.append(el('div',{class:'list-item'}, `${job.schedule?.date||job.date||''} · ${client?.name||'Unknown'} · ${summaryText} (${job.status})`));
      });
    }
    this.refreshJobPerformance();
    this.refreshJobPlanner();
    this.refreshQuotesList();
    this.renderCRMBoard();
    this.renderCRMAppointments();
    this.renderCRMPayments();
  },
  refreshQuotesList(){
    const list=document.getElementById('quotesList');
    if(!list) return;
    list.innerHTML='';
    const quotes=S.jobs.filter(job=>job.status==='Quoted');
    if(!quotes.length){
      list.append(el('div',{class:'tiny'},'No pending quotes right now.'));
      return;
    }
    quotes.sort((a,b)=>{
      const createdA=a.createdAt||'';
      const createdB=b.createdAt||'';
      return createdB.localeCompare(createdA);
    });
    quotes.forEach(job=>{
      list.append(this.buildJobCard(job,{context:'quotes'}));
    });
  },
  startQuoteFlow(){
    this.switchTab('QuoteBuilder');
    this.resetJobForm();
    this.flash('Ready to build a quote.');
  },
  printQuotesSummary(){
    const quotes=S.jobs.filter(job=>job.status==='Quoted');
    if(!quotes.length){
      alert('No pending quotes to print.');
      return;
    }
    const rows=quotes.map(job=>{
      const client=S.clients.find(c=>c.id===job.clientId);
      const scheduleDate=job.schedule?.date || job.date || '';
      const dateLabel=scheduleDate?new Date(scheduleDate+'T00:00:00').toLocaleDateString():'--';
      const summary=this.jobPackageLabel(job);
      const vehicle=this.jobVehicleSummary(job);
      const total=fmt(Calc.total(job));
      return `<tr><td>${client?.name||'Unknown'}</td><td>${dateLabel}</td><td>${summary}${vehicle?`<div class="sub">${vehicle}</div>`:''}</td><td style="text-align:right">${total}</td></tr>`;
    }).join('');
    const popup=window.open('','_blank');
    if(!popup || popup.closed){
      alert('Please allow pop-ups to view the printable list.');
      return;
    }
    const html=`<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Pending Quotes</title>
  <style>
    body{margin:0;font-family:Montserrat,Arial,sans-serif;background:#eef2f4;color:#102018;}
    .toolbar{position:sticky;top:0;padding:12px 18px;background:#fff;display:flex;justify-content:flex-end;gap:8px;border-bottom:1px solid #d6dde0;}
    .toolbar button{padding:8px 14px;border-radius:12px;border:none;font-weight:700;cursor:pointer;background:#0d1f15;color:#f2fbf6;}
    .sheet{max-width:860px;margin:24px auto;background:#fff;padding:24px;border-radius:18px;box-shadow:0 24px 60px rgba(14,28,26,.15);}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #e2e8eb;}
    th{font-size:12px;letter-spacing:.4px;text-transform:uppercase;color:#5b6d66;}
    td{font-size:14px;vertical-align:top;}
    td .sub{color:#73827c;font-size:12px;margin-top:4px;}
    @media print{body{background:#fff;} .toolbar{display:none;} .sheet{box-shadow:none;border-radius:0;margin:0;padding:0;}}
  </style>
</head>
<body>
  <div class="toolbar"><button onclick="window.print()">Print</button></div>
  <div class="sheet">
    <h2 style="margin:0 0 12px;font-size:24px;">Pending Quotes</h2>
    <table>
      <thead><tr><th>Client</th><th>Date</th><th>Summary</th><th style="text-align:right">Total</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  </div>
</body>
</html>`;
    popup.document.write(html);
    popup.document.close();
  },
  loadOcr(){
    if(window.Tesseract) return Promise.resolve(window.Tesseract);
    if(this.ocrPromise) return this.ocrPromise;
    this.ocrPromise=new Promise((resolve,reject)=>{
      const script=document.createElement('script');
      script.src='https://cdn.jsdelivr.net/npm/tesseract.js@4.0.3/dist/tesseract.min.js';
      script.async=true;
      script.crossOrigin='anonymous';
      script.onload=()=>resolve(window.Tesseract);
      script.onerror=()=>reject(new Error('Failed to load OCR engine'));
      document.head.append(script);
    });
    return this.ocrPromise;
  },
  async prepareReceiptImage(file){
    const readFile=()=>new Promise((resolve,reject)=>{
      const reader=new FileReader();
      reader.onload=()=>resolve(reader.result);
      reader.onerror=()=>reject(new Error('Failed to read receipt image'));
      reader.readAsDataURL(file);
    });
    const dataUrl=await readFile();
    const image=await new Promise((resolve,reject)=>{
      const img=new Image();
      img.onload=()=>resolve(img);
      img.onerror=()=>reject(new Error('Receipt image could not be loaded'));
      img.src=dataUrl;
    });
    const maxDimension=1280;
    const longestSide=Math.max(image.width||1,image.height||1);
    const scale=longestSide>maxDimension?maxDimension/longestSide:1;
    const targetWidth=Math.max(1,Math.round((image.width||1)*scale));
    const targetHeight=Math.max(1,Math.round((image.height||1)*scale));
    const canvas=document.createElement('canvas');
    canvas.width=targetWidth;
    canvas.height=targetHeight;
    const ctx=canvas.getContext('2d');
    if(!ctx){
      return dataUrl;
    }
    ctx.drawImage(image,0,0,targetWidth,targetHeight);
    const toDataUrl=()=>canvas.toDataURL('image/jpeg',0.85);
    return await new Promise((resolve,reject)=>{
      if(canvas.toBlob){
        canvas.toBlob(blob=>{
          if(blob){
            const reader=new FileReader();
            reader.onload=()=>resolve(reader.result);
            reader.onerror=()=>reject(new Error('Failed to process receipt image'));
            reader.readAsDataURL(blob);
          } else {
            resolve(toDataUrl());
          }
        },'image/jpeg',0.85);
      } else {
        resolve(toDataUrl());
      }
    });
  },
  detectPaymentMethod(text){
    const methods=Array.isArray(S.settings.paymentMethods)?S.settings.paymentMethods:[];
    const normalized=String(text||'').toLowerCase();
    const dictionary={
      cash:['cash'],
      card:['visa','mastercard','amex','credit','debit','discover','card','mc'],
      zelle:['zelle'],
      venmo:['venmo'],
      'cash app':['cashapp','cash app'],
      cashapp:['cashapp','cash app'],
      bank:['bank','ach','wire','transfer','checking']
    };
    for(const method of methods){
      const key=method.toLowerCase();
      const tokens=dictionary[key] || [key];
      if(tokens.some(token=>normalized.includes(token))) return method;
    }
    return '';
  },
  parseReceiptText(raw){
    const text=String(raw||'');
    const clean=text.replace(/\r/g,'');
    const lines=clean.split(/\n+/).map(line=>line.trim()).filter(Boolean);
    let vendor='';
    for(const line of lines){
      if(!line) continue;
      if(/total|amount|invoice|receipt|tax|change|item|qty|cashier|order|payment/i.test(line)) continue;
      const cleaned=line.replace(/[^A-Za-z0-9 .&@\-]/g,' ').trim();
      if(cleaned){ vendor=cleaned.slice(0,60); break; }
    }
    if(!vendor && lines.length) vendor=lines[0].slice(0,60);
    const isoFromParts=(year,month,day)=>{
      let y=Number(year);
      let m=Number(month);
      let d=Number(day);
      if(y<100) y+=y>=70?1900:2000;
      if(!(y>1900 && y<2100) || !(m>=1 && m<=12) || !(d>=1 && d<=31)) return '';
      return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    };
    let date='';
    const isoMatch=clean.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
    if(isoMatch) date=isoFromParts(isoMatch[1],isoMatch[2],isoMatch[3]);
    if(!date){
      const usMatch=clean.match(/(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})/);
      if(usMatch) date=isoFromParts(usMatch[3],usMatch[1],usMatch[2]);
    }
    if(!date){
      const monthNames=['january','february','march','april','may','june','july','august','september','october','november','december'];
      const monthMatch=clean.match(/(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|jun(?:e)?|jul(?:y)?|aug(?:ust)?|sep(?:t(?:ember)?)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\s+(\d{1,2})(?:,)?\s*(\d{2,4})/i);
      if(monthMatch){
        const monthIndex=monthNames.findIndex(name=>name.startsWith(monthMatch[1].toLowerCase()));
        if(monthIndex>=0) date=isoFromParts(monthMatch[3],monthIndex+1,monthMatch[2]);
      }
    }
    let amountValue=0;
    for(const line of lines){
      if(!/total|balance|amount due/i.test(line)) continue;
      if(/subtotal/i.test(line) && !/grand|balance|due/i.test(line)) continue;
      const matches=[...line.matchAll(/(\d{1,3}(?:,\d{3})*\.\d{2})/g)];
      if(!matches.length) continue;
      const lastMatch=matches[matches.length-1][1];
      const candidate=parseFloat(lastMatch.replace(/,/g,''));
      if(!Number.isFinite(candidate)) continue;
      amountValue=candidate;
    }
    if(!amountValue){
      const matches=[...clean.matchAll(/(\d{1,3}(?:,\d{3})*\.\d{2})/g)];
      for(const match of matches){
        const candidate=parseFloat(match[1].replace(/,/g,''));
        if(candidate>amountValue) amountValue=candidate;
      }
    }
    const payment=this.detectPaymentMethod(clean);
    return {
      vendor,
      date,
      amount:amountValue?amountValue.toFixed(2):'',
      payment
    };
  },
  showReceipt({image,vendor,date,amount}={}){
    if(!image) return;
    const details=[];
    if(vendor) details.push(vendor);
    if(date) details.push(date);
    if(amount) details.push(amount);
    const body=el('div',{class:'receipt-preview',style:'max-height:none;'}, el('img',{src:image}));
    if(details.length) body.append(el('div',{class:'receipt-ocr-status'}, details.join(' • ')));
    this.modal('Receipt',(close)=>close(), body,'Close',false,true);
  },
  openJob(id){
    this.jobPanelJobId=id;
    this.renderJobPanel(id,true);
    const panel=document.getElementById('jobPanel');
    if(panel) panel.classList.add('open');
  },
  closeJobPanel(){
    const panel=document.getElementById('jobPanel');
    if(panel) panel.classList.remove('open');
    this.jobPanelJobId=null;
  },
  renderJobPanel(jobId,force=false){
    const panel=document.getElementById('jobPanel');
    const body=document.getElementById('jobPanelBody');
    if(!panel || !body) return;
    if(!force && this.jobPanelJobId!==jobId && !panel.classList.contains('open')) return;
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job){
      this.closeJobPanel();
      return;
    }
    this.jobPanelJobId=jobId;
    App.ensureJobStructure(job);
    const client=S.clients.find(c=>c.id===job.clientId);
    const titleEl=document.getElementById('jobPanelTitle');
    const subtitleEl=document.getElementById('jobPanelSubtitle');
    if(titleEl) titleEl.textContent=`${client?.name||'Unknown'} — ${job.status}`;
    const scheduleDate=job.schedule?.date || job.date || '';
    const dateLabel=scheduleDate?new Date(scheduleDate+'T00:00:00').toLocaleDateString():'No date';
    const timeLabel=job.schedule?.start ? `${job.schedule.start}${job.schedule?.end?` – ${job.schedule.end}`:''}` : 'Any time';
    const summary=this.jobPackageLabel(job);
    if(subtitleEl) subtitleEl.textContent=`${dateLabel}${timeLabel?` · ${timeLabel}`:''} • ${summary}`;
    body.innerHTML='';
    const scheduleSection=el('div',{class:'job-section'},
      el('h4',{},'Schedule'),
      el('div',{class:'tiny'},'Date'),
      el('div',{style:'font-weight:700;'}, dateLabel),
      el('div',{class:'tiny'},'Time'),
      el('div',{style:'font-weight:700;'}, timeLabel),
      el('div',{class:'tiny'},'Estimated Duration'),
      el('div',{style:'font-weight:700;'}, job.schedule?.durationMinutes?formatDurationMinutes(job.schedule.durationMinutes):'Not set'),
      el('div',{class:'tiny'},'Package'),
      el('div',{style:'font-weight:700;'}, summary),
      el('button',{class:'btn secondary',onclick:()=>UI.editJob(job.id)},'Edit Job Details')
    );
    const total=Calc.total(job);
    const paid=(job.payments||[]).reduce((t,p)=>t+Number(p.amount||0),0);
    const due=Math.max(0,total-paid);
    const financialSection=el('div',{class:'job-section'},
      el('h4',{},'Financials'),
      el('div',{class:'tiny'},'Total'),
      el('div',{style:'font-weight:700;'}, fmt(total)),
      el('div',{class:'tiny'},'Paid'),
      el('div',{style:'font-weight:700;'}, fmt(paid)),
      el('div',{class:'tiny'},'Balance Due'),
      el('div',{style:'font-weight:700;color:'+(due>0?'#f5d7d7':'#9fb2ae')}, fmt(due))
    );
    if(due>0.01){
      financialSection.append(el('button',{class:'btn',onclick:()=>App.takePayment(job.id)},'Take Payment'));
    }
    if(Array.isArray(job.payments) && job.payments.length){
      const paymentList=el('div',{class:'job-services'});
      job.payments.forEach(p=>{
        paymentList.append(el('div',{class:'job-service'},
          el('div',{class:'service-main'}, `${p.date} — ${p.method||'Payment'}`),
          el('div',{class:'service-meta'}, fmt(Number(p.amount||0)))
        ));
      });
      financialSection.append(el('div',{class:'tiny'},'Payments'));
      financialSection.append(paymentList);
    }
    const servicesSection=el('div',{class:'job-section'},
      el('h4',{},'Services'),
      el('button',{class:'btn',onclick:()=>UI.openAddService(job.id)},'Add Service')
    );
    const servicesList=el('div',{class:'job-services'});
    if(job.services?.length){
      job.services.forEach(service=>{
        const metaParts=[];
        if(service.type) metaParts.push(service.type.charAt(0).toUpperCase()+service.type.slice(1));
        if(service.vehicleLabel) metaParts.push(service.vehicleLabel);
        const metaText=metaParts.join(' • ');
        const priceLabel=service.included?'Included':fmt(service.price||0);
        const info=el('div',{class:'service-main'},
          el('div',{style:'font-weight:700;'}, service.name||'Service')
        );
        if(metaText) info.append(el('div',{class:'service-meta'}, metaText));
        const row=el('div',{class:'job-service'},
          info,
          el('div',{class:'service-meta'}, priceLabel)
        );
        if(service.type!=='package'){
          row.append(el('button',{class:'btn secondary',onclick:()=>App.removeService(job.id,service.id)},'Remove'));
        }
        servicesList.append(row);
      });
    } else {
      servicesList.append(el('div',{class:'tiny'},'No services logged yet.'));
    }
    servicesSection.append(servicesList);
    const timersSection=el('div',{class:'job-section'}, el('h4',{},'Timers'));
    const timersWrap=el('div',{class:'job-timers'});
    const timerOrder=['overall','setup','base','addons'];
    timerOrder.forEach(key=>{
      const timer=job.timers?.[key];
      if(!timer) return;
      const minutes=App.timerElapsedMinutes(timer);
      const running=!!timer.runningSince;
      const row=el('div',{class:'job-timer', 'data-running':running?'true':'false'},
        el('div',{class:'timer-info'},
          el('div',{class:'timer-label'}, timer.label||key),
          el('div',{class:'service-meta'}, running?'Running':'Paused')
        ),
        el('div',{class:'timer-value'}, formatDurationMinutes(minutes)),
        (()=>{
          const controls=el('div',{class:'job-timer-controls'});
          controls.append(el('button',{class:'pill',onclick:()=>App.toggleTimer(job.id,key)}, running?'Pause':'Start'));
          controls.append(el('button',{class:'pill',onclick:()=>App.resetTimer(job.id,key)},'Reset'));
          controls.append(el('button',{class:'pill',onclick:()=>UI.promptTimerAdjust(job.id,key)},'Adjust'));
          return controls;
        })()
      );
      timersWrap.append(row);
    });
    timersSection.append(timersWrap);
    const checklistSection=el('div',{class:'job-section'}, el('h4',{},'Checklist'));
    const checklist=job.checklist?.sections||[];
    const totalItems=checklist.reduce((sum,section)=>sum+(section.items?.length||0),0);
    const completeItems=checklist.reduce((sum,section)=>sum+(section.items?.filter(i=>i.completed).length||0),0);
    checklistSection.append(el('div',{class:'tiny'}, `${completeItems} of ${totalItems} items complete`));
    checklistSection.append(el('button',{class:'btn secondary',onclick:()=>UI.openChecklist(job.id)},'Open Checklist'));
    const notesSection=el('div',{class:'job-section'}, el('h4',{},'Notes & Summary'));
    notesSection.append(el('div',{class:'tiny'}, job.notes||'No notes for this job.'));
    const performanceRow=el('div',{class:'service-meta'}, `Tracked time: ${formatDurationMinutes(App.timerElapsedMinutes(job.timers?.overall||{elapsed:0}))}`);
    notesSection.append(performanceRow);
    if(job.totalMinutes){
      notesSection.append(el('div',{class:'service-meta'}, `Logged duration: ${formatDurationMinutes(job.totalMinutes)}`));
    }
    body.append(scheduleSection, financialSection, servicesSection, timersSection, checklistSection, notesSection);
  },
  promptTimerAdjust(jobId,key){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    App.ensureTimers(job);
    const timer=job.timers?.[key];
    if(!timer) return;
    const current=App.timerElapsedMinutes(timer);
    const input=prompt('Set duration (e.g., 1h 45m or 105)', formatDurationMinutes(current));
    if(!input) return;
    const mins=parseDurationInput(input);
    if(mins==null) return alert('Unable to parse duration.');
    App.setTimerMinutes(jobId,key,mins);
  },
  openAddService(jobId){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    App.ensureJobStructure(job);
    const typeSel=el('select',{},
      el('option',{value:'addon'},'Menu Add-on'),
      el('option',{value:'custom'},'Custom Service')
    );
    const addonSel=el('select',{});
    addonSel.append(el('option',{value:''},'Select add-on'));
    Object.keys(S.menu.addons).forEach(name=>addonSel.append(el('option',{value:name},name)));
    const nameInput=el('input',{placeholder:'Service name'});
    const priceInput=el('input',{type:'number',min:'0',step:'0.01',placeholder:'0.00',value:'0.00'});
    const includedRow=el('label',{}, el('input',{type:'checkbox',id:'svcIncluded',style:'margin-right:.4rem;'}),'Included (no charge)');
    const vehicleSel=el('select',{});
    vehicleSel.append(el('option',{value:''},'Apply to job'));
    (job.vehicles||[]).forEach((vehicle,idx)=>{
      const label=vehicle.label||`Vehicle ${idx+1}`;
      vehicleSel.append(el('option',{value:String(idx)}, label));
    });
    const addonRow=el('div',{}, el('label',{},'Add-on'), addonSel);
    const nameRow=el('div',{}, el('label',{},'Name'), nameInput);
    const priceRow=el('div',{}, el('label',{},'Price'), priceInput);
    const vehicleRow=el('div',{}, el('label',{},'Vehicle'), vehicleSel);
    const content=el('div',{},
      el('label',{},'Service Type'),
      typeSel,
      addonRow,
      nameRow,
      priceRow,
      vehicleRow,
      includedRow
    );
    const syncControls=()=>{
      const isAddon=typeSel.value==='addon';
      addonRow.style.display=isAddon?'block':'none';
      if(isAddon){
        nameRow.style.display='none';
        if(addonSel.value){
          nameInput.value=addonSel.value;
        }
        if(!priceInput.value){
          const idx=vehicleSel.value?Number(vehicleSel.value):0;
          const size=job.vehicles?.[idx]?.size || job.size || S.menu.sizes[0];
          priceInput.value=Number(Calc.addonPrice(addonSel.value,size)||0).toFixed(2);
        }
      } else {
        nameRow.style.display='block';
      }
    };
    typeSel.addEventListener('change',syncControls);
    addonSel.addEventListener('change',()=>{
      if(addonSel.value){
        nameInput.value=addonSel.value;
        const idx=vehicleSel.value?Number(vehicleSel.value):0;
        const size=job.vehicles?.[idx]?.size || job.size || S.menu.sizes[0];
        priceInput.value=Number(Calc.addonPrice(addonSel.value,size)||0).toFixed(2);
      }
    });
    vehicleSel.addEventListener('change',()=>{
      if(typeSel.value==='addon' && addonSel.value){
        const idx=vehicleSel.value?Number(vehicleSel.value):0;
        const size=job.vehicles?.[idx]?.size || job.size || S.menu.sizes[0];
        priceInput.value=Number(Calc.addonPrice(addonSel.value,size)||0).toFixed(2);
      }
    });
    syncControls();
    UI.modal('Add Service',(close)=>{
      const type=typeSel.value;
      const included=content.querySelector('#svcIncluded').checked;
      let name=type==='addon'?addonSel.value:nameInput.value.trim();
      if(!name){
        alert('Service name is required.');
        return;
      }
      const price=Number(priceInput.value||0);
      const vehicleIndex=vehicleSel.value?Number(vehicleSel.value):null;
      const vehicleLabel=vehicleIndex!=null?((job.vehicles?.[vehicleIndex]?.label)||`Vehicle ${vehicleIndex+1}`):'';
      App.addService(jobId,{type,name,price,included,vehicleIndex,vehicleLabel});
      close();
    }, content, 'Save Service');
  },
  refreshJobPlanner(){
    const input=document.getElementById('jobPlannerDate');
    const list=document.getElementById('jobPlannerList');
    if(!input || !list) return;
    if(!input.value) input.value=today();
    const target=input.value;
    const jobs=S.jobs.filter(job=>(job.schedule?.date||job.date||'')===target);
    jobs.forEach(job=>App.ensureJobStructure(job));
    jobs.sort((a,b)=>(a.schedule?.start||'').localeCompare(b.schedule?.start||''));
    list.innerHTML='';
    if(!jobs.length){
      list.append(el('div',{class:'tiny'},'No jobs scheduled.'));
      return;
    }
    jobs.forEach(job=>{
      const client=S.clients.find(c=>c.id===job.clientId);
      const start=job.schedule?.start || 'Any time';
      const summary=this.jobPackageLabel(job);
      const due=Math.max(0,Calc.total(job)-(job.payments||[]).reduce((t,p)=>t+Number(p.amount||0),0));
      const item=el('div',{class:'list-item'},
        el('div',{style:'font-weight:700;'}, `${start} · ${client?.name||'Unknown'}`),
        el('div',{class:'tiny'}, `${summary} — ${job.status}${due>0?` · Due ${fmt(due)}`:''}`),
        el('div',{class:'row',style:'gap:.35rem;margin-top:.35rem;'},
          el('button',{class:'pill',onclick:()=>UI.openJob(job.id)},'Open'),
          el('button',{class:'pill',onclick:()=>UI.editJob(job.id)},'Edit'),
          el('button',{class:'pill',onclick:()=>UI.openChecklist(job.id)},'Checklist')
        )
      );
      list.append(item);
    });
  },
  refreshJobPerformance(){
    const host=document.getElementById('jobPerformance');
    if(!host) return;
    host.innerHTML='';
    const todayStr=today();
    const active=S.jobs.filter(job=>['Booked','In Progress'].includes(job.status)).length;
    const todays=S.jobs.filter(job=>job.status!=='Quoted' && (job.schedule?.date||job.date||'')===todayStr).length;
    const completed=S.jobs.filter(job=>['Complete','Paid'].includes(job.status)).length;
    const unpaid=S.jobs.reduce((sum,job)=>{
      if(job.status==='Quoted') return sum;
      const paid=(job.payments||[]).reduce((t,p)=>t+Number(p.amount||0),0);
      return sum+Math.max(0,Calc.total(job)-paid);
    },0);
    const minutesTracked=S.jobs.reduce((sum,job)=>{
      if(job.totalMinutes) return sum+Number(job.totalMinutes||0);
      return sum+App.timerElapsedMinutes(job.timers?.overall||{elapsed:0});
    },0);
    host.append(el('div',{style:'font-weight:700;'}, `Active jobs: ${active}`));
    host.append(el('div',{class:'tiny'}, `Scheduled today: ${todays}`));
    host.append(el('div',{class:'tiny'}, `Completed/Paid: ${completed}`));
    host.append(el('div',{class:'tiny'}, `Tracked time: ${formatDurationMinutes(minutesTracked)}`));
    host.append(el('div',{class:'tiny'}, `Unpaid balance: ${fmt(unpaid)}`));
  },
  openPrintDetails(id){
    const j = S.jobs.find(x => x.id === id);
    if (!j) return;
    UI.renderPrintSheet(j);
  },
  openChecklist(id){
    const job=S.jobs.find(x=>x.id===id);
    if(!job) return;
    App.ensureChecklist(job);
    const content=el('div',{class:'list',style:'gap:.75rem;'});
    const closeModal=(close)=>{
      UI.stopChecklistTicker();
      UI.checklistHost=null;
      UI.checklistJobId=null;
      close();
    };
    UI.modal('Crew Checklist',closeModal,content,'Close',false,true);
    UI.checklistHost=content;
    UI.checklistJobId=id;
    UI.renderChecklist(id);
    UI.startChecklistTicker();
  },
  renderChecklist(jobId){
    const host=UI.checklistHost;
    if(!host) return;
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    App.ensureChecklist(job);
    const addonInfo=Calc.addonSummary(job);
    host.innerHTML='';
    const callout=el('div',{class:`crew-callout${addonInfo.requiresUpgrade?' alert':''}`});
    callout.append(el('div',{style:'font-weight:800;'}, addonInfo.requiresUpgrade?'⚠️ Add-on upgrade recommended':'Add-on logic snapshot'));
    callout.append(el('div',{class:'tiny'}, addonInfo.message));
    if(addonInfo.totalIncluded){
      callout.append(el('div',{class:'tiny'}, `Included add-ons: ${addonInfo.totalIncluded}`));
    }
    if(addonInfo.perVehicle.length){
      callout.append(el('div',{class:'tiny'}, addonInfo.perVehicle.map((info,idx)=>{
        const label=info.label?info.label:`Vehicle ${idx+1}`;
        return `${label}: ${info.custom} custom / ${info.included} included`;
      }).join(' · ')));
    }
    callout.append(el('div',{class:'tiny'}, addonInfo.upsell));
    host.append(callout);

    job.checklist.sections.forEach(section=>{
      const sectionCard=el('div',{class:'card crew-checklist-section'});
      const completed=section.items.filter(i=>i.completed).length;
      const totalItems=section.items.length;
      const totalMs=section.items.reduce((sum,item)=>sum+App.checklistElapsedMs(item),0);

      const header=el('div',{class:'crew-checklist-header','data-section':section.id});
      header.append(el('div',{style:'font-weight:800;font-size:1.05rem;'}, section.title));
      const headerMeta=el('div',{style:'display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;'});
      headerMeta.append(el('div',{class:'tiny'}, `${completed}/${totalItems} complete`));
      headerMeta.append(el('div',{class:'tiny crew-header-time'}, `Time ${UI.formatDuration(totalMs)}`));
      if(section.goalMinutes){
        headerMeta.append(el('div',{class:'tiny'}, `Goal ${section.goalMinutes} min`));
      }
      header.append(headerMeta);
      sectionCard.append(header);

      const itemsWrap=el('div',{class:'crew-checklist-items'});
      section.items.forEach(item=>{
        const key=`${section.id}:${item.id}`;
        const row=el('div',{class:'crew-checklist-item','data-key':key,'data-running':item.runningSince?'true':'false','data-complete':item.completed?'true':'false'});
        const checkbox=el('input',{type:'checkbox'});
        checkbox.checked=item.completed;
        checkbox.addEventListener('change',()=>{
          App.setChecklistComplete(job.id, section.id, item.id, checkbox.checked);
          UI.renderChecklist(job.id);
        });
        const step=el('div',{class:'crew-step'});
        step.append(el('div',{style:'font-weight:600;'}, item.label));
        if(item.description){
          step.append(el('div',{class:'tiny'}, item.description));
        }
        const timerWrap=el('div',{class:'crew-timer-controls'});
        const timer=el('div',{class:'crew-timer','data-key':key}, UI.formatDuration(App.checklistElapsedMs(item)));
        timerWrap.append(timer);
        const toggleBtn=el('button',{class:'btn secondary'}, item.runningSince?'Stop':'Start');
        toggleBtn.addEventListener('click',()=>{
          App.toggleChecklistTimer(job.id, section.id, item.id);
          UI.renderChecklist(job.id);
        });
        timerWrap.append(toggleBtn);
        row.append(checkbox, step, timerWrap);
        itemsWrap.append(row);
      });
      sectionCard.append(itemsWrap);
      host.append(sectionCard);
    });

    UI.updateChecklistTimers();
  },
  startChecklistTicker(){
    UI.stopChecklistTicker();
    if(!UI.checklistHost || !UI.checklistJobId) return;
    UI.checklistTicker=setInterval(()=>UI.updateChecklistTimers(),1000);
    UI.updateChecklistTimers();
  },
  stopChecklistTicker(){
    if(UI.checklistTicker){
      clearInterval(UI.checklistTicker);
      UI.checklistTicker=null;
    }
  },
  updateChecklistTimers(){
    if(!UI.checklistHost || !UI.checklistJobId) return;
    const job=S.jobs.find(x=>x.id===UI.checklistJobId);
    if(!job) return;
    App.ensureChecklist(job);
    job.checklist.sections.forEach(section=>{
      const headerTime=UI.checklistHost.querySelector(`.crew-checklist-header[data-section="${section.id}"] .crew-header-time`);
      if(headerTime){
        const totalMs=section.items.reduce((sum,item)=>sum+App.checklistElapsedMs(item),0);
        headerTime.textContent=`Time ${UI.formatDuration(totalMs)}`;
      }
      section.items.forEach(item=>{
        const key=`${section.id}:${item.id}`;
        const timerNode=UI.checklistHost.querySelector(`.crew-timer[data-key="${key}"]`);
        if(timerNode){
          timerNode.textContent=UI.formatDuration(App.checklistElapsedMs(item));
        }
        const row=UI.checklistHost.querySelector(`.crew-checklist-item[data-key="${key}"]`);
        if(row){
          row.setAttribute('data-running', item.runningSince?'true':'false');
          row.setAttribute('data-complete', item.completed?'true':'false');
        }
      });
    });
  },
  formatDuration(ms){
    const totalSeconds=Math.max(0,Math.floor(ms/1000));
    const hours=Math.floor(totalSeconds/3600);
    const minutes=Math.floor((totalSeconds%3600)/60);
    const seconds=totalSeconds%60;
    if(hours>0){
      return `${hours}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
    }
    return `${minutes}:${String(seconds).padStart(2,'0')}`;
  },
  showQuickClient(){ document.getElementById('quickClient').classList.remove('hidden'); },
  hideQuickClient(){
    document.getElementById('quickClient').classList.add('hidden');
    const fields=['qcName','qcPhone','qcEmail','qcNotes'];
    fields.forEach(id=>{ const input=document.getElementById(id); if(input) input.value=''; });
    const discType=document.getElementById('qcDiscType'); if(discType) discType.value='none';
    const discValue=document.getElementById('qcDiscValue'); if(discValue) discValue.value='0';
  },
  openExpenseForm(initial={}){
    const defaultDate=initial.date || today();
    const dateInput=el('input',{type:'date',value:defaultDate});
    const categorySelect=(()=>{
      const sel=el('select',{});
      const categories=(S.settings.categories||[]).filter(c=>c!=='Package'&&c!=='Add-on');
      categories.forEach(cat=>sel.append(el('option',{value:cat,selected:cat===initial.category},cat)));
      if(!sel.value && categories.length) sel.value=categories[0];
      return sel;
    })();
    const vendorInput=el('input',{value:initial.vendor||'',placeholder:'Vendor or store'});
    const paymentSelect=(()=>{
      const sel=el('select',{});
      (S.settings.paymentMethods||[]).forEach(method=>sel.append(el('option',{value:method,selected:method===initial.payment},method)));
      if(!sel.value && sel.options.length) sel.value=sel.options[0].value;
      return sel;
    })();
    const amountInput=el('input',{type:'number',min:'0',step:'0.01',value:initial.amount?Number(initial.amount).toFixed(2):''});
    const notesInput=el('textarea',{placeholder:'Optional notes',value:initial.notes||''});
    const ocrStatus=el('div',{class:'receipt-ocr-status'},'Use the buttons above to scan or upload a receipt.');
    const previewImg=el('img',{});
    const preview=el('div',{class:'receipt-preview hidden'}, previewImg, ocrStatus);
    const cameraInput=el('input',{type:'file',accept:'image/*',capture:'environment',class:'hidden'});
    const uploadInput=el('input',{type:'file',accept:'image/*',class:'hidden'});
    const state={imageData:initial.receiptImage||'', busy:false};
    const cameraBtn=el('button',{class:'btn fullwidth',type:'button'},'Scan with Camera');
    const uploadBtn=el('button',{class:'btn secondary fullwidth',type:'button'},'Upload Receipt');
    const updateButtons=()=>{
      cameraBtn.textContent=state.imageData?'Rescan with Camera':'Scan with Camera';
      uploadBtn.textContent=state.imageData?'Upload Different Photo':'Upload Receipt';
      cameraBtn.disabled=state.busy;
      uploadBtn.disabled=state.busy;
      preview.classList.toggle('hidden',!state.imageData);
      if(state.imageData && !state.busy) ocrStatus.textContent='Receipt attached. Double-check the details below.';
    };
    const fillFromParsed=(parsed)=>{
      if(parsed.date && !dateInput.value) dateInput.value=parsed.date;
      if(parsed.vendor && !vendorInput.value) vendorInput.value=parsed.vendor;
      if(parsed.amount && !amountInput.value) amountInput.value=parsed.amount;
      if(parsed.payment){
        const match=(S.settings.paymentMethods||[]).find(method=>method.toLowerCase()===parsed.payment.toLowerCase());
        if(match) paymentSelect.value=match;
      }
    };
    const runOcr=async()=>{
      if(state.busy || !state.imageData) return;
      state.busy=true;
      updateButtons();
      ocrStatus.textContent='Scanning receipt…';
      try{
        const Tesseract=await UI.loadOcr();
        const result=await Tesseract.recognize(state.imageData,'eng');
        const text=result?.data?.text||'';
        if(text.trim()){
          const parsed=UI.parseReceiptText(text);
          fillFromParsed(parsed);
          ocrStatus.textContent='Receipt scanned. Review and adjust the extracted fields.';
        } else {
          ocrStatus.textContent='No text detected. Enter details manually.';
        }
      } catch(err){
        console.error(err);
        ocrStatus.textContent='Could not read the receipt. Enter details manually.';
      } finally {
        state.busy=false;
        updateButtons();
      }
    };
    const handleFile=async file=>{
      if(!file || state.busy) return;
      state.busy=true;
      updateButtons();
      ocrStatus.textContent='Processing receipt…';
      try{
        const processed=await UI.prepareReceiptImage(file);
        state.imageData=processed;
        previewImg.src=processed;
      } catch(err){
        console.error(err);
        state.imageData='';
        previewImg.removeAttribute('src');
        preview.classList.add('hidden');
        ocrStatus.textContent='Could not process the receipt image. Try another photo.';
      } finally {
        state.busy=false;
        updateButtons();
      }
      if(state.imageData){
        await runOcr();
      }
    };
    cameraInput.addEventListener('change',e=>handleFile(e.target.files[0]));
    uploadInput.addEventListener('change',e=>handleFile(e.target.files[0]));
    cameraBtn.addEventListener('click',()=>{ if(state.busy) return; cameraInput.value=''; cameraInput.click(); });
    uploadBtn.addEventListener('click',()=>{ if(state.busy) return; uploadInput.value=''; uploadInput.click(); });
    if(state.imageData){
      previewImg.src=state.imageData;
      preview.classList.remove('hidden');
      ocrStatus.textContent='Receipt attached. Review the details below.';
    }
    updateButtons();
    const resetForm=()=>{
      state.imageData='';
      previewImg.removeAttribute('src');
      preview.classList.add('hidden');
      ocrStatus.textContent='Use the buttons above to scan or upload a receipt.';
      cameraInput.value='';
      uploadInput.value='';
      vendorInput.value='';
      amountInput.value='';
      notesInput.value='';
      updateButtons();
      setTimeout(()=>vendorInput.focus(),0);
    };
    const content=el('div',{class:'form-grid'},
      el('div',{class:'stack-buttons'}, cameraBtn, uploadBtn),
      preview,
      el('div',{}, el('label',{},'Date'), dateInput),
      el('div',{}, el('label',{},'Category'), categorySelect),
      el('div',{}, el('label',{},'Vendor'), vendorInput),
      el('div',{class:'mobile-field-row'},
        el('div',{}, el('label',{},'Payment Method'), paymentSelect),
        el('div',{}, el('label',{},'Amount'), amountInput)
      ),
      el('div',{}, el('label',{},'Notes'), notesInput),
      cameraInput,
      uploadInput
    );
    const saveExpense=(close,{addAnother=false}={})=>{
      if(state.busy){
        alert('Please wait for the receipt scan to finish.');
        return;
      }
      const date=dateInput.value||today();
      const category=categorySelect.value||'Other';
      const vendor=vendorInput.value.trim();
      const payment=paymentSelect.value||'';
      const amountValue=Number(amountInput.value||0);
      if(!(amountValue>0)) return alert('Amount required');
      const notes=notesInput.value.trim();
      const saved=App.addExpenseRecord({date,category,vendor,payment,amount:amountValue,notes,receiptImage:state.imageData});
      if(!saved) return;
      UI.flash('Expense added.');
      if(addAnother){
        resetForm();
        return;
      }
      close();
    };
    this.modal('Add Expense',(close)=>saveExpense(close,{addAnother:false}), content, 'Save Expense', true, false, [
      {label:'Save & Add Another', className:'btn secondary', onClick:(close)=>saveExpense(close,{addAnother:true})}
    ]);
  },
  openTransactions(){
    const transactions=[...S.transactions].sort((a,b)=>String(b.date||'').localeCompare(a.date||''));
    const list=el('div',{class:'list'});
    if(!transactions.length){
      list.append(el('div',{class:'tiny'},'No transactions yet.'));
    } else {
      transactions.forEach(tx=>list.append(this.buildTransactionCard(tx,{showType:true})));
    }
    const content=el('div',{class:'form-grid'},
      el('div',{class:'stack-buttons'},
        el('button',{class:'btn secondary fullwidth',onclick:()=>Data.exportCSV()},'Export CSV'),
        el('button',{class:'btn secondary fullwidth',onclick:()=>Data.exportJSON()},'Export JSON')
      ),
      list
    );
    this.modal('Transactions',(close)=>close(), content,'Close',false,true);
  },
  openExpenses(){
    const expenses=S.transactions.filter(t=>t.type==='Expense');
    const list=el('div',{class:'list'});
    if(!expenses.length){
      list.append(el('div',{class:'tiny'},'No expenses recorded yet.'));
    } else {
      expenses.slice().sort((a,b)=>String(b.date||'').localeCompare(a.date||'')).forEach(exp=>{
        list.append(this.buildTransactionCard(exp,{showType:false}));
      });
    }
    const content=el('div',{class:'form-grid'},
      el('div',{class:'stack-buttons'},
        el('button',{class:'btn fullwidth',onclick:()=>UI.openExpenseForm()},'Add Expense'),
        el('button',{class:'btn secondary fullwidth',onclick:()=>Data.exportCSV()},'Export CSV')
      ),
      list
    );
    this.modal('Expenses',(close)=>close(), content,'Close',false,true);
  },
  openMileage(){ const rows=S.mileage.map((m,i)=>`<tr><td>${m.date}</td><td>${m.from}</td><td>${m.to}</td><td>${m.why}</td><td>${m.miles}</td><td><button class='pill' onclick='UI.delMileage(${i})'>Delete</button></td></tr>`).join(''); this.modal('Mileage',(c)=>c(), el('div',{}, el('div',{class:'row'}, el('div',{}, el('label',{},'Date'), el('input',{id:'miDate',type:'date',value:today()})), el('div',{}, el('label',{},'From'), el('input',{id:'miFrom'})), el('div',{}, el('label',{},'To'), el('input',{id:'miTo'})), el('div',{}, el('label',{},'Why'), el('input',{id:'miWhy'})), el('div',{}, el('label',{},'Miles'), el('input',{id:'miMiles',type:'number',min:'0',step:'0.1'})) ), el('div',{class:'row'}, el('button',{class:'btn', onclick:()=>UI.addMileage()},'Add Entry')), el('table',{style:'width:100%;border-collapse:collapse;margin-top:.5rem;'}, el('thead',{}, el('tr',{html:'<th>Date</th><th>From</th><th>To</th><th>Why</th><th>Miles</th><th></th>'})), el('tbody',{id:'miBody',html:rows})) )); },
  addMileage(){ const e={date:document.getElementById('miDate').value||today(),from:document.getElementById('miFrom').value||'',to:document.getElementById('miTo').value||'',why:document.getElementById('miWhy').value||'',miles:Number(document.getElementById('miMiles').value||0)}; S.mileage.push(e); Storage.save(S); const tr=`<tr><td>${e.date}</td><td>${e.from}</td><td>${e.to}</td><td>${e.why}</td><td>${e.miles}</td><td><button class='pill' onclick='UI.delMileage(${S.mileage.length-1})'>Delete</button></td></tr>`; document.getElementById('miBody').insertAdjacentHTML('beforeend', tr); UI.flash('Mileage added.'); },
  delMileage(i){ if(!confirm('Delete entry?')) return; S.mileage.splice(i,1); Storage.save(S); UI.openMileage(); },
  openMenuEditor(){
    const content=el('div',{});
    const pkgHeader=el('h4',{},'Packages');
    const pkgList=el('div',{id:'pkgEditor',class:'list',style:'gap:.75rem;'});
    const createAddonOption=(name,checked=false,onChange=()=>{})=>{
      const option=el('label',{class:'pkg-addon-option','data-name':name,'data-selected':checked?'true':'false'});
      const cb=el('input',{type:'checkbox',value:name});
      cb.checked=checked;
      cb.addEventListener('change',()=>{
        option.setAttribute('data-selected',cb.checked?'true':'false');
        onChange(cb.checked);
      });
      option.append(cb, name);
      return option;
    };
    const createCard=(name,prices=[],meta={lock:false,includedAddons:[],description:''})=>{
      const card=el('div',{class:'menu-pkg-card','data-collapsed':'false'});
      const header=el('div',{class:'pkg-header'});
      const toggle=el('button',{class:'pkg-toggle',type:'button',title:'Collapse section','aria-expanded':'true'},'▾');
      const toggleSection=()=>{
        const currentlyCollapsed=card.getAttribute('data-collapsed')==='true';
        const nextCollapsed=!currentlyCollapsed;
        card.setAttribute('data-collapsed',nextCollapsed?'true':'false');
        toggle.textContent=nextCollapsed?'▸':'▾';
        toggle.setAttribute('aria-expanded',(!nextCollapsed).toString());
      };
      toggle.addEventListener('click',toggleSection);
      header.append(toggle);
      const nameWrap=el('div',{style:'flex:1;'});
      const nameInput=el('input',{class:'pkg-name',value:name,placeholder:'Package name'});
      nameWrap.append(nameInput);
      header.append(nameWrap);
      const removeBtn=el('button',{class:'btn secondary',type:'button'},'Remove');
      removeBtn.addEventListener('click',()=>{
        if(pkgList.querySelectorAll('.menu-pkg-card').length<=1){
          UI.flash('At least one package required.');
          return;
        }
        card.remove();
      });
      header.append(removeBtn);
      card.append(header);

      const summary=el('div',{class:'pkg-summary',tabindex:'0'});
      summary.addEventListener('click',toggleSection);
      summary.addEventListener('keydown',(e)=>{
        if(e.key==='Enter'||e.key===' '){
          e.preventDefault();
          toggleSection();
        }
      });
      card.append(summary);

      const body=el('div',{class:'pkg-body'});

      const priceGrid=el('div',{class:'grid',style:'gap:.5rem;'});
      const priceInputs=[];
      S.menu.sizes.forEach((size,i)=>{
        const col=el('div',{});
        col.append(el('label',{},size));
        const input=el('input',{type:'number',class:'pkg-price','data-size-index':i,min:'0',step:'0.01',value:Number(prices[i]||0).toFixed(2)});
        priceInputs.push(input);
        col.append(input);
        priceGrid.append(col);
      });
      body.append(priceGrid);

      const lockRow=el('div',{class:'row',style:'gap:.5rem;align-items:center;'});
      lockRow.append(el('label',{style:'flex:1;'},'Lock Retail Base?'));
      const lockSelect=el('select',{class:'pkg-lock'});
      lockSelect.append(el('option',{value:'no',selected:!meta.lock},'No'));
      lockSelect.append(el('option',{value:'yes',selected:meta.lock},'Yes'));
      lockRow.append(lockSelect);
      body.append(lockRow);

      const descLabel=el('label',{},'Description');
      const descInput=el('textarea',{class:'pkg-desc',placeholder:'Short summary of what is included',value:meta.description||''});
      body.append(descLabel,descInput);

      const addonLabel=el('label',{},'Included Add-ons');
      const addonWrap=el('div',{class:'pkg-addon-options'});
      body.append(addonLabel,addonWrap);

      const updateSummary=()=>{
        const sizePreview=S.menu.sizes[0]||'';
        const previewInput=priceInputs[0];
        const baseValue=Number(previewInput?.value||0);
        const basePreview=previewInput?`${sizePreview?sizePreview+': ':''}${fmt(baseValue)}`:'';
        const description=descInput.value.trim();
        const includedCount=addonWrap.querySelectorAll('input[type=checkbox]:checked').length;
        const parts=[];
        if(basePreview) parts.push(`Base ${basePreview}`);
        if(description) parts.push(description);
        if(includedCount) parts.push(`${includedCount} included add-on${includedCount===1?'':'s'}`);
        summary.textContent=parts.join(' • ')||'Add pricing, a description, or included add-ons.';
      };

      Object.keys(S.menu.addons).forEach(addonName=>{
        const checked=!!meta.includedAddons?.includes(addonName);
        addonWrap.append(createAddonOption(addonName,checked,()=>updateSummary()));
      });

      descInput.addEventListener('input',updateSummary);
      priceInputs.forEach(input=>input.addEventListener('input',updateSummary));

      card.append(body);

      updateSummary();

      if(pkgList.children.length){
        card.setAttribute('data-collapsed','true');
        toggle.textContent='▸';
        toggle.setAttribute('aria-expanded','false');
      }

      return card;
    };

    const existingPackages=Object.entries(S.menu.packages);
    if(existingPackages.length){
      existingPackages.forEach(([name,prices])=>pkgList.append(createCard(name,prices,pkgMeta(name))));
    } else {
      pkgList.append(createCard('New Package',S.menu.sizes.map(()=>0),{lock:false,includedAddons:[],description:''}));
    }

    const addPackageBtn=el('button',{class:'btn secondary',type:'button'},'Add Package');
    addPackageBtn.addEventListener('click',()=>{
      const base='New Package';
      const currentNames=new Set(Array.from(pkgList.querySelectorAll('.pkg-name')).map(inp=>inp.value.trim()).filter(Boolean));
      let candidate=base;
      let idx=2;
      while(currentNames.has(candidate)){
        candidate=`${base} ${idx++}`;
      }
      pkgList.append(createCard(candidate,S.menu.sizes.map(()=>0),{lock:false,includedAddons:[],description:''}));
    });

    content.append(pkgHeader);
    content.append(pkgList);
    content.append(el('div',{class:'row',style:'margin:.5rem 0;'},addPackageBtn));

    const makeTable=(title,map,sizes,id)=>{
      const headers='<tr><th>Item</th>'+sizes.map(s=>`<th>${s}</th>`).join('')+'<th></th></tr>';
      const rows=Object.entries(map).map(([n,arr])=>`<tr data-name="${n}"><td><input value="${n}"></td>`+sizes.map((s,i)=>`<td><input type='number' min='0' step='1' value='${Number(arr[i]||0)}'></td>`).join('')+`<td><button class='pill' onclick='UI.delRow("${id}","${n}")'>Delete</button></td></tr>`).join('');
      return `<h4>${title}</h4><table class='table' id='${id}'><thead>${headers}</thead><tbody>${rows}</tbody></table>`;
    };

    const addonSection=el('div',{html:makeTable('Add-ons',S.menu.addons,S.menu.sizes,'addonTable')});
    content.append(addonSection);
    content.append(el('div',{class:'footnote',style:'margin-top:.5rem;'},S.menu.guidance));

    const readAddons=()=>{
      const tbody=document.querySelector('#addonTable tbody');
      if(!tbody) return {};
      const rows=Array.from(tbody.querySelectorAll('tr'));
      const out={};
      for(const r of rows){
        const inputs=r.querySelectorAll('input');
        const name=inputs[0].value.trim();
        if(!name) continue;
        const prices=Array.from(inputs).slice(1).map(x=>Number(x.value||0));
        out[name]=prices;
      }
      return out;
    };

    UI.modal('Menu Editor',(close)=>{
      try{
        const packages={};
        const meta={};
        pkgList.querySelectorAll('.menu-pkg-card').forEach(card=>{
          const name=(card.querySelector('.pkg-name')?.value||'').trim();
          if(!name) return;
          const prices=S.menu.sizes.map((_,i)=>{
            const input=card.querySelector(`.pkg-price[data-size-index="${i}"]`);
            return Number(input?.value||0);
          });
          packages[name]=prices;
          const lock=card.querySelector('.pkg-lock')?.value==='yes';
          const included=Array.from(card.querySelectorAll('.pkg-addon-option input[type=checkbox]')).filter(cb=>cb.checked).map(cb=>cb.value);
          const description=(card.querySelector('.pkg-desc')?.value||'').trim();
          meta[name]={lock,includedAddons:included, description};
        });
        if(!Object.keys(packages).length) throw new Error('At least one package is required.');
        S.menu.packages=packages;
        S.menu.packageMeta=meta;
        S.menu.addons=readAddons();
        Storage.save(S);
        UI.populateSizesAndPackages();
        UI.prefillBase();
        UI.renderAddons();
        UI.flash('Menu saved.');
        close();
      }catch(e){
        alert('Error saving: '+e.message);
      }
    }, content, 'Save Changes', true, true);
  },
  delRow(tableId,name){ const tr=document.querySelector(`#${tableId} tr[data-name="${name}"]`); if(tr) tr.remove(); },
  openCustomBuilder(row=null){ const size=(row?.querySelector('.vehicle-size')?.value)||document.querySelector('.vehicle-size')?.value||S.menu.sizes[0]; const basePref=row?.querySelector('.vehicle-base')?.value||'0'; const content=el('div',{}, el('label',{},'Package Name'), el('input',{id:'cbName', value:'Custom Package'}), el('div',{class:'row'}, el('div',{}, el('label',{}, 'Base Price for '+size), el('input',{id:'cbBase',type:'number',min:'0',step:'0.01',value:basePref})), el('div',{}, el('label',{}, 'Lock Retail Base'), el('select',{id:'cbLock'}, el('option',{value:'no'},'No'), el('option',{value:'yes'},'Yes')))), el('label',{},'Description'), el('textarea',{id:'cbDesc',placeholder:'What is highlighted in this package?'}), el('label',{},'Included Add-ons (optional)'), (()=>{ const box=el('div',{class:'list'}); for(const n of Object.keys(S.menu.addons)) box.append(el('label',{}, el('input',{type:'checkbox','data-name':n,style:'margin-right:.4rem;'}), n)); return box; })(), el('label',{},'Pick & Choose mode (no included items)'), el('select',{id:'cbPick'}, el('option',{value:'no'},'No'), el('option',{value:'yes'},'Yes')) ); UI.modal('Build Custom Package',(close)=>{ const name=content.querySelector('#cbName').value.trim()||'Custom Package'; const base=Number(content.querySelector('#cbBase').value||0); const lock=content.querySelector('#cbLock').value==='yes'; const description=content.querySelector('#cbDesc').value.trim(); const pick=content.querySelector('#cbPick').value==='yes'; const inc=pick?[]:Array.from(content.querySelectorAll('input[type=checkbox][data-name]')).filter(x=>x.checked).map(x=>x.getAttribute('data-name')); const prices=S.menu.sizes.map(()=>0); const idx=S.menu.sizes.indexOf(size); if(idx>=0) prices[idx]=base; else if(prices.length) prices[0]=base; S.menu.packages[name]=prices; S.menu.packageMeta[name]={lock, includedAddons:inc, description}; Storage.save(S); UI.populateSizesAndPackages(); if(row){ const pkgSel=row.querySelector('.vehicle-package'); if(pkgSel){ pkgSel.value=name; UI.refreshVehicleRow(row,{setBase:true}); UI.updateTotals(); } } else { const firstRow=document.querySelector('.vehicle-row'); const pkgSel=firstRow?.querySelector('.vehicle-package'); if(pkgSel){ pkgSel.value=name; UI.refreshVehicleRow(firstRow,{setBase:true}); } UI.handlePackageChange(); } UI.flash('Custom package added.'); close(); }, content, 'Use Package', true, true); },
  openImport(){ const file=el('input',{type:'file',accept:'.json'}); file.onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); if(!data.transactions) throw new Error('Invalid backup file: missing "transactions"'); S=data; if(!S.menu.packageMeta) S.menu.packageMeta={}; Storage.save(S); location.reload(); }catch(err){ alert('Import error: '+err.message); } }; r.readAsText(f); }; file.click(); },
  openSettings(){
    this.switchTab('Settings');
    this.populateSettingsTab();
  },
  pickLogo(){ const f=el('input',{type:'file',accept:'image/*'}); f.onchange=(e)=>{ const file=e.target.files[0]; if(!file) return; const r=new FileReader(); r.onload=()=>{ S.business.logoDataUrl=r.result; Storage.save(S); UI.initHeader(); UI.flash('Logo updated.'); }; r.readAsDataURL(file); }; f.click(); },
  clearLogo(){ S.business.logoDataUrl=''; Storage.save(S); UI.initHeader(); UI.flash('Logo removed.'); },
  clientName(id){ return (S.clients.find(c=>c.id===id)||{}).name||''; },
  printQuote(){
    const clientId = document.getElementById('jobClient').value || '';
    const vehicles = this.collectVehicles();
    if(!vehicles.length) return alert('Add at least one vehicle to print');
    const discType = document.getElementById('jobDiscType').value;
    const discValue= Number(document.getElementById('jobDiscValue').value || 0);
    const discScope= document.getElementById('jobDiscScope').value;
    const notes    = document.getElementById('jobNotes').value.trim();
    const primaryPkg = vehicles[0]?.pkg || '';

    const tempJob = {
      id: 'preview',
      date: new Date().toISOString().slice(0,10),
      clientId,
      pkg: primaryPkg,
      vehicles,
      discType,
      discValue,
      discScope,
      notes,
      status: 'Quoted',
      payments: []
    };
    tempJob.size = vehicles[0]?.size || '';
    tempJob.vehicleCount = vehicles.length;

    UI.renderPrintSheet(tempJob);
  },
  toggleDrawer(open){ document.getElementById('drawer').classList.toggle('open', !!open); },
  modal(title,onPrimary,contentNode,primaryText='Save',showCancel=true,wide=false,extraButtons=[]){ const host=document.getElementById('modalHost'); host.innerHTML=''; const overlay=el('div',{style:'position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:30;display:flex;align-items:center;justify-content:center;'}); const card=el('div',{class:'card',style:`width:${wide?'min(96vw,980px)':'min(96vw,640px)'};max-height:90vh;overflow:auto;`}); card.append(el('h3',{},title)); card.append(contentNode); const actions=el('div',{class:'row',style:'margin-top:.5rem;justify-content:flex-end;'}); const close=()=>{ host.innerHTML=''; }; if(showCancel) actions.append(el('button',{class:'btn secondary',onclick:close},'Cancel')); if(Array.isArray(extraButtons)){ extraButtons.forEach(cfg=>{ if(!cfg||!cfg.label) return; const className=cfg.className||'btn secondary'; actions.append(el('button',{class:className,onclick:()=>cfg.onClick?.(close)},cfg.label)); }); } actions.append(el('button',{class:'btn',onclick:()=>onPrimary(close)},primaryText)); card.append(actions); overlay.append(card); host.append(overlay); return card; },
  flash(msg){ const n=el('div',{style:'position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#06100a;border:1px solid #163c27;color:#dff8e7;padding:.6rem 1rem;border-radius:999px;z-index:50;'}, msg); document.body.append(n); setTimeout(()=>n.remove(),1600); },
  bootError(text){ const w=el('div',{class:'card',style:'margin:1rem;border-color:#3a1515;background:#1b0c0c;'}, el('h3',{},'Boot Error'), el('div',{}, text||'Unknown error')); document.body.prepend(w); }
};
// Renders the 1-page sheet for ANY job-like object
UI.renderPrintSheet = function(job){
  const j = job;
  const c = S.clients.find(x => x.id === j.clientId);
  const hasVehicles = Array.isArray(j.vehicles) && j.vehicles.length;
    const vehicles = hasVehicles ? j.vehicles.map(v=>({
      size: v.size || '',
      base: Number(v.base||0),
      addons: (v.addons||[]).map(a=>({name:a.name, price:Number(a.price||0), included:!!a.included})),
      pkg: v.pkg || j.pkg || '',
      label: v.label || ''
    })) : [];
  const pkgLabel = UI.jobPackageLabel(j);
  const packageNames = hasVehicles ? vehicles.map(v=>v.pkg).filter(Boolean) : [j.pkg].filter(Boolean);
  const uniquePackages = [...new Set(packageNames)];
  const metaSource = uniquePackages.length===1 ? uniquePackages[0] : (uniquePackages.length===0 ? (j.pkg||'') : '');
  const meta = metaSource && S.menu.packageMeta ? (S.menu.packageMeta[metaSource] || {includedAddons:[]}) : {includedAddons:[]};
  const included = uniquePackages.length>1
    ? '<li>Varies by vehicle</li>'
    : (meta.includedAddons||[]).map(n=>`<li>${n}</li>`).join('');
  const legacyAddons = (!hasVehicles ? (j.addons||[]) : []).map(a=>{
    const count=Calc.vehicleCount(j);
    if(a?.included){
      return `<tr><td>${a.name}</td><td style="text-align:right">Included</td></tr>`;
    }
    const price=Number(a.price||0);
    const lineTotal=price*count;
    const priceLabel=count>1 ? `$${price.toFixed(2)} ea × ${count} = $${lineTotal.toFixed(2)}` : `$${price.toFixed(2)}`;
    const note=count>1?'<div style="color:#777;font-size:12px;">Per vehicle</div>':'';
    return `<tr><td>${a.name}${note}</td><td style="text-align:right">${priceLabel}</td></tr>`;
  }).join('');
  const vehicleCount = hasVehicles ? vehicles.length : Calc.vehicleCount(j);
  const vehicleSummary = UI.jobVehicleSummary(j);
  const subtotal = Calc.subtotal(j).toFixed(2);
  const disc = Calc.discount(j).toFixed(2);
  const total = Calc.total(j).toFixed(2);
  const discountLabel = (j.discScope==='vehicle' && vehicleCount>1) ? 'Discount (per vehicle)' : 'Discount';
  const paidRows = (j.payments||[]).map(p=>`<tr><td>${p.date}</td><td>${p.method||''}</td><td style="text-align:right">$${Number(p.amount||0).toFixed(2)}</td></tr>`).join('');
  const bizName = S.business?.name || 'Polish Crew';
  const logo = S.business?.logoDataUrl || '';
  const headerTitle = (j.status === 'Paid') ? 'Receipt' : 'Quote';
  const vehicleSections = hasVehicles ? vehicles.map((v,idx)=>{
    const addonRows = v.addons.length ? v.addons.map(a=>{
      if(a?.included){
        return `<tr><td>${a.name}<span style="color:#0a6;font-size:12px;margin-left:6px;">Included</span></td><td style="text-align:right">Included</td></tr>`;
      }
      return `<tr><td>${a.name}</td><td style="text-align:right">$${Number(a.price||0).toFixed(2)}</td></tr>`;
    }).join('') : '<tr><td style="color:#666">No add-ons</td><td></td></tr>';
    const pkgName = v.pkg || pkgLabel || (j.pkg || 'Package');
    const headingName = v.label ? `${v.label}${v.size ? ' ('+v.size+')' : ''}` : (v.size || 'Vehicle');
    return `<div style="margin-bottom:12px;">
      <div style="font-weight:700;margin-bottom:4px;">Vehicle ${idx+1}: ${headingName}${pkgName?` — ${pkgName}`:''}</div>
      <table style="width:100%;border-collapse:collapse;font-size:14px">
        <tr><td>${pkgName || 'Package'} base${v.size ? ' — '+v.size : ''}</td><td style="text-align:right">$${v.base.toFixed(2)}</td></tr>
        ${addonRows}
      </table>
    </div>`;
  }).join('') : '';
  const docDate = j.date || j.schedule?.date || new Date().toISOString().slice(0,10);
  const popupHtml = `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>${headerTitle} — ${bizName}</title>
  <style>
    body{margin:0;background:#eef2f4;color:#111;font:14px/1.45 Montserrat,Arial,sans-serif;}
    .toolbar{position:sticky;top:0;display:flex;justify-content:flex-end;gap:8px;padding:12px 18px;background:#fff;border-bottom:1px solid #cfd8dd;box-shadow:0 4px 12px rgba(10,20,30,.06);}
    .toolbar button{padding:8px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer;font-family:inherit;}
    .toolbar button.primary{background:#0c2015;color:#f1faf4;}
    .toolbar button.secondary{background:#e7ecef;color:#12241a;}
    .sheet{max-width:820px;margin:24px auto;background:#fff;padding:28px 32px 48px;border-radius:18px;box-shadow:0 24px 60px rgba(12,22,30,.12);}
    hr{border:none;border-top:1px solid #dde3e6;margin:16px 0;}
    table{border-collapse:collapse;width:100%;}
    td{padding:4px 0;vertical-align:top;}
    ul{margin:0 0 8px 18px;padding:0;}
    @media print{
      body{background:#fff;}
      .toolbar{display:none;}
      .sheet{box-shadow:none;border-radius:0;margin:0;padding:0;}
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <button class="secondary" onclick="window.close()">Close</button>
    <button class="primary" onclick="window.print()">Print</button>
  </div>
  <div class="sheet">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
      ${logo ? `<img src="${logo}" style="width:56px;height:56px;border-radius:12px;border:2px solid #0a0;object-fit:cover">` : ''}
      <div>
        <div style="font-weight:900;font-size:20px;letter-spacing:.3px;text-transform:uppercase;">${bizName}</div>
        <div style="color:#6b7a80;font-size:12px;">Generated ${new Date().toLocaleString()}</div>
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:14px;gap:18px;flex-wrap:wrap;">
      <div>
        <div style="font-weight:900;font-size:26px;letter-spacing:.4px;margin-bottom:4px;">${headerTitle}</div>
        <div style="color:#4e5b60;font-size:13px;">Date: ${docDate}</div>
      </div>
      <div style="text-align:right;min-width:160px;">
        <div style="font-weight:700;font-size:15px;">${c?.name || ''}</div>
        ${c?.phone ? `<div style="color:#4e5b60;font-size:13px;">${c.phone}</div>` : ''}
        ${c?.email ? `<div style="color:#4e5b60;font-size:13px;">${c.email}</div>` : ''}
      </div>
    </div>

    <hr>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;margin-bottom:16px;">
      <div>
        <div style="color:#5b696f;font-size:12px;text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px;">Package</div>
        <div style="font-weight:700;font-size:16px;">${pkgLabel}${vehicleSummary?` — ${vehicleSummary}`:''}</div>
      </div>
      <div>
        <div style="color:#5b696f;font-size:12px;text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px;">Status</div>
        <div style="font-weight:700;font-size:16px;">${j.status || 'Quoted'}</div>
      </div>
      <div>
        <div style="color:#5b696f;font-size:12px;text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px;">Vehicles</div>
        <div style="font-weight:700;font-size:16px;">${vehicleCount}</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:24px;align-items:flex-start;">
      <div>
        <div style="font-weight:800;margin:6px 0 6px;font-size:15px;">Included with ${uniquePackages.length>1?'packages':'package'}</div>
        <ul>${included || '<li>None</li>'}</ul>

        ${hasVehicles ? `<div style=\"font-weight:800;margin:16px 0 8px;font-size:15px;\">Vehicles</div><div style=\"display:flex;flex-direction:column;gap:16px;\">${vehicleSections}</div>` : `<div style=\"font-weight:800;margin:16px 0 8px;font-size:15px;\">Add-ons</div><table style=\"width:100%;border-collapse:collapse;font-size:14px\">${legacyAddons || '<tr><td style=\"color:#666\">None</td><td></td></tr>'}</table>`}

        ${j.notes ? `<div style="margin-top:16px"><div style="color:#5b696f;font-size:12px;text-transform:uppercase;letter-spacing:.4px;">Notes</div><div style="margin-top:4px;white-space:pre-wrap;">${j.notes}</div></div>` : ''}
      </div>

      <div>
        <table style="font-size:14px">
          <tr><td>Subtotal</td><td style="text-align:right">$${subtotal}</td></tr>
          <tr><td>${discountLabel}</td><td style="text-align:right">-$${disc}</td></tr>
          <tr><td style="padding-top:10px;border-top:1px solid #dde3e6;font-weight:800">Total</td><td style="padding-top:10px;border-top:1px solid #dde3e6;font-weight:800;text-align:right">$${total}</td></tr>
        </table>

        ${paidRows ? `
        <div style="margin-top:18px">
          <div style="font-weight:800;margin-bottom:6px;font-size:15px;">Payments</div>
          <table style="width:100%;border-collapse:collapse;font-size:14px;">
            <tr style="color:#5b696f;font-size:12px;text-transform:uppercase;letter-spacing:.4px;">
              <td>Date</td><td>Method</td><td style="text-align:right">Amount</td>
            </tr>
            ${paidRows}
          </table>
        </div>` : ''}
      </div>
    </div>

    <div style="margin-top:28px;color:#738087;font-size:12px;">Thank you for your business.</div>
  </div>
  <script>
    window.addEventListener('load', function(){
      try { window.focus(); } catch(e){}
    });
  <\/script>
</body>
</html>`;

  const popup = window.open('', '_blank');
  if(!popup || popup.closed){
    alert('Please allow pop-ups to view the printable page.');
    return;
  }
  popup.document.open();
  popup.document.write(popupHtml);
  popup.document.close();
};

/*** Data export ***/
const Data = {
  exportJSON(){ const blob=new Blob([JSON.stringify(S,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='pc_accounting_backup.json'; a.click(); URL.revokeObjectURL(url); },
  exportCSV(){ const rows=[[ 'date','type','category','item','client','vendor','payment','amount','notes' ]]; for(const t of S.transactions) rows.push([ t.date||'', t.type||'', t.category||'', (t.item||'').replace(/,/g,' '), UI.clientName(t.clientId||'').replace(/,/g,' '), (t.vendor||'').replace(/,/g,' '), t.payment||'', Number(t.amount||0).toFixed(2), (t.notes||'').replace(/,/g,' ') ]); const csv=rows.map(r=>r.join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='transactions.csv'; a.click(); URL.revokeObjectURL(url); }
};

window.addEventListener('load', ()=>App.init());
</script>
</body>
</html>
