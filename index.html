<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<title>POLISH CREW — Accounting</title>
<style>
  :root { --bg:#0b0b0c; --card:#101114; --text:#f5f7f7; --muted:#a7b0b0; --green:#00A651; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Montserrat,system-ui,Segoe UI,Roboto,Arial,sans-serif;}
  .appbar{position:sticky;top:0;z-index:10;display:flex;gap:.75rem;align-items:center;padding:.75rem 1rem;background:linear-gradient(180deg,#000c,#0009);border-bottom:1px solid #16181a;backdrop-filter:blur(8px);}
  .logo{width:32px;height:32px;border-radius:8px;background:#000;border:2px solid var(--green);}
  .title{font-family:Oswald,'Bebas Neue',Impact,sans-serif;font-weight:800;letter-spacing:.5px;font-size:1.05rem;}
  .spacer{flex:1}
  .iconbtn{background:#0a0b0c;border:1px solid #1b1d20;padding:.5rem;border-radius:12px;cursor:pointer;}
  .tabs{display:flex;gap:.5rem;padding:.5rem;border-bottom:1px solid #15171a;background:#050607;position:sticky;top:3.5rem;z-index:9;}
  .tab{padding:.5rem .75rem;border:1px solid #1a1e21;border-radius:999px;cursor:pointer;font-weight:700;color:#cfd6d6}
  .tab.active{background:radial-gradient(120% 120% at 50% 0%,#0f1a12,#0a0d0b);border-color:#1f2a1f;color:var(--text);box-shadow:0 0 0 1px #112c19 inset,0 0 12px #0a1}
  .wrap{padding:1rem;max-width:1100px;margin:0 auto}
  .grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));}
  .grid.single-column{grid-template-columns:minmax(0,1fr);}  
  .card{background:linear-gradient(180deg,#0f1013,#0b0c0f);border:1px solid #1a1e21;border-radius:16px;padding:1rem;box-shadow:inset 0 1px 0 #1b221d;}
  .card h3{margin:.25rem 0 .75rem;font-family:Oswald,'Bebas Neue',Impact,sans-serif;letter-spacing:.4px}
  .muted{color:var(--muted);font-size:.9rem}
  input,select,textarea{width:100%;background:#0a0b0c;color:var(--text);border:1px solid #1a1e21;border-radius:12px;padding:.6rem .7rem;outline:none}
  textarea{min-height:72px}
  label{font-size:.85rem;color:#c7d0d0;display:block;margin:.4rem 0 .2rem}
  .row{display:flex;gap:.5rem;align-items:center}
  .row>*{flex:1}
  .btn{background:linear-gradient(180deg,#0c1f14,#0b1510);color:#eaf5ef;border:1px solid #153a26;border-radius:12px;padding:.6rem .8rem;cursor:pointer;font-weight:800}
  .btn.secondary{background:#0b0c0f;border-color:#20242a;color:#d5dddd}
  .pill{border-radius:999px;padding:.25rem .6rem;border:1px solid #1f2a1f;background:#0b130d;color:#cfe9d6;font-weight:800}
  .list{display:flex;flex-direction:column;gap:.5rem}
  .list-item{padding:.5rem .6rem;border:1px solid #171a1d;background:#0a0c0f;border-radius:10px}
  .tiny{font-size:.8rem;color:#aab5b5}
  .hidden{display:none}
  .stack-buttons{display:flex;flex-direction:column;gap:.5rem;align-items:stretch}
  .stack-buttons .fullwidth{width:100%}
  .stack-buttons .btn,.stack-buttons .pill{width:100%}
  @media(min-width:720px){
    .stack-buttons{flex-direction:row;}
    .stack-buttons .btn,.stack-buttons .pill{width:auto;flex:1}
  }
  .receipt-scan{display:flex;flex-direction:column;gap:.75rem;}
  .receipt-preview{border:1px dashed #1f2428;border-radius:12px;padding:.75rem;background:#080a0d;display:flex;flex-direction:column;gap:.6rem;}
  .receipt-preview.hidden{display:none;}
  .receipt-preview img{width:100%;max-height:220px;object-fit:contain;border-radius:10px;background:#000;}
  .receipt-ocr-status{font-size:.8rem;color:var(--muted);}
  .form-grid{display:flex;flex-direction:column;gap:.75rem;}
  .mobile-field-row{display:flex;flex-direction:column;gap:.5rem;}
  @media(min-width:720px){
    .mobile-field-row{flex-direction:row;}
    .mobile-field-row>div{flex:1;}
  }
  .transaction-card{display:flex;flex-direction:column;gap:.5rem;}
  .transaction-card h4{margin:0;font-size:1rem;}
  .transaction-meta{display:flex;flex-wrap:wrap;gap:.35rem;font-size:.75rem;color:var(--muted);}
  .transaction-meta span{background:#101215;border-radius:999px;padding:.2rem .6rem;}
  .transaction-amount{font-weight:800;}
  .transaction-notes{font-size:.85rem;color:#c7d0d0;}
  .vehicle-addon-row[data-included="true"]{opacity:.6;}
  .vehicle-addon-row[data-included="true"] input{pointer-events:none;opacity:.7;}
  .vehicle-package-info{border-radius:12px;border:1px solid #15191c;background:#090b0d;padding:.65rem;margin-top:.5rem;display:flex;flex-direction:column;gap:.35rem;}
  .vehicle-package-info.hidden{display:none;}
  .vehicle-package-info h4{margin:0;font-size:.85rem;color:#f5f7f7;letter-spacing:.2px;}
  .vehicle-package-info p{margin:0;color:#bac6c6;font-size:.85rem;line-height:1.4;}
  .vehicle-package-info ul{margin:.1rem 0 0 1.1rem;padding:0;color:#95a6a6;font-size:.8rem;line-height:1.5;}
  .menu-pkg-card{background:linear-gradient(180deg,#121418,#0c0d10);border:1px solid #1a1e21;border-radius:16px;padding:.75rem;display:flex;flex-direction:column;gap:.6rem;}
  .menu-pkg-card .pkg-header{display:flex;align-items:center;gap:.6rem;}
  .menu-pkg-card .pkg-name{width:100%;}
  .menu-pkg-card .pkg-toggle{flex:0 0 auto;background:#0b0c0f;border:1px solid #1a1e21;color:#d5dddd;border-radius:10px;padding:.3rem .55rem;cursor:pointer;font-size:.85rem;font-weight:700;line-height:1;}
  .menu-pkg-card .pkg-summary{font-size:.8rem;color:#96a4a4;cursor:pointer;}
  .menu-pkg-card .pkg-body{display:flex;flex-direction:column;gap:.5rem;}
  .menu-pkg-card[data-collapsed="true"] .pkg-body{display:none;}
  .menu-pkg-card .pkg-addon-options{display:flex;flex-wrap:wrap;gap:.4rem;}
  .pkg-addon-option{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .6rem;border:1px solid #1b1f22;border-radius:999px;background:#0a0c0f;font-size:.8rem;cursor:pointer;}
  .pkg-addon-option[data-selected="true"]{opacity:.6;}
  .pkg-addon-option input{margin:0;}
  .footnote{font-size:.8rem;color:#8ea59a}
  .crew-callout{border-radius:14px;padding:.75rem;border:1px solid #1f2a1f;background:linear-gradient(180deg,#0d130f,#080c0a);color:#dbe9df;font-size:.85rem;line-height:1.4}
  .crew-callout.alert{border-color:#3a2626;background:linear-gradient(180deg,#1b0f0f,#120909);color:#f4d6d6}
  .crew-checklist-section{display:flex;flex-direction:column;gap:.5rem}
  .crew-checklist-header{display:flex;justify-content:space-between;align-items:flex-end;gap:.75rem;flex-wrap:wrap}
  .crew-checklist-items{display:flex;flex-direction:column;gap:.5rem}
  .crew-checklist-item{display:flex;align-items:center;gap:.75rem;padding:.6rem;border:1px solid #15191c;background:#090b0d;border-radius:12px}
  .crew-checklist-item[data-complete="true"]{border-color:#1f2a1f;background:#0d1310}
  .crew-checklist-item[data-running="true"] .crew-timer{color:var(--green)}
  .crew-checklist-item input[type=checkbox]{width:18px;height:18px}
  .crew-step{flex:1}
  .crew-step .tiny{color:#99a7a7}
  .crew-timer{font-variant-numeric:tabular-nums;font-weight:700;min-width:72px;text-align:right}
  .crew-timer-controls{display:flex;align-items:center;gap:.45rem}
  .drawer {position:fixed;right:0;top:0;height:100%;width:min(92vw,420px);transform:translateX(100%);transition:transform .25s ease;background:#050607;border-left:1px solid #14171a;z-index:20;display:flex;flex-direction:column}
  .drawer.open{transform:translateX(0)}
  .job-panel{position:fixed;right:0;top:0;height:100%;width:min(96vw,520px);transform:translateX(100%);transition:transform .28s ease;background:#060708;border-left:1px solid #15191c;z-index:25;display:flex;flex-direction:column;box-shadow:-12px 0 40px rgba(0,0,0,.35)}
  .job-panel.open{transform:translateX(0)}
  .job-panel header{padding:1rem;border-bottom:1px solid #14171a;display:flex;flex-direction:column;gap:.35rem;background:linear-gradient(180deg,#080a0c,#050607)}
  .job-panel header .row{align-items:center}
  .job-panel-body{flex:1;overflow:auto;padding:1rem;display:flex;flex-direction:column;gap:1rem}
  .job-meta-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.6rem}
  .job-section{border:1px solid #15191c;background:#090b0d;border-radius:14px;padding:.85rem;display:flex;flex-direction:column;gap:.55rem}
  .job-section h4{margin:0;font-family:Oswald,'Bebas Neue',Impact,sans-serif;letter-spacing:.4px;font-size:1rem}
  .job-services{display:flex;flex-direction:column;gap:.45rem}
  .job-service{display:flex;align-items:center;gap:.5rem;background:#0a0c0f;border:1px solid #15191c;padding:.5rem .6rem;border-radius:12px}
  .job-service .service-main{flex:1}
  .job-service .service-meta{font-size:.8rem;color:#96a4a4}
  .job-timers{display:flex;flex-direction:column;gap:.5rem}
  .job-timer{display:flex;align-items:center;gap:.6rem;background:#0a0c0f;border:1px solid #15191c;padding:.5rem .6rem;border-radius:12px}
  .job-timer .timer-info{flex:1}
  .job-timer .timer-label{font-weight:800}
  .job-timer .timer-value{font-variant-numeric:tabular-nums;font-weight:800;font-size:1.05rem;color:#e4f6eb}
  .job-timer[data-running="true"] .timer-value{color:var(--green)}
  .job-timer-controls{display:flex;gap:.35rem;flex-wrap:wrap}
  .job-timer-controls .pill{cursor:pointer}
  .job-filter-active{background:linear-gradient(180deg,#102b1c,#0b1a12);color:#f2fbf7;border-color:#1f3a29;box-shadow:0 0 0 1px #173a26 inset}
</style>
</head>
<body>
  <div class="appbar">
    <img id="headerLogo" class="logo" alt="logo">
    <div id="headerTitle" class="title">POLISH CREW — Accounting</div>
    <div class="spacer"></div>
    <button id="openDrawer" class="iconbtn" title="More">⚙️</button>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="Dashboard">Dashboard</div>
    <div class="tab" data-tab="Quotes">Quotes</div>
    <div class="tab" data-tab="Jobs">Jobs</div>
    <div class="tab" data-tab="QuoteBuilder">Quote Builder</div>
    <div class="tab" data-tab="Clients">Clients</div>
  </div>

  <div class="wrap">
    <section id="Dashboard" class="tabpage">
      <div class="grid">
        <div class="card">
          <h3>Month to Date</h3>
          <div class="grid">
            <div class="card"><div class="muted">Income</div><div id="mIncome" style="font-size:1.6rem;font-weight:800">$0.00</div></div>
            <div class="card"><div class="muted">Expenses</div><div id="mExpense" style="font-size:1.6rem;font-weight:800">$0.00</div></div>
            <div class="card"><div class="muted">Net</div><div id="mNet" style="font-size:1.6rem;font-weight:800">$0.00</div></div>
          </div>
        </div>
        <div class="card">
          <h3>Quick Actions</h3>
          <div class="row">
            <button class="btn" onclick="UI.startQuoteFlow()">Start a Quote</button>
            <button class="btn" onclick="UI.openExpenseForm()">Add Expense</button>
            <button class="btn" onclick="UI.switchTab('Clients')">Add Client</button>
            <button class="btn secondary" onclick="Data.exportCSV()">Export CSV</button>
          </div>
        </div>
        <div class="card">
          <h3>Recent Activity</h3>
          <div id="recentList" class="list"></div>
        </div>
      </div>
    </section>

    <section id="Quotes" class="tabpage hidden">
      <div class="grid single-column">
        <div class="card">
          <h3>Pending Quotes</h3>
          <div class="muted tiny">Quotes stay here until you convert them into jobs or collect payment.</div>
          <div class="stack-buttons" style="margin:.75rem 0 .5rem;">
            <button class="btn fullwidth" onclick="UI.startQuoteFlow()">New Quote</button>
            <button class="btn secondary fullwidth" onclick="UI.printQuotesSummary()">Print All Quotes</button>
          </div>
          <div id="quotesList" class="list"></div>
        </div>
      </div>
    </section>

    <section id="Jobs" class="tabpage hidden">
      <div class="grid">
        <div class="card" style="grid-column:1 / -1;">
          <h3>Job Board</h3>
          <div class="row" style="flex-wrap:wrap;gap:.5rem;align-items:center;">
            <div class="row" style="gap:.4rem;flex-wrap:wrap;">
              <button class="pill" data-filter="all" onclick="UI.setJobFilter('all')">All</button>
              <button class="pill" data-filter="today" onclick="UI.setJobFilter('today')">Today</button>
              <button class="pill" data-filter="upcoming" onclick="UI.setJobFilter('upcoming')">Upcoming</button>
              <button class="pill" data-filter="completed" onclick="UI.setJobFilter('completed')">Completed</button>
              <button class="pill" data-filter="unpaid" onclick="UI.setJobFilter('unpaid')">Unpaid</button>
            </div>
            <div class="spacer"></div>
            <button class="btn" onclick="UI.startQuoteFlow()">Create Quote</button>
          </div>
          <div id="jobsList" class="list" style="margin-top:.75rem;"></div>
        </div>
        <div class="card">
          <h3>Schedule Planner</h3>
          <label for="jobPlannerDate">Select day</label>
          <input id="jobPlannerDate" type="date" onchange="UI.refreshJobPlanner()">
          <div id="jobPlannerList" class="list" style="margin-top:.6rem;"></div>
        </div>
        <div class="card">
          <h3>Performance Snapshot</h3>
          <div id="jobPerformance" class="list" style="gap:.35rem;"></div>
          <div class="footnote" style="margin-top:.6rem;">Completed job durations help track crew efficiency and plan future ETAs.</div>
        </div>
      </div>
    </section>

    <section id="QuoteBuilder" class="tabpage hidden">
      <div class="grid">
        <div class="card">
          <h3>Quote → Book → Pay</h3>
          <div class="row">
            <div><label>Client</label><select id="jobClient"></select></div>
            <div style="flex:0"><label>&nbsp;</label><button class="btn" onclick="UI.showQuickClient()">Quick Add Client</button></div>
          </div>

          <div class="row" style="margin-top:.6rem;flex-wrap:wrap;gap:.75rem;">
            <div style="flex:1;min-width:160px;">
              <label>Date</label>
              <input id="jobDate" type="date">
            </div>
            <div style="flex:1;min-width:140px;">
              <label>Start Time</label>
              <input id="jobStart" type="time">
            </div>
            <div style="flex:1;min-width:140px;">
              <label>End Time</label>
              <input id="jobEnd" type="time">
            </div>
            <div style="flex:1;min-width:140px;">
              <label>Estimated Duration</label>
              <input id="jobDuration" placeholder="1h 45m">
            </div>
          </div>

          <div id="quickClient" class="card hidden" style="margin:.5rem 0;">
            <div class="row"><div><label>Name *</label><input id="qcName"></div><div><label>Phone</label><input id="qcPhone"></div></div>
            <div class="row"><div>
              <label>Default Discount</label>
              <div class="row">
                <select id="qcDiscType"><option value="none">None</option><option value="%">%</option><option value="$">$</option></select>
                <input id="qcDiscValue" type="number" min="0" step="1" placeholder="0">
              </div>
            </div><div><label>Notes</label><input id="qcNotes"></div></div>
            <div class="row"><button class="btn" onclick="App.addQuickClient()">Save Client</button><button class="btn secondary" onclick="UI.hideQuickClient()">Cancel</button></div>
          </div>

            <div class="card" style="margin-top:.6rem;">
              <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:.4rem;gap:.5rem;flex-wrap:wrap;">
                <h3 style="margin:.25rem 0;">Vehicles</h3>
                <div class="row" style="gap:.5rem;flex-wrap:wrap;justify-content:flex-end;">
                  <button class="btn secondary" onclick="UI.openCustomBuilder()">Edit Packages</button>
                <button class="btn secondary" onclick="UI.addVehicle()">Add Vehicle</button>
              </div>
            </div>
            <div id="vehiclesList" class="list"></div>
            <div id="addonSummary" class="crew-callout" style="margin-top:.5rem;">
              <div style="font-weight:800;">Add-on guidance</div>
              <div class="tiny">Select packages and add-ons to see maintenance vs. full detail recommendations.</div>
            </div>
            <div class="footnote">≤3 add-ons = Maintenance. 4+ or heavy soil → Full Detail upgrade.</div>
          </div>

          <div class="row" style="margin-top:.6rem;align-items:flex-start;gap:1rem;">
            <div style="flex:1;">
              <label>Discount</label>
              <div class="row">
                <select id="jobDiscType"><option value="none">None</option><option value="%">%</option><option value="$">$</option></select>
                <input id="jobDiscValue" type="number" min="0" step="1" value="0">
              </div>
              <div class="row" style="gap:.5rem;margin-top:.4rem;">
                <button class="pill" onclick="UI.quickDisc('$',10)">$10</button>
                <button class="pill" onclick="UI.quickDisc('$',20)">$20</button>
                <button class="pill" onclick="UI.quickDisc('%',10)">10%</button>
                <button class="pill" onclick="UI.quickDisc('%',15)">F&amp;F 15%</button>
              </div>
              <div class="row" style="gap:.5rem;margin-top:.4rem;align-items:center;">
                <div class="tiny" style="flex:0 0 auto;color:#aab5b5;">Apply</div>
                <select id="jobDiscScope" style="flex:1;">
                  <option value="job">Once per job</option>
                  <option value="vehicle">Per vehicle</option>
                </select>
              </div>
              <div class="tiny" style="margin-top:.25rem;">Per-vehicle discounts are applied to each vehicle individually.</div>
            </div>
            <div style="flex:1;"><label>Notes</label><textarea id="jobNotes" placeholder="Any special conditions, soil level, etc."></textarea></div>
          </div>

          <div class="grid">
            <div class="card"><div class="muted">Subtotal</div><div id="jobSubtotal" style="font-size:1.4rem;font-weight:800">$0.00</div></div>
            <div class="card"><div class="muted">Discount</div><div id="jobDiscount" style="font-size:1.4rem;font-weight:800">$0.00</div></div>
            <div class="card"><div class="muted">Total</div><div id="jobTotal" style="font-size:1.4rem;font-weight:800">$0.00</div></div>
          </div>

          <div class="stack-buttons">
            <button id="quoteSaveBtn" class="btn fullwidth" onclick="App.saveJob({asQuote:true})">Save Quote</button>
            <button id="jobSaveBtn" class="btn fullwidth" onclick="App.saveJob({asQuote:false})">Schedule Job</button>
            <button class="btn secondary fullwidth" onclick="UI.printQuote()">Print / Save Quote</button>
            <button id="jobEditCancel" class="btn secondary fullwidth hidden" type="button" onclick="UI.cancelJobEdit()">Cancel Edit</button>
          </div>
        </div>
      </div>
    </section>

    <section id="Clients" class="tabpage hidden">
      <div class="grid">
        <div class="card">
          <h3>Add Client</h3>
          <div class="row"><div><label>Name *</label><input id="cName"></div><div><label>Phone</label><input id="cPhone"></div></div>
          <label>Notes</label><input id="cNotes">
          <div class="row">
            <div>
              <label>Default Discount</label>
              <div class="row">
                <select id="cDiscType"><option value="none">None</option><option value="%">%</option><option value="$">$</option></select>
                <input id="cDiscValue" type="number" min="0" step="1" value="0">
              </div>
            </div>
            <div class="row" style="align-items:flex-end;"><button class="btn" onclick="App.addClient()">Save Client</button></div>
          </div>
        </div>
        <div class="card"><h3>Clients</h3><div id="clientsList" class="list"></div></div>
      </div>
    </section>
  </div>

  <div id="drawer" class="drawer">
    <header style="padding:1rem;border-bottom:1px solid #14171a;display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:800;">More</div>
      <button class="iconbtn" onclick="UI.toggleDrawer(false)">✖</button>
    </header>
    <div class="content" style="padding:1rem;display:flex;flex-direction:column;gap:.6rem;overflow:auto;">
      <div class="tiny">Operations</div>
      <div class="list">
        <div class="list-item" onclick="UI.openMenuEditor()">Menu Editor ›</div>
      </div>
      <div class="tiny">Records</div>
      <div class="list">
        <div class="list-item" onclick="UI.openMileage()">Mileage ›</div>
        <div class="list-item" onclick="UI.openTransactions()">Transactions ›</div>
        <div class="list-item" onclick="UI.openExpenses()">Expenses ›</div>
      </div>
      <div class="tiny">Data</div>
      <div class="list">
        <div class="list-item" onclick="Data.exportJSON()">Export JSON ›</div>
        <div class="list-item" onclick="UI.openImport()">Import JSON ›</div>
      </div>
      <div class="tiny">App</div>
      <div class="list">
        <div class="list-item" onclick="UI.openSettings()">Settings ›</div>
      </div>
      <div class="footnote">Build cache: <b>pcwa-v2.2.0</b></div>
    </div>
  </div>

  <div id="jobPanel" class="job-panel">
    <header>
      <div class="row" style="justify-content:space-between;gap:.5rem;">
        <div id="jobPanelTitle" style="font-weight:800;font-size:1.1rem;">Job Details</div>
        <button class="iconbtn" onclick="UI.closeJobPanel()">✖</button>
      </div>
      <div id="jobPanelSubtitle" class="tiny" style="color:#9fb2ae;"></div>
    </header>
    <div id="jobPanelBody" class="job-panel-body"></div>
  </div>

  <div id="modalHost"></div>

<script>
const DEFAULT_SIZES = ["Coupe","Sedan","Crossover","SUV/Truck","XL/Lifted"];
const DEFAULT_MENU = {
  sizes: DEFAULT_SIZES,
  packages: {
    "Exterior Wash Only": [40,45,50,55,65],
    "Interior Clean Only": [45,50,55,60,70],
    "In & Out Combo": [70,75,85,95,110],
    "Quick In & Out": [65,70,80,90,100],
    "Maintenance Detail": [100,110,120,130,145],
    "Full Detail": [125,140,155,175,200],
    "Dog Hair / Stain Focus": [100,110,120,130,150]
  },
  addons: {
    "Wheels & Tires — Deep clean wheels, barrels, tires + gloss dressing": [10,12,15,18,20],
    "Exterior Brush Detail — Emblems, trim, grilles, window seals": [15,18,20,22,25],
    "Interior Brush Detail — Vents, seams, cupholders, buttons": [15,18,20,22,25],
    "Interior Protectant — UV / fade protection on plastics & vinyl": [10,12,15,18,20],
    "Dog Hair Removal — Light–heavy removal using rubber brush + vac": [30,60,80,100,130],
    "Spot Stain Clean — 1–3 seat or carpet stains treated": [25,30,35,40,50],
    "Odor Neutralizer — Deodorizing mist or fog": [25,28,30,32,35],
    "Engine Bay Clean — Degrease → rinse → dress plastics": [40,45,50,55,60],
    "Trim Restore — Restores faded black plastics / rubber": [25,28,30,32,35],
    "Spray Wax — Adds short-term gloss & slickness": [10,12,15,20,25],
    "Paste Wax — Warmer shine & 1–3 mo. protection": [20,25,28,32,35],
    "Spray Sealant — Hydrophobic layer (3–6 mo. protection)": [30,35,38,42,45],
    "Spray Ceramic — Strong hydrophobic & 6–12 mo. durability": [40,45,50,52,55],
    "Clay & Iron Decon — Removes bonded contaminants before protection": [45,50,55,60,65]
  },
  guidance: "Add ≤3 add-ons → stays at Maintenance Detail. 4+ or heavy soil → upgrade to Full Detail.",
  packageMeta: {
    "Exterior Wash Only": {lock:false, includedAddons:[], description:"Hand wash, foam bath, wheel faces, tire dressing, and streak-free glass."},
    "Interior Clean Only": {lock:false, includedAddons:[], description:"Vacuum interior, wipe plastics, clean glass, and refresh touch points."},
    "In & Out Combo": {lock:false, includedAddons:[], description:"Our balanced interior & exterior refresh with wash, vacuum, wipe-down, and glass."},
    "Quick In & Out": {lock:false, includedAddons:[], description:"Express spruce up for maintenance customers needing a fast touch-up."},
    "Maintenance Detail": {lock:false, includedAddons:[
      "Wheels & Tires — Deep clean wheels, barrels, tires + gloss dressing",
      "Exterior Brush Detail — Emblems, trim, grilles, window seals",
      "Interior Brush Detail — Vents, seams, cupholders, buttons",
      "Interior Protectant — UV / fade protection on plastics & vinyl",
      "Spray Sealant — Hydrophobic layer (3–6 mo. protection)",
      "Spot Stain Clean — 1–3 seat or carpet stains treated"
    ], description:"Full maintenance service with high-touch interior and exterior detailing essentials."},
    "Full Detail": {lock:false, includedAddons:[
      "Wheels & Tires — Deep clean wheels, barrels, tires + gloss dressing",
      "Exterior Brush Detail — Emblems, trim, grilles, window seals",
      "Interior Brush Detail — Vents, seams, cupholders, buttons",
      "Interior Protectant — UV / fade protection on plastics & vinyl",
      "Spray Sealant — Hydrophobic layer (3–6 mo. protection)",
      "Spot Stain Clean — 1–3 seat or carpet stains treated",
      "Dog Hair Removal — Light–heavy removal using rubber brush + vac",
      "Odor Neutralizer — Deodorizing mist or fog",
      "Clay & Iron Decon — Removes bonded contaminants before protection"
    ], description:"Comprehensive reset for vehicles needing the works plus odor & contamination removal."},
    "Dog Hair / Stain Focus": {lock:false, includedAddons:[
      "Dog Hair Removal — Light–heavy removal using rubber brush + vac",
      "Spot Stain Clean — 1–3 seat or carpet stains treated",
      "Odor Neutralizer — Deodorizing mist or fog"
    ], description:"Targeted interior overhaul to tackle embedded hair, stains, and lingering odors."}
  }
};

const DEFAULT_SETTINGS = {
  paymentMethods: ["Cash","Card","Zelle","Venmo","CashApp","Bank"],
  categories: ["Package","Add-on","Supplies","Fuel","Tools/Equipment","Marketing","Labor/Subcontract","Fees","Other"]
};

const DEFAULT_BIZ = { name:"Polish Crew", headerTitle:"POLISH CREW — Accounting", logoDataUrl:"" };

const CREW_CHECKLIST_SECTIONS = [
  {
    id: 'setup',
    title: 'Setup',
    goalMinutes: 10,
    items: [
      { id: 'setup-position', label: 'Position truck + hose for easy flow.', description: 'Stage the rig for an efficient workflow and protect the customer’s property.' },
      { id: 'setup-prep', label: 'Prep bucket system, towels, brushes, and chemicals.', description: 'Separate interior, exterior, glass, and wheel towels. Confirm correct dilution.' },
      { id: 'setup-power', label: 'Confirm power source or generator placement.', description: 'Keep exhaust safe and avoid detailing under direct sun when possible.' },
      { id: 'setup-greet', label: 'Greet customer, confirm package, spotlight special issues.', description: 'Manage expectations before touching the vehicle.' }
    ]
  },
  {
    id: 'exterior',
    title: 'Exterior Process',
    goalMinutes: 35,
    items: [
      { id: 'ext-rinse', label: 'Rinse vehicle.', description: 'Knock down loose dirt before contact wash.' },
      { id: 'ext-foam', label: 'Foam & wash top-down.', description: 'No dry wiping on paint — use lubricated mitts and detailer.' },
      { id: 'ext-wheels', label: 'Clean wheels & tires.', description: 'Use dedicated brushes and towels for wheels.' },
      { id: 'ext-final-rinse', label: 'Final rinse.', description: 'Check seams and badges for soap runoff.' },
      { id: 'ext-dry', label: 'Dry with microfiber + blower.', description: 'Keep towels clean and avoid dragging on paint.' },
      { id: 'ext-upsell', label: 'Offer Spray Wax / Sealant / Ceramic upsell.', description: 'Upsell once exterior is clean and dry for added protection.' },
      { id: 'ext-glass', label: 'Tire shine + exterior glass.', description: 'Dress tires (not pedals) and finish glass streak-free.' }
    ]
  },
  {
    id: 'interior',
    title: 'Interior Process',
    goalMinutes: 45,
    items: [
      { id: 'int-trash', label: 'Remove trash & mats.', description: 'Keep customer belongings organized.' },
      { id: 'int-vacuum', label: 'Vacuum rear to front.', description: 'Address pet hair or heavy soil with proper tools.' },
      { id: 'int-wipe', label: 'Wipe plastics, buttons, cupholders.', description: 'Never dress pedals or steering wheel.' },
      { id: 'int-brush', label: 'Brush seams, vents, and edges.', description: 'Use gentle detail brushes for vents and trim.' },
      { id: 'int-glass', label: 'Clean interior glass.', description: 'Use fresh towels reserved for glass only.' },
      { id: 'int-protect', label: 'Add interior protectant & scent.', description: 'Apply light, even coverage for UV protection.' },
      { id: 'int-final-check', label: 'Final interior check.', description: 'Inspect steering wheel, door jambs, and screens.' }
    ]
  },
  {
    id: 'presentation',
    title: 'Final Presentation',
    goalMinutes: 10,
    items: [
      { id: 'final-walk', label: 'Walk around with customer.', description: 'Showcase results with confident energy.' },
      { id: 'final-notes', label: 'Point out existing wear or permanent marks.', description: 'Set expectations and educate on what was corrected.' },
      { id: 'final-payment', label: 'Collect payment (Cash / Zelle / Venmo).', description: 'Use official pricing — no unapproved discounts.' },
      { id: 'final-testimonial', label: 'Request testimonial or photo.', description: 'Capture content for socials; highlight green brand accents.' }
    ]
  }
];

const AppState = { business: DEFAULT_BIZ, clients: [], menu: DEFAULT_MENU, jobs: [], transactions: [], mileage: [], settings: DEFAULT_SETTINGS };

function cloneData(obj){
  if(typeof structuredClone === 'function'){
    return structuredClone(obj);
  }
  return JSON.parse(JSON.stringify(obj));
}

const Storage = {
  key: "pc_accounting_v2",
  load() {
    try {
      const raw = localStorage.getItem(this.key);
      if (!raw) return cloneData(AppState);
      const parsed = JSON.parse(raw);
      if (!parsed.settings) parsed.settings = cloneData(DEFAULT_SETTINGS);
      if (!parsed.menu) parsed.menu = cloneData(DEFAULT_MENU);
      if (!parsed.business) parsed.business = cloneData(DEFAULT_BIZ);
      if (!parsed.transactions) parsed.transactions = [];
      if (!parsed.clients) parsed.clients = [];
      if (!parsed.jobs) parsed.jobs = [];
      if (!parsed.mileage) parsed.mileage = [];
      if (!parsed.menu.packageMeta) parsed.menu.packageMeta = {};
      return parsed;
    } catch(e) {
      UI.bootError("Failed to load saved data: " + e.message);
      return cloneData(AppState);
    }
  },
  save(state) { localStorage.setItem(this.key, JSON.stringify(state)); }
};

let S = Storage.load();
ensurePackageMetaStructure();

/*** Normalization ***/
function ensurePackageMetaStructure(){
  let changed=false;
  if(!S.menu){
    S.menu={sizes:[],packages:{},addons:{},packageMeta:{}};
    changed=true;
  }
  if(!S.menu.packageMeta){
    S.menu.packageMeta={};
    changed=true;
  }
  for(const name of Object.keys(S.menu.packages||{})){
    if(!S.menu.packageMeta[name]){
      S.menu.packageMeta[name]={};
      changed=true;
    }
    const meta=S.menu.packageMeta[name];
    if(!Array.isArray(meta.includedAddons)){
      meta.includedAddons=[];
      changed=true;
    }
    if(typeof meta.description!=='string'){
      meta.description='';
      changed=true;
    }
    const lockValue=!!meta.lock;
    if(meta.lock!==lockValue){
      meta.lock=lockValue;
      changed=true;
    }
  }
  if(changed) Storage.save(S);
}

/*** Utils ***/
function uid(){ return Math.random().toString(36).slice(2,10); }
function fmt(n){ return "$"+Number(n||0).toFixed(2); }
function el(tag, attrs={}, ...children){ const e=document.createElement(tag); for(const [k,v] of Object.entries(attrs)){ if(k==='class')e.className=v; else if(k==='html') e.innerHTML=v; else if(k.startsWith('on')) e.addEventListener(k.slice(2),v); else e.setAttribute(k,v); } children.forEach(c=>e.append(c)); return e; }
function today(){ return new Date().toISOString().slice(0,10); }
function parseDurationInput(value){
  if(!value) return null;
  const raw=String(value).trim();
  if(!raw) return null;
  const colonMatch=raw.match(/^(\d+):(\d{1,2})$/);
  if(colonMatch){
    const hrs=Number(colonMatch[1]);
    const mins=Number(colonMatch[2]);
    if(!Number.isNaN(hrs) && !Number.isNaN(mins)) return hrs*60+mins;
  }
  let total=0;
  let matched=false;
  const hourMatch=raw.match(/(\d+(?:\.\d+)?)\s*h/i);
  if(hourMatch){
    total+=Math.round(parseFloat(hourMatch[1])*60);
    matched=true;
  }
  const minMatch=raw.match(/(\d+)\s*m/i);
  if(minMatch){
    total+=parseInt(minMatch[1],10);
    matched=true;
  }
  if(!matched && /^\d+(?:\.\d+)?$/.test(raw)){
    const numeric=parseFloat(raw);
    if(raw.includes('.') && numeric<=24){
      total+=Math.round(numeric*60);
    } else {
      total+=Math.round(numeric);
    }
    matched=true;
  }
  return matched && total>0 ? total : null;
}
function formatDurationMinutes(mins){
  if(mins==null) return '';
  const value=Math.max(0,Math.round(mins));
  const hrs=Math.floor(value/60);
  const rem=value%60;
  if(hrs && rem) return `${hrs}h ${rem}m`;
  if(hrs) return `${hrs}h`;
  return `${rem}m`;
}
function pkgMeta(name){
  const meta=(S.menu.packageMeta && S.menu.packageMeta[name])||{};
  const included=Array.isArray(meta.includedAddons)?meta.includedAddons:[];
  const description=typeof meta.description==='string'?meta.description:'';
  return {lock:!!meta.lock, includedAddons:included, description};
}

const Calc = {
  sizeIndex(size){ return S.menu.sizes.indexOf(size); },
  base(pkg,size){ const i=this.sizeIndex(size); return (S.menu.packages[pkg]||[])[i]||0; },
  addonPrice(name,size){ const i=this.sizeIndex(size); return (S.menu.addons[name]||[])[i]||0; },
  vehicleSubtotal(vehicle){ const add=(vehicle.addons||[]).reduce((t,a)=>t+Number(a.price||0),0); return Number(vehicle.base||0)+add; },
  vehicles(job){
    if(job.vehicles && job.vehicles.length){
      return job.vehicles.map(v=>({
        size: v.size || job.size || S.menu.sizes[0],
        base: Number(v.base||0),
        addons: (v.addons||[]).map(a=>({name:a.name, price:Number(a.price||0), included:!!a.included})),
        pkg: v.pkg || job.pkg || '',
        label: v.label || ''
      }));
    }
    const count=Math.max(1, Number(job.vehicleCount||1));
    const base=Number(job.base||0);
    const size=job.size || S.menu.sizes[0];
    const addons=(job.addons||[]).map(a=>({name:a.name, price:Number(a.price||0), included:!!a.included}));
    return Array.from({length:count},()=>({
      size,
      base,
      addons: addons.map(a=>({name:a.name, price:Number(a.price||0), included:!!a.included})),
      pkg: job.pkg || ''
    }));
  },
  addonSummary(job){
    const vehicles=this.vehicles(job);
    const perVehicle=vehicles.map((v,idx)=>{
      const addons=Array.isArray(v.addons)?v.addons:[];
      const included=addons.filter(a=>a && a.included).length;
      const custom=addons.filter(a=>a && !a.included).length;
      return {index:idx,label:v.label||'',size:v.size||'',included,custom};
    });
    let legacyIncluded=0;
    let legacyCustom=0;
    if(!vehicles.length && Array.isArray(job.addons)){
      for(const addon of job.addons){
        if(addon?.included) legacyIncluded++;
        else legacyCustom++;
      }
    }
    const totals=perVehicle.reduce((acc,info)=>{
      acc.custom+=info.custom;
      acc.included+=info.included;
      return acc;
    },{custom:legacyCustom,included:legacyIncluded});
    if(Array.isArray(job.extraCharges)){
      for(const extra of job.extraCharges){
        if(!extra) continue;
        if(extra.included) totals.included++;
        else totals.custom++;
      }
    }
    const requiresUpgrade=totals.custom>=4;
    const message=requiresUpgrade
      ? '4+ custom add-ons selected. Upgrade to Full Detail pricing or adjust scope.'
      : (totals.custom>0
          ? '≤3 custom add-ons keeps this at Maintenance pricing. Track time carefully.'
          : 'No custom add-ons selected. Maintain Maintenance Detail pricing.');
    const upsell='Always offer Spray Wax / Sealant / Ceramic after the exterior is clean and dry.';
    return {perVehicle, totalCustom:totals.custom, totalIncluded:totals.included, requiresUpgrade, message, upsell};
  },
  vehicleCount(job){ return this.vehicles(job).length; },
  subtotal(job){
    const base=this.vehicles(job).reduce((t,v)=>t+this.vehicleSubtotal(v),0);
    const extras=Array.isArray(job.extraCharges)?job.extraCharges.reduce((sum,charge)=>{
      if(!charge) return sum;
      if(charge.included) return sum;
      return sum+Number(charge.price||0);
    },0):0;
    return base+extras;
  },
  discount(job){
    const discType = job.discType;
    if(!discType || discType==='none') return 0;
    const value = Number(job.discValue||0);
    if(!value) return 0;
    const scope = job.discScope==='vehicle' ? 'vehicle' : 'job';
    const vehicles = this.vehicles(job);
    if(!vehicles.length) return 0;
    const subtotal = this.subtotal(job);
    if(discType==='%'){
      const pct = value/100;
      if(pct<=0) return 0;
      if(scope==='vehicle') return vehicles.reduce((sum,v)=>sum+this.vehicleSubtotal(v)*pct,0);
      return subtotal * pct;
    }
    if(discType==='$'){
      if(scope==='vehicle') return vehicles.reduce((sum,v)=>sum+Math.min(this.vehicleSubtotal(v), value),0);
      return Math.min(subtotal, value);
    }
    return 0;
  },
  total(job){ return this.subtotal(job)-this.discount(job); }
};

/*** App ***/
const App = {
  init(){
    this.normalizeClients();
    this.normalizeJobs();
    UI.initHeader();
    UI.initTabs();
    UI.populateClients();
    UI.populateSizesAndPackages();
    const clientSel=document.getElementById('jobClient');
    if(clientSel){
      clientSel.addEventListener('change',()=>UI.onClientChange());
    }
    document.getElementById('jobDiscType').addEventListener('change',()=>UI.updateTotals());
    document.getElementById('jobDiscValue').addEventListener('input',()=>UI.updateTotals());
    document.getElementById('jobDiscScope').addEventListener('change',()=>UI.updateTotals());
    UI.resetJobForm();
    UI.refreshJobsList();
    UI.refreshDashboard();
    if('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');
  },
  normalizeClients(){
    S.clients = Array.isArray(S.clients) ? S.clients : [];
    for(const c of S.clients){
      if(!c.discount) c.discount={type:'none', value:0};
      if(!Array.isArray(c.vehicles)) c.vehicles=[];
      for(const v of c.vehicles){
        if(!v.id) v.id=uid();
        if(!v.lastService) v.lastService=null;
        if(!Array.isArray(v.history)) v.history=[];
      }
    }
  },
  normalizeJobs(){
    S.jobs = Array.isArray(S.jobs) ? S.jobs : [];
    for(const job of S.jobs){
      this.ensureJobStructure(job);
    }
    Storage.save(S);
  },
  ensureJobStructure(job){
    if(!job) return;
    if(!Array.isArray(job.vehicles)) job.vehicles=[];
    if(!Array.isArray(job.payments)) job.payments=[];
    if(!job.schedule || typeof job.schedule!=='object'){
      job.schedule={ date:job.date||today(), start:'', end:'', durationMinutes:null };
    } else {
      if(!job.schedule.date) job.schedule.date=job.date||today();
      if(job.schedule.durationMinutes!=null) job.schedule.durationMinutes=Number(job.schedule.durationMinutes)||0;
    }
    if(!job.date) job.date=job.schedule.date||today();
    if(!job.createdAt){
      const base=job.schedule.date?`${job.schedule.date}T08:00:00`:`${today()}T08:00:00`;
      job.createdAt=new Date(base).toISOString();
    }
    if(!Array.isArray(job.extraCharges)) job.extraCharges=[];
    if(!Array.isArray(job.services) || !job.services.length){
      job.services=this.createServicesFromVehicles(job);
    } else {
      this.normalizeServices(job);
    }
    this.ensureTimers(job);
    this.ensureChecklist(job);
  },
  normalizeServices(job){
    if(!Array.isArray(job.services)){
      job.services=[];
      return;
    }
    job.services=job.services.map(service=>{
      const copy={...service};
      copy.id=copy.id||uid();
      copy.type=copy.type||'custom';
      copy.name=copy.name||'Service';
      if(copy.price!=null) copy.price=Number(copy.price||0);
      copy.included=!!copy.included;
      if(copy.vehicleIndex!=null) copy.vehicleIndex=Number(copy.vehicleIndex);
      if(copy.vehicleLabel==null) copy.vehicleLabel='';
      return copy;
    });
  },
  createServicesFromVehicles(job){
    const services=[];
    const vehicles=Array.isArray(job.vehicles)?job.vehicles:[];
    vehicles.forEach((vehicle,idx)=>{
      const label=vehicle.label||`Vehicle ${idx+1}`;
      if(vehicle.pkg){
        services.push({id:uid(),type:'package',name:vehicle.pkg,vehicleIndex:idx,vehicleLabel:label,price:Number(vehicle.base||0)||0,included:false});
      }
      (vehicle.addons||[]).forEach(addon=>{
        if(!addon?.name) return;
        services.push({id:uid(),type:'addon',name:addon.name,vehicleIndex:idx,vehicleLabel:label,price:Number(addon.price||0)||0,included:!!addon.included});
      });
    });
    if(Array.isArray(job.extraCharges)){
      job.extraCharges.forEach(extra=>{
        if(!extra?.name) return;
        services.push({id:extra.id||uid(),type:extra.type||'custom',name:extra.name,vehicleIndex:extra.vehicleIndex!=null?Number(extra.vehicleIndex):null,vehicleLabel:extra.vehicleLabel||'',price:Number(extra.price||0)||0,included:!!extra.included});
      });
    }
    return services;
  },
  createTimers(){
    return {
      overall:this.createTimer('overall','Overall Timer'),
      setup:this.createTimer('setup','Setup / Prep'),
      base:this.createTimer('base','Base Services'),
      addons:this.createTimer('addons','Add-ons / Finishing')
    };
  },
  createTimer(id,label){
    return {id,label,elapsed:0,runningSince:null};
  },
  ensureTimers(job){
    if(!job.timers || typeof job.timers!=='object'){
      job.timers=this.createTimers();
      return;
    }
    const defaults=this.createTimers();
    for(const key of Object.keys(defaults)){
      if(!job.timers[key]){
        job.timers[key]=defaults[key];
        continue;
      }
      const timer=job.timers[key];
      if(typeof timer.label!=='string') timer.label=defaults[key].label;
      if(typeof timer.elapsed!=='number') timer.elapsed=Number(timer.elapsed||0);
      if(typeof timer.runningSince!=='number') timer.runningSince=null;
      timer.id=timer.id||key;
    }
  },
  serviceSlug(name){
    return (name||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'')||uid();
  },
  collectAddonNames(job){
    const names=[];
    if(Array.isArray(job?.services)){
      for(const service of job.services){
        if(!service?.name) continue;
        if((service.type==='addon'||service.type==='custom') && !names.includes(service.name)){
          names.push(service.name);
        }
      }
    }
    if(Array.isArray(job?.vehicles)){
      job.vehicles.forEach(vehicle=>{
        (vehicle.addons||[]).forEach(addon=>{
          if(addon?.name && !names.includes(addon.name)) names.push(addon.name);
        });
      });
    }
    if(Array.isArray(job?.extraCharges)){
      job.extraCharges.forEach(extra=>{
        if(extra?.name && !names.includes(extra.name)) names.push(extra.name);
      });
    }
    return names;
  },
  timerElapsedMs(timer){
    if(!timer) return 0;
    const elapsed=Number(timer.elapsed||0);
    if(timer.runningSince) return elapsed+Math.max(0, Date.now()-timer.runningSince);
    return elapsed;
  },
  timerElapsedMinutes(timer){
    return Math.round(this.timerElapsedMs(timer)/60000);
  },
  toggleTimer(jobId,key){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    this.ensureTimers(job);
    const timer=job.timers[key];
    if(!timer) return;
    if(timer.runningSince){
      timer.elapsed+=Date.now()-timer.runningSince;
      timer.runningSince=null;
    } else {
      timer.runningSince=Date.now();
      if(key!=='overall' && job.timers.overall && !job.timers.overall.runningSince){
        job.timers.overall.runningSince=Date.now();
      }
    }
    Storage.save(S);
    UI.refreshJobsList();
    UI.renderJobPanel(jobId);
  },
  resetTimer(jobId,key){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    this.ensureTimers(job);
    const timer=job.timers[key];
    if(!timer) return;
    timer.elapsed=0;
    timer.runningSince=null;
    Storage.save(S);
    UI.refreshJobsList();
    UI.renderJobPanel(jobId);
  },
  setTimerMinutes(jobId,key,minutes){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    this.ensureTimers(job);
    const timer=job.timers[key];
    if(!timer) return;
    timer.elapsed=Math.max(0, Math.round(Number(minutes||0)*60000));
    timer.runningSince=null;
    Storage.save(S);
    UI.refreshJobsList();
    UI.renderJobPanel(jobId);
  },
  addService(jobId, service){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    this.ensureJobStructure(job);
    const entry={
      id:uid(),
      type:service.type||'custom',
      name:service.name||'Service',
      price:Number(service.price||0),
      included:!!service.included,
      vehicleIndex:service.vehicleIndex!=null?Number(service.vehicleIndex):null,
      vehicleLabel:service.vehicleLabel||''
    };
    job.services.push(entry);
    if(entry.type==='addon' || entry.type==='custom'){
      job.extraCharges=Array.isArray(job.extraCharges)?job.extraCharges:[];
      job.extraCharges.push({id:entry.id,name:entry.name,price:entry.price,included:entry.included,type:entry.type,vehicleIndex:entry.vehicleIndex,vehicleLabel:entry.vehicleLabel});
    }
    this.ensureChecklist(job);
    Storage.save(S);
    UI.refreshJobsList();
    UI.renderJobPanel(jobId);
  },
  removeService(jobId, serviceId){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job || !Array.isArray(job.services)) return;
    const idx=job.services.findIndex(s=>s.id===serviceId);
    if(idx<0) return;
    job.services.splice(idx,1);
    if(Array.isArray(job.extraCharges)){
      job.extraCharges=job.extraCharges.filter(extra=>extra?.id!==serviceId);
    }
    this.ensureChecklist(job);
    Storage.save(S);
    UI.refreshJobsList();
    UI.renderJobPanel(jobId);
  },
  createChecklist(job=null){
    return { sections: this.createChecklistSections(job) };
  },
  createChecklistSections(job=null){
    const sections = CREW_CHECKLIST_SECTIONS.map(section=>({
      id: section.id,
      title: section.title,
      goalMinutes: section.goalMinutes,
      items: section.items.map(item=>({
        id: item.id,
        label: item.label,
        description: item.description || '',
        completed: false,
        elapsed: 0,
        runningSince: null
      }))
    }));
    const dynamic=this.buildAddonChecklistSection(job);
    if(dynamic) sections.push(dynamic);
    return sections;
  },
  buildAddonChecklistSection(job){
    if(!job) return null;
    const addonNames=this.collectAddonNames(job);
    if(!addonNames.length) return null;
    const items=addonNames.map(name=>({
      id:'addon-'+this.serviceSlug(name),
      label:name,
      description:'Confirm completion for this add-on or finishing touch.',
      completed:false,
      elapsed:0,
      runningSince:null
    }));
    return {
      id:'addons-dynamic',
      title:'Add-ons & Finishing',
      goalMinutes:Math.max(15, job.schedule?.durationMinutes ? Math.round(job.schedule.durationMinutes*0.25)||15 : 20),
      items
    };
  },
  ensureChecklist(job){
    if(!job) return;
    let changed=false;
    if(!job.checklist || !Array.isArray(job.checklist.sections)){
      job.checklist=this.createChecklist(job);
      changed=true;
    }
    const sections=job.checklist.sections;
    const templateMap=new Map(CREW_CHECKLIST_SECTIONS.map(section=>[section.id, section]));
    for(const [sectionId, template] of templateMap){
      let section=sections.find(s=>s.id===sectionId);
      if(!section){
        section={
          id: template.id,
          title: template.title,
          goalMinutes: template.goalMinutes,
          items: template.items.map(item=>({
            id: item.id,
            label: item.label,
            description: item.description || '',
            completed: false,
            elapsed: 0,
            runningSince: null
          }))
        };
        sections.push(section);
        changed=true;
        continue;
      }
      if(section.title==null) section.title=template.title;
      if(section.goalMinutes==null) section.goalMinutes=template.goalMinutes;
      if(!Array.isArray(section.items)) section.items=[];
      for(const itemTemplate of template.items){
        let item=section.items.find(i=>i.id===itemTemplate.id);
        if(!item){
          section.items.push({
            id: itemTemplate.id,
            label: itemTemplate.label,
            description: itemTemplate.description || '',
            completed: false,
            elapsed: 0,
            runningSince: null
          });
          changed=true;
        } else {
          if(item.label==null) item.label=itemTemplate.label;
          if(item.description==null && itemTemplate.description) item.description=itemTemplate.description;
          if(item.elapsed==null) item.elapsed=0;
          if(item.runningSince==null || typeof item.runningSince!=='number') item.runningSince=null;
          if(typeof item.completed!=='boolean') item.completed=!!item.completed;
        }
      }
    }
    const dynamicTemplate=this.buildAddonChecklistSection(job);
    const dynamicIndex=sections.findIndex(s=>s.id==='addons-dynamic');
    if(dynamicTemplate){
      let section=dynamicIndex>=0?sections[dynamicIndex]:null;
      if(!section){
        sections.push(dynamicTemplate);
        changed=true;
      } else {
        if(section.title!==dynamicTemplate.title){ section.title=dynamicTemplate.title; changed=true; }
        if(section.goalMinutes!==dynamicTemplate.goalMinutes){ section.goalMinutes=dynamicTemplate.goalMinutes; changed=true; }
        if(!Array.isArray(section.items)) section.items=[];
        const seen=new Set();
        for(const itemTemplate of dynamicTemplate.items){
          let item=section.items.find(i=>i.id===itemTemplate.id);
          if(!item){
            section.items.push({...itemTemplate});
            changed=true;
            item=section.items[section.items.length-1];
          }
          if(item.label!==itemTemplate.label){ item.label=itemTemplate.label; changed=true; }
          if(item.description==null) item.description=itemTemplate.description;
          if(item.elapsed==null) item.elapsed=0;
          if(item.runningSince==null || typeof item.runningSince!=='number') item.runningSince=null;
          if(typeof item.completed!=='boolean') item.completed=!!item.completed;
          seen.add(itemTemplate.id);
        }
        const filtered=section.items.filter(i=>seen.has(i.id));
        if(filtered.length!==section.items.length){
          section.items=filtered;
          changed=true;
        }
      }
    } else if(dynamicIndex>=0){
      sections.splice(dynamicIndex,1);
      changed=true;
    }
    if(changed) Storage.save(S);
  },
  findChecklistItem(job, sectionId, itemId){
    if(!job?.checklist?.sections) return {section:null,item:null};
    const section=job.checklist.sections.find(s=>s.id===sectionId) || null;
    const item=section?.items?.find(i=>i.id===itemId) || null;
    return {section,item};
  },
  checklistElapsedMs(item){
    if(!item) return 0;
    const elapsed=Number(item.elapsed||0);
    if(item.runningSince) return elapsed+Math.max(0,Date.now()-item.runningSince);
    return elapsed;
  },
  setChecklistComplete(jobId, sectionId, itemId, completed){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    this.ensureChecklist(job);
    const {item}=this.findChecklistItem(job,sectionId,itemId);
    if(!item) return;
    item.completed=!!completed;
    if(item.completed && item.runningSince){
      item.elapsed+=Date.now()-item.runningSince;
      item.runningSince=null;
    }
    Storage.save(S);
  },
  toggleChecklistTimer(jobId, sectionId, itemId){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    this.ensureChecklist(job);
    const {item}=this.findChecklistItem(job,sectionId,itemId);
    if(!item) return;
    if(item.runningSince){
      item.elapsed+=Date.now()-item.runningSince;
      item.runningSince=null;
    } else {
      item.runningSince=Date.now();
    }
    Storage.save(S);
  },
  addClient(){ const name=document.getElementById('cName').value.trim(); if(!name) return alert('Client name required'); const c={id:uid(), name, phone:document.getElementById('cPhone').value.trim(), notes:document.getElementById('cNotes').value.trim(), discount:{type:document.getElementById('cDiscType').value, value:Number(document.getElementById('cDiscValue').value||0)}, vehicles:[]}; S.clients.push(c); Storage.save(S); UI.populateClients(); UI.flash('Client added.'); document.getElementById('cName').value='';document.getElementById('cPhone').value='';document.getElementById('cNotes').value='';document.getElementById('cDiscType').value='none';document.getElementById('cDiscValue').value='0'; },
  addQuickClient(){ const name=document.getElementById('qcName').value.trim(); if(!name) return alert('Client name required'); const c={id:uid(), name, phone:document.getElementById('qcPhone').value.trim(), notes:document.getElementById('qcNotes').value.trim(), discount:{type:document.getElementById('qcDiscType').value, value:Number(document.getElementById('qcDiscValue').value||0)}, vehicles:[]}; S.clients.push(c); Storage.save(S); UI.populateClients(c.id); UI.hideQuickClient(); UI.flash('Client added.'); UI.onClientChange(); },
  syncClientVehicles(job,{updateLastService=false}={}){
    const client=S.clients.find(x=>x.id===job.clientId);
    if(!client) return;
    if(!Array.isArray(client.vehicles)) client.vehicles=[];
    for(const vehicle of job.vehicles||[]){
      const label=(vehicle.label||'').trim();
      const candidateId=vehicle.clientVehicleId||vehicle.vehicleId||'';
      let record=null;
      if(candidateId){
        record=client.vehicles.find(v=>v.id===candidateId);
      }
      if(!record && label){
        record=client.vehicles.find(v=>(v.label||'').toLowerCase()===label.toLowerCase());
      }
      if(record){
        if(label) record.label=label;
        if(vehicle.size) record.size=vehicle.size;
      } else if(label){
        record={id:candidateId||uid(), label, size:vehicle.size||'', lastService:null, history:[]};
        client.vehicles.push(record);
      } else {
        continue;
      }
      if(!Array.isArray(record.history)) record.history=[];
      if(updateLastService){
        const serviceInfo={jobId:job.id, date:job.date, pkg:vehicle.pkg||job.pkg||'', addons:(vehicle.addons||[]).map(a=>a.name).filter(Boolean)};
        record.lastService=serviceInfo;
        record.history.unshift(serviceInfo);
        if(record.history.length>20) record.history.length=20;
      }
    }
    Storage.save(S);
    UI.populateClients(job.clientId);
  },
  saveJob(options={}){
    const asQuote=!!(options && options.asQuote);
    const clientId=document.getElementById('jobClient').value;
    if(!clientId) return alert('Client is required');
    const vehicles=UI.collectVehicles();
    if(!vehicles.length) return alert('Add at least one vehicle');
    if(vehicles.some(v=>!v.pkg)) return alert('Select a package for each vehicle');
    const discType=document.getElementById('jobDiscType').value;
    const discValue=Number(document.getElementById('jobDiscValue').value||0);
    const discScopeValue=document.getElementById('jobDiscScope').value;
    const discScope=discScopeValue==='vehicle'?'vehicle':'job';
    const notes=document.getElementById('jobNotes').value.trim();
    const scheduleDate=document.getElementById('jobDate').value || today();
    const scheduleStart=document.getElementById('jobStart').value || '';
    const scheduleEnd=document.getElementById('jobEnd').value || '';
    const scheduleDuration=parseDurationInput(document.getElementById('jobDuration').value);
    const primaryPkg=vehicles[0]?.pkg||'';
    const schedule={date:scheduleDate,start:scheduleStart,end:scheduleEnd,durationMinutes:scheduleDuration};
    if(UI.editingJobId){
      const job=S.jobs.find(x=>x.id===UI.editingJobId);
      if(job){
        const previousStatus=job.status;
        job.clientId=clientId;
        job.pkg=primaryPkg;
        job.vehicles=vehicles.map(v=>({
          ...v,
          addons:Array.isArray(v.addons)?v.addons.map(a=>({...a})) : []
        }));
        job.discType=discType;
        job.discValue=discValue;
        job.discScope=discScope;
        job.notes=notes;
        job.schedule=schedule;
        job.date=scheduleDate;
        job.size=vehicles[0]?.size||'';
        job.vehicleCount=vehicles.length;
        if(Array.isArray(job.extraCharges)){
          job.extraCharges=job.extraCharges.map(extra=>{
            if(!extra) return extra;
            const copy={...extra};
            const idx=copy.vehicleIndex!=null?Number(copy.vehicleIndex):-1;
            if(copy.vehicleIndex!=null) copy.vehicleIndex=idx;
            if(idx>=vehicles.length){
              copy.vehicleIndex=null;
              copy.vehicleLabel='';
            }
            return copy;
          });
        } else {
          job.extraCharges=[];
        }
        job.services=this.createServicesFromVehicles(job);
        this.normalizeServices(job);
        this.ensureChecklist(job);
        Storage.save(S);
        this.syncClientVehicles(job);
        UI.refreshJobsList();
        UI.renderJobPanel(job.id,true);
        UI.resetJobForm();
        let converted=false;
        if(asQuote){
          if(!['Paid','Complete'].includes(job.status)){
            job.status='Quoted';
            Storage.save(S);
            UI.refreshJobsList();
          }
          UI.flash('Quote updated.');
          UI.switchTab('Quotes');
        } else {
          if(previousStatus==='Quoted'){
            job.status='Booked';
            Storage.save(S);
            UI.refreshJobsList();
            converted=true;
          }
          if(converted){
            UI.flash('Quote converted to job.');
            UI.switchTab('Jobs');
          } else {
            UI.flash('Job updated.');
          }
        }
        return;
      }
      UI.editingJobId=null;
      UI.updateJobFormEditingUI(null);
      UI.flash('Could not find the original job. A new job will be scheduled instead.');
    }
    const job={
      id:uid(),
      date:scheduleDate,
      createdAt:new Date().toISOString(),
      clientId,
      pkg:primaryPkg,
      vehicles,
      discType,
      discValue,
      discScope,
      notes,
      status:asQuote?'Quoted':'Booked',
      payments:[],
      schedule,
      extraCharges:[]
    };
    job.size=vehicles[0]?.size||'';
    job.vehicleCount=vehicles.length;
    job.services=this.createServicesFromVehicles(job);
    job.timers=this.createTimers();
    job.checklist=this.createChecklist(job);
    this.ensureChecklist(job);
    S.jobs.unshift(job);
    Storage.save(S);
    this.syncClientVehicles(job);
    UI.refreshJobsList();
    UI.resetJobForm();
    if(asQuote){
      UI.flash('Quote saved.');
      UI.switchTab('Quotes');
    } else {
      UI.flash('Job scheduled.');
      UI.switchTab('Jobs');
    }
  },
  updateJobStatus(id,next){
    const job=S.jobs.find(x=>x.id===id);
    if(!job) return;
    this.ensureJobStructure(job);
    job.status=next;
    let savedViaSync=false;
    if(next==='In Progress' && !job.startedAt){
      job.startedAt=new Date().toISOString();
      if(job.timers?.overall && !job.timers.overall.runningSince){
        job.timers.overall.runningSince=Date.now();
      }
    }
    if(next==='Complete' || next==='Paid'){
      job.completedAt=new Date().toISOString();
      if(job.timers){
        for(const timer of Object.values(job.timers)){
          if(timer?.runningSince){
            timer.elapsed+=Date.now()-timer.runningSince;
            timer.runningSince=null;
          }
        }
      }
      job.totalMinutes=this.timerElapsedMinutes(job.timers?.overall||{elapsed:0});
      this.syncClientVehicles(job,{updateLastService:true});
      savedViaSync=true;
    }
    if(!savedViaSync){
      Storage.save(S);
      UI.populateClients(job.clientId);
    }
    UI.refreshJobsList();
    UI.renderJobPanel(id);
    UI.flash('Status: '+next);
  },
  takePayment(id){
    const j=S.jobs.find(x=>x.id===id);
    if(!j) return;
    const paid=(j.payments||[]).reduce((t,p)=>t+Number(p.amount||0),0);
    const due=Math.max(0,Calc.total(j)-paid);
    const amount=Number(prompt('Amount received', due.toFixed(2))||0);
    if(amount<=0) return;
    const method=prompt('Method (Cash/Card/Zelle/Venmo/CashApp/Bank)','Cash')||'Cash';
    j.payments.push({date:today(),method,amount});
    const paid2=j.payments.reduce((t,p)=>t+Number(p.amount||0),0);
    if(paid2+1e-6>=Calc.total(j)){
      const vehicleLabel=UI.jobVehicleSummary(j);
      const pkgLabel=UI.jobPackageLabel(j);
      const itemLabel=vehicleLabel?`${pkgLabel} — ${vehicleLabel}`:pkgLabel;
      S.transactions.push({id:uid(), jobId:j.id, type:'Income', date:today(), category:'Package', item:itemLabel, clientId:j.clientId, vendor:'', payment:method, amount:Calc.total(j), notes:'Discount: '+(j.discType||'none')+' '+(j.discValue||0)});
      this.updateJobStatus(j.id,'Paid');
      UI.flash('Paid in full. Income posted.');
    } else {
      Storage.save(S);
      UI.populateClients(j.clientId);
      UI.refreshJobsList();
      UI.renderJobPanel(id);
      UI.flash('Partial payment recorded.');
    }
    UI.refreshDashboard();
  },
  deleteJob(id){
    if(!confirm('Delete this job?')) return;
    const before=S.transactions.length;
    S.jobs=S.jobs.filter(x=>x.id!==id);
    S.transactions=S.transactions.filter(t=>t.jobId!==id);
    Storage.save(S);
    if(UI.jobPanelJobId===id) UI.closeJobPanel();
    UI.refreshJobsList();
    UI.refreshDashboard();
    const removed=before!==S.transactions.length;
    UI.flash(removed?'Job and related income removed.':'Job deleted.');
  },
  deleteTransaction(id){
    const idx=S.transactions.findIndex(t=>t.id===id);
    if(idx<0) return false;
    if(!confirm('Delete this record?')) return false;
    S.transactions.splice(idx,1);
    Storage.save(S);
    UI.refreshDashboard();
    UI.flash('Transaction deleted.');
    return true;
  },
  addExpenseRecord(rec){
    const record={id:rec.id||uid(), type:'Expense', date:rec.date, category:rec.category, item:rec.item||'', clientId:rec.clientId||null, vendor:rec.vendor||'', payment:rec.payment||'', amount:Number(rec.amount||0), notes:rec.notes||'', receiptImage:rec.receiptImage||null};
    S.transactions.push(record);
    Storage.save(S);
    UI.refreshDashboard();
  }
};

/*** UI ***/
const UI = {
  checklistTicker:null,
  checklistHost:null,
  checklistJobId:null,
  ocrPromise:null,
  jobFilter:'all',
  jobPanelJobId:null,
  editingJobId:null,
  initHeader(){ const logo=document.getElementById('headerLogo'); logo.src=S.business.logoDataUrl||'icon-192.png'; document.getElementById('headerTitle').textContent=S.business.headerTitle||'POLISH CREW — Accounting'; document.getElementById('openDrawer').onclick=()=>UI.toggleDrawer(true); },
  switchTab(name){ document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.getAttribute('data-tab')===name)); document.querySelectorAll('.tabpage').forEach(p=>p.classList.add('hidden')); document.getElementById(name).classList.remove('hidden'); },
  initTabs(){ document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>UI.switchTab(t.getAttribute('data-tab')))); },
  packageOptionLabel(name,size){
    const price=Calc.base(name,size);
    const meta=pkgMeta(name);
    const included=(meta.includedAddons||[]).filter(Boolean);
    const description=(meta.description||'').trim();
    const descText=description?` • ${description}`:'';
    const includeText=included.length?` • Includes: ${included.join(', ')}`:'';
    return `${name} — ${fmt(price)}${descText}${includeText}`;
  },
  updatePackageSelectOptions(sel,{preferred}={}){
    if(!sel) return;
    const row=sel.closest('.vehicle-row');
    const size=row?.querySelector('.vehicle-size')?.value || S.menu.sizes[0] || '';
    const packageNames=Object.keys(S.menu.packages);
    const desired=(preferred && S.menu.packages[preferred])?preferred:((sel.value && S.menu.packages[sel.value])?sel.value:'');
    sel.innerHTML='';
    packageNames.forEach(name=>sel.append(el('option',{value:name},UI.packageOptionLabel(name,size))));
    if(desired && S.menu.packages[desired]) sel.value=desired;
    else if(sel.options.length) sel.value=sel.options[0].value;
  },
  addonOptionLabel(name,size,meta){
    const price=Calc.addonPrice(name,size);
    const included=!!meta?.includedAddons?.includes(name);
    return `${name} — ${fmt(price)}${included?' (Included)':''}`;
  },
  populateClients(selectId){ const sel=document.getElementById('jobClient'); if(sel){ sel.innerHTML='<option value="">-- select client --</option>'; for(const c of S.clients){ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; sel.appendChild(o); } if(selectId) sel.value=selectId; }
    const list=document.getElementById('clientsList');
    if(list){
      list.innerHTML='';
      for(const c of S.clients){
        const vehicles=Array.isArray(c.vehicles)?c.vehicles:[];
        const vehicleRows=vehicles.length?vehicles.map(v=>{
          const service=v.lastService;
          const addonsLabel=service?.addons&&service.addons.length?` (${service.addons.join(', ')})`:'';
          const pkgLabel=service?.pkg?` — ${service.pkg}`:'';
          const serviceText=service?`Last service: ${service.date||'Unknown date'}${pkgLabel}${addonsLabel}`:'No service recorded yet.';
          return el('div',{class:'tiny'},`${v.label||'Vehicle'}${v.size?` · ${v.size}`:''} · ${serviceText}`);
        }):[el('div',{class:'tiny'},'No vehicles saved yet.')];
        const header=el('div',{class:'row',style:'justify-content:space-between;align-items:flex-start;gap:.5rem;'},
          el('div',{html:`<b>${c.name}</b> <span class='tiny'>${c.phone||''}</span>`}),
          el('button',{class:'pill',onclick:()=>UI.openClientVehicles(c.id)},'Manage Vehicles')
        );
        const body=el('div',{}, ...vehicleRows, ...(c.notes?[el('div',{class:'tiny'},c.notes)]:[]));
        const li=el('div',{class:'list-item'}, header, body);
        list.append(li);
      }
    }
    UI.refreshClientVehicleOptions();
  },
  refreshClientVehicleOptions(){
    const clientId=document.getElementById('jobClient')?.value || '';
    const client=S.clients.find(c=>c.id===clientId);
    const vehicles=client?.vehicles||[];
    document.querySelectorAll('.vehicle-row').forEach(row=>{
      const sel=row.querySelector('.vehicle-existing');
      if(!sel) return;
      const current=sel.value;
      sel.innerHTML='';
      sel.append(el('option',{value:''}, clientId?'New vehicle':'Select client first'));
      vehicles.forEach(v=>sel.append(el('option',{value:v.id},v.label||'Unnamed Vehicle')));
      if(current && vehicles.some(v=>v.id===current)) sel.value=current;
      else sel.value='';
      if(sel.value){ row.setAttribute('data-client-vehicle-id', sel.value); }
      else row.removeAttribute('data-client-vehicle-id');
    });
  },
  onClientChange(){
    UI.refreshClientVehicleOptions();
  },
  updateJobFormEditingUI(job){
    const saveBtn=document.getElementById('jobSaveBtn');
    const quoteBtn=document.getElementById('quoteSaveBtn');
    const cancelBtn=document.getElementById('jobEditCancel');
    if(job){
      if(saveBtn) saveBtn.textContent=job.status==='Quoted'?'Book Job':'Update Job';
      if(quoteBtn){
        if(['Paid','Complete'].includes(job.status)){
          quoteBtn.classList.add('hidden');
        } else {
          quoteBtn.classList.remove('hidden');
          quoteBtn.textContent=job.status==='Quoted'?'Update Quote':'Save as Quote';
        }
      }
      if(cancelBtn) cancelBtn.classList.remove('hidden');
    } else {
      if(saveBtn) saveBtn.textContent='Schedule Job';
      if(quoteBtn){
        quoteBtn.classList.remove('hidden');
        quoteBtn.textContent='Save Quote';
      }
      if(cancelBtn) cancelBtn.classList.add('hidden');
    }
  },
  editJob(jobId){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    App.ensureJobStructure(job);
    this.switchTab('QuoteBuilder');
    this.editingJobId=jobId;
    this.populateClients(job.clientId);
    const clientSel=document.getElementById('jobClient');
    if(clientSel) clientSel.value=job.clientId||'';
    const list=document.getElementById('vehiclesList');
    if(list){
      list.innerHTML='';
    }
    this.onClientChange();
    if(list){
      if(Array.isArray(job.vehicles) && job.vehicles.length){
        job.vehicles.forEach(vehicle=>{
          const clone={...vehicle};
          if(Array.isArray(vehicle.addons)) clone.addons=vehicle.addons.map(a=>({...a}));
          this.addVehicle(clone);
        });
      } else {
        this.addVehicle();
      }
    }
    const schedule=job.schedule||{};
    const dateInput=document.getElementById('jobDate');
    if(dateInput) dateInput.value=schedule.date || job.date || today();
    const startInput=document.getElementById('jobStart');
    if(startInput) startInput.value=schedule.start || '';
    const endInput=document.getElementById('jobEnd');
    if(endInput) endInput.value=schedule.end || '';
    const durationInput=document.getElementById('jobDuration');
    if(durationInput){
      const mins=Number(schedule.durationMinutes||0);
      durationInput.value=mins>0?formatDurationMinutes(mins):'';
    }
    const discTypeSel=document.getElementById('jobDiscType');
    if(discTypeSel) discTypeSel.value=job.discType||'none';
    const discValueInput=document.getElementById('jobDiscValue');
    if(discValueInput) discValueInput.value=Number(job.discValue||0);
    const discScopeSel=document.getElementById('jobDiscScope');
    if(discScopeSel) discScopeSel.value=job.discScope==='vehicle'?'vehicle':'job';
    const notesInput=document.getElementById('jobNotes');
    if(notesInput) notesInput.value=job.notes||'';
    this.updateTotals();
    this.updateJobFormEditingUI(job);
    this.flash('Edit mode enabled for this job.');
  },
  cancelJobEdit(){
    if(!this.editingJobId){
      this.updateJobFormEditingUI(null);
      return;
    }
    this.resetJobForm();
    this.flash('Edit cancelled.');
  },
  openClientVehicles(id){
    const client=S.clients.find(c=>c.id===id);
    if(!client) return;
    if(!Array.isArray(client.vehicles)) client.vehicles=[];
    const list=el('div',{class:'list',style:'gap:.5rem;'});
    const renderList=()=>{
      list.innerHTML='';
      if(!client.vehicles.length){
        list.append(el('div',{class:'tiny'},'No vehicles saved yet.'));
        return;
      }
      client.vehicles.forEach(v=>{
        if(!v.id) v.id=uid();
        const item=el('div',{class:'list-item'});
        const header=el('div',{class:'row',style:'gap:.5rem;flex-wrap:wrap;align-items:flex-end;'});
        const labelWrap=el('div',{style:'flex:1;min-width:200px;'});
        labelWrap.append(el('label',{},'Vehicle'), el('input',{value:v.label||'',placeholder:'Year / Make / Model',oninput:(e)=>{ v.label=e.target.value.trim(); }}));
        const sizeWrap=el('div',{style:'flex:1;min-width:160px;'});
        const sizeSel=el('select',{});
        sizeSel.append(el('option',{value:''},'Size not set'));
        S.menu.sizes.forEach(s=>sizeSel.append(el('option',{value:s},s)));
        sizeSel.value=v.size||'';
        sizeSel.addEventListener('change',()=>{ v.size=sizeSel.value; });
        sizeWrap.append(el('label',{},'Size'), sizeSel);
        const removeBtn=el('button',{class:'btn secondary',type:'button'},'Remove');
        removeBtn.addEventListener('click',()=>{
          if(confirm('Remove this vehicle?')){
            client.vehicles=client.vehicles.filter(x=>x.id!==v.id);
            renderList();
          }
        });
        header.append(labelWrap,sizeWrap,removeBtn);
        item.append(header);
        const service=v.lastService;
        const addonsLabel=service?.addons&&service.addons.length?` (${service.addons.join(', ')})`:'';
        const pkgLabel=service?.pkg?` — ${service.pkg}`:'';
        item.append(el('div',{class:'tiny',style:'margin-top:.25rem;'}, service?`Last service: ${service.date||'Unknown date'}${pkgLabel}${addonsLabel}`:'No recorded service yet.'));
        list.append(item);
      });
    };
    renderList();
    const addLabel=el('input',{placeholder:'Year / Make / Model'});
    const addSize=el('select',{});
    addSize.append(el('option',{value:''},'Size not set'));
    S.menu.sizes.forEach(s=>addSize.append(el('option',{value:s},s)));
    const addButton=el('button',{class:'btn',type:'button'},'Add Vehicle');
    addButton.addEventListener('click',()=>{
      const label=addLabel.value.trim();
      if(!label) return alert('Vehicle description required');
      client.vehicles.push({id:uid(), label, size:addSize.value||'', lastService:null, history:[]});
      addLabel.value='';
      addSize.value='';
      renderList();
    });
    const content=el('div',{}, list, el('div',{class:'row',style:'gap:.5rem;margin-top:.75rem;align-items:flex-end;flex-wrap:wrap;'},
      el('div',{style:'flex:1;min-width:220px;'}, el('label',{},'Vehicle'), addLabel),
      el('div',{style:'flex:1;min-width:160px;'}, el('label',{},'Size'), addSize),
      addButton
    ));
    UI.modal('Client Vehicles',(close)=>{
      client.vehicles=client.vehicles.filter(v=>(v.label||'').trim());
      Storage.save(S);
      UI.populateClients(client.id);
      UI.refreshClientVehicleOptions();
      UI.flash('Vehicles updated.');
      close();
    },content,'Done',true,true);
  },
  populateSizesAndPackages(){
    document.querySelectorAll('.vehicle-package').forEach(sel=>{
      UI.updatePackageSelectOptions(sel);
      const row=sel.closest('.vehicle-row');
      if(row) UI.refreshVehicleRow(row,{setBase:true, skipPackageSync:true});
    });
    document.querySelectorAll('.vehicle-size').forEach(sel=>{
      const current=sel.value;
      sel.innerHTML='';
      S.menu.sizes.forEach(size=>sel.append(el('option',{value:size},size)));
      if(S.menu.sizes.includes(current)) sel.value=current;
      else if(S.menu.sizes.length) sel.value=S.menu.sizes[0];
    });
  },
  handlePackageChange(){
    document.querySelectorAll('.vehicle-row').forEach(row=>{
      UI.refreshVehicleRow(row,{setBase:true});
    });
    UI.updateTotals();
  },
  prefillBase(){ this.handlePackageChange(); },
  renderAddons(){ this.handlePackageChange(); },
  addVehicle(prefill={}){
    const list=document.getElementById('vehiclesList');
    if(!list) return;
    const sizeOptions=S.menu.sizes;
    const sizePref=(prefill.size && sizeOptions.includes(prefill.size))?prefill.size:(sizeOptions[0]||'');
    const pkgOptions=Object.keys(S.menu.packages);
    const pkgPref=(prefill.pkg && S.menu.packages[prefill.pkg])?prefill.pkg:(pkgOptions[0]||'');
    const baseDefault=Calc.base(pkgPref,sizePref);
    const baseValue=prefill.base!=null?Number(prefill.base):baseDefault;
    const row=el('div',{class:'list-item vehicle-row'});
    const header=el('div',{class:'row',style:'gap:.5rem;flex-wrap:wrap;align-items:flex-end;'});

    const clientId=document.getElementById('jobClient')?.value || '';
    const client=S.clients.find(c=>c.id===clientId);
    const knownVehicles=client?.vehicles||[];
    const labelPref=(prefill.label||'');
    const clientVehicleIdPref=prefill.clientVehicleId||prefill.vehicleId||'';
    const vehicleWrap=el('div',{style:'flex:1;min-width:240px;'});
    vehicleWrap.append(el('label',{},'Vehicle'));
    const vehicleRow=el('div',{class:'row',style:'gap:.4rem;'});
    const vehicleSel=el('select',{class:'vehicle-existing'});
    vehicleSel.append(el('option',{value:''}, clientId?'New vehicle':'Select client first'));
    knownVehicles.forEach(v=>vehicleSel.append(el('option',{value:v.id},v.label||'Unnamed Vehicle')));
    if(clientVehicleIdPref && knownVehicles.some(v=>v.id===clientVehicleIdPref)) vehicleSel.value=clientVehicleIdPref;
    const vehicleInput=el('input',{class:'vehicle-label',placeholder:'Year / Make / Model',value:labelPref});
    if(vehicleSel.value) row.setAttribute('data-client-vehicle-id', vehicleSel.value);
    if(labelPref) row.setAttribute('data-vehicle-label', labelPref);
    vehicleInput.addEventListener('input',()=>{ row.setAttribute('data-vehicle-label', vehicleInput.value.trim()); });
    vehicleRow.append(vehicleSel,vehicleInput);
    vehicleWrap.append(vehicleRow);
    header.append(vehicleWrap);

    const pkgWrap=el('div',{style:'flex:1;min-width:200px;'});
    pkgWrap.append(el('label',{},'Package'));
    const pkgRow=el('div',{class:'row',style:'gap:.4rem;'});
    const pkgSel=el('select',{class:'vehicle-package'});
    UI.updatePackageSelectOptions(pkgSel,{preferred:pkgPref});
    pkgRow.append(pkgSel);
    pkgWrap.append(pkgRow);
    header.append(pkgWrap);

    const sizeWrap=el('div',{style:'flex:1;min-width:160px;'});
    sizeWrap.append(el('label',{},'Vehicle Size'));
    const sizeSel=el('select',{class:'vehicle-size'});
    sizeOptions.forEach(s=>sizeSel.append(el('option',{value:s},s)));
    if(sizePref) sizeSel.value=sizePref;
    sizeWrap.append(sizeSel);
    header.append(sizeWrap);

    const baseWrap=el('div',{style:'flex:1;min-width:140px;'});
    baseWrap.append(el('label',{},'Base'));
    const baseInput=el('input',{type:'number',min:'0',step:'0.01',class:'vehicle-base',value:Number(baseValue||0).toFixed(2)});
    baseWrap.append(baseInput);
    header.append(baseWrap);

    const removeWrap=el('div',{style:'flex:0;'});
    removeWrap.append(el('label',{},'\u00a0'));
    const removeBtn=el('button',{class:'btn secondary vehicle-remove',onclick:()=>UI.removeVehicle(row)},'Remove');
    removeWrap.append(removeBtn);
    header.append(removeWrap);

    row.append(header);
    const pkgInfo=el('div',{class:'vehicle-package-info hidden'});
    row.append(pkgInfo);
    const addonsHost=el('div',{class:'list vehicle-addons',style:'margin-top:.6rem;gap:.4rem;'});
    row.append(addonsHost);
    list.append(row);

    const syncSelectedVehicle=()=>{
      const selectedId=vehicleSel.value;
      if(selectedId && client){
        const record=client.vehicles.find(v=>v.id===selectedId);
        if(record){
          if(record.label){
            vehicleInput.value=record.label;
            row.setAttribute('data-vehicle-label', record.label);
          }
          if(record.size && sizeOptions.includes(record.size)){
            sizeSel.value=record.size;
          }
        }
        row.setAttribute('data-client-vehicle-id', selectedId);
      } else {
        row.removeAttribute('data-client-vehicle-id');
      }
    };

    vehicleSel.addEventListener('change',()=>{
      syncSelectedVehicle();
      UI.refreshVehicleRow(row,{setBase:true});
      UI.updateTotals();
    });

    syncSelectedVehicle();

    UI.refreshVehicleRow(row,{skipAddons:true});
    UI.renderVehicleAddons(row, prefill.addons||null);

    baseInput.addEventListener('input',()=>UI.updateTotals());
    sizeSel.addEventListener('change',()=>{ UI.refreshVehicleRow(row,{setBase:true}); UI.updateTotals(); });
    pkgSel.addEventListener('change',()=>{ UI.refreshVehicleRow(row,{setBase:true}); UI.updateTotals(); });

    UI.syncVehicleRemovers();
    UI.refreshClientVehicleOptions();
    UI.updateTotals();
  },
  removeVehicle(row){
    const list=document.getElementById('vehiclesList');
    if(!list) return;
    if(list.querySelectorAll('.vehicle-row').length<=1){
      UI.flash('At least one vehicle required.');
      return;
    }
    row.remove();
    UI.syncVehicleRemovers();
    UI.updateTotals();
  },
  refreshVehicleRow(row,{setBase=false, skipAddons=false, skipPackageSync=false}={}){
    const pkgSel=row.querySelector('.vehicle-package');
    if(pkgSel && !skipPackageSync){
      UI.updatePackageSelectOptions(pkgSel,{preferred:pkgSel.value});
    }
    const pkg=pkgSel?.value || '';
    const meta=pkgMeta(pkg);
    const sizeSel=row.querySelector('.vehicle-size');
    const baseInput=row.querySelector('.vehicle-base');
    const size=sizeSel?.value || S.menu.sizes[0] || '';
    if(setBase && baseInput){
      const base=Calc.base(pkg,size);
      baseInput.value=Number(base||0).toFixed(2);
    }
    if(baseInput) baseInput.disabled=!!meta.lock;
    row.setAttribute('data-pkg',pkg);
    UI.renderVehiclePackageInfo(row, meta);
    if(!skipAddons) UI.renderVehicleAddons(row);
  },
  renderVehiclePackageInfo(row, metaOverride=null){
    const info=row.querySelector('.vehicle-package-info');
    if(!info) return;
    const pkgSel=row.querySelector('.vehicle-package');
    const pkg=pkgSel?.value || '';
    const size=row.querySelector('.vehicle-size')?.value || S.menu.sizes[0] || '';
    if(!pkg){
      info.innerHTML='';
      info.classList.add('hidden');
      return;
    }
    const meta=metaOverride || pkgMeta(pkg);
    const included=(meta.includedAddons||[]).filter(Boolean);
    const description=(meta.description||'').trim();
    info.innerHTML='';
    info.classList.remove('hidden');
    info.append(el('h4',{}, pkg));
    info.append(el('div',{class:'tiny',style:'color:#9fb2ae;font-weight:700;'},`Base for ${size||'selected size'}: ${fmt(Calc.base(pkg,size))}`));
    if(description) info.append(el('p',{}, description));
    if(included.length){
      info.append(el('div',{class:'muted',style:'font-size:.8rem;font-weight:700;color:#9db0a9;'},'Included add-ons'));
      const list=el('ul',{});
      included.forEach(name=>list.append(el('li',{},name)));
      info.append(list);
    } else if(!description){
      info.append(el('p',{class:'tiny',style:'color:#8f9a9a;'},'No add-ons are included by default for this package.'));
    }
  },
  renderVehicleAddons(row,preset=null){
    const host=row.querySelector('.vehicle-addons');
    if(!host) return;
    const pkgSel=row.querySelector('.vehicle-package');
    const pkg=pkgSel?.value || '';
    const size=row.querySelector('.vehicle-size')?.value || S.menu.sizes[0] || '';
    const meta=pkgMeta(pkg);
    const previous=new Map();
    if(preset){
      (preset||[]).forEach(a=>previous.set(a.name,{price:Number(a.price||0), included:a.included || meta.includedAddons?.includes(a.name)}));
    } else {
      host.querySelectorAll('.vehicle-addon-row').forEach(node=>{
        const name=node.getAttribute('data-name');
        const price=node.querySelector('input[type=number]');
        const included=node.getAttribute('data-included')==='true';
        previous.set(name,{price:Number(price?.value||0), included});
      });
    }
    host.innerHTML='';

    const controlRow=el('div',{class:'row',style:'gap:.5rem;align-items:flex-end;'});
    const select=el('select',{class:'vehicle-addon-picker'});
    select.append(el('option',{value:''},'Add add-on…'));
    Object.keys(S.menu.addons).forEach(name=>select.append(el('option',{value:name},UI.addonOptionLabel(name,size,meta))));
    const addBtn=el('button',{class:'btn secondary',type:'button'},'Add');
    controlRow.append(select,addBtn);
    host.append(controlRow);

    const selectedWrap=el('div',{class:'list vehicle-addon-selected',style:'margin-top:.5rem;gap:.4rem;'});
    host.append(selectedWrap);

    const chosen=new Set();
    const refreshOptions=()=>{
      Array.from(select.options).forEach(opt=>{
        if(!opt.value) return;
        opt.disabled=chosen.has(opt.value);
      });
    };

    const addRow=(name,info={})=>{
      if(!name || !S.menu.addons[name] || chosen.has(name)) return;
      const included=info.included || !!meta.includedAddons?.includes(name);
      const basePrice=Calc.addonPrice(name,size);
      const priceVal=included?0:(info.price!=null?Number(info.price):basePrice);
      const rowEl=el('div',{class:'list-item vehicle-addon-row','data-name':name,'data-included':included?'true':'false'});
      const rowContent=el('div',{class:'row',style:'align-items:center;gap:.5rem;'});
      rowContent.append(el('div',{style:'flex:1;font-weight:800;'}, name + (included?' — Included':'')));
      const priceInput=el('input',{type:'number',min:'0',step:'0.01',value:Number(priceVal||0).toFixed(2),style:'flex:0;width:120px;'});
      if(included) priceInput.disabled=true;
      const setStoredPrice=(val)=>previous.set(name,{price:val, included});
      setStoredPrice(Number(priceVal||0));
      priceInput.addEventListener('input',()=>{
        setStoredPrice(Number(priceInput.value||0));
        UI.updateTotals();
      });
      rowContent.append(priceInput);
      if(included){
        rowContent.append(el('span',{class:'pill',style:'flex:0 0 auto;'},'Included'));
      } else {
        const removeBtn=el('button',{class:'btn secondary',type:'button'},'Remove');
        removeBtn.addEventListener('click',()=>{
          chosen.delete(name);
          rowEl.remove();
          previous.delete(name);
          refreshOptions();
          UI.updateTotals();
        });
        rowContent.append(removeBtn);
      }
      rowEl.append(rowContent);
      selectedWrap.append(rowEl);
      chosen.add(name);
      refreshOptions();
      UI.updateTotals();
    };

    const includedSet=new Set(meta.includedAddons||[]);
    const initialMap=new Map();
    previous.forEach((info,name)=>{
      const included=includedSet.has(name) || info.included;
      initialMap.set(name,{name, price:included?0:Number(info.price||0), included});
    });
    includedSet.forEach(name=>{
      if(!initialMap.has(name)) initialMap.set(name,{name, price:0, included:true});
      else {
        const item=initialMap.get(name);
        initialMap.set(name,{name, price:0, included:true});
      }
    });
    initialMap.forEach(item=>addRow(item.name,item));

    addBtn.addEventListener('click',()=>{
      const value=select.value;
      if(!value) return;
      addRow(value,previous.get(value)||{});
      select.value='';
      refreshOptions();
    });
    select.addEventListener('change',()=>{
      if(!select.value) return;
      addRow(select.value,previous.get(select.value)||{});
      select.value='';
      refreshOptions();
    });

    refreshOptions();
  },
  syncVehicleRemovers(){
    const rows=document.querySelectorAll('.vehicle-row');
    rows.forEach(row=>{
      const btn=row.querySelector('.vehicle-remove');
      if(btn) btn.classList.toggle('hidden', rows.length<=1);
    });
  },
  collectVehicles(){
    return Array.from(document.querySelectorAll('.vehicle-row')).map(row=>{
      const size=row.querySelector('.vehicle-size')?.value || '';
      const base=Number(row.querySelector('.vehicle-base')?.value||0);
      const pkg=row.querySelector('.vehicle-package')?.value || '';
      const label=row.querySelector('.vehicle-label')?.value.trim() || '';
      const clientVehicleId=row.querySelector('.vehicle-existing')?.value || '';
      const addons=Array.from(row.querySelectorAll('.vehicle-addon-row')).map(aRow=>{
        const priceInput=aRow.querySelector('input[type=number]');
        const name=aRow.getAttribute('data-name');
        const price=Number(priceInput?.value||0);
        const included=aRow.getAttribute('data-included')==='true';
        return {name, price, included};
      }).filter(a=>a && a.name);
      const vehicle={size, base, addons, pkg};
      if(label) vehicle.label=label;
      if(clientVehicleId) vehicle.clientVehicleId=clientVehicleId;
      return vehicle;
    });
  },
  updateTotals(){
    const vehicles=this.collectVehicles();
    const job={
      pkg:vehicles[0]?.pkg || '',
      vehicles,
      discType:document.getElementById('jobDiscType').value,
      discValue:Number(document.getElementById('jobDiscValue').value||0),
      discScope:document.getElementById('jobDiscScope').value
    };
    const subtotal=Calc.subtotal(job);
    const discount=Calc.discount(job);
    const total=Calc.total(job);
    document.getElementById('jobSubtotal').textContent=fmt(subtotal);
    document.getElementById('jobDiscount').textContent=fmt(discount);
    document.getElementById('jobTotal').textContent=fmt(total);
    this.renderAddonSummary(vehicles);
  },
  renderAddonSummary(vehicles){
    const host=document.getElementById('addonSummary');
    if(!host) return;
    host.innerHTML='';
    if(!vehicles.length){
      host.append(el('div',{style:'font-weight:800;'},'Add-on guidance'));
      host.append(el('div',{class:'tiny'},'Add vehicles to compare Maintenance vs. Full Detail.'));
      host.classList.remove('alert');
      return;
    }
    const summary=Calc.addonSummary({vehicles});
    host.append(el('div',{style:'font-weight:800;'}, summary.requiresUpgrade ? '⚠️ Add-on upgrade recommended' : 'Add-on guidance'));
    host.append(el('div',{class:'tiny'}, summary.message));
    if(summary.totalIncluded){
      host.append(el('div',{class:'tiny'}, `Included add-ons: ${summary.totalIncluded}`));
    }
    if(summary.perVehicle.length>1){
      host.append(el('div',{class:'tiny'}, summary.perVehicle.map((info,idx)=>`Vehicle ${idx+1}: ${info.custom} custom / ${info.included} included`).join(' · ')));
    } else if(summary.perVehicle.length===1){
      const info=summary.perVehicle[0];
      host.append(el('div',{class:'tiny'}, `${info.custom} custom · ${info.included} included add-ons`));
    }
    host.append(el('div',{class:'tiny'}, summary.upsell));
    host.classList.toggle('alert', summary.requiresUpgrade);
  },
  refreshDashboard(){
    const month=today().slice(0,7);
    let income=0;
    let expense=0;
    for(const t of S.transactions){
      const date=(t.date||'').slice(0,7);
      if(date!==month) continue;
      const amount=Number(t.amount||0);
      if(t.type==='Income') income+=amount;
      else if(t.type==='Expense') expense+=amount;
    }
    const net=income-expense;
    const incomeEl=document.getElementById('mIncome');
    const expenseEl=document.getElementById('mExpense');
    const netEl=document.getElementById('mNet');
    if(incomeEl) incomeEl.textContent=fmt(income);
    if(expenseEl) expenseEl.textContent=fmt(expense);
    if(netEl) netEl.textContent=fmt(net);
  },
  quickDisc(type,val){ document.getElementById('jobDiscType').value=type; document.getElementById('jobDiscValue').value=val; UI.updateTotals(); },
  resetJobForm(){
    const list=document.getElementById('vehiclesList');
    if(list) list.innerHTML='';
    this.addVehicle();
    this.handlePackageChange();
    const discType=document.getElementById('jobDiscType');
    if(discType) discType.value='none';
    const discValue=document.getElementById('jobDiscValue');
    if(discValue) discValue.value='0';
    const discScope=document.getElementById('jobDiscScope');
    if(discScope) discScope.value='job';
    const notes=document.getElementById('jobNotes');
    if(notes) notes.value='';
    const dateInput=document.getElementById('jobDate');
    if(dateInput) dateInput.value=today();
    const startInput=document.getElementById('jobStart');
    if(startInput) startInput.value='';
    const endInput=document.getElementById('jobEnd');
    if(endInput) endInput.value='';
    const durationInput=document.getElementById('jobDuration');
    if(durationInput) durationInput.value='';
    this.editingJobId=null;
    this.updateJobFormEditingUI(null);
    const quoteBtn=document.getElementById('quoteSaveBtn');
    if(quoteBtn){
      quoteBtn.textContent='Save Quote';
      quoteBtn.classList.remove('hidden');
    }
    const jobBtn=document.getElementById('jobSaveBtn');
    if(jobBtn) jobBtn.textContent='Schedule Job';
    this.updateTotals();
  },
  jobVehicleSummary(job){ const vehicles=Calc.vehicles(job); if(!vehicles.length) return ''; const counts={}; vehicles.forEach(v=>{ const key=v.size||'Vehicle'; counts[key]=(counts[key]||0)+1; }); return Object.entries(counts).map(([size,count])=>count>1?`${size} × ${count}`:size).join(', '); },
  jobPackageLabel(job){
    const vehicles=Calc.vehicles(job);
    const names=[...new Set(vehicles.map(v=>v.pkg).filter(Boolean))];
    if(names.length===1) return names[0];
    if(names.length>1) return 'Multiple Packages';
    return job.pkg || '';
  },
  buildJobCard(job,{context='jobs'}={}){
    App.ensureJobStructure(job);
    const client=S.clients.find(x=>x.id===job.clientId);
    const scheduleDate=job.schedule?.date || job.date || '';
    const dateLabel=scheduleDate ? new Date(scheduleDate+'T00:00:00').toLocaleDateString() : 'No date';
    const timeLabel=job.schedule?.start ? `${job.schedule.start}${job.schedule.end?` – ${job.schedule.end}`:''}` : 'Any time';
    const summary=this.jobPackageLabel(job);
    const vehicleSummary=this.jobVehicleSummary(job);
    const paid=(job.payments||[]).reduce((t,p)=>t+Number(p.amount||0),0);
    const total=Calc.total(job);
    const due=Math.max(0,total-paid);
    const timerMinutes=App.timerElapsedMinutes(job.timers?.overall||{elapsed:0});
    const card=el('div',{class:'list-item job-card'});
    const header=el('div',{class:'row',style:'justify-content:space-between;gap:.5rem;flex-wrap:wrap;align-items:center;'},
      el('div',{style:'font-weight:800;'}, client?.name||'Unknown'),
      el('div',{class:'pill'}, job.status)
    );
    const subtextParts=[summary];
    if(vehicleSummary) subtextParts.push(vehicleSummary);
    const subtitleText=subtextParts.filter(Boolean).join(' • ');
    if(subtitleText){
      header.append(el('div',{class:'tiny',style:'color:#96a4a4;margin-top:.15rem;'}, subtitleText));
    }
    const metaGrid=el('div',{class:'job-meta-grid',style:'margin-top:.6rem;'},
      el('div',{}, el('div',{class:'tiny'},'Scheduled'), el('div',{style:'font-weight:700;'}, `${dateLabel}${timeLabel?` · ${timeLabel}`:''}`)),
      el('div',{}, el('div',{class:'tiny'},'Total'), el('div',{style:'font-weight:700;'}, fmt(total))),
      el('div',{}, el('div',{class:'tiny'},'Paid'), el('div',{style:'font-weight:700;'}, fmt(paid))),
      el('div',{}, el('div',{class:'tiny'},'Due'), el('div',{style:'font-weight:700;color:'+(due>0?'#f5d7d7':'#9fb2ae')}, fmt(due))),
      el('div',{}, el('div',{class:'tiny'},'Tracked Time'), el('div',{style:'font-weight:700;'}, timerMinutes?formatDurationMinutes(timerMinutes):'--'))
    );
    const actionsContainer=el('div',{class:'stack-buttons',style:'margin-top:.75rem;'});
    const actions=[];
    const openJob=()=>UI.openJob(job.id);
    const editJob=()=>UI.editJob(job.id);
    if(context==='jobs'){
      actions.push(el('button',{class:'pill',onclick:openJob},'View Job'));
      actions.push(el('button',{class:'pill',onclick:editJob},'Edit Job'));
      if(job.status==='Quoted'){
        actions.push(el('button',{class:'btn secondary',onclick:()=>{ App.updateJobStatus(job.id,'Booked'); UI.switchTab('Jobs'); }},'Convert to Job'));
      }
      if(job.status==='Booked') actions.push(el('button',{class:'pill',onclick:()=>App.updateJobStatus(job.id,'In Progress')},'Start Job'));
      if(job.status==='In Progress') actions.push(el('button',{class:'pill',onclick:()=>App.updateJobStatus(job.id,'Complete')},'Mark Complete'));
      if(job.status==='Complete') actions.push(el('button',{class:'pill',onclick:()=>App.updateJobStatus(job.id,'Paid')},'Mark Paid'));
      if(due>0.01) actions.push(el('button',{class:'pill',onclick:()=>App.takePayment(job.id)},'Take Payment'));
      actions.push(el('button',{class:'pill',onclick:()=>UI.openChecklist(job.id)},'Checklist'));
      actions.push(el('button',{class:'pill',onclick:()=>UI.openPrintDetails(job.id)},'Print Summary'));
      actions.push(el('button',{class:'pill',onclick:()=>App.deleteJob(job.id)},'Delete'));
    } else {
      actions.push(el('button',{class:'pill',onclick:editJob},'Edit Quote'));
      actions.push(el('button',{class:'btn',onclick:()=>{ App.updateJobStatus(job.id,'Booked'); UI.switchTab('Jobs'); UI.flash('Quote converted to job.'); }},'Convert to Job'));
      actions.push(el('button',{class:'pill',onclick:()=>UI.openPrintDetails(job.id)},'Print Quote'));
      actions.push(el('button',{class:'pill',onclick:()=>App.deleteJob(job.id)},'Delete Quote'));
    }
    actions.forEach(btn=>actionsContainer.append(btn));
    card.append(header, metaGrid, actionsContainer);
    return card;
  },
  buildTransactionCard(tx,{showType=true}={}){
    const card=el('div',{class:'list-item transaction-card'});
    const titleParts=[];
    if(showType && tx.type) titleParts.push(tx.type);
    if(tx.category) titleParts.push(tx.category);
    const title=titleParts.join(' • ') || 'Transaction';
    const left=el('div',{});
    left.append(el('h4',{}, title));
    if(tx.item) left.append(el('div',{class:'tiny'}, tx.item));
    if(tx.vendor) left.append(el('div',{class:'tiny'}, tx.vendor));
    const amountValue=Number(tx.amount||0);
    const amountLabel=fmt(amountValue);
    const amountColor=tx.type==='Expense'?'#f5d7d7':'#9fe4b9';
    const right=el('div',{style:'display:flex;flex-direction:column;align-items:flex-end;gap:.25rem;'});
    if(tx.date) right.append(el('div',{class:'tiny'}, tx.date));
    right.append(el('div',{class:'transaction-amount',style:`color:${amountColor};`}, amountLabel));
    const header=el('div',{class:'row',style:'justify-content:space-between;align-items:flex-start;gap:.5rem;'}, left,right);
    card.append(header);
    const meta=el('div',{class:'transaction-meta'});
    if(tx.payment) meta.append(el('span',{}, tx.payment));
    if(tx.clientId){
      const clientName=this.clientName(tx.clientId);
      if(clientName) meta.append(el('span',{}, clientName));
    }
    if(tx.type==='Income' && tx.jobId) meta.append(el('span',{}, 'Linked to job'));
    if(meta.childElementCount) card.append(meta);
    if(tx.notes) card.append(el('div',{class:'transaction-notes'}, tx.notes));
    const actions=el('div',{class:'stack-buttons'});
    if(tx.receiptImage){
      actions.append(el('button',{class:'btn secondary fullwidth',onclick:()=>this.showReceipt({image:tx.receiptImage,vendor:tx.vendor,date:tx.date,amount:amountLabel})},'View Receipt'));
    }
    actions.append(el('button',{class:'btn secondary fullwidth',onclick:()=>{ if(App.deleteTransaction(tx.id)) card.remove(); }},'Delete'));
    card.append(actions);
    return card;
  },
  setJobFilter(filter){
    this.jobFilter=filter;
    this.refreshJobsList();
  },
  refreshJobsList(){
    const list=document.getElementById('jobsList');
    if(!list) return;
    document.querySelectorAll('[data-filter]').forEach(btn=>{
      const filter=btn.getAttribute('data-filter');
      btn.classList.toggle('job-filter-active', filter===this.jobFilter);
    });
    const todayStr=today();
    const jobs=[...S.jobs];
    jobs.forEach(job=>App.ensureJobStructure(job));
    jobs.sort((a,b)=>{
      const dateA=(a.schedule?.date||a.date||'')+(a.schedule?.start||'');
      const dateB=(b.schedule?.date||b.date||'')+(b.schedule?.start||'');
      return dateA.localeCompare(dateB);
    });
    const filtered=jobs.filter(job=>{
      if(job.status==='Quoted') return false;
      const scheduleDate=job.schedule?.date || job.date || '';
      const paid=(job.payments||[]).reduce((t,p)=>t+Number(p.amount||0),0);
      const due=Math.max(0,Calc.total(job)-paid);
      switch(this.jobFilter){
        case 'today': return scheduleDate===todayStr;
        case 'upcoming': return scheduleDate>todayStr && !['Complete','Paid'].includes(job.status);
        case 'completed': return ['Complete','Paid'].includes(job.status);
        case 'unpaid': return due>0.01;
        default: return true;
      }
    });
    list.innerHTML='';
    if(!filtered.length){
      list.append(el('div',{class:'tiny'},'No jobs match the current filter.'));
    }
    for(const job of filtered){
      list.append(this.buildJobCard(job,{context:'jobs'}));
    }
    const recent=document.getElementById('recentList');
    if(recent){
      recent.innerHTML='';
      jobs.filter(job=>job.status!=='Quoted').slice(0,5).forEach(job=>{
        const client=S.clients.find(x=>x.id===job.clientId);
        const vehicleSummary=this.jobVehicleSummary(job);
        const pkgLabel=this.jobPackageLabel(job);
        const summaryText=vehicleSummary?`${pkgLabel} — ${vehicleSummary}`:pkgLabel;
        recent.append(el('div',{class:'list-item'}, `${job.schedule?.date||job.date||''} · ${client?.name||'Unknown'} · ${summaryText} (${job.status})`));
      });
    }
    this.refreshJobPerformance();
    this.refreshJobPlanner();
    this.refreshQuotesList();
  },
  refreshQuotesList(){
    const list=document.getElementById('quotesList');
    if(!list) return;
    list.innerHTML='';
    const quotes=S.jobs.filter(job=>job.status==='Quoted');
    if(!quotes.length){
      list.append(el('div',{class:'tiny'},'No pending quotes right now.'));
      return;
    }
    quotes.sort((a,b)=>{
      const createdA=a.createdAt||'';
      const createdB=b.createdAt||'';
      return createdB.localeCompare(createdA);
    });
    quotes.forEach(job=>{
      list.append(this.buildJobCard(job,{context:'quotes'}));
    });
  },
  startQuoteFlow(){
    this.switchTab('QuoteBuilder');
    this.resetJobForm();
    this.flash('Ready to build a quote.');
  },
  printQuotesSummary(){
    const quotes=S.jobs.filter(job=>job.status==='Quoted');
    if(!quotes.length){
      alert('No pending quotes to print.');
      return;
    }
    const rows=quotes.map(job=>{
      const client=S.clients.find(c=>c.id===job.clientId);
      const scheduleDate=job.schedule?.date || job.date || '';
      const dateLabel=scheduleDate?new Date(scheduleDate+'T00:00:00').toLocaleDateString():'--';
      const summary=this.jobPackageLabel(job);
      const vehicle=this.jobVehicleSummary(job);
      const total=fmt(Calc.total(job));
      return `<tr><td>${client?.name||'Unknown'}</td><td>${dateLabel}</td><td>${summary}${vehicle?`<div class="sub">${vehicle}</div>`:''}</td><td style="text-align:right">${total}</td></tr>`;
    }).join('');
    const popup=window.open('','_blank');
    if(!popup || popup.closed){
      alert('Please allow pop-ups to view the printable list.');
      return;
    }
    const html=`<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Pending Quotes</title>
  <style>
    body{margin:0;font-family:Montserrat,Arial,sans-serif;background:#eef2f4;color:#102018;}
    .toolbar{position:sticky;top:0;padding:12px 18px;background:#fff;display:flex;justify-content:flex-end;gap:8px;border-bottom:1px solid #d6dde0;}
    .toolbar button{padding:8px 14px;border-radius:12px;border:none;font-weight:700;cursor:pointer;background:#0d1f15;color:#f2fbf6;}
    .sheet{max-width:860px;margin:24px auto;background:#fff;padding:24px;border-radius:18px;box-shadow:0 24px 60px rgba(14,28,26,.15);}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #e2e8eb;}
    th{font-size:12px;letter-spacing:.4px;text-transform:uppercase;color:#5b6d66;}
    td{font-size:14px;vertical-align:top;}
    td .sub{color:#73827c;font-size:12px;margin-top:4px;}
    @media print{body{background:#fff;} .toolbar{display:none;} .sheet{box-shadow:none;border-radius:0;margin:0;padding:0;}}
  </style>
</head>
<body>
  <div class="toolbar"><button onclick="window.print()">Print</button></div>
  <div class="sheet">
    <h2 style="margin:0 0 12px;font-size:24px;">Pending Quotes</h2>
    <table>
      <thead><tr><th>Client</th><th>Date</th><th>Summary</th><th style="text-align:right">Total</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  </div>
</body>
</html>`;
    popup.document.write(html);
    popup.document.close();
  },
  loadOcr(){
    if(window.Tesseract) return Promise.resolve(window.Tesseract);
    if(this.ocrPromise) return this.ocrPromise;
    this.ocrPromise=new Promise((resolve,reject)=>{
      const script=document.createElement('script');
      script.src='https://cdn.jsdelivr.net/npm/tesseract.js@4.0.3/dist/tesseract.min.js';
      script.async=true;
      script.crossOrigin='anonymous';
      script.onload=()=>resolve(window.Tesseract);
      script.onerror=()=>reject(new Error('Failed to load OCR engine'));
      document.head.append(script);
    });
    return this.ocrPromise;
  },
  detectPaymentMethod(text){
    const methods=Array.isArray(S.settings.paymentMethods)?S.settings.paymentMethods:[];
    const normalized=String(text||'').toLowerCase();
    const dictionary={
      cash:['cash'],
      card:['visa','mastercard','amex','credit','debit','discover','card','mc'],
      zelle:['zelle'],
      venmo:['venmo'],
      'cash app':['cashapp','cash app'],
      cashapp:['cashapp','cash app'],
      bank:['bank','ach','wire','transfer','checking']
    };
    for(const method of methods){
      const key=method.toLowerCase();
      const tokens=dictionary[key] || [key];
      if(tokens.some(token=>normalized.includes(token))) return method;
    }
    return '';
  },
  parseReceiptText(raw){
    const text=String(raw||'');
    const clean=text.replace(/\r/g,'');
    const lines=clean.split(/\n+/).map(line=>line.trim()).filter(Boolean);
    let vendor='';
    for(const line of lines){
      if(!line) continue;
      if(/total|amount|invoice|receipt|tax|change|item|qty|cashier|order|payment/i.test(line)) continue;
      const cleaned=line.replace(/[^A-Za-z0-9 .&@\-]/g,' ').trim();
      if(cleaned){ vendor=cleaned.slice(0,60); break; }
    }
    if(!vendor && lines.length) vendor=lines[0].slice(0,60);
    const isoFromParts=(year,month,day)=>{
      let y=Number(year);
      let m=Number(month);
      let d=Number(day);
      if(y<100) y+=y>=70?1900:2000;
      if(!(y>1900 && y<2100) || !(m>=1 && m<=12) || !(d>=1 && d<=31)) return '';
      return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    };
    let date='';
    const isoMatch=clean.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
    if(isoMatch) date=isoFromParts(isoMatch[1],isoMatch[2],isoMatch[3]);
    if(!date){
      const usMatch=clean.match(/(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})/);
      if(usMatch) date=isoFromParts(usMatch[3],usMatch[1],usMatch[2]);
    }
    if(!date){
      const monthNames=['january','february','march','april','may','june','july','august','september','october','november','december'];
      const monthMatch=clean.match(/(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|jun(?:e)?|jul(?:y)?|aug(?:ust)?|sep(?:t(?:ember)?)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\s+(\d{1,2})(?:,)?\s*(\d{2,4})/i);
      if(monthMatch){
        const monthIndex=monthNames.findIndex(name=>name.startsWith(monthMatch[1].toLowerCase()));
        if(monthIndex>=0) date=isoFromParts(monthMatch[3],monthIndex+1,monthMatch[2]);
      }
    }
    let amountValue=0;
    for(const line of lines){
      if(!/total|balance|amount due/i.test(line)) continue;
      if(/subtotal/i.test(line) && !/grand|balance|due/i.test(line)) continue;
      const matches=[...line.matchAll(/(\d{1,3}(?:,\d{3})*\.\d{2})/g)];
      if(!matches.length) continue;
      const lastMatch=matches[matches.length-1][1];
      const candidate=parseFloat(lastMatch.replace(/,/g,''));
      if(!Number.isFinite(candidate)) continue;
      amountValue=candidate;
    }
    if(!amountValue){
      const matches=[...clean.matchAll(/(\d{1,3}(?:,\d{3})*\.\d{2})/g)];
      for(const match of matches){
        const candidate=parseFloat(match[1].replace(/,/g,''));
        if(candidate>amountValue) amountValue=candidate;
      }
    }
    const payment=this.detectPaymentMethod(clean);
    return {
      vendor,
      date,
      amount:amountValue?amountValue.toFixed(2):'',
      payment
    };
  },
  showReceipt({image,vendor,date,amount}={}){
    if(!image) return;
    const details=[];
    if(vendor) details.push(vendor);
    if(date) details.push(date);
    if(amount) details.push(amount);
    const body=el('div',{class:'receipt-preview',style:'max-height:none;'}, el('img',{src:image}));
    if(details.length) body.append(el('div',{class:'receipt-ocr-status'}, details.join(' • ')));
    this.modal('Receipt',(close)=>close(), body,'Close',false,true);
  },
  openJob(id){
    this.jobPanelJobId=id;
    this.renderJobPanel(id,true);
    const panel=document.getElementById('jobPanel');
    if(panel) panel.classList.add('open');
  },
  closeJobPanel(){
    const panel=document.getElementById('jobPanel');
    if(panel) panel.classList.remove('open');
    this.jobPanelJobId=null;
  },
  renderJobPanel(jobId,force=false){
    const panel=document.getElementById('jobPanel');
    const body=document.getElementById('jobPanelBody');
    if(!panel || !body) return;
    if(!force && this.jobPanelJobId!==jobId && !panel.classList.contains('open')) return;
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job){
      this.closeJobPanel();
      return;
    }
    this.jobPanelJobId=jobId;
    App.ensureJobStructure(job);
    const client=S.clients.find(c=>c.id===job.clientId);
    const titleEl=document.getElementById('jobPanelTitle');
    const subtitleEl=document.getElementById('jobPanelSubtitle');
    if(titleEl) titleEl.textContent=`${client?.name||'Unknown'} — ${job.status}`;
    const scheduleDate=job.schedule?.date || job.date || '';
    const dateLabel=scheduleDate?new Date(scheduleDate+'T00:00:00').toLocaleDateString():'No date';
    const timeLabel=job.schedule?.start ? `${job.schedule.start}${job.schedule?.end?` – ${job.schedule.end}`:''}` : 'Any time';
    const summary=this.jobPackageLabel(job);
    if(subtitleEl) subtitleEl.textContent=`${dateLabel}${timeLabel?` · ${timeLabel}`:''} • ${summary}`;
    body.innerHTML='';
    const scheduleSection=el('div',{class:'job-section'},
      el('h4',{},'Schedule'),
      el('div',{class:'tiny'},'Date'),
      el('div',{style:'font-weight:700;'}, dateLabel),
      el('div',{class:'tiny'},'Time'),
      el('div',{style:'font-weight:700;'}, timeLabel),
      el('div',{class:'tiny'},'Estimated Duration'),
      el('div',{style:'font-weight:700;'}, job.schedule?.durationMinutes?formatDurationMinutes(job.schedule.durationMinutes):'Not set'),
      el('div',{class:'tiny'},'Package'),
      el('div',{style:'font-weight:700;'}, summary),
      el('button',{class:'btn secondary',onclick:()=>UI.editJob(job.id)},'Edit Job Details')
    );
    const total=Calc.total(job);
    const paid=(job.payments||[]).reduce((t,p)=>t+Number(p.amount||0),0);
    const due=Math.max(0,total-paid);
    const financialSection=el('div',{class:'job-section'},
      el('h4',{},'Financials'),
      el('div',{class:'tiny'},'Total'),
      el('div',{style:'font-weight:700;'}, fmt(total)),
      el('div',{class:'tiny'},'Paid'),
      el('div',{style:'font-weight:700;'}, fmt(paid)),
      el('div',{class:'tiny'},'Balance Due'),
      el('div',{style:'font-weight:700;color:'+(due>0?'#f5d7d7':'#9fb2ae')}, fmt(due))
    );
    if(due>0.01){
      financialSection.append(el('button',{class:'btn',onclick:()=>App.takePayment(job.id)},'Take Payment'));
    }
    if(Array.isArray(job.payments) && job.payments.length){
      const paymentList=el('div',{class:'job-services'});
      job.payments.forEach(p=>{
        paymentList.append(el('div',{class:'job-service'},
          el('div',{class:'service-main'}, `${p.date} — ${p.method||'Payment'}`),
          el('div',{class:'service-meta'}, fmt(Number(p.amount||0)))
        ));
      });
      financialSection.append(el('div',{class:'tiny'},'Payments'));
      financialSection.append(paymentList);
    }
    const servicesSection=el('div',{class:'job-section'},
      el('h4',{},'Services'),
      el('button',{class:'btn',onclick:()=>UI.openAddService(job.id)},'Add Service')
    );
    const servicesList=el('div',{class:'job-services'});
    if(job.services?.length){
      job.services.forEach(service=>{
        const metaParts=[];
        if(service.type) metaParts.push(service.type.charAt(0).toUpperCase()+service.type.slice(1));
        if(service.vehicleLabel) metaParts.push(service.vehicleLabel);
        const metaText=metaParts.join(' • ');
        const priceLabel=service.included?'Included':fmt(service.price||0);
        const info=el('div',{class:'service-main'},
          el('div',{style:'font-weight:700;'}, service.name||'Service')
        );
        if(metaText) info.append(el('div',{class:'service-meta'}, metaText));
        const row=el('div',{class:'job-service'},
          info,
          el('div',{class:'service-meta'}, priceLabel)
        );
        if(service.type!=='package'){
          row.append(el('button',{class:'btn secondary',onclick:()=>App.removeService(job.id,service.id)},'Remove'));
        }
        servicesList.append(row);
      });
    } else {
      servicesList.append(el('div',{class:'tiny'},'No services logged yet.'));
    }
    servicesSection.append(servicesList);
    const timersSection=el('div',{class:'job-section'}, el('h4',{},'Timers'));
    const timersWrap=el('div',{class:'job-timers'});
    const timerOrder=['overall','setup','base','addons'];
    timerOrder.forEach(key=>{
      const timer=job.timers?.[key];
      if(!timer) return;
      const minutes=App.timerElapsedMinutes(timer);
      const running=!!timer.runningSince;
      const row=el('div',{class:'job-timer', 'data-running':running?'true':'false'},
        el('div',{class:'timer-info'},
          el('div',{class:'timer-label'}, timer.label||key),
          el('div',{class:'service-meta'}, running?'Running':'Paused')
        ),
        el('div',{class:'timer-value'}, formatDurationMinutes(minutes)),
        (()=>{
          const controls=el('div',{class:'job-timer-controls'});
          controls.append(el('button',{class:'pill',onclick:()=>App.toggleTimer(job.id,key)}, running?'Pause':'Start'));
          controls.append(el('button',{class:'pill',onclick:()=>App.resetTimer(job.id,key)},'Reset'));
          controls.append(el('button',{class:'pill',onclick:()=>UI.promptTimerAdjust(job.id,key)},'Adjust'));
          return controls;
        })()
      );
      timersWrap.append(row);
    });
    timersSection.append(timersWrap);
    const checklistSection=el('div',{class:'job-section'}, el('h4',{},'Checklist'));
    const checklist=job.checklist?.sections||[];
    const totalItems=checklist.reduce((sum,section)=>sum+(section.items?.length||0),0);
    const completeItems=checklist.reduce((sum,section)=>sum+(section.items?.filter(i=>i.completed).length||0),0);
    checklistSection.append(el('div',{class:'tiny'}, `${completeItems} of ${totalItems} items complete`));
    checklistSection.append(el('button',{class:'btn secondary',onclick:()=>UI.openChecklist(job.id)},'Open Checklist'));
    const notesSection=el('div',{class:'job-section'}, el('h4',{},'Notes & Summary'));
    notesSection.append(el('div',{class:'tiny'}, job.notes||'No notes for this job.'));
    const performanceRow=el('div',{class:'service-meta'}, `Tracked time: ${formatDurationMinutes(App.timerElapsedMinutes(job.timers?.overall||{elapsed:0}))}`);
    notesSection.append(performanceRow);
    if(job.totalMinutes){
      notesSection.append(el('div',{class:'service-meta'}, `Logged duration: ${formatDurationMinutes(job.totalMinutes)}`));
    }
    body.append(scheduleSection, financialSection, servicesSection, timersSection, checklistSection, notesSection);
  },
  promptTimerAdjust(jobId,key){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    App.ensureTimers(job);
    const timer=job.timers?.[key];
    if(!timer) return;
    const current=App.timerElapsedMinutes(timer);
    const input=prompt('Set duration (e.g., 1h 45m or 105)', formatDurationMinutes(current));
    if(!input) return;
    const mins=parseDurationInput(input);
    if(mins==null) return alert('Unable to parse duration.');
    App.setTimerMinutes(jobId,key,mins);
  },
  openAddService(jobId){
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    App.ensureJobStructure(job);
    const typeSel=el('select',{},
      el('option',{value:'addon'},'Menu Add-on'),
      el('option',{value:'custom'},'Custom Service')
    );
    const addonSel=el('select',{});
    addonSel.append(el('option',{value:''},'Select add-on'));
    Object.keys(S.menu.addons).forEach(name=>addonSel.append(el('option',{value:name},name)));
    const nameInput=el('input',{placeholder:'Service name'});
    const priceInput=el('input',{type:'number',min:'0',step:'0.01',placeholder:'0.00',value:'0.00'});
    const includedRow=el('label',{}, el('input',{type:'checkbox',id:'svcIncluded',style:'margin-right:.4rem;'}),'Included (no charge)');
    const vehicleSel=el('select',{});
    vehicleSel.append(el('option',{value:''},'Apply to job'));
    (job.vehicles||[]).forEach((vehicle,idx)=>{
      const label=vehicle.label||`Vehicle ${idx+1}`;
      vehicleSel.append(el('option',{value:String(idx)}, label));
    });
    const addonRow=el('div',{}, el('label',{},'Add-on'), addonSel);
    const nameRow=el('div',{}, el('label',{},'Name'), nameInput);
    const priceRow=el('div',{}, el('label',{},'Price'), priceInput);
    const vehicleRow=el('div',{}, el('label',{},'Vehicle'), vehicleSel);
    const content=el('div',{},
      el('label',{},'Service Type'),
      typeSel,
      addonRow,
      nameRow,
      priceRow,
      vehicleRow,
      includedRow
    );
    const syncControls=()=>{
      const isAddon=typeSel.value==='addon';
      addonRow.style.display=isAddon?'block':'none';
      if(isAddon){
        nameRow.style.display='none';
        if(addonSel.value){
          nameInput.value=addonSel.value;
        }
        if(!priceInput.value){
          const idx=vehicleSel.value?Number(vehicleSel.value):0;
          const size=job.vehicles?.[idx]?.size || job.size || S.menu.sizes[0];
          priceInput.value=Number(Calc.addonPrice(addonSel.value,size)||0).toFixed(2);
        }
      } else {
        nameRow.style.display='block';
      }
    };
    typeSel.addEventListener('change',syncControls);
    addonSel.addEventListener('change',()=>{
      if(addonSel.value){
        nameInput.value=addonSel.value;
        const idx=vehicleSel.value?Number(vehicleSel.value):0;
        const size=job.vehicles?.[idx]?.size || job.size || S.menu.sizes[0];
        priceInput.value=Number(Calc.addonPrice(addonSel.value,size)||0).toFixed(2);
      }
    });
    vehicleSel.addEventListener('change',()=>{
      if(typeSel.value==='addon' && addonSel.value){
        const idx=vehicleSel.value?Number(vehicleSel.value):0;
        const size=job.vehicles?.[idx]?.size || job.size || S.menu.sizes[0];
        priceInput.value=Number(Calc.addonPrice(addonSel.value,size)||0).toFixed(2);
      }
    });
    syncControls();
    UI.modal('Add Service',(close)=>{
      const type=typeSel.value;
      const included=content.querySelector('#svcIncluded').checked;
      let name=type==='addon'?addonSel.value:nameInput.value.trim();
      if(!name){
        alert('Service name is required.');
        return;
      }
      const price=Number(priceInput.value||0);
      const vehicleIndex=vehicleSel.value?Number(vehicleSel.value):null;
      const vehicleLabel=vehicleIndex!=null?((job.vehicles?.[vehicleIndex]?.label)||`Vehicle ${vehicleIndex+1}`):'';
      App.addService(jobId,{type,name,price,included,vehicleIndex,vehicleLabel});
      close();
    }, content, 'Save Service');
  },
  refreshJobPlanner(){
    const input=document.getElementById('jobPlannerDate');
    const list=document.getElementById('jobPlannerList');
    if(!input || !list) return;
    if(!input.value) input.value=today();
    const target=input.value;
    const jobs=S.jobs.filter(job=>(job.schedule?.date||job.date||'')===target);
    jobs.forEach(job=>App.ensureJobStructure(job));
    jobs.sort((a,b)=>(a.schedule?.start||'').localeCompare(b.schedule?.start||''));
    list.innerHTML='';
    if(!jobs.length){
      list.append(el('div',{class:'tiny'},'No jobs scheduled.'));
      return;
    }
    jobs.forEach(job=>{
      const client=S.clients.find(c=>c.id===job.clientId);
      const start=job.schedule?.start || 'Any time';
      const summary=this.jobPackageLabel(job);
      const due=Math.max(0,Calc.total(job)-(job.payments||[]).reduce((t,p)=>t+Number(p.amount||0),0));
      const item=el('div',{class:'list-item'},
        el('div',{style:'font-weight:700;'}, `${start} · ${client?.name||'Unknown'}`),
        el('div',{class:'tiny'}, `${summary} — ${job.status}${due>0?` · Due ${fmt(due)}`:''}`),
        el('div',{class:'row',style:'gap:.35rem;margin-top:.35rem;'},
          el('button',{class:'pill',onclick:()=>UI.openJob(job.id)},'Open'),
          el('button',{class:'pill',onclick:()=>UI.editJob(job.id)},'Edit'),
          el('button',{class:'pill',onclick:()=>UI.openChecklist(job.id)},'Checklist')
        )
      );
      list.append(item);
    });
  },
  refreshJobPerformance(){
    const host=document.getElementById('jobPerformance');
    if(!host) return;
    host.innerHTML='';
    const todayStr=today();
    const active=S.jobs.filter(job=>['Booked','In Progress'].includes(job.status)).length;
    const todays=S.jobs.filter(job=>job.status!=='Quoted' && (job.schedule?.date||job.date||'')===todayStr).length;
    const completed=S.jobs.filter(job=>['Complete','Paid'].includes(job.status)).length;
    const unpaid=S.jobs.reduce((sum,job)=>{
      if(job.status==='Quoted') return sum;
      const paid=(job.payments||[]).reduce((t,p)=>t+Number(p.amount||0),0);
      return sum+Math.max(0,Calc.total(job)-paid);
    },0);
    const minutesTracked=S.jobs.reduce((sum,job)=>{
      if(job.totalMinutes) return sum+Number(job.totalMinutes||0);
      return sum+App.timerElapsedMinutes(job.timers?.overall||{elapsed:0});
    },0);
    host.append(el('div',{style:'font-weight:700;'}, `Active jobs: ${active}`));
    host.append(el('div',{class:'tiny'}, `Scheduled today: ${todays}`));
    host.append(el('div',{class:'tiny'}, `Completed/Paid: ${completed}`));
    host.append(el('div',{class:'tiny'}, `Tracked time: ${formatDurationMinutes(minutesTracked)}`));
    host.append(el('div',{class:'tiny'}, `Unpaid balance: ${fmt(unpaid)}`));
  },
  openPrintDetails(id){
    const j = S.jobs.find(x => x.id === id);
    if (!j) return;
    UI.renderPrintSheet(j);
  },
  openChecklist(id){
    const job=S.jobs.find(x=>x.id===id);
    if(!job) return;
    App.ensureChecklist(job);
    const content=el('div',{class:'list',style:'gap:.75rem;'});
    const closeModal=(close)=>{
      UI.stopChecklistTicker();
      UI.checklistHost=null;
      UI.checklistJobId=null;
      close();
    };
    UI.modal('Crew Checklist',closeModal,content,'Close',false,true);
    UI.checklistHost=content;
    UI.checklistJobId=id;
    UI.renderChecklist(id);
    UI.startChecklistTicker();
  },
  renderChecklist(jobId){
    const host=UI.checklistHost;
    if(!host) return;
    const job=S.jobs.find(x=>x.id===jobId);
    if(!job) return;
    App.ensureChecklist(job);
    const addonInfo=Calc.addonSummary(job);
    host.innerHTML='';
    const callout=el('div',{class:`crew-callout${addonInfo.requiresUpgrade?' alert':''}`});
    callout.append(el('div',{style:'font-weight:800;'}, addonInfo.requiresUpgrade?'⚠️ Add-on upgrade recommended':'Add-on logic snapshot'));
    callout.append(el('div',{class:'tiny'}, addonInfo.message));
    if(addonInfo.totalIncluded){
      callout.append(el('div',{class:'tiny'}, `Included add-ons: ${addonInfo.totalIncluded}`));
    }
    if(addonInfo.perVehicle.length){
      callout.append(el('div',{class:'tiny'}, addonInfo.perVehicle.map((info,idx)=>{
        const label=info.label?info.label:`Vehicle ${idx+1}`;
        return `${label}: ${info.custom} custom / ${info.included} included`;
      }).join(' · ')));
    }
    callout.append(el('div',{class:'tiny'}, addonInfo.upsell));
    host.append(callout);

    job.checklist.sections.forEach(section=>{
      const sectionCard=el('div',{class:'card crew-checklist-section'});
      const completed=section.items.filter(i=>i.completed).length;
      const totalItems=section.items.length;
      const totalMs=section.items.reduce((sum,item)=>sum+App.checklistElapsedMs(item),0);

      const header=el('div',{class:'crew-checklist-header','data-section':section.id});
      header.append(el('div',{style:'font-weight:800;font-size:1.05rem;'}, section.title));
      const headerMeta=el('div',{style:'display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;'});
      headerMeta.append(el('div',{class:'tiny'}, `${completed}/${totalItems} complete`));
      headerMeta.append(el('div',{class:'tiny crew-header-time'}, `Time ${UI.formatDuration(totalMs)}`));
      if(section.goalMinutes){
        headerMeta.append(el('div',{class:'tiny'}, `Goal ${section.goalMinutes} min`));
      }
      header.append(headerMeta);
      sectionCard.append(header);

      const itemsWrap=el('div',{class:'crew-checklist-items'});
      section.items.forEach(item=>{
        const key=`${section.id}:${item.id}`;
        const row=el('div',{class:'crew-checklist-item','data-key':key,'data-running':item.runningSince?'true':'false','data-complete':item.completed?'true':'false'});
        const checkbox=el('input',{type:'checkbox'});
        checkbox.checked=item.completed;
        checkbox.addEventListener('change',()=>{
          App.setChecklistComplete(job.id, section.id, item.id, checkbox.checked);
          UI.renderChecklist(job.id);
        });
        const step=el('div',{class:'crew-step'});
        step.append(el('div',{style:'font-weight:600;'}, item.label));
        if(item.description){
          step.append(el('div',{class:'tiny'}, item.description));
        }
        const timerWrap=el('div',{class:'crew-timer-controls'});
        const timer=el('div',{class:'crew-timer','data-key':key}, UI.formatDuration(App.checklistElapsedMs(item)));
        timerWrap.append(timer);
        const toggleBtn=el('button',{class:'btn secondary'}, item.runningSince?'Stop':'Start');
        toggleBtn.addEventListener('click',()=>{
          App.toggleChecklistTimer(job.id, section.id, item.id);
          UI.renderChecklist(job.id);
        });
        timerWrap.append(toggleBtn);
        row.append(checkbox, step, timerWrap);
        itemsWrap.append(row);
      });
      sectionCard.append(itemsWrap);
      host.append(sectionCard);
    });

    UI.updateChecklistTimers();
  },
  startChecklistTicker(){
    UI.stopChecklistTicker();
    if(!UI.checklistHost || !UI.checklistJobId) return;
    UI.checklistTicker=setInterval(()=>UI.updateChecklistTimers(),1000);
    UI.updateChecklistTimers();
  },
  stopChecklistTicker(){
    if(UI.checklistTicker){
      clearInterval(UI.checklistTicker);
      UI.checklistTicker=null;
    }
  },
  updateChecklistTimers(){
    if(!UI.checklistHost || !UI.checklistJobId) return;
    const job=S.jobs.find(x=>x.id===UI.checklistJobId);
    if(!job) return;
    App.ensureChecklist(job);
    job.checklist.sections.forEach(section=>{
      const headerTime=UI.checklistHost.querySelector(`.crew-checklist-header[data-section="${section.id}"] .crew-header-time`);
      if(headerTime){
        const totalMs=section.items.reduce((sum,item)=>sum+App.checklistElapsedMs(item),0);
        headerTime.textContent=`Time ${UI.formatDuration(totalMs)}`;
      }
      section.items.forEach(item=>{
        const key=`${section.id}:${item.id}`;
        const timerNode=UI.checklistHost.querySelector(`.crew-timer[data-key="${key}"]`);
        if(timerNode){
          timerNode.textContent=UI.formatDuration(App.checklistElapsedMs(item));
        }
        const row=UI.checklistHost.querySelector(`.crew-checklist-item[data-key="${key}"]`);
        if(row){
          row.setAttribute('data-running', item.runningSince?'true':'false');
          row.setAttribute('data-complete', item.completed?'true':'false');
        }
      });
    });
  },
  formatDuration(ms){
    const totalSeconds=Math.max(0,Math.floor(ms/1000));
    const hours=Math.floor(totalSeconds/3600);
    const minutes=Math.floor((totalSeconds%3600)/60);
    const seconds=totalSeconds%60;
    if(hours>0){
      return `${hours}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
    }
    return `${minutes}:${String(seconds).padStart(2,'0')}`;
  },
  showQuickClient(){ document.getElementById('quickClient').classList.remove('hidden'); },
  hideQuickClient(){ document.getElementById('quickClient').classList.add('hidden'); },
  openExpenseForm(initial={}){
    const defaultDate=initial.date || today();
    const dateInput=el('input',{type:'date',value:defaultDate});
    const categorySelect=(()=>{
      const sel=el('select',{});
      const categories=(S.settings.categories||[]).filter(c=>c!=='Package'&&c!=='Add-on');
      categories.forEach(cat=>sel.append(el('option',{value:cat,selected:cat===initial.category},cat)));
      if(!sel.value && categories.length) sel.value=categories[0];
      return sel;
    })();
    const vendorInput=el('input',{value:initial.vendor||'',placeholder:'Vendor or store'});
    const paymentSelect=(()=>{
      const sel=el('select',{});
      (S.settings.paymentMethods||[]).forEach(method=>sel.append(el('option',{value:method,selected:method===initial.payment},method)));
      if(!sel.value && sel.options.length) sel.value=sel.options[0].value;
      return sel;
    })();
    const amountInput=el('input',{type:'number',min:'0',step:'0.01',value:initial.amount?Number(initial.amount).toFixed(2):''});
    const notesInput=el('textarea',{placeholder:'Optional notes',value:initial.notes||''});
    const ocrStatus=el('div',{class:'receipt-ocr-status'},'Use the buttons above to scan or upload a receipt.');
    const previewImg=el('img',{});
    const preview=el('div',{class:'receipt-preview hidden'}, previewImg, ocrStatus);
    const cameraInput=el('input',{type:'file',accept:'image/*',capture:'environment',class:'hidden'});
    const uploadInput=el('input',{type:'file',accept:'image/*',class:'hidden'});
    const state={imageData:initial.receiptImage||'', busy:false};
    const cameraBtn=el('button',{class:'btn fullwidth',type:'button'},'Scan with Camera');
    const uploadBtn=el('button',{class:'btn secondary fullwidth',type:'button'},'Upload Receipt');
    const updateButtons=()=>{
      cameraBtn.textContent=state.imageData?'Rescan with Camera':'Scan with Camera';
      uploadBtn.textContent=state.imageData?'Upload Different Photo':'Upload Receipt';
      preview.classList.toggle('hidden',!state.imageData);
      if(state.imageData) ocrStatus.textContent='Receipt attached. Double-check the details below.';
    };
    const fillFromParsed=(parsed)=>{
      if(parsed.date && !dateInput.value) dateInput.value=parsed.date;
      if(parsed.vendor && !vendorInput.value) vendorInput.value=parsed.vendor;
      if(parsed.amount && !amountInput.value) amountInput.value=parsed.amount;
      if(parsed.payment){
        const match=(S.settings.paymentMethods||[]).find(method=>method.toLowerCase()===parsed.payment.toLowerCase());
        if(match) paymentSelect.value=match;
      }
    };
    const runOcr=async(file)=>{
      if(state.busy) return;
      state.busy=true;
      ocrStatus.textContent='Scanning receipt…';
      try{
        const Tesseract=await UI.loadOcr();
        const source=state.imageData || file;
        const result=await Tesseract.recognize(source,'eng');
        const text=result?.data?.text||'';
        if(text.trim()){
          const parsed=UI.parseReceiptText(text);
          fillFromParsed(parsed);
          ocrStatus.textContent='Receipt scanned. Review and adjust the extracted fields.';
        } else {
          ocrStatus.textContent='No text detected. Enter details manually.';
        }
      } catch(err){
        console.error(err);
        ocrStatus.textContent='Could not read the receipt. Enter details manually.';
      } finally {
        state.busy=false;
      }
    };
    const handleFile=file=>{
      if(!file) return;
      const reader=new FileReader();
      reader.onload=()=>{
        state.imageData=reader.result;
        previewImg.src=reader.result;
        updateButtons();
        runOcr(file);
      };
      reader.readAsDataURL(file);
    };
    cameraInput.addEventListener('change',e=>handleFile(e.target.files[0]));
    uploadInput.addEventListener('change',e=>handleFile(e.target.files[0]));
    cameraBtn.addEventListener('click',()=>{ if(state.busy) return; cameraInput.value=''; cameraInput.click(); });
    uploadBtn.addEventListener('click',()=>{ if(state.busy) return; uploadInput.value=''; uploadInput.click(); });
    if(state.imageData){
      previewImg.src=state.imageData;
      preview.classList.remove('hidden');
      ocrStatus.textContent='Receipt attached. Review the details below.';
    }
    updateButtons();
    const content=el('div',{class:'form-grid'},
      el('div',{class:'stack-buttons'}, cameraBtn, uploadBtn),
      preview,
      el('div',{}, el('label',{},'Date'), dateInput),
      el('div',{}, el('label',{},'Category'), categorySelect),
      el('div',{}, el('label',{},'Vendor'), vendorInput),
      el('div',{class:'mobile-field-row'},
        el('div',{}, el('label',{},'Payment Method'), paymentSelect),
        el('div',{}, el('label',{},'Amount'), amountInput)
      ),
      el('div',{}, el('label',{},'Notes'), notesInput),
      cameraInput,
      uploadInput
    );
    this.modal('Add Expense',(close)=>{
      const date=dateInput.value||today();
      const category=categorySelect.value;
      const vendor=vendorInput.value.trim();
      const payment=paymentSelect.value;
      const amountValue=Number(amountInput.value||0);
      if(!(amountValue>0)) return alert('Amount required');
      const notes=notesInput.value.trim();
      App.addExpenseRecord({date,category,vendor,payment,amount:amountValue,notes,receiptImage:state.imageData});
      close();
      UI.flash('Expense added.');
    }, content, 'Save Expense');
  },
  openTransactions(){
    const transactions=[...S.transactions].sort((a,b)=>String(b.date||'').localeCompare(a.date||''));
    const list=el('div',{class:'list'});
    if(!transactions.length){
      list.append(el('div',{class:'tiny'},'No transactions yet.'));
    } else {
      transactions.forEach(tx=>list.append(this.buildTransactionCard(tx,{showType:true})));
    }
    const content=el('div',{class:'form-grid'},
      el('div',{class:'stack-buttons'},
        el('button',{class:'btn secondary fullwidth',onclick:()=>Data.exportCSV()},'Export CSV'),
        el('button',{class:'btn secondary fullwidth',onclick:()=>Data.exportJSON()},'Export JSON')
      ),
      list
    );
    this.modal('Transactions',(close)=>close(), content,'Close',false,true);
  },
  openExpenses(){
    const expenses=S.transactions.filter(t=>t.type==='Expense');
    const list=el('div',{class:'list'});
    if(!expenses.length){
      list.append(el('div',{class:'tiny'},'No expenses recorded yet.'));
    } else {
      expenses.slice().sort((a,b)=>String(b.date||'').localeCompare(a.date||'')).forEach(exp=>{
        list.append(this.buildTransactionCard(exp,{showType:false}));
      });
    }
    const content=el('div',{class:'form-grid'},
      el('div',{class:'stack-buttons'},
        el('button',{class:'btn fullwidth',onclick:()=>UI.openExpenseForm()},'Add Expense'),
        el('button',{class:'btn secondary fullwidth',onclick:()=>Data.exportCSV()},'Export CSV')
      ),
      list
    );
    this.modal('Expenses',(close)=>close(), content,'Close',false,true);
  },
  openMileage(){ const rows=S.mileage.map((m,i)=>`<tr><td>${m.date}</td><td>${m.from}</td><td>${m.to}</td><td>${m.why}</td><td>${m.miles}</td><td><button class='pill' onclick='UI.delMileage(${i})'>Delete</button></td></tr>`).join(''); this.modal('Mileage',(c)=>c(), el('div',{}, el('div',{class:'row'}, el('div',{}, el('label',{},'Date'), el('input',{id:'miDate',type:'date',value:today()})), el('div',{}, el('label',{},'From'), el('input',{id:'miFrom'})), el('div',{}, el('label',{},'To'), el('input',{id:'miTo'})), el('div',{}, el('label',{},'Why'), el('input',{id:'miWhy'})), el('div',{}, el('label',{},'Miles'), el('input',{id:'miMiles',type:'number',min:'0',step:'0.1'})) ), el('div',{class:'row'}, el('button',{class:'btn', onclick:()=>UI.addMileage()},'Add Entry')), el('table',{style:'width:100%;border-collapse:collapse;margin-top:.5rem;'}, el('thead',{}, el('tr',{html:'<th>Date</th><th>From</th><th>To</th><th>Why</th><th>Miles</th><th></th>'})), el('tbody',{id:'miBody',html:rows})) )); },
  addMileage(){ const e={date:document.getElementById('miDate').value||today(),from:document.getElementById('miFrom').value||'',to:document.getElementById('miTo').value||'',why:document.getElementById('miWhy').value||'',miles:Number(document.getElementById('miMiles').value||0)}; S.mileage.push(e); Storage.save(S); const tr=`<tr><td>${e.date}</td><td>${e.from}</td><td>${e.to}</td><td>${e.why}</td><td>${e.miles}</td><td><button class='pill' onclick='UI.delMileage(${S.mileage.length-1})'>Delete</button></td></tr>`; document.getElementById('miBody').insertAdjacentHTML('beforeend', tr); UI.flash('Mileage added.'); },
  delMileage(i){ if(!confirm('Delete entry?')) return; S.mileage.splice(i,1); Storage.save(S); UI.openMileage(); },
  openMenuEditor(){
    const content=el('div',{});
    const pkgHeader=el('h4',{},'Packages');
    const pkgList=el('div',{id:'pkgEditor',class:'list',style:'gap:.75rem;'});
    const createAddonOption=(name,checked=false,onChange=()=>{})=>{
      const option=el('label',{class:'pkg-addon-option','data-name':name,'data-selected':checked?'true':'false'});
      const cb=el('input',{type:'checkbox',value:name});
      cb.checked=checked;
      cb.addEventListener('change',()=>{
        option.setAttribute('data-selected',cb.checked?'true':'false');
        onChange(cb.checked);
      });
      option.append(cb, name);
      return option;
    };
    const createCard=(name,prices=[],meta={lock:false,includedAddons:[],description:''})=>{
      const card=el('div',{class:'menu-pkg-card','data-collapsed':'false'});
      const header=el('div',{class:'pkg-header'});
      const toggle=el('button',{class:'pkg-toggle',type:'button',title:'Collapse section','aria-expanded':'true'},'▾');
      const toggleSection=()=>{
        const currentlyCollapsed=card.getAttribute('data-collapsed')==='true';
        const nextCollapsed=!currentlyCollapsed;
        card.setAttribute('data-collapsed',nextCollapsed?'true':'false');
        toggle.textContent=nextCollapsed?'▸':'▾';
        toggle.setAttribute('aria-expanded',(!nextCollapsed).toString());
      };
      toggle.addEventListener('click',toggleSection);
      header.append(toggle);
      const nameWrap=el('div',{style:'flex:1;'});
      const nameInput=el('input',{class:'pkg-name',value:name,placeholder:'Package name'});
      nameWrap.append(nameInput);
      header.append(nameWrap);
      const removeBtn=el('button',{class:'btn secondary',type:'button'},'Remove');
      removeBtn.addEventListener('click',()=>{
        if(pkgList.querySelectorAll('.menu-pkg-card').length<=1){
          UI.flash('At least one package required.');
          return;
        }
        card.remove();
      });
      header.append(removeBtn);
      card.append(header);

      const summary=el('div',{class:'pkg-summary',tabindex:'0'});
      summary.addEventListener('click',toggleSection);
      summary.addEventListener('keydown',(e)=>{
        if(e.key==='Enter'||e.key===' '){
          e.preventDefault();
          toggleSection();
        }
      });
      card.append(summary);

      const body=el('div',{class:'pkg-body'});

      const priceGrid=el('div',{class:'grid',style:'gap:.5rem;'});
      const priceInputs=[];
      S.menu.sizes.forEach((size,i)=>{
        const col=el('div',{});
        col.append(el('label',{},size));
        const input=el('input',{type:'number',class:'pkg-price','data-size-index':i,min:'0',step:'0.01',value:Number(prices[i]||0).toFixed(2)});
        priceInputs.push(input);
        col.append(input);
        priceGrid.append(col);
      });
      body.append(priceGrid);

      const lockRow=el('div',{class:'row',style:'gap:.5rem;align-items:center;'});
      lockRow.append(el('label',{style:'flex:1;'},'Lock Retail Base?'));
      const lockSelect=el('select',{class:'pkg-lock'});
      lockSelect.append(el('option',{value:'no',selected:!meta.lock},'No'));
      lockSelect.append(el('option',{value:'yes',selected:meta.lock},'Yes'));
      lockRow.append(lockSelect);
      body.append(lockRow);

      const descLabel=el('label',{},'Description');
      const descInput=el('textarea',{class:'pkg-desc',placeholder:'Short summary of what is included',value:meta.description||''});
      body.append(descLabel,descInput);

      const addonLabel=el('label',{},'Included Add-ons');
      const addonWrap=el('div',{class:'pkg-addon-options'});
      body.append(addonLabel,addonWrap);

      const updateSummary=()=>{
        const sizePreview=S.menu.sizes[0]||'';
        const previewInput=priceInputs[0];
        const baseValue=Number(previewInput?.value||0);
        const basePreview=previewInput?`${sizePreview?sizePreview+': ':''}${fmt(baseValue)}`:'';
        const description=descInput.value.trim();
        const includedCount=addonWrap.querySelectorAll('input[type=checkbox]:checked').length;
        const parts=[];
        if(basePreview) parts.push(`Base ${basePreview}`);
        if(description) parts.push(description);
        if(includedCount) parts.push(`${includedCount} included add-on${includedCount===1?'':'s'}`);
        summary.textContent=parts.join(' • ')||'Add pricing, a description, or included add-ons.';
      };

      Object.keys(S.menu.addons).forEach(addonName=>{
        const checked=!!meta.includedAddons?.includes(addonName);
        addonWrap.append(createAddonOption(addonName,checked,()=>updateSummary()));
      });

      descInput.addEventListener('input',updateSummary);
      priceInputs.forEach(input=>input.addEventListener('input',updateSummary));

      card.append(body);

      updateSummary();

      if(pkgList.children.length){
        card.setAttribute('data-collapsed','true');
        toggle.textContent='▸';
        toggle.setAttribute('aria-expanded','false');
      }

      return card;
    };

    const existingPackages=Object.entries(S.menu.packages);
    if(existingPackages.length){
      existingPackages.forEach(([name,prices])=>pkgList.append(createCard(name,prices,pkgMeta(name))));
    } else {
      pkgList.append(createCard('New Package',S.menu.sizes.map(()=>0),{lock:false,includedAddons:[],description:''}));
    }

    const addPackageBtn=el('button',{class:'btn secondary',type:'button'},'Add Package');
    addPackageBtn.addEventListener('click',()=>{
      const base='New Package';
      const currentNames=new Set(Array.from(pkgList.querySelectorAll('.pkg-name')).map(inp=>inp.value.trim()).filter(Boolean));
      let candidate=base;
      let idx=2;
      while(currentNames.has(candidate)){
        candidate=`${base} ${idx++}`;
      }
      pkgList.append(createCard(candidate,S.menu.sizes.map(()=>0),{lock:false,includedAddons:[],description:''}));
    });

    content.append(pkgHeader);
    content.append(pkgList);
    content.append(el('div',{class:'row',style:'margin:.5rem 0;'},addPackageBtn));

    const makeTable=(title,map,sizes,id)=>{
      const headers='<tr><th>Item</th>'+sizes.map(s=>`<th>${s}</th>`).join('')+'<th></th></tr>';
      const rows=Object.entries(map).map(([n,arr])=>`<tr data-name="${n}"><td><input value="${n}"></td>`+sizes.map((s,i)=>`<td><input type='number' min='0' step='1' value='${Number(arr[i]||0)}'></td>`).join('')+`<td><button class='pill' onclick='UI.delRow("${id}","${n}")'>Delete</button></td></tr>`).join('');
      return `<h4>${title}</h4><table class='table' id='${id}'><thead>${headers}</thead><tbody>${rows}</tbody></table>`;
    };

    const addonSection=el('div',{html:makeTable('Add-ons',S.menu.addons,S.menu.sizes,'addonTable')});
    content.append(addonSection);
    content.append(el('div',{class:'footnote',style:'margin-top:.5rem;'},S.menu.guidance));

    const readAddons=()=>{
      const tbody=document.querySelector('#addonTable tbody');
      if(!tbody) return {};
      const rows=Array.from(tbody.querySelectorAll('tr'));
      const out={};
      for(const r of rows){
        const inputs=r.querySelectorAll('input');
        const name=inputs[0].value.trim();
        if(!name) continue;
        const prices=Array.from(inputs).slice(1).map(x=>Number(x.value||0));
        out[name]=prices;
      }
      return out;
    };

    UI.modal('Menu Editor',(close)=>{
      try{
        const packages={};
        const meta={};
        pkgList.querySelectorAll('.menu-pkg-card').forEach(card=>{
          const name=(card.querySelector('.pkg-name')?.value||'').trim();
          if(!name) return;
          const prices=S.menu.sizes.map((_,i)=>{
            const input=card.querySelector(`.pkg-price[data-size-index="${i}"]`);
            return Number(input?.value||0);
          });
          packages[name]=prices;
          const lock=card.querySelector('.pkg-lock')?.value==='yes';
          const included=Array.from(card.querySelectorAll('.pkg-addon-option input[type=checkbox]')).filter(cb=>cb.checked).map(cb=>cb.value);
          const description=(card.querySelector('.pkg-desc')?.value||'').trim();
          meta[name]={lock,includedAddons:included, description};
        });
        if(!Object.keys(packages).length) throw new Error('At least one package is required.');
        S.menu.packages=packages;
        S.menu.packageMeta=meta;
        S.menu.addons=readAddons();
        Storage.save(S);
        UI.populateSizesAndPackages();
        UI.prefillBase();
        UI.renderAddons();
        UI.flash('Menu saved.');
        close();
      }catch(e){
        alert('Error saving: '+e.message);
      }
    }, content, 'Save Changes', true, true);
  },
  delRow(tableId,name){ const tr=document.querySelector(`#${tableId} tr[data-name="${name}"]`); if(tr) tr.remove(); },
  openCustomBuilder(row=null){ const size=(row?.querySelector('.vehicle-size')?.value)||document.querySelector('.vehicle-size')?.value||S.menu.sizes[0]; const basePref=row?.querySelector('.vehicle-base')?.value||'0'; const content=el('div',{}, el('label',{},'Package Name'), el('input',{id:'cbName', value:'Custom Package'}), el('div',{class:'row'}, el('div',{}, el('label',{}, 'Base Price for '+size), el('input',{id:'cbBase',type:'number',min:'0',step:'0.01',value:basePref})), el('div',{}, el('label',{}, 'Lock Retail Base'), el('select',{id:'cbLock'}, el('option',{value:'no'},'No'), el('option',{value:'yes'},'Yes')))), el('label',{},'Description'), el('textarea',{id:'cbDesc',placeholder:'What is highlighted in this package?'}), el('label',{},'Included Add-ons (optional)'), (()=>{ const box=el('div',{class:'list'}); for(const n of Object.keys(S.menu.addons)) box.append(el('label',{}, el('input',{type:'checkbox','data-name':n,style:'margin-right:.4rem;'}), n)); return box; })(), el('label',{},'Pick & Choose mode (no included items)'), el('select',{id:'cbPick'}, el('option',{value:'no'},'No'), el('option',{value:'yes'},'Yes')) ); UI.modal('Build Custom Package',(close)=>{ const name=content.querySelector('#cbName').value.trim()||'Custom Package'; const base=Number(content.querySelector('#cbBase').value||0); const lock=content.querySelector('#cbLock').value==='yes'; const description=content.querySelector('#cbDesc').value.trim(); const pick=content.querySelector('#cbPick').value==='yes'; const inc=pick?[]:Array.from(content.querySelectorAll('input[type=checkbox][data-name]')).filter(x=>x.checked).map(x=>x.getAttribute('data-name')); const prices=S.menu.sizes.map(()=>0); const idx=S.menu.sizes.indexOf(size); if(idx>=0) prices[idx]=base; else if(prices.length) prices[0]=base; S.menu.packages[name]=prices; S.menu.packageMeta[name]={lock, includedAddons:inc, description}; Storage.save(S); UI.populateSizesAndPackages(); if(row){ const pkgSel=row.querySelector('.vehicle-package'); if(pkgSel){ pkgSel.value=name; UI.refreshVehicleRow(row,{setBase:true}); UI.updateTotals(); } } else { const firstRow=document.querySelector('.vehicle-row'); const pkgSel=firstRow?.querySelector('.vehicle-package'); if(pkgSel){ pkgSel.value=name; UI.refreshVehicleRow(firstRow,{setBase:true}); } UI.handlePackageChange(); } UI.flash('Custom package added.'); close(); }, content, 'Use Package', true, true); },
  openImport(){ const file=el('input',{type:'file',accept:'.json'}); file.onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); if(!data.transactions) throw new Error('Invalid backup file: missing "transactions"'); S=data; if(!S.menu.packageMeta) S.menu.packageMeta={}; Storage.save(S); location.reload(); }catch(err){ alert('Import error: '+err.message); } }; r.readAsText(f); }; file.click(); },
  openSettings(){ const content=el('div',{}, el('h4',{},'Brand'), el('label',{},'Header Title'), el('input',{id:'stHeader', value:S.business.headerTitle||''}), el('label',{},'Business Name (on quotes)'), el('input',{id:'stBiz', value:S.business.name||''}), el('label',{},'Logo'), el('div',{class:'row'}, el('button',{class:'btn', onclick:()=>UI.pickLogo()},'Upload Logo'), el('button',{class:'btn secondary', onclick:()=>{ S.business.logoDataUrl=''; Storage.save(S); UI.initHeader(); UI.flash('Logo removed.'); }},'Remove Logo')), el('div',{class:'footnote'},'Replace install icons by swapping icon-192.png / icon-512.png in the bundle.') ); UI.modal('Settings',(close)=>{ S.business.headerTitle=content.querySelector('#stHeader').value.trim()||'POLISH CREW — Accounting'; S.business.name=content.querySelector('#stBiz').value.trim()||'Polish Crew'; Storage.save(S); UI.initHeader(); UI.flash('Settings saved.'); close(); }, content); },
  pickLogo(){ const f=el('input',{type:'file',accept:'image/*'}); f.onchange=(e)=>{ const file=e.target.files[0]; if(!file) return; const r=new FileReader(); r.onload=()=>{ S.business.logoDataUrl=r.result; Storage.save(S); UI.initHeader(); UI.flash('Logo updated.'); }; r.readAsDataURL(file); }; f.click(); },
  clientName(id){ return (S.clients.find(c=>c.id===id)||{}).name||''; },
  printQuote(){
    const clientId = document.getElementById('jobClient').value || '';
    const vehicles = this.collectVehicles();
    if(!vehicles.length) return alert('Add at least one vehicle to print');
    const discType = document.getElementById('jobDiscType').value;
    const discValue= Number(document.getElementById('jobDiscValue').value || 0);
    const discScope= document.getElementById('jobDiscScope').value;
    const notes    = document.getElementById('jobNotes').value.trim();
    const primaryPkg = vehicles[0]?.pkg || '';

    const tempJob = {
      id: 'preview',
      date: new Date().toISOString().slice(0,10),
      clientId,
      pkg: primaryPkg,
      vehicles,
      discType,
      discValue,
      discScope,
      notes,
      status: 'Quoted',
      payments: []
    };
    tempJob.size = vehicles[0]?.size || '';
    tempJob.vehicleCount = vehicles.length;

    UI.renderPrintSheet(tempJob);
  },
  toggleDrawer(open){ document.getElementById('drawer').classList.toggle('open', !!open); },
  modal(title,onPrimary,contentNode,primaryText='Save',showCancel=true,wide=false){ const host=document.getElementById('modalHost'); host.innerHTML=''; const overlay=el('div',{style:'position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:30;display:flex;align-items:center;justify-content:center;'}); const card=el('div',{class:'card',style:`width:${wide?'min(96vw,980px)':'min(96vw,640px)'};max-height:90vh;overflow:auto;`}); card.append(el('h3',{},title)); card.append(contentNode); const actions=el('div',{class:'row',style:'margin-top:.5rem;justify-content:flex-end;'}); if(showCancel) actions.append(el('button',{class:'btn secondary',onclick:()=>host.innerHTML=''},'Cancel')); actions.append(el('button',{class:'btn',onclick:()=>onPrimary(()=>host.innerHTML='')},primaryText)); card.append(actions); overlay.append(card); host.append(overlay); return card; },
  flash(msg){ const n=el('div',{style:'position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#06100a;border:1px solid #163c27;color:#dff8e7;padding:.6rem 1rem;border-radius:999px;z-index:50;'}, msg); document.body.append(n); setTimeout(()=>n.remove(),1600); },
  bootError(text){ const w=el('div',{class:'card',style:'margin:1rem;border-color:#3a1515;background:#1b0c0c;'}, el('h3',{},'Boot Error'), el('div',{}, text||'Unknown error')); document.body.prepend(w); }
};
// Renders the 1-page sheet for ANY job-like object
UI.renderPrintSheet = function(job){
  const j = job;
  const c = S.clients.find(x => x.id === j.clientId);
  const hasVehicles = Array.isArray(j.vehicles) && j.vehicles.length;
    const vehicles = hasVehicles ? j.vehicles.map(v=>({
      size: v.size || '',
      base: Number(v.base||0),
      addons: (v.addons||[]).map(a=>({name:a.name, price:Number(a.price||0), included:!!a.included})),
      pkg: v.pkg || j.pkg || '',
      label: v.label || ''
    })) : [];
  const pkgLabel = UI.jobPackageLabel(j);
  const packageNames = hasVehicles ? vehicles.map(v=>v.pkg).filter(Boolean) : [j.pkg].filter(Boolean);
  const uniquePackages = [...new Set(packageNames)];
  const metaSource = uniquePackages.length===1 ? uniquePackages[0] : (uniquePackages.length===0 ? (j.pkg||'') : '');
  const meta = metaSource && S.menu.packageMeta ? (S.menu.packageMeta[metaSource] || {includedAddons:[]}) : {includedAddons:[]};
  const included = uniquePackages.length>1
    ? '<li>Varies by vehicle</li>'
    : (meta.includedAddons||[]).map(n=>`<li>${n}</li>`).join('');
  const legacyAddons = (!hasVehicles ? (j.addons||[]) : []).map(a=>{
    const count=Calc.vehicleCount(j);
    if(a?.included){
      return `<tr><td>${a.name}</td><td style="text-align:right">Included</td></tr>`;
    }
    const price=Number(a.price||0);
    const lineTotal=price*count;
    const priceLabel=count>1 ? `$${price.toFixed(2)} ea × ${count} = $${lineTotal.toFixed(2)}` : `$${price.toFixed(2)}`;
    const note=count>1?'<div style="color:#777;font-size:12px;">Per vehicle</div>':'';
    return `<tr><td>${a.name}${note}</td><td style="text-align:right">${priceLabel}</td></tr>`;
  }).join('');
  const vehicleCount = hasVehicles ? vehicles.length : Calc.vehicleCount(j);
  const vehicleSummary = UI.jobVehicleSummary(j);
  const subtotal = Calc.subtotal(j).toFixed(2);
  const disc = Calc.discount(j).toFixed(2);
  const total = Calc.total(j).toFixed(2);
  const discountLabel = (j.discScope==='vehicle' && vehicleCount>1) ? 'Discount (per vehicle)' : 'Discount';
  const paidRows = (j.payments||[]).map(p=>`<tr><td>${p.date}</td><td>${p.method||''}</td><td style="text-align:right">$${Number(p.amount||0).toFixed(2)}</td></tr>`).join('');
  const bizName = S.business?.name || 'Polish Crew';
  const logo = S.business?.logoDataUrl || '';
  const headerTitle = (j.status === 'Paid') ? 'Receipt' : 'Quote';
  const vehicleSections = hasVehicles ? vehicles.map((v,idx)=>{
    const addonRows = v.addons.length ? v.addons.map(a=>{
      if(a?.included){
        return `<tr><td>${a.name}<span style="color:#0a6;font-size:12px;margin-left:6px;">Included</span></td><td style="text-align:right">Included</td></tr>`;
      }
      return `<tr><td>${a.name}</td><td style="text-align:right">$${Number(a.price||0).toFixed(2)}</td></tr>`;
    }).join('') : '<tr><td style="color:#666">No add-ons</td><td></td></tr>';
    const pkgName = v.pkg || pkgLabel || (j.pkg || 'Package');
    const headingName = v.label ? `${v.label}${v.size ? ' ('+v.size+')' : ''}` : (v.size || 'Vehicle');
    return `<div style="margin-bottom:12px;">
      <div style="font-weight:700;margin-bottom:4px;">Vehicle ${idx+1}: ${headingName}${pkgName?` — ${pkgName}`:''}</div>
      <table style="width:100%;border-collapse:collapse;font-size:14px">
        <tr><td>${pkgName || 'Package'} base${v.size ? ' — '+v.size : ''}</td><td style="text-align:right">$${v.base.toFixed(2)}</td></tr>
        ${addonRows}
      </table>
    </div>`;
  }).join('') : '';
  const docDate = j.date || j.schedule?.date || new Date().toISOString().slice(0,10);
  const popupHtml = `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>${headerTitle} — ${bizName}</title>
  <style>
    body{margin:0;background:#eef2f4;color:#111;font:14px/1.45 Montserrat,Arial,sans-serif;}
    .toolbar{position:sticky;top:0;display:flex;justify-content:flex-end;gap:8px;padding:12px 18px;background:#fff;border-bottom:1px solid #cfd8dd;box-shadow:0 4px 12px rgba(10,20,30,.06);}
    .toolbar button{padding:8px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer;font-family:inherit;}
    .toolbar button.primary{background:#0c2015;color:#f1faf4;}
    .toolbar button.secondary{background:#e7ecef;color:#12241a;}
    .sheet{max-width:820px;margin:24px auto;background:#fff;padding:28px 32px 48px;border-radius:18px;box-shadow:0 24px 60px rgba(12,22,30,.12);}
    hr{border:none;border-top:1px solid #dde3e6;margin:16px 0;}
    table{border-collapse:collapse;width:100%;}
    td{padding:4px 0;vertical-align:top;}
    ul{margin:0 0 8px 18px;padding:0;}
    @media print{
      body{background:#fff;}
      .toolbar{display:none;}
      .sheet{box-shadow:none;border-radius:0;margin:0;padding:0;}
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <button class="secondary" onclick="window.close()">Close</button>
    <button class="primary" onclick="window.print()">Print</button>
  </div>
  <div class="sheet">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
      ${logo ? `<img src="${logo}" style="width:56px;height:56px;border-radius:12px;border:2px solid #0a0;object-fit:cover">` : ''}
      <div>
        <div style="font-weight:900;font-size:20px;letter-spacing:.3px;text-transform:uppercase;">${bizName}</div>
        <div style="color:#6b7a80;font-size:12px;">Generated ${new Date().toLocaleString()}</div>
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:14px;gap:18px;flex-wrap:wrap;">
      <div>
        <div style="font-weight:900;font-size:26px;letter-spacing:.4px;margin-bottom:4px;">${headerTitle}</div>
        <div style="color:#4e5b60;font-size:13px;">Date: ${docDate}</div>
      </div>
      <div style="text-align:right;min-width:160px;">
        <div style="font-weight:700;font-size:15px;">${c?.name || ''}</div>
        ${c?.phone ? `<div style="color:#4e5b60;font-size:13px;">${c.phone}</div>` : ''}
        ${c?.email ? `<div style="color:#4e5b60;font-size:13px;">${c.email}</div>` : ''}
      </div>
    </div>

    <hr>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;margin-bottom:16px;">
      <div>
        <div style="color:#5b696f;font-size:12px;text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px;">Package</div>
        <div style="font-weight:700;font-size:16px;">${pkgLabel}${vehicleSummary?` — ${vehicleSummary}`:''}</div>
      </div>
      <div>
        <div style="color:#5b696f;font-size:12px;text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px;">Status</div>
        <div style="font-weight:700;font-size:16px;">${j.status || 'Quoted'}</div>
      </div>
      <div>
        <div style="color:#5b696f;font-size:12px;text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px;">Vehicles</div>
        <div style="font-weight:700;font-size:16px;">${vehicleCount}</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:24px;align-items:flex-start;">
      <div>
        <div style="font-weight:800;margin:6px 0 6px;font-size:15px;">Included with ${uniquePackages.length>1?'packages':'package'}</div>
        <ul>${included || '<li>None</li>'}</ul>

        ${hasVehicles ? `<div style=\"font-weight:800;margin:16px 0 8px;font-size:15px;\">Vehicles</div><div style=\"display:flex;flex-direction:column;gap:16px;\">${vehicleSections}</div>` : `<div style=\"font-weight:800;margin:16px 0 8px;font-size:15px;\">Add-ons</div><table style=\"width:100%;border-collapse:collapse;font-size:14px\">${legacyAddons || '<tr><td style=\"color:#666\">None</td><td></td></tr>'}</table>`}

        ${j.notes ? `<div style="margin-top:16px"><div style="color:#5b696f;font-size:12px;text-transform:uppercase;letter-spacing:.4px;">Notes</div><div style="margin-top:4px;white-space:pre-wrap;">${j.notes}</div></div>` : ''}
      </div>

      <div>
        <table style="font-size:14px">
          <tr><td>Subtotal</td><td style="text-align:right">$${subtotal}</td></tr>
          <tr><td>${discountLabel}</td><td style="text-align:right">-$${disc}</td></tr>
          <tr><td style="padding-top:10px;border-top:1px solid #dde3e6;font-weight:800">Total</td><td style="padding-top:10px;border-top:1px solid #dde3e6;font-weight:800;text-align:right">$${total}</td></tr>
        </table>

        ${paidRows ? `
        <div style="margin-top:18px">
          <div style="font-weight:800;margin-bottom:6px;font-size:15px;">Payments</div>
          <table style="width:100%;border-collapse:collapse;font-size:14px;">
            <tr style="color:#5b696f;font-size:12px;text-transform:uppercase;letter-spacing:.4px;">
              <td>Date</td><td>Method</td><td style="text-align:right">Amount</td>
            </tr>
            ${paidRows}
          </table>
        </div>` : ''}
      </div>
    </div>

    <div style="margin-top:28px;color:#738087;font-size:12px;">Thank you for your business.</div>
  </div>
  <script>
    window.addEventListener('load', function(){
      try { window.focus(); } catch(e){}
    });
  <\/script>
</body>
</html>`;

  const popup = window.open('', '_blank');
  if(!popup || popup.closed){
    alert('Please allow pop-ups to view the printable page.');
    return;
  }
  popup.document.open();
  popup.document.write(popupHtml);
  popup.document.close();
};

/*** Data export ***/
const Data = {
  exportJSON(){ const blob=new Blob([JSON.stringify(S,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='pc_accounting_backup.json'; a.click(); URL.revokeObjectURL(url); },
  exportCSV(){ const rows=[[ 'date','type','category','item','client','vendor','payment','amount','notes' ]]; for(const t of S.transactions) rows.push([ t.date||'', t.type||'', t.category||'', (t.item||'').replace(/,/g,' '), UI.clientName(t.clientId||'').replace(/,/g,' '), (t.vendor||'').replace(/,/g,' '), t.payment||'', Number(t.amount||0).toFixed(2), (t.notes||'').replace(/,/g,' ') ]); const csv=rows.map(r=>r.join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='transactions.csv'; a.click(); URL.revokeObjectURL(url); }
};

window.addEventListener('load', ()=>App.init());
</script>
</body>
</html>
